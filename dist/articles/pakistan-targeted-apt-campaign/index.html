<!DOCTYPE html><html data-n-head="" data-n-head-ssr><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1" name="viewport"><meta data-n-head="true" content="Nuxt.js project" name="description" data-hid="description"><title data-n-head="true">360威胁情报中心</title><link href="/fav.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.863edfce59f0a00ce608.js" rel="preload" as="script"><link href="/_nuxt/vendor.bundle.21224f443c6ee9ce918d.js" rel="preload" as="script"><link href="/_nuxt/nuxt.bundle.b8b247420f15d35e36d4.js" rel="preload" as="script"><link href="/_nuxt/0.nuxt.bundle.2df9fec90221d3916af4.js" rel="prefetch"><link href="/_nuxt/1.nuxt.bundle.a78c0d1fcdf1a526e7b5.js" rel="prefetch"><link href="/_nuxt/2.nuxt.bundle.f39815f9942bae29e5fd.js" rel="prefetch"><link href="/_nuxt/3.nuxt.bundle.7f40b4df92fe73eb8bcb.js" rel="prefetch"><style data-vue-ssr-id="1cbf7f39:0 198c0e1e:0 034fd8e0:0 ba3a09e0:0 c2ba7178:0 01cb4693:0 69b5e360:0">.progress[data-v-862bdd9c]{position:fixed;top:0;left:0;right:0;height:2px;width:0;-webkit-transition:width .2s,opacity .4s;-o-transition:width .2s,opacity .4s;transition:width .2s,opacity .4s;opacity:1;background-color:#efc14e;z-index:999999}.hljs ::-webkit-scrollbar{width:8px;height:10px;border-radius:2px;background-color:#839496}.hljs ::-webkit-scrollbar-track{background-color:#bebebe}.hljs ::-webkit-scrollbar-thumb,.hljs ::-webkit-scrollbar-track{border-radius:2px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3)}.hljs ::-webkit-scrollbar-thumb{background-color:#789}html{font-family:Source Sans Pro,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:rgba(66,66,66,.05)}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;text-decoration:none}a:active,a:hover,a:link,a:visited{color:#0b1802}.main-body h1,.main-body h2,.main-body h3,.main-body h4,.main-body h5,.main-body h6{margin-top:0;margin-bottom:.5rem}.main-body p{margin-top:0;margin-bottom:1rem;font-size:15px;text-indent:25px;word-wrap:break-word}.main-body img{vertical-align:middle;border-style:none;margin:auto 20px auto auto;padding:3px;border-radius:3px;background-color:#e6e6d5;-webkit-box-shadow:0 1px 2px rgba(0,0,0,.15);box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid #b9baa6}.main-body .text-center{text-align:center!important}.main-body table{border-collapse:collapse!important;width:100%;max-width:100%;margin:1em 0;background-color:transparent}.main-body table tbody+tbody{border-top:2px solid #e9ecef}.main-body table td,.main-body table th{padding:.5rem;font-size:.95em;text-align:center;border-collapse:collapse}.main-body table tr{border:1px solid #dfe8fe}.main-body table tr:nth-child(odd){background-color:#ecf1fe}.main-body table tr:nth-child(2n){background-color:#fdfdfd}.main-body table td{white-space:normal;word-break:break-all}.main-body code,.main-body kbd,.main-body pre,.main-body samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.nav-bar[data-v-42857612]{height:60px;border-bottom:1px solid #d5d5d5}.nav-bar .ico-favicon[data-v-42857612]{height:28px;margin-top:16px;margin-left:108px;cursor:pointer}.nav-bar .ico-home[data-v-42857612]{display:inline-block;margin:16px;float:right}.disPic .pic[data-v-42857612]{background-color:#faa732;height:480px;width:100%}.article-page[data-v-8db87e62]{margin:0 auto;max-width:1108px;background-size:cover}.article-page .page-header[data-v-8db87e62]{border-bottom:1px solid #efefef}.article-page .page-header .ava img[data-v-8db87e62]{border-radius:50%;height:56px;width:56px;float:left;margin:12px}.article-page .page-header .title[data-v-8db87e62]{font-size:48px;color:#0b1802;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'"}.article-page .page-header .author[data-v-8db87e62]{display:inline-block;color:#979996;font-size:16px;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'";margin:12px 7px 12px 0;line-height:16px}.article-page .page-header .author .ico-time img[data-v-8db87e62]{width:16px;height:16px}.article-page .main-body[data-v-8db87e62]{padding:0 108px;margin:28px auto 168px;background:url(/_nuxt/img/post-entry-bg.98216ca.png) no-repeat -10px 9px}.title-home[data-v-552f8598]{font-family:sans-serif;line-height:32px;font-size:24px;color:#0b1802;cursor:pointer}.title-home[data-v-552f8598]:hover{text-shadow:2px 3px 1px #d0d0d0}.title-detail[data-v-552f8598]{font-size:48px;color:#0b1802;font-family:Arial Rounded MT Bold;margin-top:48px;line-height:64px}@media screen and (min-width:550px) and (max-width:950px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}@media screen and (max-width:550px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}.tags[data-v-53a17526]{height:42px;padding-top:10px}.tag[data-v-53a17526]{background-color:#6aacd8;display:inline-block;height:22px;font-size:13px;color:#fefefe;font-family:sans-serif;padding:2px 6px;margin-right:8px;border-radius:2px}</style><body data-n-head=""><div data-server-rendered="true" id="__nuxt"><div class="progress" data-v-862bdd9c style="width:0%;height:2px;background-color:#3b8070;opacity:0"></div><div><section><div data-v-42857612><div class="nav-bar" data-v-42857612><a href="/" data-v-42857612><img src="/_nuxt/img/blog-icon.f80549d.png" class="ico-favicon" data-v-42857612></a><a href="/" data-v-42857612><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABYklEQVRYR+2Vy1HDMBCGV5sG0oLH3EkHkA78CHUAHdABtMCZyHEHdgnmHo8pIQ1kxcgTh+DRY20fAjPWTaOV/s//PizgyktcWR9mgP/rQLRrlkj0qGuIEN/zOPgaU0+jHIh2zQqJCgGw1KIK4ECI6zwOqqEQgwH64p3gWIhBADbxKRBsgFPOm852m9VDnWABaPHFkQoQsOLk+AQR5HFw8MV7AYaKnwUVVMdFW5hOCCfAaPGfovBCWAEmizMhrACJrCsBcOvLIevckQ4jQCLrJwHwynqcGaQAnrM0fOuH/00ATbn5aO7bMYtUMD/SGCYI1/pg+xCUpgBvG6ayVqaLCuATQJ1bTIC4M8XJNHRqjAboP2wDnQFmByY7kMh9aapwThHqTsnS0PkH9XfBdh+BELt+i3EAQKlYbm5y1xzxAnRDiZDawdStLA1fLveJrH/tkbC0DZ/LeyyAKZPQd3cGmB34BjX7xSHXvTXWAAAAAElFTkSuQmCC" class="ico-home" data-v-42857612></a></div><!----></div><div class="article-page" data-v-8db87e62><div class="page-header" data-v-8db87e62><div class="title-detail" data-v-8db87e62 data-v-552f8598>针对巴基斯坦的某APT活动事件分析</div><div class="ava" data-v-8db87e62><img src="/_nuxt/img/Avatar.e419573.jpg" data-v-8db87e62></div><div class="tags" data-v-8db87e62 data-v-53a17526><p class="tag" data-v-53a17526>APT<p class="tag" data-v-53a17526>PAKISTAN</div><div class="author lh32" data-v-8db87e62>admin on</div></div><div class="main-body" data-v-8db87e62><h2 class="line" data-line="0">事件背景</h2><p class="line" data-line="2">2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。<h2 class="line" data-line="4">样本分析</h2><h3 class="line" data-line="6">漏洞利用Dropper</h3><center><table><thead><tr><th><th><tbody><tr><td><strong>Hash</strong><td>4f4cc89905bea999642a40d0590bdfa3<tr><td><strong>文件类型</strong><td>Word文档<tr><td><strong>文件大小</strong><td>66Kb<tr><td><strong>文件名</strong><td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</table></center><p class="line" data-line="17">该文档所利用的漏洞为CVE-2015-2545（关于该漏洞的分析已经有不少详细分析的资料，这里就不再赘述），当受害者点开该文档时，会加载EPS文件从而触发漏洞，这里攻击者使用的漏洞利用代码是已经在野外流传很久的成熟利用，这套利用的特点是通过shellcode注入explorer进程下载木马文件，但shellcode后附加一个DLL文件以利用CVE-2015-2546权限提升漏洞得到系统最高权限。<p class="line" data-line="19">注入explorer.exe的代码如下：<p class="line text-center" data-line="21"><img src="/uploads/2017/07/25/eb9521a61de45d6696701d74995cfc2f.png" alt="" width="90%"><p class="line" data-line="23">explorer.exe中下载载荷的代码如下：可以看到下载地址为http://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe<p class="line text-center" data-line="25"><img src="/uploads/2017/07/25/b659e713974a2508b1eb331696921a64.png" alt="" width="90%"><p class="line" data-line="27">CVE-2015-2546权限提升DLL部分代码：<p class="line text-center" data-line="29"><img src="/uploads/2017/07/25/80a5702267f59cc449a8a99109decec5.png" alt="" width="90%"><h3 class="line" data-line="31">WelcomeScrn.exe</h3><center><table><thead><tr><th><th><tbody><tr><td><strong>Hash</strong><td>feea1d90e77dff5ff9f896122cf768f6<tr><td><strong>文件类型</strong><td>PE可执行文件<tr><td><strong>文件大小</strong><td>124Kb<tr><td><strong>文件名</strong><td>WelcomeScrn.exe</table></center><p class="line" data-line="42">这是个downloader，功能非常简单，直接连接到内置网址http://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，下载并执行文件。<p class="line text-center" data-line="44"><img src="/uploads/2017/07/25/289299000188e3e0f3367813412d3323.png" alt=""><h3 class="line" data-line="46">DefenderReference.exe</h3><center><table><thead><tr><th><th><tbody><tr><td><strong>Hash</strong><td>c43bab60cbf7922a35979e4f41f9aa9e<tr><td><strong>文件类型</strong><td>PE可执行文件<tr><td><strong>文件大小</strong><td>747Kb<tr><td><strong>文件名</strong><td>DefenderReference.exe</table></center><p class="line" data-line="57">DefenderReference.exe通过HTTP协议与服务器通信的窃密木马，被执行起来后，会先完成一些初始化的工作，释放并加载WER167893459067.dll后创建以下目录：<ul><li>%Local%\SharedFiles\Log<li>% Local %\ SharedFiles \Sys<li>% Local %\ SharedFiles \Temp<li>% Local %\ SharedFiles \WinAero<li>% Local %\ SharedFiles \WinDataShots<li>% Local %\ SharedFiles \WinInternetData<li>% Local %\ SharedFiles \WinLog<li>% Local %\ SharedFiles \WinRM</ul><p class="line" data-line="68">然后终止cmd.exe、PATHPING.EXE、TRACERT.EXE、net.exe、systeminfo.exe进程,并判断自身进程启动路径是否为% Local %\ SharedFiles \Sys，如果不是，则将自身拷贝到% Local %\ SharedFiles \Sys\ DefenderReference.exe，释放MSOBuild.exe、AdminNewDll.dll、AdminServerDll.dll等文件，最后启动MSOBuild.exe<p class="line text-center" data-line="70"><img src="/uploads/2017/07/25/67cfd127816a0b08e055a75b5f3749fb.png" alt="" width="90%"><p class="line text-center" data-line="72"><img src="/uploads/2017/07/25/f5fcabe462f04323612f741364ad9ee4.png" alt="" width="90%"><h3 class="line" data-line="74">MSOBuild.exe</h3><center><table><thead><tr><th><th><tbody><tr><td><strong>Hash</strong><td>c5f76015b2cb15f59070d2e5cfdd8f6e<tr><td><strong>文件类型</strong><td>PE可执行文件<tr><td><strong>文件大小</strong><td>147Kb<tr><td><strong>文件名</strong><td>MSOBuild.exe</table></center><p class="line" data-line="85">这个文件其实还是个downloader，在初始化和检查执行环境（虚拟机、沙箱、调试）后，访问http://docs.google.com/uc?id=0Bx9cf6a5Mapaa3g4MlI4T244SlU&export=download,获取C&C的地址185.109.144.102<p class="line" data-line="87">接着下载以下配置文件：<ul><li>hxxp://185[.]109.144.102/DistBuild/getAllFiles.php(指明需要下载的组件)<li>http://185[.]109.144.102/DistBuild/getExecutables.php (指明要执行的组件)<li>http://185[.]109.144.102/DistBuild/getExtensions_doc.php (指明关心的文档类型文件后缀名)<li>http://185[.]109.144.102/DistBuild/ getExtensions_nondoc.php (指明关心的非文档文件类型)<li>http://185[.]109.144.102/DistBuild/getExtensions_rmdrive.php (指明要执行的组件)</ul><p class="line text-center" data-line="95"><img src="/uploads/2017/07/25/a7cadc72c9ec9521e5aed7c0499ff14f.png" alt="" width="90%"><p class="line" data-line="97">接着下载配置文件中指定的组件，再一一启动这些组件：<p class="line text-center" data-line="99"><img src="/uploads/2017/07/25/57cc6ae8567dd473da18554bd80e7f87.png" alt="" width="90%"><p class="line" data-line="101">下表是木马的各个组件信息：</p><center><table><thead><tr><th><strong>文件名</strong><th><strong>备注</strong><tbody><tr><td>DefenderReference.exe<td>Dropper<tr><td>MSOBuild.exe<td>通过调用AdminServerDll.dll下载其他组件<tr><td>AdminServerDll.dll<td>功能模块，每个导出函数对应一种功能<tr><td>AdminNewDll.dll<td>检测到虚拟机\沙箱时加载的无效dll<tr><td>PackageMSOffce.exe<td>上传文档类型文件<tr><td>PlayMedia.exe<td>上传非文档类型文件<tr><td>TimeSyncApp.exe<td>发送受害者信息，等待指令<tr><td>FoldrOpt.exe<td>设置启动项、检查环境、收集计算机信息<tr><td>OptimisedDisply.exe<td>屏幕截图、上传截图<tr><td>LangEngUTF16.exe<td>上传键盘记录<tr><td>LangEngUTF8.exe<td>键盘记录<tr><td>InstntAccelx.exe<td>检测U盘，自拷贝进行传播<tr><td>InstntAccelx.exe<td>检测U盘，上传U盘内的文件</table></center><p class="line" data-line="121">经过以上分析，我们发现这个木马家族有以下功能：上传/下载文件、执行指定文件、键盘记录、屏幕截图、感染U盘、发送感染电脑位置信息等，窃取的文件列表如下：<ul><li>.doc<li>.docx<li>.ppt<li>.pps<li>.pptx<li>.ppsx<li>.xls<li>.xlsx<li>.pdf<li>.inp<li>.vcf<li>.txt<li>.jpg<li>.jpeg<li>.bmp<li>.gif<li>.png<li>.avi<li>.wmv<li>.mp4<li>.mpg<li>.mpeg<li>.3gp<li>.mp3<li>.wav</ul><p class="line" data-line="149">并且该木马可以通过在线获取新插件的形式迅速方便地扩展更多的功能。木马的代码清晰、结构严谨，受控端通过HTTP请求与控制服务器通信，访问不同的php页面代表执行不同的功能，可能是高度定制的专用木马，或者是专门出售的商业间谍木马。<p class="line" data-line="151">下面介绍该木马比较有特色的地方：<ol><li>不同的组件都通过调用同一个AdminServerDll.dll来完成具体功能，高度模块化。例如MSOBuild.exe和DefenderReference.exe中，分别获取AdminServerDll.dll的不同导出函数，然后调用这些导出函数，程序里只有基本的逻辑而没有具体的功能实现，下面左边是MSOBuild.exe,右边是DefenderReference.exe</ol><p class="line text-center" data-line="155"><img src="/uploads/2017/07/25/95424d612fcb7769b0291f79a5969a56.png" alt="" width="90%"><p class="line text-center" data-line="157"><img src="/uploads/2017/07/25/cf66e0663f24d7def1df2cdca3b1a9a0.png" alt="" width="90%"><p class="line" data-line="159">其中AdminServerDll.dll是主要的功能模块，其每一个导出函数对应一个功能，可以从导出函数名知道其功能，如下：</p><center><table><thead><tr><th><strong>导出函数</strong><th><strong>备注</strong><tbody><tr><td>EHCheckDownloadedFilesInDownloadFolderAreCompleteForModuleFile<td>检查组件是否完整<tr><td>EHCheckFolderRecursive<td>遍历文件目录<tr><td>EHCopyDirectory<td>拷贝目录<tr><td>EHCountFilesInFolder<td>遍历目录下面文件数<tr><td>EHCreateCompleteDirectoryStructure<td>创建前面提到的Log、Sys等全部目录<tr><td>EHCreateDirectoryStructureFolderPath<td>创建前面提到的Log、Sys中的指定目录<tr><td>EHCreateFileListForFolder<td>获取目录文件列表<tr><td>EHCreateFolderHerarchyOnServer<td>在服务端创建对应主机的目录<tr><td>EHCreateFolderHerarchyOnServerNeo<td>在服务端创建对应主机的目录<tr><td>EHCreateFolderOnServerWithName<td><tr><td>EHCreateFolderOnServerWithNameNeo<td><tr><td>EHDeleteDirectory<td>EHDeleteFilesInFolder<tr><td>EHDeleteListerUploaderFileOnServer<td><tr><td>EHDownLoadListerUploaderFileFromServer<td><tr><td>EHDownloadClientMachineGeoLocation<td><tr><td>EHDownloadDownloadFilesInDownloadFolderForModuleFile<td>下载新模块<tr><td>EHExecuteDwonloadFilesInDownloadFolderForModuleFile<td><tr><td>EHExecuteFile<td>执行指定文件<tr><td>EHExecuteFile_Parameters_With_Wait_To_Close<td><tr><td>EHExtractBinResource<td><tr><td>EHExtractBufferFromFile<td>读取指定文件的内容<tr><td>EHGetAeroModuleExeState<td><tr><td>EHGetDirectoryStructureFolderPath<td><tr><td>EHGetFileNameFromFilePath<td><tr><td>EHGetFilePathFromFilePath<td><tr><td>EHGetLastWriteTime<td><tr><td>EHGetListerUploaderExeState<td><tr><td>EHGetListerUploaderStateFromServer<td><tr><td>EHGetModuleFilePath<td><tr><td>EHGetOnlineModuleFile<td><tr><td>EHGetThisFinalRealeaseORNot<td><tr><td>EHGetWinExePath<td><tr><td>EHIsAeroFilesNeededServerState<td><tr><td>EHIsDots<td><tr><td>EHIsInternetDataFilesNeededSeverState<td><tr><td>EHMyFileSeek<td><tr><td>EHPathFileExists<td><tr><td>EHPerformMainAllFunctionsOfApplication<td><tr><td>EHPerformOnLineModuleFunctions<td><tr><td>EHPutLogMessage<td><tr><td>EHScreenShotGrabberCreateAndGetNewScrnShotFolderNeo<td>上传屏幕截图<tr><td>EHScreenShotGrabberGetConfigDataNeo<td><tr><td>EHSetAeroFilesServerStateFalse<td><tr><td>EHSetAeroModuleExeState<td><tr><td>EHSetInternetDataFilesServerStateFalse<td><tr><td>EHSetListerUploaderExeState<td><tr><td>EHSetLogFilePath<td><tr><td>EHSetValueForEHApplicationServer<td><tr><td>EHSetValueForEHApplicationServerNeo<td><tr><td>EHTerminateThisProcess<td><tr><td>EHUploadFileKeyLogArchiveNeo<td>上传键盘记录<tr><td>EHUploadFileMainUpload<td>上传文件<tr><td>EHUploadFileRemoveableDrive<td><tr><td>EHUploadFolderRecursive<td><tr><td>EHUploadFolderRecursiveNeo<td></table></center><ol start="2"><li>通信控制：</ol><p class="line" data-line="223">受控端通过HTTP请求与控制服务器通信，通过访问不同的php页面与控制端交互：<p class="line text-center" data-line="225"><img src="/uploads/2017/07/25/be35f96995c2353ac8b23f6798f7262d.png" alt="" width="90%"><p class="line text-center" data-line="227"><img src="/uploads/2017/07/25/11104c88181d21537583d5b3a4131c87.png" alt="" width="90%"><p class="line" data-line="229">经过整理后的路径如下：<ul><li>/EHGetScrnShotConfig.php<li>/getAllFiles.php<li>/getExecutables.php<li>/getExtensions_doc.php<li>/getExtensions_nondoc.php<li>/getExtensions_rmdrive.php<li>/EHCreateUploadFolder.php<li>/EHOnlineModuleOperations.php<li>/EHListerFunction.php<li>/EHAeroFunction.php<li>/EHAeroFunctionFalse.php<li>/EHDeleteListerFile.php<li>/EHFolderWithName.php<li>/EHDelFolderWithName.php<li>/EHInternetDataFiles.php<li>/EHInternetDataFilesFalse.php<li>/EHCreateAndGetScrnShotFolder.php<li>/EHMainUpload.php<li>/EHMergeAndMoveMainUpload.php<li>/EHRemoveableDriveUpload.php<li>/EHMergeAndMoveRemoveableDrive.php<li>/EHFileFolderUpload.php<li>/EHMergeAndMoveFileFolder.php<li>/EHUploadKeylogArchive.php<li>/DO_NOT_NEED_A_URI</ul><ol start="3"><li>检查VM、沙箱和调试</ol><p class="line" data-line="260">通过特权指令检查Virtual PC和VMWare：<p class="line text-center" data-line="262"><img src="/uploads/2017/07/25/e88dbcd4397243b4c906fd7cc81112fa.png" alt=""><img src="/uploads/2017/07/25/e781dc98e41e276d67641c5366295297.png" alt=""><p class="line" data-line="264">通过dll来识别Sandboxie和是否调试：<p class="line text-center" data-line="266"><img src="/uploads/2017/07/25/f23cdac98d216499b5359c50fba73440.png" alt="" width="90%"><h2 class="line" data-line="268">扩展与关联分析</h2><p class="line" data-line="270">使用<a href="http://ti.360.com">360威胁情报中心的威胁情报平台</a>对样本连接的C&C地址（185.109.144.102）做进一步关联，我们发现了更多的信息。<p class="line text-center" data-line="272"><img src="/uploads/2017/07/25/959432cad2c5d6d40d259d62dc7d703e.png" alt="" width="90%"><p class="line" data-line="274">其中有几个样本引起了我们的注意：<ol><li>MD5：a6c7d68c6593b9dd2e9b42f08942a8b0，文件名：isi_report_of_2016.rar</ol><p class="line" data-line="278">这个样本是一个邮件附件，解压后为Name of Facilitators revealed.scr，这个其实是一个sfx自解压文件，点击后会将explorerss.pub改名为explorerss.exe，注册启动项并执行，然后打开Pakistan army officers cover blown.pdf迷惑受害人。<p class="line text-center" data-line="280"><img src="/uploads/2017/07/25/983b177cf4eedac5772b63213ab843b5.png" alt="" width="90%"><p class="line text-center" data-line="282"><img src="/uploads/2017/07/25/c61fb927553f2aec1f0c137547934645.png" alt="" width="90%"><p class="line" data-line="284">而explorerss.exe是由python打包成exe的，功能是窃取指定文件内容并上传到hxxps:// 185[.]109[.]144[.]102/browse.php?folder=%s&%s中。将其中的python代码还原后，部分代码如下：<p class="line text-center" data-line="286"><img src="/uploads/2017/07/25/fa19545206958eab8471323406fb797b.png" alt="" width="90%"><ol start="2"><li>MD5：872e7043ee8490db6e455942642c2c86 文件名：Current vacancies.doc</ol><p class="line" data-line="290">这个样本利用CVE-2012-0158释放一个downloader，downloader会下载执行hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，之后的流程就和前面分析的一样，就不再多说了，值得注意的是文档的内容。显示为联合国招聘文件，这明显是对安全相关人员投递的邮件，有明显的政治动机：<p class="line text-center" data-line="292"><img src="/uploads/2017/07/25/67d581ac06304a980c4b44ce451ef6ac.png" alt="cid:image001.png@01D2E5D2.5FAAFD20" width="90%"><ol><li>MD5: 1b41454bc0ff4ee428c0b49e614ef56c文件名：Ramadan Mubaraq.rtf</ol><p class="line" data-line="296">这个样本所利用的漏洞为CVE-2017-0199，olelink的地址为http://138[.]197[.]129[.]94/logo.doc<p class="line text-center" data-line="298"><img src="/uploads/2017/07/25/44203dd80cb70f50f8040855f2d8bab2.png" alt="" width="90%"><p class="line" data-line="300">从以上的分析和其他关联到的样本中，我们注意到一些有趣的事情：这些样本应该都是通过邮件附件的形式传递的，并且使用Office Nday漏洞或者社工手段引诱目标点开；从文件名、文档内容来看，都是对政治领域的相关人员进行的钓鱼邮件投递。综合多个样本的来源信息，这很有可能是一起针对巴基斯坦政府人员的定向攻击事件。<h2 class="line" data-line="302">IOC</h2><table><thead><tr><th><strong>文件名</strong><tbody><tr><td>Current vacancies.doc<tr><td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc<tr><td>Name of Facilitators revealed.scr<tr><td>isi_report_of_2016.rar<tr><td>Pakistan army officers cover blown.pdf<tr><td>Ramadan Mubaraq.rtf</table><table><thead><tr><th><strong>MD5</strong><tbody><tr><td>154ee0c3bb8250cae00d5ed0e6f894b4<tr><td>4f4cc89905bea999642a40d0590bdfa3<tr><td>6d7ef5c67604d62e63aa06c4a7832dac<tr><td>842e125beca97c185b33235e54e77d3a<tr><td>9cddfd8fa9dc98149e63f08f02a179cf<tr><td>c2be017b2fb3ad6f0f1c05ef10573b90<tr><td>c43bab60cbf7922a35979e4f41f9aa9e<tr><td>c5f76015b2cb15f59070d2e5cfdd8f6e<tr><td>cbd2340e37b2ae9fc85908affbb786a7<tr><td>d0dd1c70581606aa2a4926c5df4a32ee<tr><td>1b41454bc0ff4ee428c0b49e614ef56c</table><table><thead><tr><th><strong>PDB</strong><tbody><tr><td>E:\EHDevelopmentSolution3\EHDevelopmentSolution3\Release\DefenderReference.pdb<tr><td>D:\EH_DEVELOPMENT_SVN\EHDevelopmentSolution3\EHDevelopmentSolution3\Release\EsstnalUpdte.pdb<tr><td>D:\EH_DEVELOPMENT_SVN\EHDevelopmentSolution3\EHDevelopmentSolution3\Release\ProcNeo.pdb<tr><td>E:\EHDevelopmentSolution3\EHDevelopmentSolution3\Release\AdminNewDll.pdb<tr><td>E:\EHDevelopmentSolution3\EHDevelopmentSolution3\Release\AdminServerDll.pdb<tr><td>E:\EHDevelopmentSolution3\EHDevelopmentSolution3\Release\MSOBuild.pdb<tr><td>C:\Users\Fire\Documents\Visual Studio 2015\Projects\newfiles sent\newfiles\obj\Release\Pro-Gaurd.pdb<tr><td>E:\EHDevelopmentSolution3\EHDevelopmentSolution3\Release\WelcomeScrn.pdb</table><table><thead><tr><th><strong>C&C</strong><th><tbody><tr><td>185.109.144.102:80<td>hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe<tr><td><td>hxxp://185[.]109[.]144[.]102/DO_NOT_NEED_A_URI<tr><td>185.109.144.102:443<td>Tcp<tr><td>tes.sessions4life.pw<td>hxxp://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe<tr><td>138.197.129.94:80<td>hxxp://138[.]197[.]129[.]94/logo.doc</table><table><thead><tr><th><strong>Mutex</strong><tbody><tr><td>EHWinHTTPWebServiceCall_MUTEX<tr><td>EHGetListerUploaderExeStateNeo_MUTEX</table></div></div></section></div></div><script type="text/javascript">window.__NUXT__={layout:"default",data:[{articleData:{_id:"597733a71c670a09e493ee3d",title:"针对巴基斯坦的某APT活动事件分析",author:"admin",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。</p>\n<h2 class="line" data-line="4">样本分析</h2>\n<h3 class="line" data-line="6">漏洞利用Dropper</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>4f4cc89905bea999642a40d0590bdfa3</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>66Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="17">该文档所利用的漏洞为CVE-2015-2545（关于该漏洞的分析已经有不少详细分析的资料，这里就不再赘述），当受害者点开该文档时，会加载EPS文件从而触发漏洞，这里攻击者使用的漏洞利用代码是已经在野外流传很久的成熟利用，这套利用的特点是通过shellcode注入explorer进程下载木马文件，但shellcode后附加一个DLL文件以利用CVE-2015-2546权限提升漏洞得到系统最高权限。</p>\n<p class="line" data-line="19">注入explorer.exe的代码如下：</p>\n<p class="text-center line" data-line="21"><img src="/uploads/2017/07/25/eb9521a61de45d6696701d74995cfc2f.png" alt="" width="90%"></p>\n<p class="line" data-line="23">explorer.exe中下载载荷的代码如下：可以看到下载地址为http://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe</p>\n<p class="text-center line" data-line="25"><img src="/uploads/2017/07/25/b659e713974a2508b1eb331696921a64.png" alt="" width="90%"></p>\n<p class="line" data-line="27">CVE-2015-2546权限提升DLL部分代码：</p>\n<p class="text-center line" data-line="29"><img src="/uploads/2017/07/25/80a5702267f59cc449a8a99109decec5.png" alt="" width="90%"></p>\n<h3 class="line" data-line="31">WelcomeScrn.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>feea1d90e77dff5ff9f896122cf768f6</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>124Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>WelcomeScrn.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="42">这是个downloader，功能非常简单，直接连接到内置网址http://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，下载并执行文件。</p>\n<p class="text-center line" data-line="44"><img src="/uploads/2017/07/25/289299000188e3e0f3367813412d3323.png" alt=""></p>\n<h3 class="line" data-line="46">DefenderReference.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>c43bab60cbf7922a35979e4f41f9aa9e</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>747Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>DefenderReference.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="57">DefenderReference.exe通过HTTP协议与服务器通信的窃密木马，被执行起来后，会先完成一些初始化的工作，释放并加载WER167893459067.dll后创建以下目录：</p>\n<ul>\n<li>%Local%\\SharedFiles\\Log</li>\n<li>% Local %\\ SharedFiles \\Sys</li>\n<li>% Local %\\ SharedFiles \\Temp</li>\n<li>% Local %\\ SharedFiles \\WinAero</li>\n<li>% Local %\\ SharedFiles \\WinDataShots</li>\n<li>% Local %\\ SharedFiles \\WinInternetData</li>\n<li>% Local %\\ SharedFiles \\WinLog</li>\n<li>% Local %\\ SharedFiles \\WinRM</li>\n</ul>\n<p class="line" data-line="68">然后终止cmd.exe、PATHPING.EXE、TRACERT.EXE、net.exe、systeminfo.exe进程,并判断自身进程启动路径是否为% Local %\\ SharedFiles \\Sys，如果不是，则将自身拷贝到% Local %\\ SharedFiles \\Sys\\ DefenderReference.exe，释放MSOBuild.exe、AdminNewDll.dll、AdminServerDll.dll等文件，最后启动MSOBuild.exe</p>\n<p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/67cfd127816a0b08e055a75b5f3749fb.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="72"><img src="/uploads/2017/07/25/f5fcabe462f04323612f741364ad9ee4.png" alt="" width="90%"></p>\n<h3 class="line" data-line="74">MSOBuild.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>c5f76015b2cb15f59070d2e5cfdd8f6e</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>147Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>MSOBuild.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="85">这个文件其实还是个downloader，在初始化和检查执行环境（虚拟机、沙箱、调试）后，访问http://docs.google.com/uc?id=0Bx9cf6a5Mapaa3g4MlI4T244SlU&amp;export=download,获取C&amp;C的地址185.109.144.102</p>\n<p class="line" data-line="87">接着下载以下配置文件：</p>\n<ul>\n<li>hxxp://185[.]109.144.102/DistBuild/getAllFiles.php(指明需要下载的组件)</li>\n<li>http://185[.]109.144.102/DistBuild/getExecutables.php (指明要执行的组件)</li>\n<li>http://185[.]109.144.102/DistBuild/getExtensions_doc.php (指明关心的文档类型文件后缀名)</li>\n<li>http://185[.]109.144.102/DistBuild/ getExtensions_nondoc.php (指明关心的非文档文件类型)</li>\n<li>http://185[.]109.144.102/DistBuild/getExtensions_rmdrive.php (指明要执行的组件)</li>\n</ul>\n<p class="text-center line" data-line="95"><img src="/uploads/2017/07/25/a7cadc72c9ec9521e5aed7c0499ff14f.png" alt="" width="90%"></p>\n<p class="line" data-line="97">接着下载配置文件中指定的组件，再一一启动这些组件：</p>\n<p class="text-center line" data-line="99"><img src="/uploads/2017/07/25/57cc6ae8567dd473da18554bd80e7f87.png" alt="" width="90%"></p>\n<p class="line" data-line="101">下表是木马的各个组件信息：</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefenderReference.exe</td>\n<td>Dropper</td>\n</tr>\n<tr>\n<td>MSOBuild.exe</td>\n<td>通过调用AdminServerDll.dll下载其他组件</td>\n</tr>\n<tr>\n<td>AdminServerDll.dll</td>\n<td>功能模块，每个导出函数对应一种功能</td>\n</tr>\n<tr>\n<td>AdminNewDll.dll</td>\n<td>检测到虚拟机\\沙箱时加载的无效dll</td>\n</tr>\n<tr>\n<td>PackageMSOffce.exe</td>\n<td>上传文档类型文件</td>\n</tr>\n<tr>\n<td>PlayMedia.exe</td>\n<td>上传非文档类型文件</td>\n</tr>\n<tr>\n<td>TimeSyncApp.exe</td>\n<td>发送受害者信息，等待指令</td>\n</tr>\n<tr>\n<td>FoldrOpt.exe</td>\n<td>设置启动项、检查环境、收集计算机信息</td>\n</tr>\n<tr>\n<td>OptimisedDisply.exe</td>\n<td>屏幕截图、上传截图</td>\n</tr>\n<tr>\n<td>LangEngUTF16.exe</td>\n<td>上传键盘记录</td>\n</tr>\n<tr>\n<td>LangEngUTF8.exe</td>\n<td>键盘记录</td>\n</tr>\n<tr>\n<td>InstntAccelx.exe</td>\n<td>检测U盘，自拷贝进行传播</td>\n</tr>\n<tr>\n<td>InstntAccelx.exe</td>\n<td>检测U盘，上传U盘内的文件</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="121">经过以上分析，我们发现这个木马家族有以下功能：上传/下载文件、执行指定文件、键盘记录、屏幕截图、感染U盘、发送感染电脑位置信息等，窃取的文件列表如下：</p>\n<ul>\n<li>.doc</li>\n<li>.docx</li>\n<li>.ppt</li>\n<li>.pps</li>\n<li>.pptx</li>\n<li>.ppsx</li>\n<li>.xls</li>\n<li>.xlsx</li>\n<li>.pdf</li>\n<li>.inp</li>\n<li>.vcf</li>\n<li>.txt</li>\n<li>.jpg</li>\n<li>.jpeg</li>\n<li>.bmp</li>\n<li>.gif</li>\n<li>.png</li>\n<li>.avi</li>\n<li>.wmv</li>\n<li>.mp4</li>\n<li>.mpg</li>\n<li>.mpeg</li>\n<li>.3gp</li>\n<li>.mp3</li>\n<li>.wav</li>\n</ul>\n<p class="line" data-line="149">并且该木马可以通过在线获取新插件的形式迅速方便地扩展更多的功能。木马的代码清晰、结构严谨，受控端通过HTTP请求与控制服务器通信，访问不同的php页面代表执行不同的功能，可能是高度定制的专用木马，或者是专门出售的商业间谍木马。</p>\n<p class="line" data-line="151">下面介绍该木马比较有特色的地方：</p>\n<ol>\n<li>不同的组件都通过调用同一个AdminServerDll.dll来完成具体功能，高度模块化。例如MSOBuild.exe和DefenderReference.exe中，分别获取AdminServerDll.dll的不同导出函数，然后调用这些导出函数，程序里只有基本的逻辑而没有具体的功能实现，下面左边是MSOBuild.exe,右边是DefenderReference.exe</li>\n</ol>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/25/95424d612fcb7769b0291f79a5969a56.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="157"><img src="/uploads/2017/07/25/cf66e0663f24d7def1df2cdca3b1a9a0.png" alt="" width="90%"></p>\n<p class="line" data-line="159">其中AdminServerDll.dll是主要的功能模块，其每一个导出函数对应一个功能，可以从导出函数名知道其功能，如下：</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>导出函数</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EHCheckDownloadedFilesInDownloadFolderAreCompleteForModuleFile</td>\n<td>检查组件是否完整</td>\n</tr>\n<tr>\n<td>EHCheckFolderRecursive</td>\n<td>遍历文件目录</td>\n</tr>\n<tr>\n<td>EHCopyDirectory</td>\n<td>拷贝目录</td>\n</tr>\n<tr>\n<td>EHCountFilesInFolder</td>\n<td>遍历目录下面文件数</td>\n</tr>\n<tr>\n<td>EHCreateCompleteDirectoryStructure</td>\n<td>创建前面提到的Log、Sys等全部目录</td>\n</tr>\n<tr>\n<td>EHCreateDirectoryStructureFolderPath</td>\n<td>创建前面提到的Log、Sys中的指定目录</td>\n</tr>\n<tr>\n<td>EHCreateFileListForFolder</td>\n<td>获取目录文件列表</td>\n</tr>\n<tr>\n<td>EHCreateFolderHerarchyOnServer</td>\n<td>在服务端创建对应主机的目录</td>\n</tr>\n<tr>\n<td>EHCreateFolderHerarchyOnServerNeo</td>\n<td>在服务端创建对应主机的目录</td>\n</tr>\n<tr>\n<td>EHCreateFolderOnServerWithName</td>\n<td></td>\n</tr>\n<tr>\n<td>EHCreateFolderOnServerWithNameNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDeleteDirectory</td>\n<td>EHDeleteFilesInFolder</td>\n</tr>\n<tr>\n<td>EHDeleteListerUploaderFileOnServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownLoadListerUploaderFileFromServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownloadClientMachineGeoLocation</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownloadDownloadFilesInDownloadFolderForModuleFile</td>\n<td>下载新模块</td>\n</tr>\n<tr>\n<td>EHExecuteDwonloadFilesInDownloadFolderForModuleFile</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExecuteFile</td>\n<td>执行指定文件</td>\n</tr>\n<tr>\n<td>EHExecuteFile_Parameters_With_Wait_To_Close</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExtractBinResource</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExtractBufferFromFile</td>\n<td>读取指定文件的内容</td>\n</tr>\n<tr>\n<td>EHGetAeroModuleExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetDirectoryStructureFolderPath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetFileNameFromFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetFilePathFromFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetLastWriteTime</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetListerUploaderExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetListerUploaderStateFromServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetModuleFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetOnlineModuleFile</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetThisFinalRealeaseORNot</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetWinExePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsAeroFilesNeededServerState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsDots</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsInternetDataFilesNeededSeverState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHMyFileSeek</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPathFileExists</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPerformMainAllFunctionsOfApplication</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPerformOnLineModuleFunctions</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPutLogMessage</td>\n<td></td>\n</tr>\n<tr>\n<td>EHScreenShotGrabberCreateAndGetNewScrnShotFolderNeo</td>\n<td style="\'color:red\'">上传屏幕截图</td>\n</tr>\n<tr>\n<td>EHScreenShotGrabberGetConfigDataNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetAeroFilesServerStateFalse</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetAeroModuleExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetInternetDataFilesServerStateFalse</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetListerUploaderExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetLogFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetValueForEHApplicationServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetValueForEHApplicationServerNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHTerminateThisProcess</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFileKeyLogArchiveNeo</td>\n<td>上传键盘记录</td>\n</tr>\n<tr>\n<td>EHUploadFileMainUpload</td>\n<td>上传文件</td>\n</tr>\n<tr>\n<td>EHUploadFileRemoveableDrive</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFolderRecursive</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFolderRecursiveNeo</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</center>\n<ol start="2">\n<li>通信控制：</li>\n</ol>\n<p class="line" data-line="223">受控端通过HTTP请求与控制服务器通信，通过访问不同的php页面与控制端交互：</p>\n<p class="text-center line" data-line="225"><img src="/uploads/2017/07/25/be35f96995c2353ac8b23f6798f7262d.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="227"><img src="/uploads/2017/07/25/11104c88181d21537583d5b3a4131c87.png" alt="" width="90%"></p>\n<p class="line" data-line="229">经过整理后的路径如下：</p>\n<ul>\n<li>/EHGetScrnShotConfig.php</li>\n<li>/getAllFiles.php</li>\n<li>/getExecutables.php</li>\n<li>/getExtensions_doc.php</li>\n<li>/getExtensions_nondoc.php</li>\n<li>/getExtensions_rmdrive.php</li>\n<li>/EHCreateUploadFolder.php</li>\n<li>/EHOnlineModuleOperations.php</li>\n<li>/EHListerFunction.php</li>\n<li>/EHAeroFunction.php</li>\n<li>/EHAeroFunctionFalse.php</li>\n<li>/EHDeleteListerFile.php</li>\n<li>/EHFolderWithName.php</li>\n<li>/EHDelFolderWithName.php</li>\n<li>/EHInternetDataFiles.php</li>\n<li>/EHInternetDataFilesFalse.php</li>\n<li>/EHCreateAndGetScrnShotFolder.php</li>\n<li>/EHMainUpload.php</li>\n<li>/EHMergeAndMoveMainUpload.php</li>\n<li>/EHRemoveableDriveUpload.php</li>\n<li>/EHMergeAndMoveRemoveableDrive.php</li>\n<li>/EHFileFolderUpload.php</li>\n<li>/EHMergeAndMoveFileFolder.php</li>\n<li>/EHUploadKeylogArchive.php</li>\n<li>/DO_NOT_NEED_A_URI</li>\n</ul>\n<ol start="3">\n<li>检查VM、沙箱和调试</li>\n</ol>\n<p class="line" data-line="260">通过特权指令检查Virtual PC和VMWare：</p>\n<p class="text-center line" data-line="262"><img src="/uploads/2017/07/25/e88dbcd4397243b4c906fd7cc81112fa.png" alt=""><img src="/uploads/2017/07/25/e781dc98e41e276d67641c5366295297.png" alt=""></p>\n<p class="line" data-line="264">通过dll来识别Sandboxie和是否调试：</p>\n<p class="text-center line" data-line="266"><img src="/uploads/2017/07/25/f23cdac98d216499b5359c50fba73440.png" alt="" width="90%"></p>\n<h2 class="line" data-line="268">扩展与关联分析</h2>\n<p class="line" data-line="270">使用<a href="http://ti.360.com">360威胁情报中心的威胁情报平台</a>对样本连接的C&amp;C地址（185.109.144.102）做进一步关联，我们发现了更多的信息。</p>\n<p class="text-center line" data-line="272"><img src="/uploads/2017/07/25/959432cad2c5d6d40d259d62dc7d703e.png" alt="" width="90%"></p>\n<p class="line" data-line="274">其中有几个样本引起了我们的注意：</p>\n<ol>\n<li>MD5：a6c7d68c6593b9dd2e9b42f08942a8b0，文件名：isi_report_of_2016.rar</li>\n</ol>\n<p class="line" data-line="278">这个样本是一个邮件附件，解压后为Name of Facilitators revealed.scr，这个其实是一个sfx自解压文件，点击后会将explorerss.pub改名为explorerss.exe，注册启动项并执行，然后打开Pakistan army officers cover blown.pdf迷惑受害人。</p>\n<p class="text-center line" data-line="280"><img src="/uploads/2017/07/25/983b177cf4eedac5772b63213ab843b5.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="282"><img src="/uploads/2017/07/25/c61fb927553f2aec1f0c137547934645.png" alt="" width="90%"></p>\n<p class="line" data-line="284">而explorerss.exe是由python打包成exe的，功能是窃取指定文件内容并上传到hxxps:// 185[.]109[.]144[.]102/browse.php?folder=%s&amp;%s中。将其中的python代码还原后，部分代码如下：</p>\n<p class="text-center line" data-line="286"><img src="/uploads/2017/07/25/fa19545206958eab8471323406fb797b.png" alt="" width="90%"></p>\n<ol start="2">\n<li>MD5：872e7043ee8490db6e455942642c2c86 文件名：Current vacancies.doc</li>\n</ol>\n<p class="line" data-line="290">这个样本利用CVE-2012-0158释放一个downloader，downloader会下载执行hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，之后的流程就和前面分析的一样，就不再多说了，值得注意的是文档的内容。显示为联合国招聘文件，这明显是对安全相关人员投递的邮件，有明显的政治动机：</p>\n<p class="text-center line" data-line="292"><img src="/uploads/2017/07/25/67d581ac06304a980c4b44ce451ef6ac.png" alt="cid:image001.png@01D2E5D2.5FAAFD20" width="90%"></p>\n<ol>\n<li>MD5: 1b41454bc0ff4ee428c0b49e614ef56c文件名：Ramadan Mubaraq.rtf</li>\n</ol>\n<p class="line" data-line="296">这个样本所利用的漏洞为CVE-2017-0199，olelink的地址为http://138[.]197[.]129[.]94/logo.doc</p>\n<p class="text-center line" data-line="298"><img src="/uploads/2017/07/25/44203dd80cb70f50f8040855f2d8bab2.png" alt="" width="90%"></p>\n<p class="line" data-line="300">从以上的分析和其他关联到的样本中，我们注意到一些有趣的事情：这些样本应该都是通过邮件附件的形式传递的，并且使用Office Nday漏洞或者社工手段引诱目标点开；从文件名、文档内容来看，都是对政治领域的相关人员进行的钓鱼邮件投递。综合多个样本的来源信息，这很有可能是一起针对巴基斯坦政府人员的定向攻击事件。</p>\n<h2 class="line" data-line="302">IOC</h2>\n<table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Current vacancies.doc</td>\n</tr>\n<tr>\n<td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</td>\n</tr>\n<tr>\n<td>Name of Facilitators revealed.scr</td>\n</tr>\n<tr>\n<td>isi_report_of_2016.rar</td>\n</tr>\n<tr>\n<td>Pakistan army officers cover blown.pdf</td>\n</tr>\n<tr>\n<td>Ramadan Mubaraq.rtf</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>MD5</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>154ee0c3bb8250cae00d5ed0e6f894b4</td>\n</tr>\n<tr>\n<td>4f4cc89905bea999642a40d0590bdfa3</td>\n</tr>\n<tr>\n<td>6d7ef5c67604d62e63aa06c4a7832dac</td>\n</tr>\n<tr>\n<td>842e125beca97c185b33235e54e77d3a</td>\n</tr>\n<tr>\n<td>9cddfd8fa9dc98149e63f08f02a179cf</td>\n</tr>\n<tr>\n<td>c2be017b2fb3ad6f0f1c05ef10573b90</td>\n</tr>\n<tr>\n<td>c43bab60cbf7922a35979e4f41f9aa9e</td>\n</tr>\n<tr>\n<td>c5f76015b2cb15f59070d2e5cfdd8f6e</td>\n</tr>\n<tr>\n<td>cbd2340e37b2ae9fc85908affbb786a7</td>\n</tr>\n<tr>\n<td>d0dd1c70581606aa2a4926c5df4a32ee</td>\n</tr>\n<tr>\n<td>1b41454bc0ff4ee428c0b49e614ef56c</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>PDB</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\DefenderReference.pdb</td>\n</tr>\n<tr>\n<td>D:\\EH_DEVELOPMENT_SVN\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\EsstnalUpdte.pdb</td>\n</tr>\n<tr>\n<td>D:\\EH_DEVELOPMENT_SVN\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\ProcNeo.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\AdminNewDll.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\AdminServerDll.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\MSOBuild.pdb</td>\n</tr>\n<tr>\n<td>C:\\Users\\Fire\\Documents\\Visual Studio 2015\\Projects\\newfiles sent\\newfiles\\obj\\Release\\Pro-Gaurd.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\WelcomeScrn.pdb</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>C&amp;C</strong></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>185.109.144.102:80</td>\n<td>hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe</td>\n</tr>\n<tr>\n<td></td>\n<td>hxxp://185[.]109[.]144[.]102/DO_NOT_NEED_A_URI</td>\n</tr>\n<tr>\n<td>185.109.144.102:443</td>\n<td>Tcp</td>\n</tr>\n<tr>\n<td>tes.sessions4life.pw</td>\n<td>hxxp://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe</td>\n</tr>\n<tr>\n<td>138.197.129.94:80</td>\n<td>hxxp://138[.]197[.]129[.]94/logo.doc</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>Mutex</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EHWinHTTPWebServiceCall_MUTEX</td>\n</tr>\n<tr>\n<td>EHGetListerUploaderExeStateNeo_MUTEX</td>\n</tr>\n</tbody>\n</table>\n',category:"专题报告",__v:1,abstract:"2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。",modify_time:"2017-08-01T08:24:07.172Z",readableId:"pakistan-targeted-apt-campaign",publish_time:"2016-06-23T18:05:05.000Z",descImg:"/uploads/2017/08/01/e3c37af797ae3d864e14f3e178ef86d5.png",insert_time:"2017-07-25T12:03:51.356Z",isDraft:!1,tags:["APT","Pakistan"]}}],error:null,state:{pageId:[],tagParam:[],isMainPage:!1,pageNum:[1,2],articleData:{_id:"597733a71c670a09e493ee3d",title:"针对巴基斯坦的某APT活动事件分析",author:"admin",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。</p>\n<h2 class="line" data-line="4">样本分析</h2>\n<h3 class="line" data-line="6">漏洞利用Dropper</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>4f4cc89905bea999642a40d0590bdfa3</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>66Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="17">该文档所利用的漏洞为CVE-2015-2545（关于该漏洞的分析已经有不少详细分析的资料，这里就不再赘述），当受害者点开该文档时，会加载EPS文件从而触发漏洞，这里攻击者使用的漏洞利用代码是已经在野外流传很久的成熟利用，这套利用的特点是通过shellcode注入explorer进程下载木马文件，但shellcode后附加一个DLL文件以利用CVE-2015-2546权限提升漏洞得到系统最高权限。</p>\n<p class="line" data-line="19">注入explorer.exe的代码如下：</p>\n<p class="text-center line" data-line="21"><img src="/uploads/2017/07/25/eb9521a61de45d6696701d74995cfc2f.png" alt="" width="90%"></p>\n<p class="line" data-line="23">explorer.exe中下载载荷的代码如下：可以看到下载地址为http://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe</p>\n<p class="text-center line" data-line="25"><img src="/uploads/2017/07/25/b659e713974a2508b1eb331696921a64.png" alt="" width="90%"></p>\n<p class="line" data-line="27">CVE-2015-2546权限提升DLL部分代码：</p>\n<p class="text-center line" data-line="29"><img src="/uploads/2017/07/25/80a5702267f59cc449a8a99109decec5.png" alt="" width="90%"></p>\n<h3 class="line" data-line="31">WelcomeScrn.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>feea1d90e77dff5ff9f896122cf768f6</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>124Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>WelcomeScrn.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="42">这是个downloader，功能非常简单，直接连接到内置网址http://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，下载并执行文件。</p>\n<p class="text-center line" data-line="44"><img src="/uploads/2017/07/25/289299000188e3e0f3367813412d3323.png" alt=""></p>\n<h3 class="line" data-line="46">DefenderReference.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>c43bab60cbf7922a35979e4f41f9aa9e</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>747Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>DefenderReference.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="57">DefenderReference.exe通过HTTP协议与服务器通信的窃密木马，被执行起来后，会先完成一些初始化的工作，释放并加载WER167893459067.dll后创建以下目录：</p>\n<ul>\n<li>%Local%\\SharedFiles\\Log</li>\n<li>% Local %\\ SharedFiles \\Sys</li>\n<li>% Local %\\ SharedFiles \\Temp</li>\n<li>% Local %\\ SharedFiles \\WinAero</li>\n<li>% Local %\\ SharedFiles \\WinDataShots</li>\n<li>% Local %\\ SharedFiles \\WinInternetData</li>\n<li>% Local %\\ SharedFiles \\WinLog</li>\n<li>% Local %\\ SharedFiles \\WinRM</li>\n</ul>\n<p class="line" data-line="68">然后终止cmd.exe、PATHPING.EXE、TRACERT.EXE、net.exe、systeminfo.exe进程,并判断自身进程启动路径是否为% Local %\\ SharedFiles \\Sys，如果不是，则将自身拷贝到% Local %\\ SharedFiles \\Sys\\ DefenderReference.exe，释放MSOBuild.exe、AdminNewDll.dll、AdminServerDll.dll等文件，最后启动MSOBuild.exe</p>\n<p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/67cfd127816a0b08e055a75b5f3749fb.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="72"><img src="/uploads/2017/07/25/f5fcabe462f04323612f741364ad9ee4.png" alt="" width="90%"></p>\n<h3 class="line" data-line="74">MSOBuild.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>c5f76015b2cb15f59070d2e5cfdd8f6e</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>147Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>MSOBuild.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="85">这个文件其实还是个downloader，在初始化和检查执行环境（虚拟机、沙箱、调试）后，访问http://docs.google.com/uc?id=0Bx9cf6a5Mapaa3g4MlI4T244SlU&amp;export=download,获取C&amp;C的地址185.109.144.102</p>\n<p class="line" data-line="87">接着下载以下配置文件：</p>\n<ul>\n<li>hxxp://185[.]109.144.102/DistBuild/getAllFiles.php(指明需要下载的组件)</li>\n<li>http://185[.]109.144.102/DistBuild/getExecutables.php (指明要执行的组件)</li>\n<li>http://185[.]109.144.102/DistBuild/getExtensions_doc.php (指明关心的文档类型文件后缀名)</li>\n<li>http://185[.]109.144.102/DistBuild/ getExtensions_nondoc.php (指明关心的非文档文件类型)</li>\n<li>http://185[.]109.144.102/DistBuild/getExtensions_rmdrive.php (指明要执行的组件)</li>\n</ul>\n<p class="text-center line" data-line="95"><img src="/uploads/2017/07/25/a7cadc72c9ec9521e5aed7c0499ff14f.png" alt="" width="90%"></p>\n<p class="line" data-line="97">接着下载配置文件中指定的组件，再一一启动这些组件：</p>\n<p class="text-center line" data-line="99"><img src="/uploads/2017/07/25/57cc6ae8567dd473da18554bd80e7f87.png" alt="" width="90%"></p>\n<p class="line" data-line="101">下表是木马的各个组件信息：</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefenderReference.exe</td>\n<td>Dropper</td>\n</tr>\n<tr>\n<td>MSOBuild.exe</td>\n<td>通过调用AdminServerDll.dll下载其他组件</td>\n</tr>\n<tr>\n<td>AdminServerDll.dll</td>\n<td>功能模块，每个导出函数对应一种功能</td>\n</tr>\n<tr>\n<td>AdminNewDll.dll</td>\n<td>检测到虚拟机\\沙箱时加载的无效dll</td>\n</tr>\n<tr>\n<td>PackageMSOffce.exe</td>\n<td>上传文档类型文件</td>\n</tr>\n<tr>\n<td>PlayMedia.exe</td>\n<td>上传非文档类型文件</td>\n</tr>\n<tr>\n<td>TimeSyncApp.exe</td>\n<td>发送受害者信息，等待指令</td>\n</tr>\n<tr>\n<td>FoldrOpt.exe</td>\n<td>设置启动项、检查环境、收集计算机信息</td>\n</tr>\n<tr>\n<td>OptimisedDisply.exe</td>\n<td>屏幕截图、上传截图</td>\n</tr>\n<tr>\n<td>LangEngUTF16.exe</td>\n<td>上传键盘记录</td>\n</tr>\n<tr>\n<td>LangEngUTF8.exe</td>\n<td>键盘记录</td>\n</tr>\n<tr>\n<td>InstntAccelx.exe</td>\n<td>检测U盘，自拷贝进行传播</td>\n</tr>\n<tr>\n<td>InstntAccelx.exe</td>\n<td>检测U盘，上传U盘内的文件</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="121">经过以上分析，我们发现这个木马家族有以下功能：上传/下载文件、执行指定文件、键盘记录、屏幕截图、感染U盘、发送感染电脑位置信息等，窃取的文件列表如下：</p>\n<ul>\n<li>.doc</li>\n<li>.docx</li>\n<li>.ppt</li>\n<li>.pps</li>\n<li>.pptx</li>\n<li>.ppsx</li>\n<li>.xls</li>\n<li>.xlsx</li>\n<li>.pdf</li>\n<li>.inp</li>\n<li>.vcf</li>\n<li>.txt</li>\n<li>.jpg</li>\n<li>.jpeg</li>\n<li>.bmp</li>\n<li>.gif</li>\n<li>.png</li>\n<li>.avi</li>\n<li>.wmv</li>\n<li>.mp4</li>\n<li>.mpg</li>\n<li>.mpeg</li>\n<li>.3gp</li>\n<li>.mp3</li>\n<li>.wav</li>\n</ul>\n<p class="line" data-line="149">并且该木马可以通过在线获取新插件的形式迅速方便地扩展更多的功能。木马的代码清晰、结构严谨，受控端通过HTTP请求与控制服务器通信，访问不同的php页面代表执行不同的功能，可能是高度定制的专用木马，或者是专门出售的商业间谍木马。</p>\n<p class="line" data-line="151">下面介绍该木马比较有特色的地方：</p>\n<ol>\n<li>不同的组件都通过调用同一个AdminServerDll.dll来完成具体功能，高度模块化。例如MSOBuild.exe和DefenderReference.exe中，分别获取AdminServerDll.dll的不同导出函数，然后调用这些导出函数，程序里只有基本的逻辑而没有具体的功能实现，下面左边是MSOBuild.exe,右边是DefenderReference.exe</li>\n</ol>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/25/95424d612fcb7769b0291f79a5969a56.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="157"><img src="/uploads/2017/07/25/cf66e0663f24d7def1df2cdca3b1a9a0.png" alt="" width="90%"></p>\n<p class="line" data-line="159">其中AdminServerDll.dll是主要的功能模块，其每一个导出函数对应一个功能，可以从导出函数名知道其功能，如下：</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>导出函数</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EHCheckDownloadedFilesInDownloadFolderAreCompleteForModuleFile</td>\n<td>检查组件是否完整</td>\n</tr>\n<tr>\n<td>EHCheckFolderRecursive</td>\n<td>遍历文件目录</td>\n</tr>\n<tr>\n<td>EHCopyDirectory</td>\n<td>拷贝目录</td>\n</tr>\n<tr>\n<td>EHCountFilesInFolder</td>\n<td>遍历目录下面文件数</td>\n</tr>\n<tr>\n<td>EHCreateCompleteDirectoryStructure</td>\n<td>创建前面提到的Log、Sys等全部目录</td>\n</tr>\n<tr>\n<td>EHCreateDirectoryStructureFolderPath</td>\n<td>创建前面提到的Log、Sys中的指定目录</td>\n</tr>\n<tr>\n<td>EHCreateFileListForFolder</td>\n<td>获取目录文件列表</td>\n</tr>\n<tr>\n<td>EHCreateFolderHerarchyOnServer</td>\n<td>在服务端创建对应主机的目录</td>\n</tr>\n<tr>\n<td>EHCreateFolderHerarchyOnServerNeo</td>\n<td>在服务端创建对应主机的目录</td>\n</tr>\n<tr>\n<td>EHCreateFolderOnServerWithName</td>\n<td></td>\n</tr>\n<tr>\n<td>EHCreateFolderOnServerWithNameNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDeleteDirectory</td>\n<td>EHDeleteFilesInFolder</td>\n</tr>\n<tr>\n<td>EHDeleteListerUploaderFileOnServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownLoadListerUploaderFileFromServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownloadClientMachineGeoLocation</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownloadDownloadFilesInDownloadFolderForModuleFile</td>\n<td>下载新模块</td>\n</tr>\n<tr>\n<td>EHExecuteDwonloadFilesInDownloadFolderForModuleFile</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExecuteFile</td>\n<td>执行指定文件</td>\n</tr>\n<tr>\n<td>EHExecuteFile_Parameters_With_Wait_To_Close</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExtractBinResource</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExtractBufferFromFile</td>\n<td>读取指定文件的内容</td>\n</tr>\n<tr>\n<td>EHGetAeroModuleExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetDirectoryStructureFolderPath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetFileNameFromFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetFilePathFromFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetLastWriteTime</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetListerUploaderExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetListerUploaderStateFromServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetModuleFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetOnlineModuleFile</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetThisFinalRealeaseORNot</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetWinExePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsAeroFilesNeededServerState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsDots</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsInternetDataFilesNeededSeverState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHMyFileSeek</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPathFileExists</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPerformMainAllFunctionsOfApplication</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPerformOnLineModuleFunctions</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPutLogMessage</td>\n<td></td>\n</tr>\n<tr>\n<td>EHScreenShotGrabberCreateAndGetNewScrnShotFolderNeo</td>\n<td style="\'color:red\'">上传屏幕截图</td>\n</tr>\n<tr>\n<td>EHScreenShotGrabberGetConfigDataNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetAeroFilesServerStateFalse</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetAeroModuleExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetInternetDataFilesServerStateFalse</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetListerUploaderExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetLogFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetValueForEHApplicationServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetValueForEHApplicationServerNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHTerminateThisProcess</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFileKeyLogArchiveNeo</td>\n<td>上传键盘记录</td>\n</tr>\n<tr>\n<td>EHUploadFileMainUpload</td>\n<td>上传文件</td>\n</tr>\n<tr>\n<td>EHUploadFileRemoveableDrive</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFolderRecursive</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFolderRecursiveNeo</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</center>\n<ol start="2">\n<li>通信控制：</li>\n</ol>\n<p class="line" data-line="223">受控端通过HTTP请求与控制服务器通信，通过访问不同的php页面与控制端交互：</p>\n<p class="text-center line" data-line="225"><img src="/uploads/2017/07/25/be35f96995c2353ac8b23f6798f7262d.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="227"><img src="/uploads/2017/07/25/11104c88181d21537583d5b3a4131c87.png" alt="" width="90%"></p>\n<p class="line" data-line="229">经过整理后的路径如下：</p>\n<ul>\n<li>/EHGetScrnShotConfig.php</li>\n<li>/getAllFiles.php</li>\n<li>/getExecutables.php</li>\n<li>/getExtensions_doc.php</li>\n<li>/getExtensions_nondoc.php</li>\n<li>/getExtensions_rmdrive.php</li>\n<li>/EHCreateUploadFolder.php</li>\n<li>/EHOnlineModuleOperations.php</li>\n<li>/EHListerFunction.php</li>\n<li>/EHAeroFunction.php</li>\n<li>/EHAeroFunctionFalse.php</li>\n<li>/EHDeleteListerFile.php</li>\n<li>/EHFolderWithName.php</li>\n<li>/EHDelFolderWithName.php</li>\n<li>/EHInternetDataFiles.php</li>\n<li>/EHInternetDataFilesFalse.php</li>\n<li>/EHCreateAndGetScrnShotFolder.php</li>\n<li>/EHMainUpload.php</li>\n<li>/EHMergeAndMoveMainUpload.php</li>\n<li>/EHRemoveableDriveUpload.php</li>\n<li>/EHMergeAndMoveRemoveableDrive.php</li>\n<li>/EHFileFolderUpload.php</li>\n<li>/EHMergeAndMoveFileFolder.php</li>\n<li>/EHUploadKeylogArchive.php</li>\n<li>/DO_NOT_NEED_A_URI</li>\n</ul>\n<ol start="3">\n<li>检查VM、沙箱和调试</li>\n</ol>\n<p class="line" data-line="260">通过特权指令检查Virtual PC和VMWare：</p>\n<p class="text-center line" data-line="262"><img src="/uploads/2017/07/25/e88dbcd4397243b4c906fd7cc81112fa.png" alt=""><img src="/uploads/2017/07/25/e781dc98e41e276d67641c5366295297.png" alt=""></p>\n<p class="line" data-line="264">通过dll来识别Sandboxie和是否调试：</p>\n<p class="text-center line" data-line="266"><img src="/uploads/2017/07/25/f23cdac98d216499b5359c50fba73440.png" alt="" width="90%"></p>\n<h2 class="line" data-line="268">扩展与关联分析</h2>\n<p class="line" data-line="270">使用<a href="http://ti.360.com">360威胁情报中心的威胁情报平台</a>对样本连接的C&amp;C地址（185.109.144.102）做进一步关联，我们发现了更多的信息。</p>\n<p class="text-center line" data-line="272"><img src="/uploads/2017/07/25/959432cad2c5d6d40d259d62dc7d703e.png" alt="" width="90%"></p>\n<p class="line" data-line="274">其中有几个样本引起了我们的注意：</p>\n<ol>\n<li>MD5：a6c7d68c6593b9dd2e9b42f08942a8b0，文件名：isi_report_of_2016.rar</li>\n</ol>\n<p class="line" data-line="278">这个样本是一个邮件附件，解压后为Name of Facilitators revealed.scr，这个其实是一个sfx自解压文件，点击后会将explorerss.pub改名为explorerss.exe，注册启动项并执行，然后打开Pakistan army officers cover blown.pdf迷惑受害人。</p>\n<p class="text-center line" data-line="280"><img src="/uploads/2017/07/25/983b177cf4eedac5772b63213ab843b5.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="282"><img src="/uploads/2017/07/25/c61fb927553f2aec1f0c137547934645.png" alt="" width="90%"></p>\n<p class="line" data-line="284">而explorerss.exe是由python打包成exe的，功能是窃取指定文件内容并上传到hxxps:// 185[.]109[.]144[.]102/browse.php?folder=%s&amp;%s中。将其中的python代码还原后，部分代码如下：</p>\n<p class="text-center line" data-line="286"><img src="/uploads/2017/07/25/fa19545206958eab8471323406fb797b.png" alt="" width="90%"></p>\n<ol start="2">\n<li>MD5：872e7043ee8490db6e455942642c2c86 文件名：Current vacancies.doc</li>\n</ol>\n<p class="line" data-line="290">这个样本利用CVE-2012-0158释放一个downloader，downloader会下载执行hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，之后的流程就和前面分析的一样，就不再多说了，值得注意的是文档的内容。显示为联合国招聘文件，这明显是对安全相关人员投递的邮件，有明显的政治动机：</p>\n<p class="text-center line" data-line="292"><img src="/uploads/2017/07/25/67d581ac06304a980c4b44ce451ef6ac.png" alt="cid:image001.png@01D2E5D2.5FAAFD20" width="90%"></p>\n<ol>\n<li>MD5: 1b41454bc0ff4ee428c0b49e614ef56c文件名：Ramadan Mubaraq.rtf</li>\n</ol>\n<p class="line" data-line="296">这个样本所利用的漏洞为CVE-2017-0199，olelink的地址为http://138[.]197[.]129[.]94/logo.doc</p>\n<p class="text-center line" data-line="298"><img src="/uploads/2017/07/25/44203dd80cb70f50f8040855f2d8bab2.png" alt="" width="90%"></p>\n<p class="line" data-line="300">从以上的分析和其他关联到的样本中，我们注意到一些有趣的事情：这些样本应该都是通过邮件附件的形式传递的，并且使用Office Nday漏洞或者社工手段引诱目标点开；从文件名、文档内容来看，都是对政治领域的相关人员进行的钓鱼邮件投递。综合多个样本的来源信息，这很有可能是一起针对巴基斯坦政府人员的定向攻击事件。</p>\n<h2 class="line" data-line="302">IOC</h2>\n<table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Current vacancies.doc</td>\n</tr>\n<tr>\n<td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</td>\n</tr>\n<tr>\n<td>Name of Facilitators revealed.scr</td>\n</tr>\n<tr>\n<td>isi_report_of_2016.rar</td>\n</tr>\n<tr>\n<td>Pakistan army officers cover blown.pdf</td>\n</tr>\n<tr>\n<td>Ramadan Mubaraq.rtf</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>MD5</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>154ee0c3bb8250cae00d5ed0e6f894b4</td>\n</tr>\n<tr>\n<td>4f4cc89905bea999642a40d0590bdfa3</td>\n</tr>\n<tr>\n<td>6d7ef5c67604d62e63aa06c4a7832dac</td>\n</tr>\n<tr>\n<td>842e125beca97c185b33235e54e77d3a</td>\n</tr>\n<tr>\n<td>9cddfd8fa9dc98149e63f08f02a179cf</td>\n</tr>\n<tr>\n<td>c2be017b2fb3ad6f0f1c05ef10573b90</td>\n</tr>\n<tr>\n<td>c43bab60cbf7922a35979e4f41f9aa9e</td>\n</tr>\n<tr>\n<td>c5f76015b2cb15f59070d2e5cfdd8f6e</td>\n</tr>\n<tr>\n<td>cbd2340e37b2ae9fc85908affbb786a7</td>\n</tr>\n<tr>\n<td>d0dd1c70581606aa2a4926c5df4a32ee</td>\n</tr>\n<tr>\n<td>1b41454bc0ff4ee428c0b49e614ef56c</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>PDB</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\DefenderReference.pdb</td>\n</tr>\n<tr>\n<td>D:\\EH_DEVELOPMENT_SVN\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\EsstnalUpdte.pdb</td>\n</tr>\n<tr>\n<td>D:\\EH_DEVELOPMENT_SVN\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\ProcNeo.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\AdminNewDll.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\AdminServerDll.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\MSOBuild.pdb</td>\n</tr>\n<tr>\n<td>C:\\Users\\Fire\\Documents\\Visual Studio 2015\\Projects\\newfiles sent\\newfiles\\obj\\Release\\Pro-Gaurd.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\WelcomeScrn.pdb</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>C&amp;C</strong></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>185.109.144.102:80</td>\n<td>hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe</td>\n</tr>\n<tr>\n<td></td>\n<td>hxxp://185[.]109[.]144[.]102/DO_NOT_NEED_A_URI</td>\n</tr>\n<tr>\n<td>185.109.144.102:443</td>\n<td>Tcp</td>\n</tr>\n<tr>\n<td>tes.sessions4life.pw</td>\n<td>hxxp://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe</td>\n</tr>\n<tr>\n<td>138.197.129.94:80</td>\n<td>hxxp://138[.]197[.]129[.]94/logo.doc</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>Mutex</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EHWinHTTPWebServiceCall_MUTEX</td>\n</tr>\n<tr>\n<td>EHGetListerUploaderExeStateNeo_MUTEX</td>\n</tr>\n</tbody>\n</table>\n',category:"专题报告",__v:1,abstract:"2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。",modify_time:"2017-08-01T08:24:07.172Z",readableId:"pakistan-targeted-apt-campaign",publish_time:"2016-06-23T18:05:05.000Z",descImg:"/uploads/2017/08/01/e3c37af797ae3d864e14f3e178ef86d5.png",insert_time:"2017-07-25T12:03:51.356Z",isDraft:!1,tags:["APT","Pakistan"]}},serverRendered:!0}</script><script defer src="/_nuxt/manifest.863edfce59f0a00ce608.js"></script><script defer src="/_nuxt/vendor.bundle.21224f443c6ee9ce918d.js"></script><script defer src="/_nuxt/nuxt.bundle.b8b247420f15d35e36d4.js"></script>