<!DOCTYPE html><html data-n-head="" data-n-head-ssr><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1" name="viewport"><meta data-n-head="true" content="Nuxt.js project" name="description" data-hid="description"><title data-n-head="true">360威胁情报中心</title><link href="/fav.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.38f62477280dcc27df9e.js" rel="preload" as="script"><link href="/_nuxt/vendor.bundle.45eca4dc7fa9e1bc4361.js" rel="preload" as="script"><link href="/_nuxt/nuxt.bundle.8e9d53f64bed77ebfe81.js" rel="preload" as="script"><link href="/_nuxt/0.nuxt.bundle.2f45ca512d92831b456d.js" rel="prefetch"><link href="/_nuxt/1.nuxt.bundle.ddf9ea85dc483e3df228.js" rel="prefetch"><link href="/_nuxt/2.nuxt.bundle.ae682d6568221e03d161.js" rel="prefetch"><link href="/_nuxt/3.nuxt.bundle.55fb549cb8ff45291a32.js" rel="prefetch"><link href="/_nuxt/4.nuxt.bundle.34c699b301359d6a3c4d.js" rel="prefetch"><link href="/_nuxt/5.nuxt.bundle.1375829ca49ba88d696d.js" rel="prefetch"><style data-vue-ssr-id="1cbf7f39:0 198c0e1e:0 034fd8e0:0 ba3a09e0:0 c2ba7178:0 01cb4693:0 69b5e360:0">.progress[data-v-862bdd9c]{position:fixed;top:0;left:0;right:0;height:2px;width:0;-webkit-transition:width .2s,opacity .4s;-o-transition:width .2s,opacity .4s;transition:width .2s,opacity .4s;opacity:1;background-color:#efc14e;z-index:999999}.hljs ::-webkit-scrollbar{width:8px;height:10px;border-radius:2px;background-color:#839496}.hljs ::-webkit-scrollbar-track{background-color:#bebebe}.hljs ::-webkit-scrollbar-thumb,.hljs ::-webkit-scrollbar-track{border-radius:2px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3)}.hljs ::-webkit-scrollbar-thumb{background-color:#789}html{font-family:Source Sans Pro,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:rgba(66,66,66,.05)}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;text-decoration:none}li{list-style-type:none}a:active,a:hover,a:link,a:visited{color:#0b1802}.main-body h1,.main-body h2,.main-body h3,.main-body h4,.main-body h5,.main-body h6{margin-top:0;margin-bottom:.5rem}.main-body p{margin-top:0;margin-bottom:1rem;font-size:15px;text-indent:25px;word-wrap:break-word}.main-body img{vertical-align:middle;border-style:none;margin:auto 20px auto auto;padding:3px;border-radius:3px;background-color:#e6e6d5;-webkit-box-shadow:0 1px 2px rgba(0,0,0,.15);box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid #b9baa6}.main-body .text-center{text-align:center!important}.main-body table{border-collapse:collapse!important;width:100%;max-width:100%;margin:1em 0;background-color:transparent}.main-body table tbody+tbody{border-top:2px solid #e9ecef}.main-body table td,.main-body table th{padding:.5rem;font-size:.95em;border-collapse:collapse}.main-body table tr{border:1px solid #dfe8fe}.main-body table tr:nth-child(odd){background-color:#ecf1fe}.main-body table tr:nth-child(2n){background-color:#fdfdfd}.main-body table td{white-space:normal;word-break:break-all}.main-body code,.main-body kbd,.main-body pre,.main-body samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.nav-bar[data-v-42857612]{height:60px;border-bottom:1px solid #d5d5d5}.nav-bar .ico-favicon[data-v-42857612]{height:28px;margin-top:16px;margin-left:108px;cursor:pointer}.nav-bar .ico-home[data-v-42857612]{width:32px;height:32px;display:inline-block;margin:16px 32px;float:right;cursor:pointer;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACU0lEQVRYR+2XzZHaQBCFX48cAM4AStxNBmYzACSfDREYIjAbAcoA9mwkcARmM1jfocAZbADWPNfIDAtaCUmUXdhV6Cjm5+vX3Y+W4MqPXPl+XAzQWWxrSuvPJgCt1P2y23i+JJiLADqLbcuJ9RSCVnIp8RQ7arDsNp6qQlQG6IXrPiATIYTCoblQKAEFBDiKvOasCkRpgL3kEwH6BL5rpfo2YqOI0nomwDsCM63UqGxKSgGcSE4+xI4zTF9gAJ04DiDysUpKCgHSkhdJbNZXSUkuQJ7k+0inFHmMPDfIync6JZHnDvLqIhOgs9jWnVgvkio/kvxwMDkO/ebyXLFlpKS77DZ26T2vALz5ukORqQA1ggMreS/cmIrva6U6WQflwZh9AkwIPAs5SIOfAHjzTQDBJ3tY6LliJQfkR+i7SdtVfXrhZixAYloEgshzR/aMA0AvXK8E8h7kV4rUTUsZALMZ4K6o+M5BWQDTvuZckKvQb94lHmI3mugp2JnCsjAWQGm1mn9orKpGbtdbANHqTivdEqJu1cwswr8JkA7kBlCogOmCsr5+phWTLjA18P+lwP+ybf98g501nxdfQC0r4thxzD/hyVxw3AWVFUhfYp0ttyXJh9Bv9o9//9MAufn0wg0JPkZes30DuCnwTyoQK/U2bWqZTniYC8hueoA411L5XbBeCaUV+u4r78gEMOZDpb/Zjw6Ah6+e/axQN5Pv8ftkrUh7P/kcjIgird/TFe4jzx0XjmR2QQIh8ZCS7XhlZwMhDPwsb4YsHMvLXnTpuqsD/AKIkSQ/Gqk/IAAAAABJRU5ErkJggg==) no-repeat}.nav-bar .ico-home[data-v-42857612]:hover{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACRElEQVRYR+2XT5LSQBTGvy9B13gDbmBuIJSJ65kTGKqEciecQOYEsJxKrII5gboVLJgbzNwAb8Aah7ypjmnMNPlLaaFV9DLV3e/3vvcnr4kTL57YPo4G8JfSfP6Aj8qBbQNXsw43xzhzFEDvmzggpiQcZVQEdxB0wze8qwtRG6D3XXwIxhRQLAyUQUaYCCEghuFrzupAVAZQkj/bYUzAB3AvEXztsVKEFpThlwLMftoYVg1JJQBD8putjYFpIM6JHSYA3tYJSSmAKXmZxGp/nZDkAuRJnng6heA28Kg8PlhmSEKX3by8yAR4v5TW7gGfkyzfS566eBS4/FKUbGZI7AYurztcm2cOAPoLuRBgSqApRFdL3p/LAIRv2bjIuigPJjk3FmBDoGuCPwHoLWRC4IO+LHBJLbkAP0KXcdnVXf25jMBfTQuCSeBxqO/YA/TmsiLxSgRfSbRUSSkAdVgsrMuSrwgqBXCflOoqdNmJe4g+GHsvWKvE0jAaIAJWnzyu6nqu92uASNCxAEeIllYzMwn/JoDpyBmgVAFVBVX7ekEpxlWgcuD/C8G7ubQbDax180n1hWamxxGG5lyQroLaCphGdGcrKMmbwKX6Ze/XnwbIjWd/ISKC29Bj+wxwVuCfVGBr44XZ1LI74e+54NIcIIpKKq8K4p8b4AQeD3pHJoBqPhaxjOcH9egg9q8eIp4VWub35N/eVpMPgPQDxVHTFQRXgcdR6UimNygIIn54ZHe86sPBhsQsb4YsHcur2zlu58kBHgGcWwk/vbbC3wAAAABJRU5ErkJggg==) no-repeat}.disPic .pic[data-v-42857612]{background-color:#faa732;height:480px;width:100%}.article-page[data-v-8db87e62]{margin:0 auto;max-width:1108px;background-size:cover}.article-page .page-header[data-v-8db87e62]{border-bottom:1px solid #efefef}.article-page .page-header .ava img[data-v-8db87e62]{border-radius:50%;height:56px;width:56px;float:left;margin:12px}.article-page .page-header .title[data-v-8db87e62]{font-size:48px;color:#0b1802;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'"}.article-page .page-header .author[data-v-8db87e62]{display:inline-block;color:#979996;font-size:16px;font-family:"Verdana, \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, Geneva, 'sans-serif'";margin:12px 7px 12px 0;line-height:16px}.article-page .page-header .author .ico-time img[data-v-8db87e62]{width:16px;height:16px}.article-page .main-body[data-v-8db87e62]{padding:0 108px;margin:28px auto 168px;background:url(/_nuxt/img/post-entry-bg.98216ca.png) no-repeat -10px 9px}.article-page .back-top[data-v-8db87e62]{width:48px;height:48px;position:fixed;bottom:30px;right:20px;background:url(/_nuxt/img/top.1d1a857.png) no-repeat}.article-page .back-top[data-v-8db87e62]:hover{cursor:pointer;background:url(/_nuxt/img/top-light.0cd636b.png) no-repeat}.title-home[data-v-552f8598]{font-family:sans-serif;line-height:32px;font-size:24px;color:#0b1802;cursor:pointer;max-height:32px;overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis}.title-home[data-v-552f8598]:hover{text-shadow:2px 3px 1px #d0d0d0}.title-detail[data-v-552f8598]{font-size:48px;color:#0b1802;font-family:Arial Rounded MT Bold;margin-top:48px;line-height:64px}@media screen and (min-width:550px) and (max-width:950px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}@media screen and (max-width:550px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}.tags[data-v-53a17526]{height:42px;padding-top:10px}.tag[data-v-53a17526]{background-color:#6aacd8;display:inline-block;height:22px;font-size:13px;color:#fefefe;font-family:sans-serif;padding:2px 6px;margin-right:8px;border-radius:2px}</style><body data-n-head=""><div data-server-rendered="true" id="__nuxt"><div class="progress" data-v-862bdd9c style="width:0%;height:2px;background-color:#3b8070;opacity:0"></div><div><section><div data-v-42857612><div class="nav-bar" data-v-42857612><a href="/" data-v-42857612><img src="/_nuxt/img/blog-icon.f80549d.png" class="ico-favicon" data-v-42857612></a><div class="ico-home" data-v-42857612></div></div><!----></div><div class="article-page" data-v-8db87e62><div class="page-header" data-v-8db87e62><div class="title-detail" data-v-552f8598 data-v-8db87e62>CVE-2014-6352漏洞及定向攻击样本分析</div><div class="ava" data-v-8db87e62><img data-v-8db87e62></div><div class="tags" data-v-53a17526 data-v-8db87e62><p class="tag" data-v-53a17526>CVE-2014-6352</div><div class="author lh32" data-v-8db87e62>黄朝文 on</div></div><div class="main-body" data-v-8db87e62><h2 class="line" data-line="0">引子</h2><p class="line" data-line="3">人在做，天在看。<p class="line" data-line="5">近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。<p class="line" data-line="7">本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。<h2 class="line" data-line="9">漏洞分析</h2><p class="line" data-line="12">样本利用的漏洞为CVE-2014-6352，该漏洞是CVE-2014-4114的补丁绕过（MS14-060）问题,在管理员模式或者关闭UAC的情况下可以实现不弹出警告窗运行嵌入的恶意程序。与CVE-2014-4114的利用样本相比，CVE-2014-6352样本的特点是没有嵌入inf，只有一个嵌入PE的OLE对象。从攻击者的角度看，这类样本可以说有利有弊。在管理员模式下，可以无警告窗执行PE文件，绕开MS14-060的补丁。但是如果不是在管理员模式下，就算受害者没有安装MS14-060的补丁，也会弹窗提示是否要执行嵌入的EXE文件。<p class="line" data-line="14">我们知道CVE-2014-4114漏洞的成因在于<code>packager.dll</code>的<code>CPackage::Load</code>方法加载对应的OLE复合文档对象时，对不同类型的复合文档有不同的处理流程，其中对某些复合文档嵌入的不可信来源文件没有经过处理，从而使得攻击者可以通过伪造OLE复合文档的CLSID来达到执行特定文件的效果：<p class="text-center line" data-line="16"><img src="/uploads/2017/07/19/f897205ebdd4b539662fd55a38f8764c.png" alt="ec5689a025ca576871fd17473bcbc8c8" width="90%"><p class="line" style="text-align:center;font-size:11px" data-line="18"><code>packager!Cpackage:: Load</code>方法中处理不同类型复合文档的分支<p class="line" data-line="20">在MS14-060这个补丁中，微软通过添加MarkFileUnsafe函数来弥补这个漏洞：<p class="text-center line" data-line="22"><img src="/uploads/2017/07/19/f8526ca329f4febc58d84379d2e857a3.png" alt="17ff0c4e99eedd776dc74c83cd72c86e" width="90%"><p class="line" style="text-align:center;font-size:11px" data-line="25">ms14-060补丁中的<code>packager!Cpackage:: EmbedReadFromStream</code>方法<p class="text-center line" data-line="27"><img src="/uploads/2017/07/19/500690b9394d10953d84afcfcccecf5c.png" alt="ee2bf9b4ccab377f39d334ff2b4dd703" width="90%"><p class="line" style="text-align:center;font-size:11px" data-line="30">未安装ms14-060的<code>packager!Cpackage:: EmbedReadFromStream</code>方法<p class="line" data-line="32"><code>MarkFileUnsafe()</code>通过调用<code>IZoneIdentifier::SetId</code>来设置文件的Security Zone，传入的参数3对应的是设置URLZONE_INTERNET，从而标明此文件来自于其他计算机，运行时会弹出警告窗口：<p class="text-center line" data-line="34"><img src="/uploads/2017/07/19/8f9bade0d68af67a30677e2402f505b1.png" alt="de9349df8bd2c409db5fb768a4e43517" width="70%"><p class="text-center line" data-line="36"><img src="/uploads/2017/07/19/f7ac3d0d95fc8757994bc71f1d7b1aa8.png" alt="3849abadc8fa5c51f32251ef06cdfb55" width="55%"><p class="line" data-line="38">然而漏洞并不仅仅只是未对不可信来源的文件处理，攻击者还可以通过伪造OLE复合文档的CLSID和XML中的OLE Verb来改变执行流程。问题还在于对一个exe文件来说，即使被标记了URLZONE_INTERNET之后，右键点击以管理员权限运行时，将不会再弹窗提示该文件来自于其他计算机，而是以UAC的提示窗弹出：<p class="text-center line" data-line="40"><img src="/uploads/2017/07/19/8e41d3b4d060bdc985a952f701f3338f.png" alt="88ced94789ce38c0e55e572dc208d252" width="60%"><p class="line" data-line="42">所以只需要构造特定的CLSID和OLE Verb，使执行流程来到右键界面的第二项管理员权限运行EXE程序，那么在关闭UAC或者管理员权限的情况下，就能绕过MS14-060补丁施加的限制。下面我们结合这次从外面捕获到的样本来展示一下整个漏洞利用的过程。<h2 class="line" data-line="44">样本分析</h2><p class="line" data-line="47">首先我们拿到了一个名为vedio.ppsx的PPT文件，MD5为<strong>b6a1ee16de885c70682a7a8e4c1b556c</strong>，从VirusTotal的上传来源看为来自印度。对这个ppsx解压处理，可以看到其内嵌了一个OLE对象，嵌入的是一个PE文件：<p class="text-center line" data-line="49"><img src="/uploads/2017/07/19/8530294cce4221c3b4b01073411f8feb.png" alt="da510314acac1a35878ca8c501550066" width="70%"><p class="text-center line" data-line="51"><img src="/uploads/2017/07/19/71277408e68d7ff10d9133df8c53121b.png" alt="7a789920319ebd01a8111191b8436d07" width="70%"><p class="line" data-line="54">在video.ppsx\ppt\slides\slide1.xml中，指定了嵌入的对象<em>id = rId3</em><p class="text-center line" data-line="56"><img src="/uploads/2017/07/19/0dad7c0e72148d4bcf5696155bd56afe.png" alt="dd45f53f870504f4cb90c4aeb3216967" width="90%"><p class="line" data-line="59">在video.ppsx \ppt\slides\_rels\ slide1.xml.rels中指定了rId3对应的是前面提到的oleObject1.bin<p class="text-center line" data-line="61"><img src="/uploads/2017/07/19/70bba37c63f251a821b6d85c0b99f089.png" alt="25e8be6c73bc79e942c20ca4ec47d751" width="90%"><p class="line" data-line="64">复合文档对应的CLSID如下图，是{0003000c-0000-0000-c000-000000000046}，对应的是<code>CLSID\_OldPackage</code>，那么根据上面的分析，<code>CPackage::Load</code>调用<code>CPackage::PackageReadFromStream</code>进一步处理，<code>PackageReadFromStream</code>会通过<code>CPackage::EmbedReadFromStream</code>在临时目录释放嵌入的PE文件。<p class="text-center line" data-line="66"><img src="/uploads/2017/07/19/3b26fb904b5198daf95db220515432fc.png" alt="bd02c7199b8937e755285c7a94319bab" width="70%"><p class="line" data-line="69"><code>packager!CPackage::EmbedReadFromStream</code>中调用了 <code>packager!CopyStreamToFile</code>这个函数，将嵌入的PE释放到temp目录下的putty.exe，并通过MarkFileUnsafe设置文件标记：<p class="text-center line" data-line="71"><img src="/uploads/2017/07/19/4d8325c9f5d207023f8dc61d8b3d6084.png" alt="5aa0635ef7f3180fe1db46f7399917fc" width="70%"><p class="line" data-line="74">然后，通过<code>CPackage::DoVerb</code>方法来响应终端用户的动作，在 <code>CPackage::DoVerb</code>中，会先对第二个参数进行判断，这个参数在video.ppsx\ppt\slides\slide1.xml中指定：<p class="text-center line" data-line="76"><img src="/uploads/2017/07/19/6185b2931696c6e14f0fcb33ed723bdc.png" alt="110e72f2b2d8cc8fb61b1b03d434272b" width="60%"><p class="text-center line" data-line="78"><img src="/uploads/2017/07/19/974285891fde33c617e3bf0491c2c9e4.png" alt="84a19910d81ea7d7e44d3b4b02528135" width="50%"><p class="line" data-line="80">样本中构造的参数是3，所以进入使用popup菜单命令执行操作的流程：<p class="text-center line" data-line="82"><img src="/uploads/2017/07/19/53028b83a41a36a4db703f8136d7728c.png" alt="40cec50bbd6ae2f8051496495b28f10c" width="70%"><p class="line" data-line="85">调用GetMenuItemInfo时，第二个参数uItem代表菜单的位置，这里参数为1，也就是右键菜单的第二项，对于exe文件，右键菜单的第二项是“以管理员权限运行”<p class="text-center line" data-line="87"><img src="/uploads/2017/07/19/0839a8cf4c88abab33f22ceefcd087b9.png" alt="c63035508e86f51a92ba30eb4923487d" width="70%"><p class="line" data-line="90">最终调用了<code>SHELL32!CDefFolderMenu::InvokeCommand</code>方法，这时就会以试图管理员权限运行putty.exe，在关闭了UAC或者管理员模式下，就绕过了MS14-060的保护静默地执行了一个PE文件。<h2 class="line" data-line="92">所释放程序的分析</h2><h3 class="line" data-line="95">putty.exe</h3><p class="line" data-line="97">ppt文件释放出来的putty.exe实际上是一个改名后的经过混淆的.NET 程序，MD5为 <strong>78fab9978ae4de4f684908f47fdc2333</strong>，这个程序其实是一个Dropper。<p class="line" data-line="99">经过去混淆后，我们可以清楚地看到其程序代码，首先遍历是否有杀软进程：<p class="text-center line" data-line="101"><img src="/uploads/2017/07/19/b1424f26361cd612bea23097ac9ebdd5.png" alt="6288c40a99e15e50f60403cd645fdf7b" width="70%"><p class="line" data-line="104">样本在这里其实不是一次遍历查找，而是分成多次遍历穿插在功能代码中，每次查找一到两款杀软的进程，查找的杀软进程如下：<ul><li>ekrn.exe（ESET）<li>guardxkickoff.exe（IKARUS）<li>AvastSvc.exe<li>btagent.exe<li>bdagent.exe（BitDefender）<li>avgui.exe。</ul><p class="line" data-line="113">然后从资源中读取数据，并解密为一个PE文件<p class="text-center line" data-line="115"><img src="/uploads/2017/07/19/8d14516bf5fda74c4fda4048d187393a.png" alt="fd4d12799d8a7d3ba57780053606e0e0" width="70%"><p class="line" data-line="118">启动cmd进程，将自身拷贝成%temp%\net\health.exe并添加注册表启动项<p class="text-center line" data-line="120"><img src="/uploads/2017/07/19/e2c5fbd89afc5af31fd936983addb09f.png" alt="d755d300218b7dddee8b99a2b22a18ca" width="90%"><p class="text-center line" data-line="122"><img src="/uploads/2017/07/19/6406e44c2341468d55b1008d4a45c344.png" alt="25119ad65db1a5d422c56f97cf33fdbb" width="90%"><p class="line" data-line="125"><strong>HKEY_CURRENT_USER/Software/Microsoft/Windows NT/CurrentVersion/Windows - load</strong> 这个值可以指定在用户登录后自动运行的程序文件名。<p class="line" data-line="127">然后将RegAsm.exe拷贝为%temp%\svhost.exe<p class="text-center line" data-line="129"><img src="/uploads/2017/07/19/045a76172ad87b67fb6d983d27bca8aa.png" alt="ed46672de8d53ce473fa7954a269da27" width="40%"><p class="text-center line" data-line="131"><img src="/uploads/2017/07/19/fa85671b4f2d25b42a835941e8b1b314.png" alt="9b6440545c9cbff8e32d59cf008fe4b7" width="90%"><p class="text-center line" data-line="133"><img src="/uploads/2017/07/19/07c64ae2210d205282d9996758959d27.png" alt="1d3d631a1227c51f472b44367128ab08" width="60%"><p class="line" data-line="135">接着以Suspend方式启动svhost.exe，将之前解密出来的PE注入，并恢复线程。<p class="text-center line" data-line="137"><img src="/uploads/2017/07/19/ba0c7e440408f7d03148d03e952bfeab.png" alt="7f38dd2a4d4f4cdd659319f1af2c5e62" width="90%"><p class="line" data-line="139">最后在%temp%/net/目录下写入health.exe.bat文件并执行<p class="text-center line" data-line="141"><img src="/uploads/2017/07/19/5c48658f739e268d990f44b2b8c62f60.png" alt="835aae11f4e76320611b52eb98d3d1d2" width="80%"><p class="line" data-line="143">health.exe.bat的代码如下，作用是不断遍历进程查看svhost.exe是否启动，没有启动的话则将其启动。<p class="text-center line" data-line="145"><img src="/uploads/2017/07/19/26b6d8ff104be4f22a048131f4d481cd.png" alt="7da28826361240a37f148a685e5ab563" width="80%"><h3 class="line" data-line="147">svhost.exe</h3><p class="line" data-line="149">在HKEY_CURRENT_USER中设置一个值di用于判断是否已经感染过该系统：<p class="text-center line" data-line="151"><img src="/uploads/2017/07/19/addb5d89a982f492bf7b89a19ad98a82.png" alt="c95ebff2497c18d2b3bb4b9710c9049d" width="70%"><p class="line" data-line="153">设置HKEY_CURRENT_USER\Environment\SEE_MASK_NOZONECHECKS的值为1，这是用于关闭附件管理器检查的：<p class="text-center line" data-line="155"><img src="/uploads/2017/07/19/5b53e06d0749114811dc105474a0b25b.png" alt="7ddf63a334a55426403ccf7796ed9ac4" width="90%"><p class="line" data-line="157">然后用命令行启动netsh.exe，添加防火墙规则，允许其通过防火墙<p class="text-center line" data-line="159"><img src="/uploads/2017/07/19/a24b4030f205e25bd7786d5c801195c7.png" alt="11cf4fcbdcc9843135ccf3501f432f78" width="70%"><p class="line" data-line="161">命令行如下<pre class="hljs"><code class="hljs">netsh firewall add allowedprogram "C:\\Users\\\*\*\*\\AppData\\Local\\Temp\\svhost.exe" " svhost.exe" ENABLE
</code></pre><p class="line" data-line="166">申请一片内存空间用于存放接收/发送的数据，开始网络连接：<p class="text-center line" data-line="168"><img src="/uploads/2017/07/19/9676a58a7a0286760d7efe01716f8b8d.png" alt="2b352c13dc65a30c5a89e3e58b7e5cd1" width="85%"><p class="line" data-line="170">C&C地址： 191.101.23.190<p class="text-center line" data-line="172"><img src="/uploads/2017/07/19/7af893eca785ff862aee5afbac77b95b.png" alt="d0e210eb3f1849905b921d248fec11dd" width="45%"><p class="line" data-line="174">端口号： 5552<p class="text-center line" data-line="176"><img src="/uploads/2017/07/19/9bc5294feb1eba985a19966856852ebd.png" alt="3ee54e4519c9871e67dc2e902f0f5158" width="45%"><p class="line" data-line="178">收集受害者的系统信息，包括上线时间、系统版本、系统位数、磁盘信息、当前用户等等，并发送出去：<p class="text-center line" data-line="180"><img src="/uploads/2017/07/19/6d0d740ce86a5be474a38e095a07958b.png" alt="b34f35ad7c8977ff9ef8112311810416" width="90%"><p class="line" data-line="182">然后开启一个线程循环查询socket是否可读（接收命令）：<p class="text-center line" data-line="184"><img src="/uploads/2017/07/19/6f86f185399a40ecfcaafc97da288f3d.png" alt="64a74da6585d5361b5e420fd66de70a5" width="70%"><p class="line" data-line="186">读取命令后，开启新线程根据指令执行对应的操作：<p class="text-center line" data-line="188"><img src="/uploads/2017/07/19/425702e46d852ad1355b76207ab5f7fb.png" alt="6a52e6ba30f4ef0bce214db10ae90dae" width="90%"><p class="line" data-line="190">开启键盘记录线程，并将记录信息保存在注册表HKEY_CURRENT_USER\SoftWare\ ce99f8fa1676b15364293a0db3d6a707中：<p class="text-center line" data-line="192"><img src="/uploads/2017/07/19/b40472dad950a9b67f100bbfdace23fe.png" alt="a717d59135d644202bedebcc6412c553" width="90%"><p class="text-center line" data-line="194"><img src="/uploads/2017/07/19/500e126afffb6afb4d141341145f9512.png" alt="80b41258aea92eb0ca1b83e446a900bf" width="90%"><p class="line" data-line="196">设置自启动项：<p class="text-center line" data-line="198"><img src="/uploads/2017/07/19/109deec3d382e38db502a2043da04b0c.png" alt="65ff19f29e11e13e3178dcf40a1416fb" width="90%"><p class="text-center line" data-line="201"><img src="/uploads/2017/07/19/7fbf79d02308fa3ea4b0b3868cefcf89.png" alt="601e1a90b302e8c0c9989aafe7f95cb4" width="90%"><p class="line" data-line="203">接收命令后，对命令做出相应的处理，在switch中根据命令执行对应的功能，这里就不再详细分析，下面给出部分功能与对应的命令，<table><thead><tr><th><th><tbody><tr><td>rn<td>下载/执行文件<tr><td>CAP<td>屏幕监控<tr><td>un<td>自删除、启动和终止进程<tr><td>up<td>在线更新<tr><td>Ex<td>加载插件<tr><td>GTV<td>获取注册表HKEY_CURRENT_USER\SoftWare\ ce99f8fa1676b15364293a0db3d6a707中的键盘记录信息<tr><td>STV<td>设置注册表HKEY_CURRENT_USER\SoftWare\ ce99f8fa1676b15364293a0db3d6a707开始键盘记录<tr><td>…..<td>……</table><h2 class="line" data-line="216">IOC</h2><table><thead><tr><th>类型<th>值<tbody><tr><td>C&C<td>191.101.23.190:5552<tr><td>Downloader URL<td>http://pcdopune.com/ad/video.ppsx</table><h2 class="line" data-line="224">总结</h2><p class="line" data-line="227">在网上公开的IOC平台中发现，该C&C地址与趋势科技在今年三月份发布的“Operation C-Major”报告中的一个C&C完全一致。另外，样本下载的域名pcdopune.com关联到的其他样本中，也出现了与报告中几乎一样的恶意宏样本，由此我们认为这是与C-Major相关的攻击行动。<p class="line" data-line="229">根据360威胁情报中心的数据，我们发现本文所涉及的样本仅仅只是C-Major行动中使用的多种Dropper中的一种类型，CVE-2010-3333、CVE-2012-0158等漏洞也被利用来做恶意代码的植入，不仅如此，甚至还利用了宏和脚本，所使用的PE样本更是灵活多变。从这些迹象来看C-Major行动背后团伙非常积极地利用所能得到各种植入手段，极有可能是专业的有背景及一定技术能力的组织。<h2 class="line" data-line="231">参考链接</h2><p class="line" data-line="234"><a href="http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf"><em>http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf</em></a><p class="line" data-line="236"><a href="http://www.cnblogs.com/Danny-Wei/p/4161539.html"><em>http://www.cnblogs.com/Danny-Wei/p/4161539.html</em></a><p class="line" data-line="238"><a href="http://www.openoffice.org/sc/compdocfileformat.pdf"><em>http://www.openoffice.org/sc/compdocfileformat.pdf</em></a></div><div class="back-top" data-v-8db87e62></div></div></section></div></div><script type="text/javascript">window.__NUXT__={layout:"default",data:[{articleData:{_id:"596f0ad74337d4596e59ed0b",title:"CVE-2014-6352漏洞及定向攻击样本分析",category:"事件追踪",readableId:"CVE-2014-6352-and-targeted-attack-sample",abstract:"近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。",author:"黄朝文",headImg:"/uploads/2017/08/17/13296b2306bed22900c8f2ffd7d3242a.png",descImg:"/uploads/2017/08/01/847ba7154379f2cd5d13599b5f1023bf.png",tags:["CVE-2014-6352"],publish_time:"2016-06-15T10:13:24.000Z",content:'<h2 class="line" data-line="0">引子</h2>\n<p class="line" data-line="3">人在做，天在看。</p>\n<p class="line" data-line="5">近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。</p>\n<p class="line" data-line="7">本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。</p>\n<h2 class="line" data-line="9">漏洞分析</h2>\n<p class="line" data-line="12">样本利用的漏洞为CVE-2014-6352，该漏洞是CVE-2014-4114的补丁绕过（MS14-060）问题,在管理员模式或者关闭UAC的情况下可以实现不弹出警告窗运行嵌入的恶意程序。与CVE-2014-4114的利用样本相比，CVE-2014-6352样本的特点是没有嵌入inf，只有一个嵌入PE的OLE对象。从攻击者的角度看，这类样本可以说有利有弊。在管理员模式下，可以无警告窗执行PE文件，绕开MS14-060的补丁。但是如果不是在管理员模式下，就算受害者没有安装MS14-060的补丁，也会弹窗提示是否要执行嵌入的EXE文件。</p>\n<p class="line" data-line="14">我们知道CVE-2014-4114漏洞的成因在于<code>packager.dll</code>的<code>CPackage::Load</code>方法加载对应的OLE复合文档对象时，对不同类型的复合文档有不同的处理流程，其中对某些复合文档嵌入的不可信来源文件没有经过处理，从而使得攻击者可以通过伪造OLE复合文档的CLSID来达到执行特定文件的效果：</p>\n<p class="text-center line" data-line="16"><img src="/uploads/2017/07/19/f897205ebdd4b539662fd55a38f8764c.png" alt="ec5689a025ca576871fd17473bcbc8c8" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="18"><code>packager!Cpackage:: Load</code>方法中处理不同类型复合文档的分支</p>\n<p class="line" data-line="20">在MS14-060这个补丁中，微软通过添加MarkFileUnsafe函数来弥补这个漏洞：</p>\n<p class="text-center line" data-line="22"><img src="/uploads/2017/07/19/f8526ca329f4febc58d84379d2e857a3.png" alt="17ff0c4e99eedd776dc74c83cd72c86e" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="25">ms14-060补丁中的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="text-center line" data-line="27"><img src="/uploads/2017/07/19/500690b9394d10953d84afcfcccecf5c.png" alt="ee2bf9b4ccab377f39d334ff2b4dd703" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="30">未安装ms14-060的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="line" data-line="32"><code>MarkFileUnsafe()</code>通过调用<code>IZoneIdentifier::SetId</code>来设置文件的Security Zone，传入的参数3对应的是设置URLZONE_INTERNET，从而标明此文件来自于其他计算机，运行时会弹出警告窗口：</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/19/8f9bade0d68af67a30677e2402f505b1.png" alt="de9349df8bd2c409db5fb768a4e43517" width="70%"></p>\n<p class="text-center line" data-line="36"><img src="/uploads/2017/07/19/f7ac3d0d95fc8757994bc71f1d7b1aa8.png" alt="3849abadc8fa5c51f32251ef06cdfb55" width="55%"></p>\n<p class="line" data-line="38">然而漏洞并不仅仅只是未对不可信来源的文件处理，攻击者还可以通过伪造OLE复合文档的CLSID和XML中的OLE Verb来改变执行流程。问题还在于对一个exe文件来说，即使被标记了URLZONE_INTERNET之后，右键点击以管理员权限运行时，将不会再弹窗提示该文件来自于其他计算机，而是以UAC的提示窗弹出：</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/19/8e41d3b4d060bdc985a952f701f3338f.png" alt="88ced94789ce38c0e55e572dc208d252" width="60%"></p>\n<p class="line" data-line="42">所以只需要构造特定的CLSID和OLE Verb，使执行流程来到右键界面的第二项管理员权限运行EXE程序，那么在关闭UAC或者管理员权限的情况下，就能绕过MS14-060补丁施加的限制。下面我们结合这次从外面捕获到的样本来展示一下整个漏洞利用的过程。</p>\n<h2 class="line" data-line="44">样本分析</h2>\n<p class="line" data-line="47">首先我们拿到了一个名为vedio.ppsx的PPT文件，MD5为<strong>b6a1ee16de885c70682a7a8e4c1b556c</strong>，从VirusTotal的上传来源看为来自印度。对这个ppsx解压处理，可以看到其内嵌了一个OLE对象，嵌入的是一个PE文件：</p>\n<p class="text-center line" data-line="49"><img src="/uploads/2017/07/19/8530294cce4221c3b4b01073411f8feb.png" alt="da510314acac1a35878ca8c501550066" width="70%"></p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/19/71277408e68d7ff10d9133df8c53121b.png" alt="7a789920319ebd01a8111191b8436d07" width="70%"></p>\n<p class="line" data-line="54">在video.ppsx\\ppt\\slides\\slide1.xml中，指定了嵌入的对象<em>id = rId3</em></p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/19/0dad7c0e72148d4bcf5696155bd56afe.png" alt="dd45f53f870504f4cb90c4aeb3216967" width="90%"></p>\n<p class="line" data-line="59">在video.ppsx \\ppt\\slides\\_rels\\ slide1.xml.rels中指定了rId3对应的是前面提到的oleObject1.bin</p>\n<p class="text-center line" data-line="61"><img src="/uploads/2017/07/19/70bba37c63f251a821b6d85c0b99f089.png" alt="25e8be6c73bc79e942c20ca4ec47d751" width="90%"></p>\n<p class="line" data-line="64">复合文档对应的CLSID如下图，是{0003000c-0000-0000-c000-000000000046}，对应的是<code>CLSID\\_OldPackage</code>，那么根据上面的分析，<code>CPackage::Load</code>调用<code>CPackage::PackageReadFromStream</code>进一步处理，<code>PackageReadFromStream</code>会通过<code>CPackage::EmbedReadFromStream</code>在临时目录释放嵌入的PE文件。</p>\n<p class="text-center line" data-line="66"><img src="/uploads/2017/07/19/3b26fb904b5198daf95db220515432fc.png" alt="bd02c7199b8937e755285c7a94319bab" width="70%"></p>\n<p class="line" data-line="69"><code>packager!CPackage::EmbedReadFromStream</code>中调用了 <code>packager!CopyStreamToFile</code>这个函数，将嵌入的PE释放到temp目录下的putty.exe，并通过MarkFileUnsafe设置文件标记：</p>\n<p class="text-center line" data-line="71"><img src="/uploads/2017/07/19/4d8325c9f5d207023f8dc61d8b3d6084.png" alt="5aa0635ef7f3180fe1db46f7399917fc" width="70%"></p>\n<p class="line" data-line="74">然后，通过<code>CPackage::DoVerb</code>方法来响应终端用户的动作，在 <code>CPackage::DoVerb</code>中，会先对第二个参数进行判断，这个参数在video.ppsx\\ppt\\slides\\slide1.xml中指定：</p>\n<p class="text-center line" data-line="76"><img src="/uploads/2017/07/19/6185b2931696c6e14f0fcb33ed723bdc.png" alt="110e72f2b2d8cc8fb61b1b03d434272b" width="60%"></p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/19/974285891fde33c617e3bf0491c2c9e4.png" alt="84a19910d81ea7d7e44d3b4b02528135" width="50%"></p>\n<p class="line" data-line="80">样本中构造的参数是3，所以进入使用popup菜单命令执行操作的流程：</p>\n<p class="text-center line" data-line="82"><img src="/uploads/2017/07/19/53028b83a41a36a4db703f8136d7728c.png" alt="40cec50bbd6ae2f8051496495b28f10c" width="70%"></p>\n<p class="line" data-line="85">调用GetMenuItemInfo时，第二个参数uItem代表菜单的位置，这里参数为1，也就是右键菜单的第二项，对于exe文件，右键菜单的第二项是“以管理员权限运行”</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/19/0839a8cf4c88abab33f22ceefcd087b9.png" alt="c63035508e86f51a92ba30eb4923487d" width="70%"></p>\n<p class="line" data-line="90">最终调用了<code>SHELL32!CDefFolderMenu::InvokeCommand</code>方法，这时就会以试图管理员权限运行putty.exe，在关闭了UAC或者管理员模式下，就绕过了MS14-060的保护静默地执行了一个PE文件。</p>\n<h2 class="line" data-line="92">所释放程序的分析</h2>\n<h3 class="line" data-line="95">putty.exe</h3>\n<p class="line" data-line="97">ppt文件释放出来的putty.exe实际上是一个改名后的经过混淆的.NET 程序，MD5为 <strong>78fab9978ae4de4f684908f47fdc2333</strong>，这个程序其实是一个Dropper。</p>\n<p class="line" data-line="99">经过去混淆后，我们可以清楚地看到其程序代码，首先遍历是否有杀软进程：</p>\n<p class="text-center line" data-line="101"><img src="/uploads/2017/07/19/b1424f26361cd612bea23097ac9ebdd5.png" alt="6288c40a99e15e50f60403cd645fdf7b" width="70%"></p>\n<p class="line" data-line="104">样本在这里其实不是一次遍历查找，而是分成多次遍历穿插在功能代码中，每次查找一到两款杀软的进程，查找的杀软进程如下：</p>\n<ul>\n<li>ekrn.exe（ESET）</li>\n<li>guardxkickoff.exe（IKARUS）</li>\n<li>AvastSvc.exe</li>\n<li>btagent.exe</li>\n<li>bdagent.exe（BitDefender）</li>\n<li>avgui.exe。</li>\n</ul>\n<p class="line" data-line="113">然后从资源中读取数据，并解密为一个PE文件</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/19/8d14516bf5fda74c4fda4048d187393a.png" alt="fd4d12799d8a7d3ba57780053606e0e0" width="70%"></p>\n<p class="line" data-line="118">启动cmd进程，将自身拷贝成%temp%\\net\\health.exe并添加注册表启动项</p>\n<p class="text-center line" data-line="120"><img src="/uploads/2017/07/19/e2c5fbd89afc5af31fd936983addb09f.png" alt="d755d300218b7dddee8b99a2b22a18ca" width="90%"></p>\n<p class="text-center line" data-line="122"><img src="/uploads/2017/07/19/6406e44c2341468d55b1008d4a45c344.png" alt="25119ad65db1a5d422c56f97cf33fdbb" width="90%"></p>\n<p class="line" data-line="125"><strong>HKEY_CURRENT_USER/Software/Microsoft/Windows NT/CurrentVersion/Windows - load</strong> 这个值可以指定在用户登录后自动运行的程序文件名。</p>\n<p class="line" data-line="127">然后将RegAsm.exe拷贝为%temp%\\svhost.exe</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/19/045a76172ad87b67fb6d983d27bca8aa.png" alt="ed46672de8d53ce473fa7954a269da27" width="40%"></p>\n<p class="text-center line" data-line="131"><img src="/uploads/2017/07/19/fa85671b4f2d25b42a835941e8b1b314.png" alt="9b6440545c9cbff8e32d59cf008fe4b7" width="90%"></p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/19/07c64ae2210d205282d9996758959d27.png" alt="1d3d631a1227c51f472b44367128ab08" width="60%"></p>\n<p class="line" data-line="135">接着以Suspend方式启动svhost.exe，将之前解密出来的PE注入，并恢复线程。</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/19/ba0c7e440408f7d03148d03e952bfeab.png" alt="7f38dd2a4d4f4cdd659319f1af2c5e62" width="90%"></p>\n<p class="line" data-line="139">最后在%temp%/net/目录下写入health.exe.bat文件并执行</p>\n<p class="text-center line" data-line="141"><img src="/uploads/2017/07/19/5c48658f739e268d990f44b2b8c62f60.png" alt="835aae11f4e76320611b52eb98d3d1d2" width="80%"></p>\n<p class="line" data-line="143">health.exe.bat的代码如下，作用是不断遍历进程查看svhost.exe是否启动，没有启动的话则将其启动。</p>\n<p class="text-center line" data-line="145"><img src="/uploads/2017/07/19/26b6d8ff104be4f22a048131f4d481cd.png" alt="7da28826361240a37f148a685e5ab563" width="80%"></p>\n<h3 class="line" data-line="147">svhost.exe</h3>\n<p class="line" data-line="149">在HKEY_CURRENT_USER中设置一个值di用于判断是否已经感染过该系统：</p>\n<p class="text-center line" data-line="151"><img src="/uploads/2017/07/19/addb5d89a982f492bf7b89a19ad98a82.png" alt="c95ebff2497c18d2b3bb4b9710c9049d" width="70%"></p>\n<p class="line" data-line="153">设置HKEY_CURRENT_USER\\Environment\\SEE_MASK_NOZONECHECKS的值为1，这是用于关闭附件管理器检查的：</p>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/19/5b53e06d0749114811dc105474a0b25b.png" alt="7ddf63a334a55426403ccf7796ed9ac4" width="90%"></p>\n<p class="line" data-line="157">然后用命令行启动netsh.exe，添加防火墙规则，允许其通过防火墙</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/19/a24b4030f205e25bd7786d5c801195c7.png" alt="11cf4fcbdcc9843135ccf3501f432f78" width="70%"></p>\n<p class="line" data-line="161">命令行如下</p>\n<pre class="hljs"><code class="hljs">netsh firewall add allowedprogram "C:\\\\Users\\\\\\*\\*\\*\\\\AppData\\\\Local\\\\Temp\\\\svhost.exe" " svhost.exe" ENABLE\n</code></pre>\n<p class="line" data-line="166">申请一片内存空间用于存放接收/发送的数据，开始网络连接：</p>\n<p class="text-center line" data-line="168"><img src="/uploads/2017/07/19/9676a58a7a0286760d7efe01716f8b8d.png" alt="2b352c13dc65a30c5a89e3e58b7e5cd1" width="85%"></p>\n<p class="line" data-line="170">C&amp;C地址： 191.101.23.190</p>\n<p class="text-center line" data-line="172"><img src="/uploads/2017/07/19/7af893eca785ff862aee5afbac77b95b.png" alt="d0e210eb3f1849905b921d248fec11dd" width="45%"></p>\n<p class="line" data-line="174">端口号： 5552</p>\n<p class="text-center line" data-line="176"><img src="/uploads/2017/07/19/9bc5294feb1eba985a19966856852ebd.png" alt="3ee54e4519c9871e67dc2e902f0f5158" width="45%"></p>\n<p class="line" data-line="178">收集受害者的系统信息，包括上线时间、系统版本、系统位数、磁盘信息、当前用户等等，并发送出去：</p>\n<p class="text-center line" data-line="180"><img src="/uploads/2017/07/19/6d0d740ce86a5be474a38e095a07958b.png" alt="b34f35ad7c8977ff9ef8112311810416" width="90%"></p>\n<p class="line" data-line="182">然后开启一个线程循环查询socket是否可读（接收命令）：</p>\n<p class="text-center line" data-line="184"><img src="/uploads/2017/07/19/6f86f185399a40ecfcaafc97da288f3d.png" alt="64a74da6585d5361b5e420fd66de70a5" width="70%"></p>\n<p class="line" data-line="186">读取命令后，开启新线程根据指令执行对应的操作：</p>\n<p class="text-center line" data-line="188"><img src="/uploads/2017/07/19/425702e46d852ad1355b76207ab5f7fb.png" alt="6a52e6ba30f4ef0bce214db10ae90dae" width="90%"></p>\n<p class="line" data-line="190">开启键盘记录线程，并将记录信息保存在注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中：</p>\n<p class="text-center line" data-line="192"><img src="/uploads/2017/07/19/b40472dad950a9b67f100bbfdace23fe.png" alt="a717d59135d644202bedebcc6412c553" width="90%"></p>\n<p class="text-center line" data-line="194"><img src="/uploads/2017/07/19/500e126afffb6afb4d141341145f9512.png" alt="80b41258aea92eb0ca1b83e446a900bf" width="90%"></p>\n<p class="line" data-line="196">设置自启动项：</p>\n<p class="text-center line" data-line="198"><img src="/uploads/2017/07/19/109deec3d382e38db502a2043da04b0c.png" alt="65ff19f29e11e13e3178dcf40a1416fb" width="90%"></p>\n<p class="text-center line" data-line="201"><img src="/uploads/2017/07/19/7fbf79d02308fa3ea4b0b3868cefcf89.png" alt="601e1a90b302e8c0c9989aafe7f95cb4" width="90%"></p>\n<p class="line" data-line="203">接收命令后，对命令做出相应的处理，在switch中根据命令执行对应的功能，这里就不再详细分析，下面给出部分功能与对应的命令，</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>rn</td>\n<td>下载/执行文件</td>\n</tr>\n<tr>\n<td>CAP</td>\n<td>屏幕监控</td>\n</tr>\n<tr>\n<td>un</td>\n<td>自删除、启动和终止进程</td>\n</tr>\n<tr>\n<td>up</td>\n<td>在线更新</td>\n</tr>\n<tr>\n<td>Ex</td>\n<td>加载插件</td>\n</tr>\n<tr>\n<td>GTV</td>\n<td>获取注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中的键盘记录信息</td>\n</tr>\n<tr>\n<td>STV</td>\n<td>设置注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707开始键盘记录</td>\n</tr>\n<tr>\n<td>…..</td>\n<td>……</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="216">IOC</h2>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>C&amp;C</td>\n<td>191.101.23.190:5552</td>\n</tr>\n<tr>\n<td>Downloader URL</td>\n<td>http://pcdopune.com/ad/video.ppsx</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="224">总结</h2>\n<p class="line" data-line="227">在网上公开的IOC平台中发现，该C&amp;C地址与趋势科技在今年三月份发布的“Operation C-Major”报告中的一个C&amp;C完全一致。另外，样本下载的域名pcdopune.com关联到的其他样本中，也出现了与报告中几乎一样的恶意宏样本，由此我们认为这是与C-Major相关的攻击行动。</p>\n<p class="line" data-line="229">根据360威胁情报中心的数据，我们发现本文所涉及的样本仅仅只是C-Major行动中使用的多种Dropper中的一种类型，CVE-2010-3333、CVE-2012-0158等漏洞也被利用来做恶意代码的植入，不仅如此，甚至还利用了宏和脚本，所使用的PE样本更是灵活多变。从这些迹象来看C-Major行动背后团伙非常积极地利用所能得到各种植入手段，极有可能是专业的有背景及一定技术能力的组织。</p>\n<h2 class="line" data-line="231">参考链接</h2>\n<p class="line" data-line="234"><a href="http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf"><em>http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf</em></a></p>\n<p class="line" data-line="236"><a href="http://www.cnblogs.com/Danny-Wei/p/4161539.html"><em>http://www.cnblogs.com/Danny-Wei/p/4161539.html</em></a></p>\n<p class="line" data-line="238"><a href="http://www.openoffice.org/sc/compdocfileformat.pdf"><em>http://www.openoffice.org/sc/compdocfileformat.pdf</em></a></p>\n'}}],error:null,state:{pageId:[],tagParam:[],isMainPage:!1,pageNum:[1,2],articleData:{_id:"596f0ad74337d4596e59ed0b",title:"CVE-2014-6352漏洞及定向攻击样本分析",category:"事件追踪",readableId:"CVE-2014-6352-and-targeted-attack-sample",abstract:"近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。",author:"黄朝文",headImg:"/uploads/2017/08/17/13296b2306bed22900c8f2ffd7d3242a.png",descImg:"/uploads/2017/08/01/847ba7154379f2cd5d13599b5f1023bf.png",tags:["CVE-2014-6352"],publish_time:"2016-06-15T10:13:24.000Z",content:'<h2 class="line" data-line="0">引子</h2>\n<p class="line" data-line="3">人在做，天在看。</p>\n<p class="line" data-line="5">近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。</p>\n<p class="line" data-line="7">本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。</p>\n<h2 class="line" data-line="9">漏洞分析</h2>\n<p class="line" data-line="12">样本利用的漏洞为CVE-2014-6352，该漏洞是CVE-2014-4114的补丁绕过（MS14-060）问题,在管理员模式或者关闭UAC的情况下可以实现不弹出警告窗运行嵌入的恶意程序。与CVE-2014-4114的利用样本相比，CVE-2014-6352样本的特点是没有嵌入inf，只有一个嵌入PE的OLE对象。从攻击者的角度看，这类样本可以说有利有弊。在管理员模式下，可以无警告窗执行PE文件，绕开MS14-060的补丁。但是如果不是在管理员模式下，就算受害者没有安装MS14-060的补丁，也会弹窗提示是否要执行嵌入的EXE文件。</p>\n<p class="line" data-line="14">我们知道CVE-2014-4114漏洞的成因在于<code>packager.dll</code>的<code>CPackage::Load</code>方法加载对应的OLE复合文档对象时，对不同类型的复合文档有不同的处理流程，其中对某些复合文档嵌入的不可信来源文件没有经过处理，从而使得攻击者可以通过伪造OLE复合文档的CLSID来达到执行特定文件的效果：</p>\n<p class="text-center line" data-line="16"><img src="/uploads/2017/07/19/f897205ebdd4b539662fd55a38f8764c.png" alt="ec5689a025ca576871fd17473bcbc8c8" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="18"><code>packager!Cpackage:: Load</code>方法中处理不同类型复合文档的分支</p>\n<p class="line" data-line="20">在MS14-060这个补丁中，微软通过添加MarkFileUnsafe函数来弥补这个漏洞：</p>\n<p class="text-center line" data-line="22"><img src="/uploads/2017/07/19/f8526ca329f4febc58d84379d2e857a3.png" alt="17ff0c4e99eedd776dc74c83cd72c86e" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="25">ms14-060补丁中的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="text-center line" data-line="27"><img src="/uploads/2017/07/19/500690b9394d10953d84afcfcccecf5c.png" alt="ee2bf9b4ccab377f39d334ff2b4dd703" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="30">未安装ms14-060的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="line" data-line="32"><code>MarkFileUnsafe()</code>通过调用<code>IZoneIdentifier::SetId</code>来设置文件的Security Zone，传入的参数3对应的是设置URLZONE_INTERNET，从而标明此文件来自于其他计算机，运行时会弹出警告窗口：</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/19/8f9bade0d68af67a30677e2402f505b1.png" alt="de9349df8bd2c409db5fb768a4e43517" width="70%"></p>\n<p class="text-center line" data-line="36"><img src="/uploads/2017/07/19/f7ac3d0d95fc8757994bc71f1d7b1aa8.png" alt="3849abadc8fa5c51f32251ef06cdfb55" width="55%"></p>\n<p class="line" data-line="38">然而漏洞并不仅仅只是未对不可信来源的文件处理，攻击者还可以通过伪造OLE复合文档的CLSID和XML中的OLE Verb来改变执行流程。问题还在于对一个exe文件来说，即使被标记了URLZONE_INTERNET之后，右键点击以管理员权限运行时，将不会再弹窗提示该文件来自于其他计算机，而是以UAC的提示窗弹出：</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/19/8e41d3b4d060bdc985a952f701f3338f.png" alt="88ced94789ce38c0e55e572dc208d252" width="60%"></p>\n<p class="line" data-line="42">所以只需要构造特定的CLSID和OLE Verb，使执行流程来到右键界面的第二项管理员权限运行EXE程序，那么在关闭UAC或者管理员权限的情况下，就能绕过MS14-060补丁施加的限制。下面我们结合这次从外面捕获到的样本来展示一下整个漏洞利用的过程。</p>\n<h2 class="line" data-line="44">样本分析</h2>\n<p class="line" data-line="47">首先我们拿到了一个名为vedio.ppsx的PPT文件，MD5为<strong>b6a1ee16de885c70682a7a8e4c1b556c</strong>，从VirusTotal的上传来源看为来自印度。对这个ppsx解压处理，可以看到其内嵌了一个OLE对象，嵌入的是一个PE文件：</p>\n<p class="text-center line" data-line="49"><img src="/uploads/2017/07/19/8530294cce4221c3b4b01073411f8feb.png" alt="da510314acac1a35878ca8c501550066" width="70%"></p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/19/71277408e68d7ff10d9133df8c53121b.png" alt="7a789920319ebd01a8111191b8436d07" width="70%"></p>\n<p class="line" data-line="54">在video.ppsx\\ppt\\slides\\slide1.xml中，指定了嵌入的对象<em>id = rId3</em></p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/19/0dad7c0e72148d4bcf5696155bd56afe.png" alt="dd45f53f870504f4cb90c4aeb3216967" width="90%"></p>\n<p class="line" data-line="59">在video.ppsx \\ppt\\slides\\_rels\\ slide1.xml.rels中指定了rId3对应的是前面提到的oleObject1.bin</p>\n<p class="text-center line" data-line="61"><img src="/uploads/2017/07/19/70bba37c63f251a821b6d85c0b99f089.png" alt="25e8be6c73bc79e942c20ca4ec47d751" width="90%"></p>\n<p class="line" data-line="64">复合文档对应的CLSID如下图，是{0003000c-0000-0000-c000-000000000046}，对应的是<code>CLSID\\_OldPackage</code>，那么根据上面的分析，<code>CPackage::Load</code>调用<code>CPackage::PackageReadFromStream</code>进一步处理，<code>PackageReadFromStream</code>会通过<code>CPackage::EmbedReadFromStream</code>在临时目录释放嵌入的PE文件。</p>\n<p class="text-center line" data-line="66"><img src="/uploads/2017/07/19/3b26fb904b5198daf95db220515432fc.png" alt="bd02c7199b8937e755285c7a94319bab" width="70%"></p>\n<p class="line" data-line="69"><code>packager!CPackage::EmbedReadFromStream</code>中调用了 <code>packager!CopyStreamToFile</code>这个函数，将嵌入的PE释放到temp目录下的putty.exe，并通过MarkFileUnsafe设置文件标记：</p>\n<p class="text-center line" data-line="71"><img src="/uploads/2017/07/19/4d8325c9f5d207023f8dc61d8b3d6084.png" alt="5aa0635ef7f3180fe1db46f7399917fc" width="70%"></p>\n<p class="line" data-line="74">然后，通过<code>CPackage::DoVerb</code>方法来响应终端用户的动作，在 <code>CPackage::DoVerb</code>中，会先对第二个参数进行判断，这个参数在video.ppsx\\ppt\\slides\\slide1.xml中指定：</p>\n<p class="text-center line" data-line="76"><img src="/uploads/2017/07/19/6185b2931696c6e14f0fcb33ed723bdc.png" alt="110e72f2b2d8cc8fb61b1b03d434272b" width="60%"></p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/19/974285891fde33c617e3bf0491c2c9e4.png" alt="84a19910d81ea7d7e44d3b4b02528135" width="50%"></p>\n<p class="line" data-line="80">样本中构造的参数是3，所以进入使用popup菜单命令执行操作的流程：</p>\n<p class="text-center line" data-line="82"><img src="/uploads/2017/07/19/53028b83a41a36a4db703f8136d7728c.png" alt="40cec50bbd6ae2f8051496495b28f10c" width="70%"></p>\n<p class="line" data-line="85">调用GetMenuItemInfo时，第二个参数uItem代表菜单的位置，这里参数为1，也就是右键菜单的第二项，对于exe文件，右键菜单的第二项是“以管理员权限运行”</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/19/0839a8cf4c88abab33f22ceefcd087b9.png" alt="c63035508e86f51a92ba30eb4923487d" width="70%"></p>\n<p class="line" data-line="90">最终调用了<code>SHELL32!CDefFolderMenu::InvokeCommand</code>方法，这时就会以试图管理员权限运行putty.exe，在关闭了UAC或者管理员模式下，就绕过了MS14-060的保护静默地执行了一个PE文件。</p>\n<h2 class="line" data-line="92">所释放程序的分析</h2>\n<h3 class="line" data-line="95">putty.exe</h3>\n<p class="line" data-line="97">ppt文件释放出来的putty.exe实际上是一个改名后的经过混淆的.NET 程序，MD5为 <strong>78fab9978ae4de4f684908f47fdc2333</strong>，这个程序其实是一个Dropper。</p>\n<p class="line" data-line="99">经过去混淆后，我们可以清楚地看到其程序代码，首先遍历是否有杀软进程：</p>\n<p class="text-center line" data-line="101"><img src="/uploads/2017/07/19/b1424f26361cd612bea23097ac9ebdd5.png" alt="6288c40a99e15e50f60403cd645fdf7b" width="70%"></p>\n<p class="line" data-line="104">样本在这里其实不是一次遍历查找，而是分成多次遍历穿插在功能代码中，每次查找一到两款杀软的进程，查找的杀软进程如下：</p>\n<ul>\n<li>ekrn.exe（ESET）</li>\n<li>guardxkickoff.exe（IKARUS）</li>\n<li>AvastSvc.exe</li>\n<li>btagent.exe</li>\n<li>bdagent.exe（BitDefender）</li>\n<li>avgui.exe。</li>\n</ul>\n<p class="line" data-line="113">然后从资源中读取数据，并解密为一个PE文件</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/19/8d14516bf5fda74c4fda4048d187393a.png" alt="fd4d12799d8a7d3ba57780053606e0e0" width="70%"></p>\n<p class="line" data-line="118">启动cmd进程，将自身拷贝成%temp%\\net\\health.exe并添加注册表启动项</p>\n<p class="text-center line" data-line="120"><img src="/uploads/2017/07/19/e2c5fbd89afc5af31fd936983addb09f.png" alt="d755d300218b7dddee8b99a2b22a18ca" width="90%"></p>\n<p class="text-center line" data-line="122"><img src="/uploads/2017/07/19/6406e44c2341468d55b1008d4a45c344.png" alt="25119ad65db1a5d422c56f97cf33fdbb" width="90%"></p>\n<p class="line" data-line="125"><strong>HKEY_CURRENT_USER/Software/Microsoft/Windows NT/CurrentVersion/Windows - load</strong> 这个值可以指定在用户登录后自动运行的程序文件名。</p>\n<p class="line" data-line="127">然后将RegAsm.exe拷贝为%temp%\\svhost.exe</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/19/045a76172ad87b67fb6d983d27bca8aa.png" alt="ed46672de8d53ce473fa7954a269da27" width="40%"></p>\n<p class="text-center line" data-line="131"><img src="/uploads/2017/07/19/fa85671b4f2d25b42a835941e8b1b314.png" alt="9b6440545c9cbff8e32d59cf008fe4b7" width="90%"></p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/19/07c64ae2210d205282d9996758959d27.png" alt="1d3d631a1227c51f472b44367128ab08" width="60%"></p>\n<p class="line" data-line="135">接着以Suspend方式启动svhost.exe，将之前解密出来的PE注入，并恢复线程。</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/19/ba0c7e440408f7d03148d03e952bfeab.png" alt="7f38dd2a4d4f4cdd659319f1af2c5e62" width="90%"></p>\n<p class="line" data-line="139">最后在%temp%/net/目录下写入health.exe.bat文件并执行</p>\n<p class="text-center line" data-line="141"><img src="/uploads/2017/07/19/5c48658f739e268d990f44b2b8c62f60.png" alt="835aae11f4e76320611b52eb98d3d1d2" width="80%"></p>\n<p class="line" data-line="143">health.exe.bat的代码如下，作用是不断遍历进程查看svhost.exe是否启动，没有启动的话则将其启动。</p>\n<p class="text-center line" data-line="145"><img src="/uploads/2017/07/19/26b6d8ff104be4f22a048131f4d481cd.png" alt="7da28826361240a37f148a685e5ab563" width="80%"></p>\n<h3 class="line" data-line="147">svhost.exe</h3>\n<p class="line" data-line="149">在HKEY_CURRENT_USER中设置一个值di用于判断是否已经感染过该系统：</p>\n<p class="text-center line" data-line="151"><img src="/uploads/2017/07/19/addb5d89a982f492bf7b89a19ad98a82.png" alt="c95ebff2497c18d2b3bb4b9710c9049d" width="70%"></p>\n<p class="line" data-line="153">设置HKEY_CURRENT_USER\\Environment\\SEE_MASK_NOZONECHECKS的值为1，这是用于关闭附件管理器检查的：</p>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/19/5b53e06d0749114811dc105474a0b25b.png" alt="7ddf63a334a55426403ccf7796ed9ac4" width="90%"></p>\n<p class="line" data-line="157">然后用命令行启动netsh.exe，添加防火墙规则，允许其通过防火墙</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/19/a24b4030f205e25bd7786d5c801195c7.png" alt="11cf4fcbdcc9843135ccf3501f432f78" width="70%"></p>\n<p class="line" data-line="161">命令行如下</p>\n<pre class="hljs"><code class="hljs">netsh firewall add allowedprogram "C:\\\\Users\\\\\\*\\*\\*\\\\AppData\\\\Local\\\\Temp\\\\svhost.exe" " svhost.exe" ENABLE\n</code></pre>\n<p class="line" data-line="166">申请一片内存空间用于存放接收/发送的数据，开始网络连接：</p>\n<p class="text-center line" data-line="168"><img src="/uploads/2017/07/19/9676a58a7a0286760d7efe01716f8b8d.png" alt="2b352c13dc65a30c5a89e3e58b7e5cd1" width="85%"></p>\n<p class="line" data-line="170">C&amp;C地址： 191.101.23.190</p>\n<p class="text-center line" data-line="172"><img src="/uploads/2017/07/19/7af893eca785ff862aee5afbac77b95b.png" alt="d0e210eb3f1849905b921d248fec11dd" width="45%"></p>\n<p class="line" data-line="174">端口号： 5552</p>\n<p class="text-center line" data-line="176"><img src="/uploads/2017/07/19/9bc5294feb1eba985a19966856852ebd.png" alt="3ee54e4519c9871e67dc2e902f0f5158" width="45%"></p>\n<p class="line" data-line="178">收集受害者的系统信息，包括上线时间、系统版本、系统位数、磁盘信息、当前用户等等，并发送出去：</p>\n<p class="text-center line" data-line="180"><img src="/uploads/2017/07/19/6d0d740ce86a5be474a38e095a07958b.png" alt="b34f35ad7c8977ff9ef8112311810416" width="90%"></p>\n<p class="line" data-line="182">然后开启一个线程循环查询socket是否可读（接收命令）：</p>\n<p class="text-center line" data-line="184"><img src="/uploads/2017/07/19/6f86f185399a40ecfcaafc97da288f3d.png" alt="64a74da6585d5361b5e420fd66de70a5" width="70%"></p>\n<p class="line" data-line="186">读取命令后，开启新线程根据指令执行对应的操作：</p>\n<p class="text-center line" data-line="188"><img src="/uploads/2017/07/19/425702e46d852ad1355b76207ab5f7fb.png" alt="6a52e6ba30f4ef0bce214db10ae90dae" width="90%"></p>\n<p class="line" data-line="190">开启键盘记录线程，并将记录信息保存在注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中：</p>\n<p class="text-center line" data-line="192"><img src="/uploads/2017/07/19/b40472dad950a9b67f100bbfdace23fe.png" alt="a717d59135d644202bedebcc6412c553" width="90%"></p>\n<p class="text-center line" data-line="194"><img src="/uploads/2017/07/19/500e126afffb6afb4d141341145f9512.png" alt="80b41258aea92eb0ca1b83e446a900bf" width="90%"></p>\n<p class="line" data-line="196">设置自启动项：</p>\n<p class="text-center line" data-line="198"><img src="/uploads/2017/07/19/109deec3d382e38db502a2043da04b0c.png" alt="65ff19f29e11e13e3178dcf40a1416fb" width="90%"></p>\n<p class="text-center line" data-line="201"><img src="/uploads/2017/07/19/7fbf79d02308fa3ea4b0b3868cefcf89.png" alt="601e1a90b302e8c0c9989aafe7f95cb4" width="90%"></p>\n<p class="line" data-line="203">接收命令后，对命令做出相应的处理，在switch中根据命令执行对应的功能，这里就不再详细分析，下面给出部分功能与对应的命令，</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>rn</td>\n<td>下载/执行文件</td>\n</tr>\n<tr>\n<td>CAP</td>\n<td>屏幕监控</td>\n</tr>\n<tr>\n<td>un</td>\n<td>自删除、启动和终止进程</td>\n</tr>\n<tr>\n<td>up</td>\n<td>在线更新</td>\n</tr>\n<tr>\n<td>Ex</td>\n<td>加载插件</td>\n</tr>\n<tr>\n<td>GTV</td>\n<td>获取注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中的键盘记录信息</td>\n</tr>\n<tr>\n<td>STV</td>\n<td>设置注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707开始键盘记录</td>\n</tr>\n<tr>\n<td>…..</td>\n<td>……</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="216">IOC</h2>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>C&amp;C</td>\n<td>191.101.23.190:5552</td>\n</tr>\n<tr>\n<td>Downloader URL</td>\n<td>http://pcdopune.com/ad/video.ppsx</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="224">总结</h2>\n<p class="line" data-line="227">在网上公开的IOC平台中发现，该C&amp;C地址与趋势科技在今年三月份发布的“Operation C-Major”报告中的一个C&amp;C完全一致。另外，样本下载的域名pcdopune.com关联到的其他样本中，也出现了与报告中几乎一样的恶意宏样本，由此我们认为这是与C-Major相关的攻击行动。</p>\n<p class="line" data-line="229">根据360威胁情报中心的数据，我们发现本文所涉及的样本仅仅只是C-Major行动中使用的多种Dropper中的一种类型，CVE-2010-3333、CVE-2012-0158等漏洞也被利用来做恶意代码的植入，不仅如此，甚至还利用了宏和脚本，所使用的PE样本更是灵活多变。从这些迹象来看C-Major行动背后团伙非常积极地利用所能得到各种植入手段，极有可能是专业的有背景及一定技术能力的组织。</p>\n<h2 class="line" data-line="231">参考链接</h2>\n<p class="line" data-line="234"><a href="http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf"><em>http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf</em></a></p>\n<p class="line" data-line="236"><a href="http://www.cnblogs.com/Danny-Wei/p/4161539.html"><em>http://www.cnblogs.com/Danny-Wei/p/4161539.html</em></a></p>\n<p class="line" data-line="238"><a href="http://www.openoffice.org/sc/compdocfileformat.pdf"><em>http://www.openoffice.org/sc/compdocfileformat.pdf</em></a></p>\n'}},serverRendered:!0}</script><script defer src="/_nuxt/manifest.38f62477280dcc27df9e.js"></script><script defer src="/_nuxt/vendor.bundle.45eca4dc7fa9e1bc4361.js"></script><script defer src="/_nuxt/nuxt.bundle.8e9d53f64bed77ebfe81.js"></script>